;/*FB_PKG_DELIM*/

__d("E2EEMetadataMailboxFetchGroupInfoMutation_facebookRelayOperation",[],(function(t,n,r,o,a,i){a.exports="25084023101236084"}),null);
__d("E2EEMetadataMailboxFetchGroupInfoMutation.graphql",["E2EEMetadataMailboxFetchGroupInfoMutation_facebookRelayOperation"],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e=[{defaultValue:null,kind:"LocalArgument",name:"input"}],t=[{alias:null,args:[{kind:"Variable",name:"data",variableName:"input"}],concreteType:"XFBTFetchGroupInfoGQLResponse",kind:"LinkedField",name:"xfb_fetch_group_info_from_mi",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"success",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"transport_thread_fbid",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"participant_update_mode",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"creator_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"creation_ts_ms",storageKey:null},{alias:null,args:null,concreteType:"XFBTFetchGroupInfoSubjectChangeGQLResponse",kind:"LinkedField",name:"subject_change",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"subject",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"subject_change_ts_ms",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"subject_changer_id",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBTFetchGroupInfoParticipantGQLResponse",kind:"LinkedField",name:"participants",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"contact_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"is_addressable",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"type",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"status",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"dma_interop_integrator_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"dma_interop_device_id",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"participant_version_id",storageKey:null},{alias:null,args:null,concreteType:"XFBTFetchGroupInfoEphemeralDataGQLResponse",kind:"LinkedField",name:"thread_ephemerality_data",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"mode",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"ttl_sec",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"last_set_actor_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"last_set_timestamp_ms",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"last_set_action_log_type",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"last_set_ttl_sec",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"e2ee_attribution_timestamp_ms",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"group_evolution_version",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"open_thread_id",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"group_domain",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_error_code",storageKey:null}],storageKey:null}];return{fragment:{argumentDefinitions:e,kind:"Fragment",metadata:null,name:"E2EEMetadataMailboxFetchGroupInfoMutation",selections:t,type:"Mutation",abstractKey:null},kind:"Request",operation:{argumentDefinitions:e,kind:"Operation",name:"E2EEMetadataMailboxFetchGroupInfoMutation",selections:t},params:{id:n("E2EEMetadataMailboxFetchGroupInfoMutation_facebookRelayOperation"),metadata:{},name:"E2EEMetadataMailboxFetchGroupInfoMutation",operationKind:"mutation",text:null}}})();a.exports=e}),null);
__d("E2EEMetadataMailboxFetchGroupInfoMutation",["E2EEMetadataMailboxFetchGroupInfoMutation.graphql","FBLogger","asyncToGeneratorRuntime","createWorkerMutation"],(function(t,n,r,o,a,i,l){"use strict";var e,s=e!==void 0?e:e=n("E2EEMetadataMailboxFetchGroupInfoMutation.graphql");function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=r("createWorkerMutation")(s),n=t[0],o=yield n({input:e});if(o==null)throw r("FBLogger")("wmi").mustfixThrow("Failed to fetch E2EE metadata mailbox group info from MI");return o}),c.apply(this,arguments)}l.fetchGroupInfoFromMIOverGraphQL=u}),98);
__d("EBAPIConvertNativeToLS",["I64","LSDict","LSShape","LSVec"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return{decrypted_protobuf:t.decryptedProtobuf,protobuf_timestamp_ms:(e||(e=o("I64"))).of_float(t.protobufTimestampMs)}}function u(e,t){var n=r("LSVec").ofArray(e.map(function(e){return e.value}).filter(Boolean)),o=r("LSVec").ofArray(t.map(function(e){return c(e)}).filter(Boolean));return{echo:n,protobuf:o}}function c(e){var t=e.topLevelProtobuf,n=e.supplementalProtobufs,a=e.otid;if(a!=null){var i=new Map;n.forEach(function(e,t){var n=o("LSShape").ofRecord(s(e));i.set(t,n)});var l={otid:a,supplemental_protobufs:new(r("LSDict"))(i),tags:e.messageTags.map(function(e){return e}),toplevel_protobuf:o("LSShape").ofRecord(s(t))};return o("LSShape").ofRecord(l)}}l.convertNativeProtobufToLSType=s,l.convertNativeDecryptionResponseToDecryptedMessageType=u,l.convertDecryptedProtobufMessageToLSNativeType=c}),98);
__d("MEBEncryptionVersion",[],(function(t,n,r,o,a,i){var e=Object.freeze({UNKNOWN:0,ENCRYPTION_KDF_WITH_VERSION:2,ENCRYPTION_KDF_WITH_NULL_SALT:3,ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY:4,TEST_VERSION:99});i.default=e}),66);
__d("EBCryptoUtils",["Base64Utils","EncryptedBackupsSymmetricEncryptionUtils","HChaCha20","MEBEncryptionVersion","SymmetricEncryptionCreateEncryptedData","SymmetricEncryptionPaddingUtils","XPlatReactCrypto","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e=32,s=2147483647,u="message_key_in_epoch",c="_",d="cipher_version",m="thread",p="message_thread",_="supplemental_enc_aad",f="kdf_info:mailbox_root_key_v2>supplemental_enc_key";function g(t,n,o,a,i){var l=o>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT?null:h(a),s=y(t,o,a);if(s==null)throw i.endFailWithError("failed_to_derive_message_symmetric_key"),r("err")("Error in derive message symmetric key. info is null");return b(s,l,n,[e],i)}function h(e){try{return new TextEncoder().encode(e).buffer}catch(e){throw r("err")("Error in get blob from string with exception: ",e)}}function y(e,t,n){var r=C(e,t,n);return h(r)}function C(e,t,n){return t>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY||t>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT?[u,new TextDecoder().decode(e),d,t,m,n!=null?n:""].join(c):t>=r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_VERSION?[u,new TextDecoder().decode(e),d,t].join(c):[u,new TextDecoder().decode(e)].join(c)}function b(e,t,n,a,i){if(a.length<1||a.some(function(e){return e>s}))throw i==null||i.endFailWithError("invalid_key_lengths_for_derive_keys"),r("err")("Invalid key lengths for derive keys");var l=a.reduce(function(e,t){return e+t},0)*8;return o("XPlatReactCrypto").subtleImportKey("raw",n,"HKDF",!1,["deriveBits"]).then(function(n){return o("XPlatReactCrypto").subtleDeriveBits({hash:"SHA-256",info:e,name:"HKDF",salt:t!=null?t:new Uint8Array(10).buffer},n,l)}).then(function(e){for(var t=new Uint8Array(e),n=[],r=0,o=0,i=a.length;o<i;++o){var l=r+a[o];n.push(t.slice(r,l).buffer),r=l}return n}).catch(function(e){throw i==null||i.endFailWithError("exception_in_create_derived_keys",e),r("err")("Exception in create derived keys",e)})}function v(e,t,n,a){var i=o("Base64Utils").toArrayBuffer(n);return S(e,t,i).then(function(e){if(e==null)throw a==null||a.endFailWithError("symmetric_string_decryption_with_null_result"),r("err")("symmetric string decryption with null result");return e}).catch(function(e){throw a==null||a.endFailWithError("symmetric_string_decryption_failed_with_error",e),r("err")("symmetric string decryption failed with error",e)})}function S(e,t,n){if(n.byteLength<o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes+o("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLengthInBytes)throw r("err")("cipher text is invalid");var a=new Uint8Array(n),i=a.slice(0,o("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes),l=new(o("HChaCha20")).HChaCha20,s=a.slice(o("EncryptedBackupsSymmetricEncryptionUtils").totalNonceLengthInBytes).buffer,u=l.hChaCha20Bytes(i.slice(0,o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer,e);return o("XPlatReactCrypto").subtleImportKey("raw",u,"AES-GCM",!1,["decrypt"]).then(function(e){return o("XPlatReactCrypto").subtleDecrypt({additionalData:t,iv:new Uint8Array(i.slice(o("EncryptedBackupsSymmetricEncryptionUtils").hChaCha20SubKeyNonceLengthInBytes).buffer),name:"AES-GCM",tagLength:o("EncryptedBackupsSymmetricEncryptionUtils").aesGcmTagLength},e,s)}).then(function(e){var t=o("SymmetricEncryptionPaddingUtils").stripPadding(e);if(t==null)throw r("err")("Failed to strip padding for symmetric decryption");return t}).catch(function(e){throw r("err")("symmetric data decryption failed with error",e)})}function R(e,t,n){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a=yield r("SymmetricEncryptionCreateEncryptedData")(t,new TextEncoder().encode([p,n].join(c)).buffer,e),i=a[0];return i!=null?o("Base64Utils").fromArrayBuffer(i):null}),L.apply(this,arguments)}l.KEY_LEN=e,l.MAX_INT_32=s,l.STRING_JOIN_SEPARATOR=c,l.MESSAGE_ENCYPTION_AAD=p,l.SUPPLEMENTAL_ENC_AAD=_,l.SUPPLEMENTAL_ENC_KEY_INFO=f,l.deriveMessageSymmetricKey=g,l.getBlobFromString=h,l.createDerivedKeys=b,l.symmetricEncryptionCreateDecryptedString=v,l.encryptThenBase64EncodeBlob=R}),98);
__d("EBDecryptQplFlow",["QPLUserFlow","Random","gkx","qex","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.annotations,n=e.decryptionType,a=e.entryPoint,i=e.isMinos,l=e.source,u=e.threadId,c=r("qpl")._(521485751,"1118"),d=o("Random").uint32();return r("QPLUserFlow").start(c,{annotations:babelHelpers.extends({},t,{bool:babelHelpers.extends({},t==null?void 0:t.bool,{is_wasm_serializer_on:r("gkx")("18428"),isMinos:i,minos_mvp_enabled:r("qex")._("208")===!0,occam_only_mailbox_users:r("gkx")("16674")}),int:babelHelpers.extends({},t==null?void 0:t.int,{instanceKey:d,retryCount:0}),string:babelHelpers.extends({},t==null?void 0:t.string,{decryptionType:n,queryType:a,source:l!=null?l:"unknown",threadId:u})}),instanceKey:d}),s(c,d)}function s(e,t){return{addAnnotations:function(o){r("QPLUserFlow").addAnnotations(e,o,{instanceKey:t})},addPoint:function(o,a){a&&r("QPLUserFlow").addAnnotations(e,a,{instanceKey:t}),r("QPLUserFlow").addPoint(e,o,{instanceKey:t})},endFailWithError:function(o,a,i){var n=babelHelpers.extends({},i,{string:babelHelpers.extends({},i==null?void 0:i.string,{failReason:a})});r("QPLUserFlow").endFailure(e,o,{annotations:n,instanceKey:t})},endSuccess:function(o){r("QPLUserFlow").endSuccess(e,{annotations:o,instanceKey:t})},getInstanceKey:function(){return t}}}l.startDecryptQplFlow=e}),98);
__d("EBEchoMessageDecryptor",["EBCryptoUtils","EBDecryptQplFlow","I64","LSAuthorityLevel","LSIntEnum","MEBEncryptionVersion","Promise","ReQL","WACryptoUtils","WALogger","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_;function f(e,t,n){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){if(t==null)throw o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No backup id provided"]))),r("err")("no-backup-id-provided");var a=yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(e.tables.secure_encrypted_backups_epochs));if(a.length===0)throw o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] SecureEncryptedBackupsEpoch table is empty"]))),r("err")("secure-epochs-table-empty");return a.filter(function(e){return(p||(p=o("I64"))).equal(e.authorityLevel,(_||(_=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))&&(p||(p=o("I64"))).equal(e.backupId,(p||(p=o("I64"))).of_string(t))&&n.equals(e[n.key])})}),g.apply(this,arguments)}function h(e,t){var n=t.epoch_id;return n!=null?f(e,t.backup_id,{equals:function(t){return t instanceof ArrayBuffer?!1:(p||(p=o("I64"))).equal(n,t)},key:"epochId",value:n}):f(e,t.backup_id,{equals:function(n){return n instanceof ArrayBuffer?o("WACryptoUtils").arrayBuffersEqual(t.epoch_anon_id,n):!1},key:"epochAnonIdBlob",value:t.epoch_anon_id})}var y=(function(){function t(){}var a=t.prototype;return a.decrypt=function(a,i,l,c,d){var t=l.map((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n,l=o("EBDecryptQplFlow").startDecryptQplFlow({decryptionType:"echo_message_decryptor",entryPoint:d,isMinos:!1,source:c,threadId:i});if(t.value==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Empty echo message string - cannot decrypt"]))),l.endFailWithError("empty_echo_message_string"),{otid:t.otid,value:void 0};var m=t.value;l.addPoint("get_epoch_keys_by_id_start");var p=yield h(a,t);if(p.length===0)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No epoch keys found for message"]))),l.endFailWithError("no_epoch_keys_found_for_message"),{otid:t.otid,value:void 0};l.addPoint("get_epoch_keys_by_id_end"),l.addPoint("derive_message_symmetric_key_start");var _=yield o("EBCryptoUtils").deriveMessageSymmetricKey(p[0].epochAnonIdBlob,p[0].epochRootKeyBlob,(n=t.encryption_version)!=null?n:r("MEBEncryptionVersion").UNKNOWN,i,l);if(_==null||_.length===0)return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to derive symmetric key for message"]))),l.endFailWithError("failed_to_derive_symmetric_key"),{otid:t.otid,value:void 0};l.addPoint("derive_message_symmetric_key_end"),l.addPoint("symmetric_encryption_create_decrypted_string_start");var f=yield o("EBCryptoUtils").symmetricEncryptionCreateDecryptedString(_[0],new TextEncoder().encode([o("EBCryptoUtils").MESSAGE_ENCYPTION_AAD,i].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR)).buffer,m,l);return l.addPoint("symmetric_encryption_create_decrypted_string_end"),l.endSuccess(),{otid:t.otid,value:f!=null?new TextDecoder().decode(f):void 0}});return function(e){return t.apply(this,arguments)}})());return(m||(m=n("Promise"))).all(t)},t})();l.getEpochKeysByID=h,l.EchoMessageDecryptor=y}),98);
__d("EBTypes",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.unsafeCastToDecryptedLabyrinthMessage=e}),66);
__d("EBProtobufMessageDecryptor",["Base64Utils","EBCryptoUtils","EBDecryptQplFlow","EBEchoMessageDecryptor","EBTypes","MEBEncryptionVersion","MpsTypes","Promise","WALogger","WALongInt","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h=(function(){function t(){}var a=t.prototype;return a.$1=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l){var m,p=o("EBDecryptQplFlow").startDecryptQplFlow({decryptionType:"protobuf_message_decryptor",entryPoint:l,isMinos:!1,source:i,threadId:n});p.addAnnotations({string:{message_id:a.otid}}),p.addPoint("get_epoch_keys_by_id_start");var _=yield o("EBEchoMessageDecryptor").getEpochKeysByID(t,a);if(_.length===0){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] No epoch keys found for message"]))),p.endFailWithError("no_epoch_keys_found_for_message");return}p.addPoint("get_epoch_keys_by_id_end");var f=_[0];p.addPoint("derive_message_symmetric_key_start");var g=yield o("EBCryptoUtils").deriveMessageSymmetricKey(f.epochAnonIdBlob,f.epochRootKeyBlob,(m=a.encryption_version)!=null?m:r("MEBEncryptionVersion").UNKNOWN,n,p);if(g==null||g.length===0){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to derive symmetric key for message"]))),p.endFailWithError("failed_to_derive_symmetric_key");return}if(p.addPoint("derive_message_symmetric_key_end"),p.addPoint("symmetric_encryption_create_decrypted_string_start"),a.encryptedProtobufContent==null){o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] encrypted protobuf content is null"]))),p.endFailWithError("encrypted_protobuf_content_is_null");return}var h=a.encryptedProtobufContent,y=yield o("EBCryptoUtils").symmetricEncryptionCreateDecryptedString(g[0],new TextEncoder().encode([o("EBCryptoUtils").MESSAGE_ENCYPTION_AAD,n].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR)).buffer,h,p),C;if(a.skCipherText!=null){var b,v=a.skCipherText,S=yield(b=o("EBCryptoUtils")).createDerivedKeys(new TextEncoder().encode(b.SUPPLEMENTAL_ENC_KEY_INFO).buffer,void 0,f.epochRootKeyBlob,[b.KEY_LEN],p);C=yield b.symmetricEncryptionCreateDecryptedString(S[0],new TextEncoder().encode(b.SUPPLEMENTAL_ENC_AAD).buffer,v,p)}if(y==null){p.endFailWithError("failed_to_decrypt_protobuf"),o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt protobuf"])));return}p.addPoint("symmetric_encryption_create_decrypted_string_end"),p.addPoint("decrypt_supplemental_key_start");var R=C!=null?o("MpsTypes").toSupplementalKey(new TextDecoder().decode(C)):void 0;if(p.addPoint("decrypt_supplemental_key_end"),a.protobufTimestampMs==null){p.endFailWithError("protobuf_timestamp_is_null"),o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] protobuf timestamp is null"])));return}var L=o("WATimeUtils").castLongIntToMillisTime(o("WALongInt").decimalStringToLongInt(a.protobufTimestampMs));return p.endSuccess(),{decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(y),decryptedSupplementalKey:R,protobufTimestampMs:L}});function a(e,n,r,o,a){return t.apply(this,arguments)}return a})(),a.$2=function(t){var e=t.topLevelProtobuf.encryptedProtobufContent,n=t.topLevelProtobuf.protobufTimestampMs,r=t.topLevelProtobuf.otid;if(!(e==null||n==null||r==null))return{messageTags:t.messageTags,otid:o("MpsTypes").toMessageId(r),supplementalProtobufs:new Map,topLevelProtobuf:{decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(o("Base64Utils").toArrayBuffer(e)),decryptedSupplementalKey:void 0,protobufTimestampMs:o("WATimeUtils").castLongIntToMillisTime(o("WALongInt").decimalStringToLongInt(n))}}},a.$3=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r,a,i){var l=this,s=r.topLevelProtobuf,u=r.supplementalProtobufs,c=yield this.$1(e,t,s,a,i);if(c==null){o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt top level protobuf"])));return}var d=new Map;return yield(g||(g=n("Promise"))).all(u.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=yield l.$1(e,t,n,a,i);if(r==null){o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt supplemental protobuf"])));return}var s=r.decryptedSupplementalKey;if(s==null){o("WALogger").ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] decrypted supplemental key is null"])));return}d.set(s,r)});return function(e){return r.apply(this,arguments)}})())),{messageTags:r.messageTags,otid:r.topLevelProtobuf.otid!=null?o("MpsTypes").toMessageId(r.topLevelProtobuf.otid):void 0,supplementalProtobufs:d,topLevelProtobuf:c}});function t(t,n,r,o,a){return e.apply(this,arguments)}return t})(),a.decrypt=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,r,a,i){var l=this,s=[];return yield(g||(g=n("Promise"))).all(r.map((function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){if(n.isUnencrypted===!0){var r=l.$2(n);r!=null&&s.push(r);return}var u=yield l.$3(e,t,n,a,i);if(u==null){o("WALogger").ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Failed to decrypt protobuf message for message with otid ",""])),n.topLevelProtobuf.otid);return}s.push(u)});return function(e){return r.apply(this,arguments)}})())),s});function t(t,n,r,o,a){return e.apply(this,arguments)}return t})(),t})();l.ProtobufMessageDecryptor=h}),98);
__d("EBAPIDecryptionModule",["EBEchoMessageDecryptor","EBProtobufMessageDecryptor","WALogger","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,r,o,a){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r,a,i,l){o("WALogger").DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Running native decryption"])));var u=new(o("EBEchoMessageDecryptor")).EchoMessageDecryptor,c=new(o("EBProtobufMessageDecryptor")).ProtobufMessageDecryptor;try{var d=a.length>0?yield u.decrypt(t,n,a,i,l):[],m=r.length>0?yield c.decrypt(t,n,r,i,l):[];return o("WAResultOrError").makeResult({decryptedEchoMessages:d,decryptedProtobufs:m})}catch(e){return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Error thrown when running native decryption: ",""])),e),o("WAResultOrError").makeError(e)}}),c.apply(this,arguments)}l.decryptUsingNativeJS=u}),98);
__d("EBAPISharedTypes",[],(function(t,n,r,o,a,i){"use strict";var e=["ebls-not-initialized","no-client-state","runtime-error","invalid-client-state","invalid-graphql-response","empty-decryption-response","delete-mailbox","unsupported-context","eb-not-enabled","echo-to-protobuf-conversion-error","called-from-main-thread","missing-message-range-info","server-side-exception","thread-not-found-in-mi-act-mapping-table","thread-not-found-on-server","echo-decryption-failure","protobuf-decryption-failure","decryption-error","null-chat-jid","native-decryption-error","invalid-parameters","secure-epochs-table-empty","no-backup-id-provided"],l=new Set(e);i.EBAPIRestoreErrorValues=e,i.errorSet=l}),66);
__d("EBBase64Decode",["Base64Utils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.replace(/-/g,"+").replace(/_/g,"/").replace(/\./g,"=").replace("/,/","="),n=4-t.length%4;if(n<4)for(var r=0;r<n;r++)t+="=";return t}function s(t){return o("Base64Utils").toArrayBuffer(e(t))}l.default=s}),98);
__d("EBConvertMinosProtobufShape",["EBTypes"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t;return{messageTags:e.messageTags,otid:(t=e.otid)!=null?t:void 0,supplementalProtobufs:s(e.supplementalProtobufs),topLevelProtobuf:{decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(e.topLevelProtobuf.decryptedProtobuf),decryptedSupplementalKey:e.topLevelProtobuf.decryptedSupplementalKey,protobufTimestampMs:e.topLevelProtobuf.protobufTimestampMs}}}function s(e){var t=new Map;return e.forEach(function(e,n){var r={decryptedProtobuf:o("EBTypes").unsafeCastToDecryptedLabyrinthMessage(e.decryptedProtobuf),decryptedSupplementalKey:n,protobufTimestampMs:e.protobufTimestampMs};t.set(n,r)}),t}l.convertMinosProtobufShape=e}),98);
__d("EBDBMetricsConsistencyOperationEnum",["$InternalEnum"],(function(t,n,r,o,a,i){"use strict";var e=n("$InternalEnum")({Upload:0});i.EBConsistencyOperation=e}),66);
__d("EBDedupeLabyrinthMessages",["EBConvertMinosProtobufShape","MpsTypes"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=new Map;return e.forEach(function(e,n){var r=o("EBConvertMinosProtobufShape").convertMinosProtobufShape(e);t.set(n,r)}),t}function s(t,n){if(n==null)return t;var r=e(n),a=[];t.forEach(function(e){if(e.otid!=null){var t=o("MpsTypes").toMessageId(e.otid),n=r.get(t);if(n!=null){var i=u(e.supplementalProtobufs,n.supplementalProtobufs);n.supplementalProtobufs=i,a.push(n),r.delete(t)}else a.push(e)}});for(var i of r.values())a.push(i);return a}function u(e,t){var n=new Map;return e.forEach(function(e,r){var o=t.get(r);o!=null?(n.set(r,o),t.delete(r)):n.set(r,e)}),t.forEach(function(e,t){n.set(t,e)}),n}l.dedupeLabyrinthMessages=s}),98);
__d("PublicKeyEncryptionUtils",["Promise","UInt8Array","XPlatReactCrypto"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){}function u(e){return e!=null?e:new Uint8Array(0).buffer}function c(e,t,n,r,a){return o("UInt8Array").concatBytes([e,t,n,r,a]).buffer}function d(e,t,n,r){return o("XPlatReactCrypto").subtleImportKey("raw",e.buffer,"HKDF",!1,["deriveKey"]).then(function(e){return o("XPlatReactCrypto").subtleDeriveKey({hash:"SHA-256",info:n,name:"HKDF",salt:t},e,{length:256,name:"AES-GCM"},!1,[r])})}var m="key length is not 32";function p(e,t){if(e.length!==32)return t(m)}function _(t){return new(e||(e=n("Promise")))(function(e,n){return p(t,n),e()})}var f=32;l.assertValidCurvePoint=s,l.getSalt=u,l.concatAad=c,l.getAesKey=d,l.testKeyLength=p,l.assertKeyLength=_,l.keyLength=f}),98);
__d("PublicEncryptionCreateDecryptedData",["CryptoLogger","Promise","PublicKeyEncryptionUtils","RetUtil","XPlatReactCrypto","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("PublicKeyCrypto").__setRef("PublicEncryptionCreateDecryptedData"),u=r("requireDeferred")("X25519").__setRef("PublicEncryptionCreateDecryptedData");function c(e,t){var n=1+o("PublicKeyEncryptionUtils").keyLength+16,r=e.length;r<1+o("PublicKeyEncryptionUtils").keyLength+16&&t("CipherText length is "+r+", < "+n)}function d(e,t,n){var r=t[0];if(r!==e)return n("Unexpected version "+r)}function m(t){return new(e||(e=n("Promise")))(function(e,n){return d(1,t,n),c(t,n),e()})}function p(t,r){return new(e||(e=n("Promise")))(function(e,n){return o("PublicKeyEncryptionUtils").assertValidCurvePoint(t,n),o("PublicKeyEncryptionUtils").assertValidCurvePoint(r,n),e()})}function _(t,r,a,i,l,c){var d,_=new Uint8Array(l),f=new Uint8Array([1]),g=(d=o("PublicKeyEncryptionUtils")).getSalt(i),h=new Uint8Array(t),y=new Uint8Array(a),C=new Uint8Array(r),b=new Uint8Array(c);return(e||(e=n("Promise"))).all([o("PublicKeyEncryptionUtils").assertKeyLength(h),o("PublicKeyEncryptionUtils").assertKeyLength(C),o("PublicKeyEncryptionUtils").assertKeyLength(y)]).then(function(){return m(b)}).then(function(){return u.load()}).then(function(t){var r=b.slice(1,o("PublicKeyEncryptionUtils").keyLength+1),a=t.publicKeyFromBytes(r,t.KeyPurpose.Encryption);return p(a,y).then(function(){var i=o("PublicKeyEncryptionUtils").concatAad(f,y,h,r,_),l=function(o,i,l){var r=t.publicKeyFromBytes(o,t.KeyPurpose.Encryption),s=t.publicKeyFromBytes(i,t.KeyPurpose.Encryption),u=t.secretKeyFromBytes(l,t.KeyPurpose.Encryption);return r==null||s==null||u==null||a==null?(e||(e=n("Promise"))).resolve():(e||(e=n("Promise"))).resolve([r,s,u,a])};return l(h,y,C).then(function(e){if(e!=null)return{ephemeralPub:e[3],innerAad:i,receiverPriv:e[2],receiverPub:e[0],senderPub:e[1]}})})}).then(function(e){if(e!=null){var t=e.ephemeralPub,n=e.receiverPriv,r=e.senderPub,a=e.innerAad;return s.load().then(function(e){return e.receiverDeriveSharedSecret(n,t,r)}).then(function(e){return e==null?null:o("PublicKeyEncryptionUtils").getAesKey(e,g,a,"decrypt")}).then(function(e){if(e!=null){var t=new Uint8Array(12).buffer,n=b.slice(o("PublicKeyEncryptionUtils").keyLength+1).buffer;return o("XPlatReactCrypto").subtleDecrypt({additionalData:a,iv:new Uint8Array(t),name:"AES-GCM",tagLength:128},e,n)}})}}).then(function(t){return(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(t))}).catch(function(t){var r=o("CryptoLogger").CryptoLogger("public_encryption_create_decrypted_data");return o("CryptoLogger").captureError(r,t).mustfix("Creation of decrypted data for public encryption failed"),(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(void 0))})}l.default=_}),98);
__d("PublicEncryptionCreateEncryptedData",["CryptoLogger","Promise","PublicKeyEncryptionUtils","RetUtil","UInt8Array","XPlatReactCrypto","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("PublicKeyCrypto").__setRef("PublicEncryptionCreateEncryptedData"),u=r("requireDeferred")("X25519").__setRef("PublicEncryptionCreateEncryptedData");function c(e,t){if(e.byteLength>32)return t("PSK is too long")}function d(t,r){return new(e||(e=n("Promise")))(function(e,n){return o("PublicKeyEncryptionUtils").assertValidCurvePoint(r,n),c(t,n),e()})}function m(t,r,a,i,l,c){var m,p=new Uint8Array([1]),_=new Uint8Array(l),f=(m=o("PublicKeyEncryptionUtils")).getSalt(i),g=new Uint8Array(t),h=new Uint8Array(r),y=new Uint8Array(a);return(e||(e=n("Promise"))).all([o("PublicKeyEncryptionUtils").assertKeyLength(g),o("PublicKeyEncryptionUtils").assertKeyLength(h),o("PublicKeyEncryptionUtils").assertKeyLength(y)]).then(function(){return d(f,g)}).then(function(){return u.load()}).then(function(t){var r=t.generateKeys(t.KeyPurpose.Encryption),a=r.pk,i=o("PublicKeyEncryptionUtils").concatAad(p,h,g,a,_),l=function(o,a,i){var r=t.publicKeyFromBytes(o,t.KeyPurpose.Encryption),l=t.publicKeyFromBytes(a,t.KeyPurpose.Encryption),s=t.secretKeyFromBytes(i,t.KeyPurpose.Encryption);return r==null||l==null||s==null?(e||(e=n("Promise"))).resolve():(e||(e=n("Promise"))).resolve([r,l,s])};return l(g,h,y).then(function(e){return e==null?null:{ephemeralPriv:r.sk,ephemeralPubBytes:r.pk,innerAad:i,receiverPub:e[0],senderPriv:e[2],senderPub:e[1]}})}).then(function(e){if(e!=null){var t=e.ephemeralPubBytes,n=e.ephemeralPriv,r=e.senderPriv,a=e.receiverPub,i=e.innerAad;return s.load().then(function(e){return e.senderDeriveSharedSecret(r,n,a)}).then(function(e){if(e!=null)return o("PublicKeyEncryptionUtils").getAesKey(e,f,i,"encrypt")}).then(function(e){if(e!=null){var t=new Uint8Array(12).buffer;return o("XPlatReactCrypto").subtleEncrypt({additionalData:i,iv:new Uint8Array(t),name:"AES-GCM",tagLength:128},e,c)}}).then(function(e){if(e!=null){var n=new Uint8Array(e);return o("UInt8Array").concatBytes([p,t,n]).buffer}})}}).then(function(t){return(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(t))}).catch(function(t){var r=o("CryptoLogger").CryptoLogger("public_encryption_create_encrypted_data");return o("CryptoLogger").captureError(r,t).mustfix("Creation of encrypted data for public encryption failed"),(e||(e=n("Promise"))).resolve(o("RetUtil").getNullableRetResult(void 0))})}l.default=m}),98);
__d("EBEpochUtils",["Base64Utils","EBCryptoUtils","FBLogger","I64","Promise","PublicEncryptionCreateDecryptedData","PublicEncryptionCreateEncryptedData","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u="epoch_chaining",c="epoch_root_key",d="epoch_data_storage",m="epoch_data_metadata",p=18;function _(e){var t=new TextEncoder().encode("0").buffer;if(e==null||e.byteLength===0)return t;var n=new TextDecoder,o=n.decode(e),a=Number.parseInt(o,10);if(Number.isNaN(a))throw r("FBLogger")("messenger_web").mustfixThrow("currentEpochInt is NaN");var i=a+1;return new TextEncoder().encode(i.toString()).buffer}function f(e,t,n){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a,i=[(a=o("EBCryptoUtils")).KEY_LEN,a.KEY_LEN],l=a.getBlobFromString([u,e,(s||(s=o("I64"))).to_string(t)].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR));if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("infoForEpochChaining is empty");var c=yield o("EBCryptoUtils").createDerivedKeys(l,null,n,i);return{epoch_chaining_key:c[0],epoch_distribution_pre_shared_key:c[1]}}),g.apply(this,arguments)}function h(e,t,n,r,o,a){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,o,a,i){var l=yield r("PublicEncryptionCreateDecryptedData")(e,t,n,o,v(a),i);return l[0]}),y.apply(this,arguments)}function C(e,t,n,r,o,a){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,o,a,i){var l=yield r("PublicEncryptionCreateEncryptedData")(e,t,n,o,v(a),i);return l[0]}),b.apply(this,arguments)}function v(e){return new TextEncoder().encode(["epoch_",e].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR)).buffer}function S(e,t,n,r){return R.apply(this,arguments)}function R(){return R=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){var a=yield o("EBCryptoUtils").createDerivedKeys(e,t,n,r);return a[0]}),R.apply(this,arguments)}function L(e,t){var n=o("EBCryptoUtils").getBlobFromString(c);if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("epochRootKey is empty");return S(n,e,t,[o("EBCryptoUtils").KEY_LEN])}function E(e,t){var n=new TextEncoder().encode("meb/debug/fingerprint/"+t).buffer;if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("blob type for which fingerprints are supported is empty");return S(n,null,e,[p])}function k(e,t,n){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,r,a){var i=[o("EBCryptoUtils").KEY_LEN],l=o("Base64Utils").fromArrayBuffer(r),s=[t,l].join(o("EBCryptoUtils").STRING_JOIN_SEPARATOR),u=yield o("EBCryptoUtils").createDerivedKeys(new TextEncoder().encode(s).buffer,null,a,i);return u.length===0?(e||(e=n("Promise"))).resolve():u[0]}),I.apply(this,arguments)}function T(e){return k(d,e.epochAnonIdBlob,e.epochRootKeyBlob)}function D(e,t){return x.apply(this,arguments)}function x(){return x=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield $(t,e,m);if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("symmetricDecryptAndBase64Decode output is empty while decrypting backward edge");return o("Base64Utils").toArrayBuffer(n)}),x.apply(this,arguments)}function $(e,t,n){return P.apply(this,arguments)}function P(){return P=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a=new TextEncoder().encode(n).buffer;if(a==null)throw r("FBLogger")("messenger_web").mustfixThrow("aadBuffer is empty");var i=yield o("EBCryptoUtils").symmetricEncryptionCreateDecryptedString(t,a,e);if(i==null)throw r("FBLogger")("messenger_web").mustfixThrow("decrypted_arraybuffer is empty");return new TextDecoder().decode(i)}),P.apply(this,arguments)}l.getNextEpochId=_,l.generateEpochChainingAndDistributionPreSharedKey=f,l.decryptEpochKey=h,l.generateEncryptedEpochKey=C,l.deriveKey=S,l.generateEpochRootKey=L,l.getFingerPrint=E,l.createDerivedKeysForEpoch=k,l.deriveBackwardEdgeKey=T,l.decryptBackwardEdge=D}),98);
__d("LSEpochStatus",[],(function(t,n,r,o,a,i){var e=Object.freeze({ES_OPEN:1,ES_CLOSE:2});i.default=e}),66);
__d("MEBEpochDerivationResult",[],(function(t,n,r,o,a,i){var e=Object.freeze({SUCCESS:0,UNKNOWN_ERROR:1,EDGE_NEITHER_FORWARD_NOR_BACKWARD:2,FORWARD_DECRYPTION_FAILED:3,FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED:4,BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED:5,BACKWARD_DECRYPTION_FAILED:6,MISSING_CLIENT_STATE:7,DEVICE_ID_MISMATCH:8,SOURCE_FINGERPRINT_MISMATCH:9,DEST_FINGERPRINT_MISMATCH:10,STORAGE_KEY_MISMATH:11,PSK_FINGERPRINT_MISMATCH:12,SOURCE_EPOCH_NOT_FOUND:13,FORWARD_EDGE_NOT_CONSECUTIVE:14,BACKWARD_EDGE_NOT_CONSECUTIVE:15,DERIVATION_DEST_EXISTS:16,DERIVATION_DEST_ANON_ID_EXISTS:17});i.default=e}),66);
__d("EBDeriveAndStoreEpochs",["Base64Utils","EBBase64Decode","EBEpochUtils","I64","LSAuthorityLevel","LSEpochStatus","MEBEpochDerivationResult","ReQL","WACryptoUtils","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,r){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i){var l,s,u,c,d=yield o("EBEpochUtils").getNextEpochId(i.epochAnonIdBlob),m=a==null||(l=a.to_epoch)==null?void 0:l.epoch_anon_id;if(m==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge target epoch anon id is null",resultCode:r("MEBEpochDerivationResult").FORWARD_EDGE_NOT_CONSECUTIVE});var p=r("EBBase64Decode")(m);if(new TextDecoder().decode(d)!==new TextDecoder().decode(p))return o("WAResultOrError").makeError({errorMessage:"epoch forward edge not consecutive",resultCode:r("MEBEpochDerivationResult").FORWARD_EDGE_NOT_CONSECUTIVE});var _=a==null||(s=a.from_epoch)==null?void 0:s.epoch_id,f=a==null||(u=a.from_epoch)==null?void 0:u.epoch_anon_id;if(_==null||f==null)return o("WAResultOrError").makeError({errorMessage:"fromEpochId or fromEpochAnonId is null",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var g=r("EBBase64Decode")(f),h=new TextDecoder().decode(g),y=yield o("EBEpochUtils").generateEpochChainingAndDistributionPreSharedKey(h,(e||(e=o("I64"))).of_string(_),i.epochRootKeyBlob),C=y.epoch_distribution_pre_shared_key,b=yield o("EBEpochUtils").getFingerPrint(C,"MEBCryptoPreSharedKey");if((n==null?void 0:n.psk_fingerprint)!==o("Base64Utils").fromArrayBuffer(b))return o("WAResultOrError").makeError({errorMessage:"epoch forward edge psk fingerprint mismatch",resultCode:r("MEBEpochDerivationResult").PSK_FINGERPRINT_MISMATCH});var v=n==null?void 0:n.epoch_storage_public_key;if(o("Base64Utils").fromArrayBuffer(t.epochStoragePublicKeyBlob)!==v)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge storage key mismatch",resultCode:r("MEBEpochDerivationResult").STORAGE_KEY_MISMATH});var S=n==null?void 0:n.auth_public_key;if(S==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge auth public key is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var R=a==null||(c=a.to_epoch)==null?void 0:c.epoch_anon_id;if(R==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge target epoch anon id is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var L=n==null?void 0:n.encrypted_entropy;if(L==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge encrypted entropy is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var E=r("EBBase64Decode")(S);if(E==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge auth public key is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var k=r("EBBase64Decode")(L);if(k==null)return o("WAResultOrError").makeError({errorMessage:"epoch forward edge encrypted entropy is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var I=r("EBBase64Decode")(R),T=new TextDecoder().decode(I),D=yield o("EBEpochUtils").decryptEpochKey(t.epochStoragePublicKeyBlob,t.epochStoragePrivateKeyBlob,E,C,T,k);return D==null?o("WAResultOrError").makeError({errorMessage:"epoch forward edge entropy is null",resultCode:r("MEBEpochDerivationResult").FORWARD_DECRYPTION_FAILED}):o("WAResultOrError").makeResult(yield o("EBEpochUtils").generateEpochRootKey(y.epoch_chaining_key,D))}),u.apply(this,arguments)}function c(e,t,n){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a,i=t==null||(a=t.to_epoch)==null?void 0:a.epoch_anon_id;if(i==null)return o("WAResultOrError").makeError({errorMessage:"toEpochId is null",resultCode:r("MEBEpochDerivationResult").BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});var l=o("EBEpochUtils").getNextEpochId(r("EBBase64Decode")(i));if(!o("WACryptoUtils").arrayBuffersEqual(l,e.epochAnonIdBlob))return o("WAResultOrError").makeError({errorMessage:"epoch backward edge not consecutive",resultCode:r("MEBEpochDerivationResult").BACKWARD_EDGE_NOT_CONSECUTIVE});var s=yield o("EBEpochUtils").deriveBackwardEdgeKey(e);return s==null?o("WAResultOrError").makeError({errorMessage:"epoch backward edge storage key is null",resultCode:r("MEBEpochDerivationResult").STORAGE_KEY_MISMATH}):o("WAResultOrError").makeResult(yield o("EBEpochUtils").decryptBackwardEdge(s,n))}),d.apply(this,arguments)}function m(e,t){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var a,l,u,d,m=yield t.runInTransaction(function(e){return o("ReQL").firstAsync(o("ReQL").fromTableAscending(e.secure_encrypted_backups_client_state))},"readwrite",void 0,void 0,i.id+":224");if(m==null)return o("WAResultOrError").makeError({errorMessage:"client state is missing",resultCode:r("MEBEpochDerivationResult").MISSING_CLIENT_STATE});var p=n==null||(a=n.from_epoch)==null?void 0:a.epoch_id;if(p==null)return o("WAResultOrError").makeError({errorMessage:"fromEpochId is null",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var _=yield t.runInTransaction(function(t){return t.secure_encrypted_backups_epochs.get((e||(e=o("I64"))).of_string(p))},"readwrite",void 0,void 0,i.id+":242");if(_==null)return o("WAResultOrError").makeError({errorMessage:"source epoch is missing",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var f=n==null||(l=n.from_epoch)==null?void 0:l.epoch_anon_id;if(f==null)return o("WAResultOrError").makeError({errorMessage:"fromEpochId or fromEpochAnonId is null",resultCode:r("MEBEpochDerivationResult").SOURCE_EPOCH_NOT_FOUND});var g=r("EBBase64Decode")(f);if(new TextDecoder().decode(_.epochAnonIdBlob)!==new TextDecoder().decode(g))return o("WAResultOrError").makeError({errorMessage:"epoch derivation source epoch anon id mismatch",resultCode:r("MEBEpochDerivationResult").SOURCE_FINGERPRINT_MISMATCH});var h=n==null?void 0:n.from_epoch_fingerprint,y=yield o("EBEpochUtils").getFingerPrint(_.epochRootKeyBlob,"MEBEpochRootKey");if(o("Base64Utils").fromArrayBuffer(y)!==h)return o("WAResultOrError").makeError({errorMessage:"epoch derivation source epoch fingerprint mismatch",resultCode:r("MEBEpochDerivationResult").SOURCE_FINGERPRINT_MISMATCH});var C=n==null?void 0:n.forward_edge,b;if(C!=null)b=yield s(m,C,n,_);else{var v=n==null?void 0:n.backward_edge;if(v==null)return o("WAResultOrError").makeError({errorMessage:"backward edge is null",resultCode:r("MEBEpochDerivationResult").BACKWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});b=yield c(_,n,v)}var S=n==null?void 0:n.to_epoch_fingerprint,R=b.value,L=n==null||(u=n.to_epoch)==null?void 0:u.epoch_id,E=n==null||(d=n.to_epoch)==null?void 0:d.epoch_anon_id;if(L==null||E==null)return o("WAResultOrError").makeError({errorMessage:"target epoch id or anon id is null",resultCode:r("MEBEpochDerivationResult").FORWARD_SOURCE_EPOCH_NOT_FOUND_DEPRECATED});if(R==null)return b;var k=yield o("EBEpochUtils").getFingerPrint(R,"MEBEpochRootKey");if(S!==o("Base64Utils").fromArrayBuffer(k))return o("WAResultOrError").makeError({errorMessage:"epoch derivation target epoch fingerprint mismatch",resultCode:r("MEBEpochDerivationResult").DEST_FINGERPRINT_MISMATCH});var I=r("EBBase64Decode")(E);return yield t.runInTransaction(function(t){return t.secure_encrypted_backups_epochs.put({authorityLevel:(e||(e=o("I64"))).of_float(r("LSAuthorityLevel").AUTHORITATIVE),backupId:m.backupId,epochAnonIdBlob:I,epochId:e.of_string(L),epochRootKeyBlob:R,epochStatus:e.of_float(r("LSEpochStatus").ES_CLOSE)})},"readwrite",void 0,void 0,i.id+":331"),o("WAResultOrError").makeResult(R)}),p.apply(this,arguments)}function _(e,t){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){if((t==null?void 0:t.epoch_edges)==null)return[];var n=[];for(var o of t.epoch_edges){var a,i,l,s,u,c=yield m(e,o),d={resultForEpochSync:{error_message:(a=c.error)==null?void 0:a.errorMessage,from:{epoch_anon_id:(i=o.from_epoch)==null?void 0:i.epoch_anon_id,epoch_id:o==null||(l=o.from_epoch)==null?void 0:l.epoch_id},has_backward_edge:(o==null?void 0:o.backward_edge)!=null,has_forward_edge:(o==null?void 0:o.forward_edge)!=null,result_code:c.success?r("MEBEpochDerivationResult").SUCCESS:c.error.resultCode,to:{epoch_anon_id:o==null||(s=o.to_epoch)==null?void 0:s.epoch_anon_id,epoch_id:o==null||(u=o.to_epoch)==null?void 0:u.epoch_id}}};n.push(d)}return n}),f.apply(this,arguments)}l.deriveAndStoreEpochsNonLS=_}),98);
__d("EBMinosEncryptedMekVersion",["$InternalEnum","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e=n("$InternalEnum")({V1:1,V2:2}),s=e.V1,u=r("gkx")("19417")?e.V2:e.V1;l.MinosEncryptedMekVersion=e,l.INITIAL_VERSION=s,l.MINOS_ENCRYPTED_MEK_CURRENT_VERSION=u}),98);
__d("EBMinosWasmDeriveMailboxAuthKeypair",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.mailboxAuthPrivateKey,n=e.mailboxAuthPublicKey;return o("WAResultOrError").makeResult({pk:o("EBMinosTypes").unsafeCastToMailboxAuthPK(n),sk:o("EBMinosTypes").unsafeCastToMailboxAuthSK(t)})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochNumber,r=t.exportRootKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DeriveMailboxAuthKeypairResultSpec,validateResult:e},{deriveMailboxAuthKeypair:{epochNumber:n,exportRootKey:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.deriveMailboxAuthKeypair=s}),98);
__d("EBMinosClientConfig",["EBMinosEncryptedMekVersion","EBMinosMessageEncryptionVersion"],(function(t,n,r,o,a,i,l){"use strict";var e={preferredMekEncryptionVersion:o("EBMinosEncryptedMekVersion").MINOS_ENCRYPTED_MEK_CURRENT_VERSION,preferredMessageEncryptionVersion:o("EBMinosMessageEncryptionVersion").MINOS_MESSAGE_ENCRYPTION_CURRENT_VERSION};l.MINOS_CLIENT_CONFIG=e}),98);
__d("EBMinosWasmEncryptMekForDistribution",["EBMinosClientConfig","EBMinosEncryptedMekVersion","EBMinosLogger","EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WALongInt","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){function t(t){var n=t.ciphertext,r=t.version,a=o("WALongInt").maybeNumberOrThrowIfTooLarge(r);if(a==null)return o("WAResultOrError").makeError("missing-mek-encryption-version");var i=o("EBMinosEncryptedMekVersion").MinosEncryptedMekVersion.cast(a);return i==null?(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast encrypted mek version: ",""])),a),o("WAResultOrError").makeError("invalid-mek-encryption-version")):o("WAResultOrError").makeResult({encryptedMek:o("EBMinosTypes").unsafeCastToEncryptedMek(n),mekEncryptionVersion:i})}return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.fromKeypair,r=e.mek,a=e.senderEpochHead,i=e.toEpochHead,l=e.toMailboxPk;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").EncryptMekForDistributionResultSpec,validateResult:t},{encryptMekForDistribution:{conf:o("EBMinosClientConfig").MINOS_CLIENT_CONFIG,fromKeypair:n,mek:r,senderEpochHead:a,toEpochHead:i,toMailboxPk:l}})});function r(t){return e.apply(this,arguments)}return r})()}var u=s();l.encryptMekForDistribution=u}),98);
__d("EBMinosWasmEncryptMeksForDistributionFromTransportSender",["EBMinosClientConfig","EBMinosEncryptedMekVersion","EBMinosLogger","EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WALongInt","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){function t(t){var n=t.encryptedMeks,r=t.ephemeralEncryptionPk,a=t.signature,i=t.signingPk,l=t.version,s=o("WALongInt").maybeNumberOrThrowIfTooLarge(l);if(s==null)return o("WAResultOrError").makeError("missing-mek-encryption-version");var u=o("EBMinosEncryptedMekVersion").MinosEncryptedMekVersion.cast(s);return u==null?(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast encrypted mek version: ",""])),s),o("WAResultOrError").makeError("invalid-mek-encryption-version")):o("WAResultOrError").makeResult({encryptedMeks:n.map(o("EBMinosTypes").unsafeCastToEncryptedMek),encryptedMekVersion:u,ephemeralEncryptionPk:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralPK(r),signature:o("EBMinosTypes").unsafeCastToTransportSenderEphemeralKeySig(a),signingPk:o("EBMinosTypes").unsafeCastToTransportSigningPK(i)})}return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.mek,r=e.recipientEpochHeads,a=e.recipientMailboxEncryptionPks,i=e.transportSigningKp;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").EncryptMeksForDistributionFromTransportSenderResultSpec,validateResult:t},{encryptMeksForDistributionFromTransportSender:{conf:o("EBMinosClientConfig").MINOS_CLIENT_CONFIG,mek:n,recipientEpochHeads:r,recipientMailboxEncryptionPks:a,transportSigningKp:i}})});function r(t){return e.apply(this,arguments)}return r})()}var u=s();l.createMinosWasmEncryptMeksForDistributionFromTransportSender=s,l.encryptMeksForDistributionFromTransportSender=u}),98);
__d("EBMinosWasmGenerateMek",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.mek;return o("WAResultOrError").makeResult({key:o("EBMinosTypes").unsafeCastMekKey(t.key),mekId:o("EBMinosTypes").unsafeCastToMekId(t.mekId),rosterHash:o("EBMinosTypes").unsafeCastMekRosterHash(t.rosterHash)})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochHeads;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").GenerateMekResultSpec,validateResult:e},{generateMek:{epochHeads:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.generateMek=s}),98);
__d("WAPromiseMap",["Promise"],(function(t,n,r,o,a,i){"use strict";var e;function l(t,r){return(e||(e=n("Promise"))).resolve(t).then(function(t){return(e||(e=n("Promise"))).all(t.map(function(e,t){return r(e,t)}))})}i.promiseMap=l}),66);
__d("EBGenerateAndUploadMek",["Base64Utils","EBMinosEncryptedMekVersion","EBMinosWasmDeriveMailboxAuthKeypair","EBMinosWasmEncryptMekForDistribution","EBMinosWasmEncryptMeksForDistributionFromTransportSender","EBMinosWasmGenerateMek","WAErrorMessage","WAPromiseMap","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=["mekEncryptionVersion","mekEnvelopes"],s,u,c,d,m,p,_,f,g,h,y,C,b,v;function S(e){return R.apply(this,arguments)}function R(){return R=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var r=t.actThreadId,a=t.io,i=t.logger,l=t.msgUploadQpl,g=t.participantMailboxes,h=t.transportSigningKeypair;i.DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["start generate and upload mek"]))),l.addPoint("generate_mek_start");var y=g.map(function(e){var t=e.epochHead;return t}),C=yield o("EBMinosWasmGenerateMek").generateMek({epochHeads:y});if(!C.success)return i.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["mek generated error: ",""])),C.error),o("WAResultOrError").makeError("generate-mek-error");l.addPoint("generate_mek_end"),l.addPoint("get_minos_mailbox_key_start");var b=yield a.loadMostRecentSelfMinosEpoch().then((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e==null)return o("WAResultOrError").makeError("unable-to-get-latest-epoch");var t=yield o("EBMinosWasmDeriveMailboxAuthKeypair").deriveMailboxAuthKeypair({epochNumber:e.epochNumber,exportRootKey:e.exportRootKey});return t.success?(l.addAnnotations({string:{epoch_fbid:e.epochFbId,epoch_head:o("Base64Utils").fromArrayBuffer(e.epochHead)}}),o("WAResultOrError").makeResult({epochFbId:e.epochFbId,epochHead:e.epochHead,mailboxAuthKeyPair:t.value})):(i.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Unable to get mailbox auth key pair for sender - failed with exception ",""])),t.error),o("WAResultOrError").makeError("unable-to-get-sender-mailbox-auth-key-pair"))});return function(t){return e.apply(this,arguments)}})()),v=b.success?{fromKeypair:b.value.mailboxAuthKeyPair,senderEpochFbId:b.value.epochFbId,senderEpochHead:b.value.epochHead,senderType:"Minos"}:{senderType:"Transport",transportSigningKp:h};i.DEV(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Sender type: ",". Epoch FBID: ",""])),v.senderType,v.senderEpochFbId),l.addPoint("get_minos_mailbox_key_end",{string:{senderType:v.senderType}}),i.DEV(m||(m=babelHelpers.taggedTemplateLiteralLoose(["start encrypy mek. senderType: ",""])),v.senderType),l.addPoint("encrypt_mek_envelopes_start");var S=C.value,R=yield v.senderType==="Minos"?L({fromKeypair:v.fromKeypair,logger:i,mek:S,participantMailboxes:g,senderEpochFbId:v.senderEpochFbId,senderEpochHead:v.senderEpochHead}):k({logger:i,mek:S,participantMailboxes:g,transportSigningKp:v.transportSigningKp});if(!R.success)return l.addPoint("encrypt_mek_envelopes_fail"),o("WAResultOrError").makeError("encrypt-mek-error");l.addPoint("encrypt_mek_envelopes_end");var E=R.value,I=E.mekEncryptionVersion,T=E.mekEnvelopes,D=babelHelpers.objectWithoutPropertiesLoose(E,e);l.addAnnotations({int:{mek_encryption_version:I}}),l.addPoint("register_mek_gql_start");var x=yield a.registerMinosMessageEncryptionKey({actThreadId:r,instanceKey:l.getInstanceKey(),mekEncryptionVersion:I,mekEnvelopes:T,mekId:S.mekId,mekRosterHash:S.rosterHash,sender:D}).catch(function(e){var t=o("WAErrorMessage").maybeGetMessageFromError(e);return i.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["upload mek runtime-error: ",". ",""])),t,e),o("WAResultOrError").makeError({errorName:"runtime-error",failReason:t})});if(x.success!==!0){var $=x.error,P=$.errorName,N=$.failReason;return i.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["upload mek error: ",". Reason: ",""])),P,N),l.addPoint("register_mek_gql_fail"),o("WAResultOrError").makeError("distribute-mek-error")}return l.addPoint("register_mek_gql_end"),i.DEV(f||(f=babelHelpers.taggedTemplateLiteralLoose(["register minos message encryption key success"]))),o("WAResultOrError").makeResult({mek:S,mekFbid:x.value.mekFbid})}),R.apply(this,arguments)}function L(e){return E.apply(this,arguments)}function E(){return E=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.fromKeypair,r=e.logger,a=e.mek,i=e.participantMailboxes,l=e.senderEpochFbId,s=e.senderEpochHead,u=o("EBMinosEncryptedMekVersion").INITIAL_VERSION,c=yield o("WAPromiseMap").promiseMap(i,(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.epochHead,i=e.mailboxKey,l=e.mailboxKeyFbid,c=e.participantId,d=yield o("EBMinosWasmEncryptMekForDistribution").encryptMekForDistribution({fromKeypair:t,mek:a,senderEpochHead:s,toEpochHead:n,toMailboxPk:i});if(!d.success)return r.ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["mek encryption error: ",""])),d.error),null;var m=d.value.mekEncryptionVersion;if(m!=null)u=m;else return r.ERROR(h||(h=babelHelpers.taggedTemplateLiteralLoose(["invalid encryptedMekVersion: ",""])),d.value.mekEncryptionVersion),null;return{encryptedMek:d.value.encryptedMek,mailboxKey:i,mailboxKeyFbid:l,participantId:c}});return function(t){return e.apply(this,arguments)}})()),d=c.filter(Boolean);return d.length===0?(r.ERROR(y||(y=babelHelpers.taggedTemplateLiteralLoose(["no successful mek encryption results"]))),o("WAResultOrError").makeError("encrypt-mek-error")):o("WAResultOrError").makeResult({epochFbId:l,mekEncryptionVersion:u,mekEnvelopes:d,senderType:"Minos"})}),E.apply(this,arguments)}function k(e){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.logger,n=e.mek,r=e.participantMailboxes,a=e.transportSigningKp,i=yield o("EBMinosWasmEncryptMeksForDistributionFromTransportSender").encryptMeksForDistributionFromTransportSender({mek:n,recipientEpochHeads:r.map(function(e){var t=e.epochHead;return t}),recipientMailboxEncryptionPks:r.map(function(e){var t=e.mailboxKey;return t}),transportSigningKp:a});if(!i.success)return t.ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["mek encryption error: ",""])),i.error),o("WAResultOrError").makeError("encrypt-mek-error");if(i.value.encryptedMeks.length!==r.length)return t.ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["number of encrypted meks does not match number of participants"]))),o("WAResultOrError").makeError("encrypt-mek-error");var l=o("EBMinosEncryptedMekVersion").INITIAL_VERSION,s=r.map(function(e,n){var r=i.value.encryptedMekVersion;if(r!=null)l=r;else return t.ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["invalid encryptedMekVersion: ",""])),i.value.encryptedMekVersion),null;return{encryptedMek:i.value.encryptedMeks[n],mailboxKey:e.mailboxKey,mailboxKeyFbid:e.mailboxKeyFbid,participantId:e.participantId}}),u=s.filter(Boolean);return o("WAResultOrError").makeResult({ephemeralEncryptionPk:i.value.ephemeralEncryptionPk,mekEncryptionVersion:l,mekEnvelopes:u,senderType:"Transport",signature:i.value.signature,signingPk:i.value.signingPk})}),I.apply(this,arguments)}l.generateAndUploadMek=S}),98);
__d("EBGenerateMessageTags",["EncryptedBackupsUploadEntity","MSGDataclassTypes.flow"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE:return o("MSGDataclassTypes.flow").MpsMessageTag.Photo;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO:return o("MSGDataclassTypes.flow").MpsMessageTag.Video;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:return o("MSGDataclassTypes.flow").MpsMessageTag.Gif;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT:return o("MSGDataclassTypes.flow").MpsMessageTag.Audio;case o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT:return o("MSGDataclassTypes.flow").MpsMessageTag.File;default:return null}}l.generateEBMessageTags=e}),98);
__d("EBGetClientState",["EBLogger","I64","LSAuthorityLevel","LSIntEnum","ReQL","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var a=n!=null?yield o("ReQL").firstAsync(o("ReQL").fromTableAscending(n.secure_encrypted_backups_client_state)):yield o("ReQL").firstAsync(o("ReQL").fromTableAscending(t.tables.secure_encrypted_backups_client_state)),i=n!=null?yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(n.secure_encrypted_backups_epochs)):yield o("ReQL").toArrayAsync(o("ReQL").fromTableAscending(t.tables.secure_encrypted_backups_epochs)),l=i.filter(function(e){return(s||(s=o("I64"))).equal(e.authorityLevel,(u||(u=o("LSIntEnum"))).ofNumber(r("LSAuthorityLevel").AUTHORITATIVE))}).map(function(e){return(s||(s=o("I64"))).to_string(e.epochId)});if(a==null){o("EBLogger").EBLogger("wmi").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth][web Client state is null - unable to proceed with GQL restore"])));return}var c=a.deviceId,d=a.mailboxRootKeyBlob,m=a.ocmfClientStateBlob,p=a.backupId;return{backupId:p,device_id:c,locally_available_epochs:l,mailboxRootKey:d,ocmfClientStateBlob:m}}),d.apply(this,arguments)}l.getClientState=c}),98);
__d("EBGetMinosAttachmentPayloadFromMpsMessage",["EBMinosTypes","EBMinosWasmDeriveAttachmentAccessTokenSecret","EBMinosWasmDeriveAttachmentPrimaryKeySecret","MpsMessageToBridgeWrapper","Promise","WAMediaUtils","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p;function _(e){var t,r,a=e.logger,i=e.message,l=e.qplFlow,s=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(i),u=s.deserialize(),c=(t=u.encryptedTransportMessage())==null?void 0:t.consumerMessage();if(c!=null)return f({consumerApplication:c,logger:a,qplFlow:l});var d=(r=u.encryptedTransportMessage())==null||(r=r.armadillo())==null?void 0:r.extendedContentMessage();return d!=null?h({extendedContentMessage:d,logger:a,qplFlow:l}):(p||(p=n("Promise"))).resolve([])}function f(e){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n,r,a,i,l,s=e.consumerApplication,u=e.logger,c=e.qplFlow,d=s.attachmentMessage();if(d==null||((t=d.payload.integral)==null?void 0:t.receiverFetchId)!=null)return[];var m=d.kind,p=d.payload.integral,_=(n=p==null||(r=p.transport)==null?void 0:r.integral)!=null?n:{},f=_.mediaKey,g=(a=p==null||(i=p.transport)==null?void 0:i.ancillary)!=null?a:{},h=g.objectId,y=yield C({logger:u,maybeMediaKey:f,maybeObjectId:h}),b=p==null||(l=p.transport)==null||(l=l.ancillary)==null||(l=l.thumbnail)==null?void 0:l.downloadableThumbnail,S=b==null?null:yield C({logger:u,maybeMediaKey:b.mediaKey,maybeObjectId:b.objectId}),R=c.getInstanceKey().toString();return[y.success===!0?babelHelpers.extends({},y.value,{attachmentTraceId:R,mediaType:v(m)}):null,(S==null?void 0:S.success)===!0?babelHelpers.extends({},S.value,{attachmentTraceId:R,mediaType:o("EBMinosTypes").MinosAttachmentMediaType.MESSENGER_PREVIEW}):null].filter(Boolean)}),g.apply(this,arguments)}function h(e){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var r=t.extendedContentMessage,a=t.logger,i=t.qplFlow,l=[r.favicon(),r.headerImage()].concat(r.previews()).filter(Boolean);if(l.length===0)return[];var u=yield(p||(p=n("Promise"))).all(l.map(function(e){var t,n;return C({logger:a,maybeMediaKey:(t=e.integral)==null||(t=t.transport)==null||(t=t.integral)==null?void 0:t.mediaKey,maybeObjectId:(n=e.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.objectId})})),c=u.filter(function(e){return e.success===!0}),d=u.filter(function(e){return e.success===!1});return d.forEach(function(t){a.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to parse an attachment in XMA message: ",""])),t.error)}),c.length===0&&a.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to parse all attachments in XMA message"]))),c.map(function(e){return babelHelpers.extends({},e.value,{attachmentTraceId:i.getInstanceKey().toString(),mediaType:o("EBMinosTypes").MinosAttachmentMediaType.XMA})})}),y.apply(this,arguments)}function C(e){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.logger,n=e.maybeMediaKey,r=e.maybeObjectId;if(n==null)return t.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Missing mediaKey in media message protobuf"]))),o("WAResultOrError").makeError("missing-media-key");if(r==null)return t.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Missing objectId in media message protobuf"]))),o("WAResultOrError").makeError("missing-object-id");var a=o("WAMediaUtils").castToMediaKey(n),i=yield o("EBMinosWasmDeriveAttachmentPrimaryKeySecret").deriveAttachmentPrimaryKeySecret({mediaKey:a});if(!i.success)return t.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to derive attachment primary key secret"]))),o("WAResultOrError").makeError("derive-primary-key-secret-error");var l=yield o("EBMinosWasmDeriveAttachmentAccessTokenSecret").deriveAttachmentAccessTokenSecret({mediaKey:a});return l.success?o("WAResultOrError").makeResult({accessTokenSecret:l.value,primaryKeySecret:i.value,zippyObjectId:o("WAMediaUtils").stringToDeliveryObjectId(r)}):(t.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Failed to derive attachment access token secret"]))),o("WAResultOrError").makeError("derive-access-token-secret-error"))}),b.apply(this,arguments)}function v(e){return e==="audioTransport"?o("EBMinosTypes").MinosAttachmentMediaType.PTT:e==="imageTransport"?o("EBMinosTypes").MinosAttachmentMediaType.IMAGE:e==="videoTransport"?o("EBMinosTypes").MinosAttachmentMediaType.VIDEO:e==="stickerTransport"?o("EBMinosTypes").MinosAttachmentMediaType.STICKER:e==="documentTransport"?o("EBMinosTypes").MinosAttachmentMediaType.DOCUMENT:(function(){throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+e)})()}l.getMinosAttachmentPayloadFromMpsMessage=_}),98);
__d("EBGraphQLRestoreDefinition",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.toMpsMessageQueryForGraphQLQuery=e}),66);
__d("EBMessageEncryptionKeyStorage",["WABase64","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){return o("WABase64").encodeB64(e)+"|"+o("WABase64").encodeB64(t)}function u(t){var r=t.io,o=t.logger,a=new Map,i=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.minosThreadId,i=t.rosterHash,l=s(i,n),u=a.get(l);if(u!=null)return{cacheStatus:"cached-by-memory",registeredMek:u};var c=yield r.loadMessageEncryptionKey(n,i).catch(function(t){return o.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["loadMessageEncryptionKey runtime-error: ",""])),t),null});return c!=null?(a.set(l,c),{cacheStatus:"cached-by-db",registeredMek:c}):null});return function(n){return t.apply(this,arguments)}})(),l=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.minosThreadId,n=e.registeredMek,o=e.rosterHash,i=s(o,t);a.set(i,n),yield r.saveNewMessageEncryptionKey(t,n.mek,n.mekFbid)});return function(n){return e.apply(this,arguments)}})();return{getMessageEncryptionKey:i,setNewMessageEncryptionKey:l}}l.createMessageEncryptionKeyStorage=u}),98);
__d("EBMessageEncryptionKeyStorageDecrypt",["asyncToGeneratorRuntime"],(function(t,n,r,o,a,i){"use strict";var e;function l(t){var r=t.io,o=t.logger,a=new Map,i=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.mekId,i=a.get(n);if(i!=null)return{cacheStatus:"cached-by-memory",registeredMek:i};var l=yield r.loadMessageEncryptionKeyForDecryption(n).catch(function(t){return o.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["loadMessageEncryptionKeyForDecryption runtime-error: ",""])),t),null});return l!=null?(a.set(n,l),{cacheStatus:"cached-by-db",registeredMek:l}):null});return function(n){return t.apply(this,arguments)}})(),l=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.minosThreadId,n=e.registeredMek,o=n.mek.mekId;a.set(o,n),yield r.saveNewMessageEncryptionKey(t,n.mek,n.mekFbid)});return function(n){return e.apply(this,arguments)}})();return{getMessageEncryptionKeyDecrypt:i,setNewMessageEncryptionKeyDecrypt:l}}i.createMessageEncryptionKeyStorageDecrypt=l}),66);
__d("EBMessagePointQuery_facebookRelayOperation",[],(function(t,n,r,o,a,i){a.exports="32643898351892811"}),null);
__d("EBMessagePointQuery.graphql",["EBMessagePointQuery_facebookRelayOperation"],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e={defaultValue:null,kind:"LocalArgument",name:"app_id"},t={defaultValue:!1,kind:"LocalArgument",name:"minos_gk_enabled"},r={defaultValue:null,kind:"LocalArgument",name:"restore_payload_string"},o={defaultValue:null,kind:"LocalArgument",name:"restore_type"},a=[{kind:"Variable",name:"app_id",variableName:"app_id"},{kind:"Variable",name:"restore_payload_string",variableName:"restore_payload_string"},{kind:"Variable",name:"restore_type",variableName:"restore_type"}],i={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},l={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},s={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},u={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},c={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},d={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},m={alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null},p={alias:null,args:null,kind:"ScalarField",name:"supplemental_otid",storageKey:null},_={alias:null,args:null,kind:"ScalarField",name:"actor_token",storageKey:null},f={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"mek_fbid",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"mek_id",storageKey:null},y={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp",storageKey:null},C={alias:null,args:null,kind:"ScalarField",name:"transport_sender_signing_pk",storageKey:null},b={alias:null,args:null,kind:"ScalarField",name:"transport_sender_message_signature",storageKey:null},v={alias:null,args:null,kind:"ScalarField",name:"franking_tag",storageKey:null},S={alias:null,args:null,kind:"ScalarField",name:"reporting_tag",storageKey:null},R={alias:null,args:null,kind:"ScalarField",name:"message_encryption_version",storageKey:null},L={alias:null,args:null,kind:"ScalarField",name:"message_metadata_version",storageKey:null},E=[l,s],k={alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null};return{fragment:{argumentDefinitions:[e,t,r,o],kind:"Fragment",metadata:null,name:"EBMessagePointQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:a,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{args:[{kind:"Variable",name:"minos_gk_enabled",variableName:"minos_gk_enabled"}],kind:"FragmentSpread",name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages"}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],type:"Query",abstractKey:null},kind:"Request",operation:{argumentDefinitions:[r,o,e,t],kind:"Operation",name:"EBMessagePointQuery",selections:[{alias:null,args:null,concreteType:"Viewer",kind:"LinkedField",name:"viewer",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackup",kind:"LinkedField",name:"encrypted_backup",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMailbox",kind:"LinkedField",name:"mailbox",plural:!1,selections:[{alias:null,args:a,concreteType:"XFBEncryptedBackupMessages",kind:"LinkedField",name:"messages_point_restore",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},i,l,s,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"message_tags",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[u,i,l,s,c,d],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[u,i,l,s,c,d,m,p],storageKey:null},{alias:null,args:null,concreteType:"XFBUnencryptedProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_unencrypted",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"unencrypted_protobuf",storageKey:null},c],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_v2",plural:!1,selections:[_,f,g,h,y,C,b,v,S,R,L],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs_v2",plural:!0,selections:[_,f,y,g,h,m,p,C,b,v,S,R,L],storageKey:null}]}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:E,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:E,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosDecryptionKeyMap",kind:"LinkedField",name:"minos_decryption_keys",plural:!0,selections:[k,{alias:null,args:null,concreteType:"XFBMinosDecryptionKeys",kind:"LinkedField",name:"keys",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosMekInfo",kind:"LinkedField",name:"mek_info",plural:!1,selections:[h,{alias:null,args:null,kind:"ScalarField",name:"roster_hash",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_mek",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creation_timestamp",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_encryption_version",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosRecipientInfo",kind:"LinkedField",name:"recipient_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"epoch_fbid",storageKey:null},l,{alias:null,args:null,kind:"ScalarField",name:"epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMekCreatorInfo",kind:"LinkedField",name:"mek_creator_info",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosEncryptionKeys",kind:"LinkedField",name:"minos_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"sender_auth_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"sender_epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosTransportKeys",kind:"LinkedField",name:"transport_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"ephm_hpke_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"ephm_signature",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creator_transport_signing_pk",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}]}],storageKey:null}],storageKey:null},k],storageKey:null}],storageKey:null}]},params:{id:n("EBMessagePointQuery_facebookRelayOperation"),metadata:{},name:"EBMessagePointQuery",operationKind:"query",text:null}}})();a.exports=e}),null);
__d("EBgenerateMPSMessageQuery",["EBGraphQLRestoreDefinition"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return{__typename:"MPSMessageQuery",ctx:{__typename:"MPSQueryContext",caller:"HISTORY_RESTORE"},query:{__typename:"MPSMessagePointQuery",include_deleted:!1,otids:t,thread_id:e}}}function s(t,n){return o("EBGraphQLRestoreDefinition").toMpsMessageQueryForGraphQLQuery(JSON.stringify(e(t,n)))}l.generateMPSMessageQuery=e,l.generateMPSMessageQueryForGraphQLQuery=s}),98);
__d("XFBLSRestoreOperationType.facebook",["$InternalEnum"],(function(t,n,r,o,a,i){var e=n("$InternalEnum").Mirrored(["DELTA_GENERIC_MESSAGE_SYNC","INITIAL_RESTORE","MESSAGE_QUERY_RESTORE","POINT_QUERY_RESTORE","RANGE_QUERY_RESTORE","SNAPSHOT_RESTORE","SURROUNDING_RESTORE","THREAD_POINT_QUERY_RESTORE","UNKNOWN"]),l=e;i.default=l}),66);
__d("handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages.graphql",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){var e={alias:null,args:null,kind:"ScalarField",name:"encryption_version",storageKey:null},t={alias:null,args:null,kind:"ScalarField",name:"epoch_anon_id",storageKey:null},n={alias:null,args:null,kind:"ScalarField",name:"epoch_id",storageKey:null},r={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf_stanza",storageKey:null},o={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp_ms",storageKey:null},a={alias:null,args:null,kind:"ScalarField",name:"sk_ciphertext",storageKey:null},i={alias:null,args:null,kind:"ScalarField",name:"supplemental_key",storageKey:null},l={alias:null,args:null,kind:"ScalarField",name:"supplemental_otid",storageKey:null},s={alias:null,args:null,kind:"ScalarField",name:"actor_token",storageKey:null},u={alias:null,args:null,kind:"ScalarField",name:"encrypted_protobuf",storageKey:null},c={alias:null,args:null,kind:"ScalarField",name:"mek_fbid",storageKey:null},d={alias:null,args:null,kind:"ScalarField",name:"mek_id",storageKey:null},m={alias:null,args:null,kind:"ScalarField",name:"protobuf_timestamp",storageKey:null},p={alias:null,args:null,kind:"ScalarField",name:"transport_sender_signing_pk",storageKey:null},_={alias:null,args:null,kind:"ScalarField",name:"transport_sender_message_signature",storageKey:null},f={alias:null,args:null,kind:"ScalarField",name:"franking_tag",storageKey:null},g={alias:null,args:null,kind:"ScalarField",name:"reporting_tag",storageKey:null},h={alias:null,args:null,kind:"ScalarField",name:"message_encryption_version",storageKey:null},y={alias:null,args:null,kind:"ScalarField",name:"message_metadata_version",storageKey:null},C=[t,n];return{argumentDefinitions:[{defaultValue:!1,kind:"LocalArgument",name:"minos_gk_enabled"}],kind:"Fragment",metadata:null,name:"handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages",selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupMessage",kind:"LinkedField",name:"encrypted_messages",plural:!0,selections:[{alias:null,args:null,concreteType:"XFBEchoDocument",kind:"LinkedField",name:"echo_document",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"echo_document_string",storageKey:null},e,t,n,{alias:null,args:null,kind:"ScalarField",name:"epoch_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"otid",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanzas",kind:"LinkedField",name:"protobuf_stanzas",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"message_tags",storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"top_level_protobuf",plural:!1,selections:[r,e,t,n,o,a],storageKey:null},{alias:null,args:null,concreteType:"XFBProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs",plural:!0,selections:[r,e,t,n,o,a,i,l],storageKey:null},{alias:null,args:null,concreteType:"XFBUnencryptedProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_unencrypted",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"unencrypted_protobuf",storageKey:null},o],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"top_level_protobuf_v2",plural:!1,selections:[s,u,c,d,m,p,_,f,g,h,y],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosProtobufStanza",kind:"LinkedField",name:"supplemental_protobufs_v2",plural:!0,selections:[s,u,m,c,d,i,l,p,_,f,g,h,y],storageKey:null}]}],storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"backup_id",storageKey:null},{alias:null,args:null,concreteType:"XFBMessageRangeInfo",kind:"LinkedField",name:"message_range_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"has_more_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"has_more_after",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_before",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"next_message_timestamp_ms_after",storageKey:null}],storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"should_delete_mailbox",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"exception_string",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"thread_not_found",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochDerivationSet",kind:"LinkedField",name:"epoch_derivation_set",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBEncryptedBackupsEpochEdge",kind:"LinkedField",name:"epoch_edges",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"backward_edge",storageKey:null},{alias:null,args:null,concreteType:"XFBEpochForwardEdge",kind:"LinkedField",name:"forward_edge",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"auth_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_entropy",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"entropy_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"epoch_storage_public_key",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"psk_fingerprint",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"from_epoch",plural:!1,selections:C,storageKey:null},{alias:null,args:null,concreteType:"XFBEpochIds",kind:"LinkedField",name:"to_epoch",plural:!1,selections:C,storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"from_epoch_fingerprint",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"to_epoch_fingerprint",storageKey:null}],storageKey:null}],storageKey:null},{condition:"minos_gk_enabled",kind:"Condition",passingValue:!0,selections:[{alias:null,args:null,concreteType:"XFBMinosDecryptionKeyMap",kind:"LinkedField",name:"minos_decryption_keys",plural:!0,selections:[{alias:null,args:null,kind:"ScalarField",name:"id",storageKey:null},{alias:null,args:null,concreteType:"XFBMinosDecryptionKeys",kind:"LinkedField",name:"keys",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosMekInfo",kind:"LinkedField",name:"mek_info",plural:!1,selections:[d,{alias:null,args:null,kind:"ScalarField",name:"roster_hash",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"encrypted_mek",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creation_timestamp",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_encryption_version",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosRecipientInfo",kind:"LinkedField",name:"recipient_info",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"epoch_fbid",storageKey:null},t,{alias:null,args:null,kind:"ScalarField",name:"epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMekCreatorInfo",kind:"LinkedField",name:"mek_creator_info",plural:!1,selections:[{alias:null,args:null,concreteType:"XFBMinosEncryptionKeys",kind:"LinkedField",name:"minos_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"sender_auth_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"sender_epoch_head",storageKey:null}],storageKey:null},{alias:null,args:null,concreteType:"XFBMinosTransportKeys",kind:"LinkedField",name:"transport_keys",plural:!1,selections:[{alias:null,args:null,kind:"ScalarField",name:"ephm_hpke_pk",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"ephm_signature",storageKey:null},{alias:null,args:null,kind:"ScalarField",name:"mek_creator_transport_signing_pk",storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}],storageKey:null}]}],type:"XFBEncryptedBackupMessages",abstractKey:null}})();a.exports=e}),null);
__d("handleRestoreMessagesGraphQLResponse",["EBMinosInterfaceTypes","I64","MEBEncryptionVersion","QPLUserFlow","WALogger","handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages.graphql"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d;function m(e){if(e==null)return r("MEBEncryptionVersion").UNKNOWN;switch(e){case"ENCRYPTION_KDF_WITH_NULL_SALT":return r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT;case"ENCRYPTION_KDF_WITH_VERSION":return r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_VERSION;case"ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY":return r("MEBEncryptionVersion").ENCRYPTION_KDF_WITH_NULL_SALT_DF_CANARY;case"TEST_VERSION":return r("MEBEncryptionVersion").TEST_VERSION;default:return r("MEBEncryptionVersion").UNKNOWN}}function p(e,t,n,a){var i,l=((i=e==null?void 0:e.map(function(e){var n,r,a,i,l,c,p,f,g;if(e==null)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message is null in the GraphQL range restore response"]))),null;var h=e.otid;if(h==null)return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] otid is null for a message in the GraphQL range restore response"]))),null;var y=(n=e.echo_document)==null?void 0:n.echo_document_string,C=(r=e.echo_document)==null?void 0:r.epoch_anon_id,b=(a=e.echo_document)==null?void 0:a.epoch_fingerprint,v=e.protobuf_stanzas,S=v==null||(i=v.top_level_protobuf)==null?void 0:i.encrypted_protobuf_stanza,R=v==null||(l=v.top_level_protobuf)==null?void 0:l.epoch_anon_id,L=v==null||(c=v.top_level_protobuf)==null?void 0:c.epoch_id,E=v==null||(p=v.top_level_protobuf)==null?void 0:p.protobuf_timestamp_ms,k=v==null?void 0:v.supplemental_protobufs,I=v==null?void 0:v.message_tags,T=(f=e.protobuf_stanzas)==null?void 0:f.top_level_protobuf_v2,D=(g=e.protobuf_stanzas)==null?void 0:g.top_level_protobuf_unencrypted;if(D!=null&&D.unencrypted_protobuf!=null&&D.protobuf_timestamp_ms!=null){var x=D.unencrypted_protobuf,$=D.protobuf_timestamp_ms;return{message:{isUnencrypted:!0,messageTags:[],otid:h,supplementalProtobufs:[],topLevelProtobuf:{backup_id:t,encryptedProtobufContent:x,encryption_version:void 0,epoch_anon_id:new ArrayBuffer(0),epoch_id:void 0,otid:h,protobufTimestampMs:$,value:void 0}},type:"protobuf"}}if(S==null||R==null||L==null||E==null){var P,N;if(y==null||C==null||y.length===0)return T==null&&_(S,R,L,E),null;var M=m((P=e.echo_document)==null?void 0:P.encryption_version);return{message:{backup_id:t,encryption_version:M,epoch_anon_id:new TextEncoder().encode(C).buffer,epoch_fingerprint:b!=null?new TextEncoder().encode(b).buffer:void 0,epoch_id:((N=e.echo_document)==null?void 0:N.epoch_id)!=null?(d||(d=o("I64"))).of_string(e.echo_document.epoch_id):void 0,otid:h,value:y},type:"echo"}}if(v!=null){var w,A=m(v==null||(w=v.top_level_protobuf)==null?void 0:w.encryption_version),F={messageTags:o("EBMinosInterfaceTypes").convertArrayToMpsMessageTags(I),otid:h,supplementalProtobufs:[],topLevelProtobuf:{backup_id:t,encryptedProtobufContent:S,encryption_version:A,epoch_anon_id:new TextEncoder().encode(R).buffer,epoch_id:(d||(d=o("I64"))).of_string(L),otid:h,protobufTimestampMs:E,value:void 0}};return k==null||k.forEach(function(e){var n=e==null?void 0:e.supplemental_key,r=e==null?void 0:e.encrypted_protobuf_stanza,a=e.epoch_anon_id,i=e==null?void 0:e.epoch_id,l=e==null?void 0:e.protobuf_timestamp_ms;if(!(r==null||a==null||i==null||l==null||n==null)){var s=m(e==null?void 0:e.encryption_version);F.supplementalProtobufs.push({backup_id:t,encryptedProtobufContent:r,encryption_version:s,epoch_anon_id:new TextEncoder().encode(a).buffer,epoch_id:(d||(d=o("I64"))).of_string(i),protobufTimestampMs:l,skCipherText:e==null?void 0:e.sk_ciphertext,supplementalKey:n,value:void 0})}}),{message:F,type:"protobuf"}}return null}))!=null?i:[]).filter(Boolean),c=l.filter(function(e){return e.type==="echo"}).map(function(e){return e.message}),p=l.filter(function(e){return e.type==="protobuf"}).map(function(e){return e.message});return a!=null&&n!=null&&r("QPLUserFlow").addPoint(n,"processing_encrypted_messages_complete",{instanceKey:a}),{encryptedNonLSEchoMessages:c,encryptedNonLSProtobufs:p}}function _(e,t,n,r){o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] message with no echo document and no protobuf data, more details: encrypted_protobuf_content: ",", protobuf_epoch_anon_id: ",", protobuf_epoch_id: ",", protobuf_timestamp_ms: ",""])),e==null?"null/empty":"not empty",t==null?"null/empty":"not empty",n==null?"null/empty":"not empty",r==null?"null/empty":"not empty")}e!==void 0||(e=n("handleRestoreMessagesGraphQLResponse_XFBEncryptedBackupMessages.graphql")),l.processMessageArray=p}),98);
__d("EBMessagePointQuery",["Base64Utils","EBAPIConvertNativeToLS","EBAPIDecryptionModule","EBAPIQPLPoints","EBAPISharedTypes","EBAPIWorkerCheck","EBDedupeLabyrinthMessages","EBDeriveAndStoreEpochs","EBGetClientState","EBLS","EBMessagePointQuery.graphql","EBMinosCheckWasmFeatureSupport","EBgenerateMPSMessageQuery","FBLogger","I64","LSVec","MAWCurrentUser","MAWEncryptedBackupUtils","MAWHandleEBRestoreWithHIM","MAWJobDefinitions","MpsTypes","QPLFlow","WAJids","WAResultOrError","WorkerRelay","WorkerRelayNetwork","asyncToGeneratorRuntime","cr:4467","cr:5247","cr:5284","getErrorSafe","gkx","handleRestoreMessagesGraphQLResponse","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=e!==void 0?e:e=n("EBMessagePointQuery.graphql");function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.chatJid,a=e.messageIds,i=e.source,l=yield o("EBMinosCheckWasmFeatureSupport").checkWasFeatureSupportAndQE(),c=o("QPLFlow").startQPLFlow(r("qpl")._(521474469,"2612"),{annotations:{bool:{is_wasm_serializer_on:r("gkx")("18428"),minos_mvp_enabled:l,occam_only_mailbox_users:r("gkx")("16674")},string:{source:i!=null?i:"unknown"}}});try{var d,m,p,_;if(!o("EBAPIWorkerCheck").runningInWorker())return c.endFail(o("EBAPIQPLPoints").EBAPIQPLCommonErrorPoints.UNSUPPORTED_CONTEXT),o("WAResultOrError").makeError("unsupported-context");var f=(yield o("EBLS").init()).db;c.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.LSDB_SINGLETON_RETRIEVED);var g=yield o("EBGetClientState").getClientState(f);if(c.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CLIENT_STATE_RETRIEVED,{string:{device_id:(s||(s=o("I64"))).to_string((d=g==null?void 0:g.device_id)!=null?d:(s||(s=o("I64"))).zero)}}),g==null)return c.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.NO_CLIENT_STATE}}),o("WAResultOrError").makeError("no-client-state");var h=o("WAJids").threadIdForChatJid(t),y=g.backupId,C=g.device_id,b=g.locally_available_epochs,v=g.mailboxRootKey,S=g.ocmfClientStateBlob;if(y==null||C==null||v==null||S==null)return c.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_CLIENT_STATE}}),o("WAResultOrError").makeError("invalid-client-state");var R=""+((m=o("MAWCurrentUser").getAppID())!=null?m:0),L={restore_context:{act_thread_id:h,site:"www",tam_thread_subtype:0},success:{device_context:{device_id:s.to_string(C),locally_available_epochs:b,raw_tokens:{mailbox_root_key:o("Base64Utils").fromArrayBuffer(v),ocmf_client_state_blob:o("Base64Utils").fromArrayBuffer(S)}},mps_message_query:o("EBgenerateMPSMessageQuery").generateMPSMessageQueryForGraphQLQuery(h,[].concat(a))}},E={app_id:R,minos_gk_enabled:l,restore_payload_string:JSON.stringify(L),restore_type:"MESSAGE_QUERY_RESTORE"};c.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CREATE_WORKER_NETWORK_EXECUTE_START),yield o("WorkerRelayNetwork").createWorkerNetworkExecute(),c.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.CREATE_WORKER_NETWORK_EXECUTE_END),c.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_START);var k=yield o("WorkerRelay").createWorkerQuery(u,E);c.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.GRAPHQL_QUERY_END);var I=k==null||(p=k.viewer)==null||(p=p.encrypted_backup)==null||(p=p.mailbox)==null?void 0:p.messages_point_restore;if(I==null)return c.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}}),o("WAResultOrError").makeError("invalid-graphql-response");var T=I;if((T==null?void 0:T.encrypted_messages)==null)return c.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.INVALID_GRAPHQL_RESPONSE}}),o("WAResultOrError").makeError("invalid-graphql-response");var D=T.backup_id,x=T.encrypted_messages,$=T.epoch_derivation_set,P=T.exception_string,N=T.minos_decryption_keys;if(P!=null)return c.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,{string:{error_description:o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.SERVER_SIDE_EXCEPTION,exception:P}}),o("WAResultOrError").makeError("server-side-exception");D==null&&c.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.BACKUP_ID_NULL),c.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_START);var M=$;c.addAnnotations({bool:{hasEpochs:M!=null&&M.epoch_edges.length>0}}),yield o("EBDeriveAndStoreEpochs").deriveAndStoreEpochsNonLS(f,M),c.addPoint(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.DERIVE_AND_STORE_EPOCHS_END),c.addPoint("decryption_start");var w=x,A=n("cr:5284")!=null&&l?n("cr:5284").processMinosMessages(w):[];c.addAnnotations({int:{encrypted_messages:w.length,encrypted_minos_messages:A.length}});var F=n("cr:5247")!=null&&l&&n("cr:5284")!=null?yield n("cr:5247").minosDecryptAndValidateMessages({encryptedMinosMessages:A,entryPoint:"point_query",minosDecryptionKeys:N,qplFlow:c,source:i!=null?i:"unknown",threadId:o("MpsTypes").toThreadId(t)}):o("WAResultOrError").makeResult({decryptionResult:new Map,errorMessages:[]}),O=F.success===!0&&F.value.decryptionResult.size>0?F.value.decryptionResult:null,B=F.success===!0?F.value.errorMessages:[(_=F.error)!=null?_:"unknown-error"];c.addAnnotations({bool:{minos_decrypt_success:B.length===0},string_array:{minos_decrypt_errors:B}});var W=n("cr:4467")!=null&&O!=null&&l?n("cr:4467").dedupeEncryptedLabyrinthMessages(w,O,c):w,q=o("handleRestoreMessagesGraphQLResponse").processMessageArray(W,D!=null?D:(s||(s=o("I64"))).to_string(y)),U=q.encryptedNonLSEchoMessages,V=q.encryptedNonLSProtobufs,H=yield o("EBAPIDecryptionModule").decryptUsingNativeJS(f,h,V,U,i,"point_query");if(!H.success){var G,z=H.error,j=z.message,K=o("EBAPISharedTypes").EBAPIRestoreErrorValues.find(function(e){return e===j});return c.endFail("decrypt_labyrinth10_messages_failure",{string:{error_description:z.message,errorStackTrace:(G=z.stack)!=null?G:""}}),K!=null?o("WAResultOrError").makeError(K):o("WAResultOrError").makeError("native-decryption-error")}c.addAnnotations({bool:{labyrinth_10_toplevel_decrypt_success:H.value.decryptedEchoMessages.length===U.length&&H.value.decryptedProtobufs.length===V.length}});var Q=H.value.decryptedEchoMessages,X=H.value.decryptedProtobufs,Y=l?o("EBDedupeLabyrinthMessages").dedupeLabyrinthMessages(X,O):X;c.addAnnotations({int:{decrypted_echo_count:Q.length,decrypted_protobuf_count:Y.length}});var J=o("EBAPIConvertNativeToLS").convertNativeDecryptionResponseToDecryptedMessageType(Q,Y),Z=r("LSVec").toArray(J.echo),ee=J.protobuf,te=Z.map(function(e){return o("MAWJobDefinitions").toEncodedEchoMessage(e)}),ne=[];if(r("gkx")("7840")){var re=o("MAWHandleEBRestoreWithHIM").convertEchoMessagesToEBProtobufs(te,t).concat(o("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(ee));ne=Array.from(new Map(re.map(function(e){return[e.otid,e]})).values())}else Q.length>0?ne=o("MAWHandleEBRestoreWithHIM").convertEchoMessagesToEBProtobufs(te,t):ne=o("MAWEncryptedBackupUtils").convertLSTypesToJSTypesForRestoreJob(ee);return c.addPoint("decryption_end"),c.endSuccess(),o("WAResultOrError").makeResult(ne)}catch(e){var oe,ae=r("getErrorSafe")(e);return c.endFail(o("EBAPIQPLPoints").EBMessageRestoreQueryQPLPoints.RUNTIME_ERROR,{string:{error_description:ae.message,errorStackTrace:(oe=ae.stack)!=null?oe:""}}),r("FBLogger")("wmi_eb").catching(ae).mustfix("Runtime error performing messagePointQuery: %s",ae.message),o("WAResultOrError").DEPRECATED_makeError("runtime-error")}}),d.apply(this,arguments)}l.messagePointQuery=c}),98);
__d("EBProbe",["FBLogger","MAWODSProxy","Promise","WAOdsEnums","WAShiftTimer","WATimeUtils","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=(function(){function t(e,t,n){this.$5=!1,this.$1=e,this.$2=t,this.$3=n}var a=t.prototype;return a.sample=function(t){var e=this.$1.sample(t);return e&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_MESSAGE_PROBE,key:"sampled"}),e},a.start=function(){var e=this;this.$4==null&&(this.$4=new(o("WAShiftTimer")).ShiftTimer(function(){e.$6()}),this.$4.onOrBefore(this.$3.validationIntervalMs,void 0))},a.stop=function(){this.$4!=null&&(this.$4.cancel(),this.$4=null)},a.hasStarted=function(){return this.$4!=null},a.$6=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield this.$7(),this.$4!=null&&this.$4.onOrBefore(this.$3.validationIntervalMs,void 0)});function t(){return e.apply(this,arguments)}return t})(),a.$7=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(!this.$5){this.$5=!0;try{var t=o("WATimeUtils").castToMillisTime(Date.now()-this.$3.sampleAgeThresholdMs),n=this.$2.fetchOlderThan({consume:!0,cutOffTimestamp:t});if(n.length>0)try{o("MAWODSProxy").odsBumpEntityKey({amount:n.length,entity:o("WAOdsEnums").Entity.EB_MESSAGE_PROBE,key:"validated"}),yield this.validateSamples(n)}catch(t){var a=t instanceof Error?t:r("err")(String(t));r("FBLogger")("wmi_eb").catching(a).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Exception in validateSamples()"])))}}finally{this.$5=!1}}});function a(){return t.apply(this,arguments)}return a})(),a.addMarkerToItem=function(t,n,r){return!1},a.updateSample=function(t,n){var e=this.getSamplingDB();if(e==null)return!1;var r=e.getItemByPrimaryKey(t);return r==null?!1:(n(r),!0)},a.getConfig=function(){return this.$3},a.getSamplingDB=function(){return this.$2},a.validateSamples=function(t){return(s||(s=n("Promise"))).reject(r("err")("validateSamples() must be implemented by concrete probe classes"))},t})();l.EBProbe=u}),98);
__d("EBSampler",["Random"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){function e(e,t,n,r){this.$1=e,this.$2=t,this.$3=n,this.$4=r}var t=e.prototype;return t.sample=function(t){var e,n=this.$3(t),r=((e=this.$2.get(n))!=null?e:0)*this.$1,a=o("Random").random(),i=a<r;return i&&this.$4.append(t),i},t.setSamplingMultipler=function(t,n){this.$2.set(t,n)},t.setSamplingRate=function(t){this.$1=t},e})();l.EBSampler=e}),98);
__d("EBMinosDisableLabyrinth10Uploads",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("16675")}l.disableLabyrinth10Uploads=e}),98);
__d("EncryptedBackupsUploadQueue",["EBMinosDisableLabyrinth10Uploads","EncryptedBackupsUploadEntity","MWEBODSEntityName.enum","MWEBODSUtils","PersistedQueueApi","Promise","QPLUserFlow","WAPersistedQueue","WATagsLogger","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=o("WATagsLogger").TAGS(["EbUploadQueue"]),d=null;function m(){return d==null?p():d}function p(){d!=null&&c.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EB Upload Queue is already initialized"])));var t=o("WAPersistedQueue").initPersistedQueue("ebUploadQueue",o("PersistedQueueApi").persistedQueueApi());return d=t,t}function _(e){if(e.length===0||o("EBMinosDisableLabyrinth10Uploads").disableLabyrinth10Uploads())return(u||(u=n("Promise"))).resolve();o("MWEBODSUtils").markODSForEB(r("MWEBODSEntityName.enum").MAW_EB_UPLOAD_COUNTER,"upload.api.put",e.length);var t=m();return t.addAndCommit(e.map(o("EncryptedBackupsUploadEntity").asEBUploadEntity)).then(function(){e.forEach(function(e){(e==null?void 0:e.instanceKey)!=null&&r("QPLUserFlow").endSuccess(r("qpl")._(521477113,"2698"),{instanceKey:e.instanceKey})})}).catch(function(e){return c.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to write to ebUploadQueue ",""])),e),(u||(u=n("Promise"))).reject(e)})}l.logger=c,l.ebUploadQueue=m,l.initEbUploadQueue=p,l.putMsgsToEbUpload=_}),98);
__d("InMemorySamplingDB",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){function e(e,t){this.$1=[],this.$4=new Map,this.$2=e,this.$3=t}var t=e.prototype;return t.append=function(t){var e=this.$3(t);this.$1.push([this.$2(t),t]),this.$4.set(e,t)},t.fetchOlderThan=function(t){var e=t.consume,n=e===void 0?!1:e,r=t.cutOffTimestamp,o=t.limit,a=o===void 0?50:o,i=[];if(a<=0)return i;var l=0,s=[];for(var u of this.$1){var c=u[0],d=u[1];if(c<=r&&(i.push(d),n===!0&&(l++,s.push(d))),i.length>=a)break}if(n===!0&&l>0){this.$1.splice(0,l);for(var m of s){var p=this.$3(m);this.$4.delete(p)}}return i},t.getItemByPrimaryKey=function(t){var e;return(e=this.$4.get(t))!=null?e:null},t.size=function(){return this.$1.length},t.pruneOlderThan=function(t){var e=[];this.$1=this.$1.filter(function(n){var r=n[0],o=n[1];return r<=t?(e.push(o),!1):!0});for(var n of e){var r=this.$3(n);this.$4.delete(r)}},t.purgeAll=function(){this.$1=[],this.$4.clear()},e})();i.InMemorySamplingDB=e}),66);
__d("EBMessageProbe",["EBMessagePointQuery","EBProbe","EBSampler","EncryptedBackupsUploadQueue","EncryptedBackupsUploadQueueProcessor","EncryptedBackupsUploadQueueV3Scheduler","FBLogger","InMemorySamplingDB","MAWEBLSInWorkerSwitch","MAWODSProxy","MpsTypes","Promise","QPLFlow","WAHashStringToNumber","WAOdsEnums","WAResultOrError","WATimeUtils","WebMps","asyncToGeneratorRuntime","getErrorSafe","gkx","justknobx","qpl","uuidv4"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){var n={};for(var r of e){var o=t(r);n[o]==null&&(n[o]=[]),n[o].push(r)}return n}var d={qplEvent:r("qpl")._(521475573,"3232"),sampleAgeThresholdMs:(u=r("justknobx"))._("3485"),validationIntervalMs:u._("3949")},m=u._("3573")/1e4,p=new Map([["text",u._("3952")],["image",u._("3957")],["video",u._("3969")],["audio",u._("3970")],["document",u._("3973")],["sticker",u._("3977")],["gif",u._("3981")]]),_=function(t){return t.timestampMs},f=function(t){return t.messageType},g=function(){return new(o("InMemorySamplingDB")).InMemorySamplingDB(_,function(e){return e.messageId})},h=function(t){return new(o("EBSampler")).EBSampler(m,p,f,t)},y=(function(t){function a(e,n,r){return r===void 0&&(r=d),t.call(this,e,n,r)||this}babelHelpers.inheritsLoose(a,t),a.getInstance=function(){if(!a.$EBMessageProbe$p_1){var e=g(),t=h(e);a.$EBMessageProbe$p_1=new a(t,e,d)}return a.$EBMessageProbe$p_1},a.reset=function(){a.$EBMessageProbe$p_1=null};var i=a.prototype;return i.addMarkerToItem=function(t,n,r){return this.addMarker(t,n,r)},i.addMarker=function(t,n,r){var e=this.getSamplingDB();if(e==null)return!1;var a=e.getItemByPrimaryKey(t);if(a==null)return!1;var i={event:n,metadata:r,timestampMs:o("WATimeUtils").castToMillisTime(Date.now())};return a.markers.push(i),!0},i.getMarkersForMessage=function(t){var e=this.getSamplingDB();if(e==null)return null;var n=e.getItemByPrimaryKey(t);return n==null?null:[].concat(n.markers)},i.getMessageSample=function(t){var e=this.getSamplingDB();return e==null?null:e.getItemByPrimaryKey(t)},i.$EBMessageProbe$p_2=function(t){return t.length===0?"":t.map(function(e){return e.event}).join(",")},i.$EBMessageProbe$p_3=function(t){var e={bool:{},int:{},string:{}};for(var n of t){var r=n.metadata;if(r!=null)for(var o of Object.entries(r)){var a=o[0],i=o[1];typeof i=="string"?e.string!=null&&(e.string[a]=i):typeof i=="number"?e.int!=null&&(e.int[a]=i):typeof i=="boolean"&&e.bool!=null&&(e.bool[a]=i)}}return e},i.$EBMessageProbe$p_4=function(t){if(t===0)return"0";if(t>=1e3)return"1000+";var e=Math.floor(t/50)*50,n=e+50;return e+"-"+n},i.$EBMessageProbe$p_5=function(t){if(t<0)return"never";var e=t/(1e3*60);return e<1?"<1min":e>=1&&e<5?"1-5min":e>=5&&e<10?"5-10min":e>=10&&e<20?"10-20min":e>=20&&e<60?"20-60min":">60min"},i.validateSamples=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){if(t.length!==0){var a=o("EncryptedBackupsUploadQueue").ebUploadQueue(),i=-1,l="unknown";try{i=yield a.count(),l=this.$EBMessageProbe$p_4(i),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"upload_queue_count_bucket_"+l})}catch(e){r("FBLogger")("wmi").catching(r("getErrorSafe")(e)).warn("Failed to get upload queue count for probe annotation")}var u=r("gkx")("10326"),d=u?o("EncryptedBackupsUploadQueueV3Scheduler").isUploadTaskScheduled():o("EncryptedBackupsUploadQueueProcessor").isEbUploadTaskScheduled(),m=u?o("EncryptedBackupsUploadQueueV3Scheduler").getLastSuccessfulAckTimestampMs():o("EncryptedBackupsUploadQueueProcessor").getLastSuccessfulAckTimestampMs(),p=m!=null?Date.now()-m:-1,_=this.$EBMessageProbe$p_5(p),f=new Set,g=[];for(var h of t){var y,C,b=h.chatJid+"_"+h.messageId;if(!f.has(b)){f.add(b);var v=o("WAHashStringToNumber").hashStringToNumber(r("uuidv4")()),S=Date.now()-h.timestampMs,R=S/(1e3*60),L=function(t){return t<5?"<5min":t>=5&&t<10?"5-10min":">10min"},E=void 0,k=void 0;if(h.queueId!=null){var I,T=yield a.get(h.queueId);if(E=T!=null,(T==null||(I=T.msgId)==null?void 0:I.externalId)!=null){var D;k=o("MpsTypes").toMessageId(T==null||(D=T.msgId)==null?void 0:D.externalId)===h.messageId}}var x=o("QPLFlow").startQPLFlow(this.getConfig().qplEvent,{annotations:babelHelpers.extends({},this.$EBMessageProbe$p_3(h.markers),{bool:{eb_state:r("MAWEBLSInWorkerSwitch").isEnabled(),ebUploadTaskScheduled:d,isProtobufOnlyUpload:r("gkx")("18095")||r("gkx")("10326"),queueItemExists:E,queueItemMessageIdMatches:k},int:{markerCount:h.markers.length,queueCount:i,queueId:(y=h.queueId)!=null?y:-1,sampleSize:t.length,sampleTimestampMs:h.timestampMs,validationIntervalMs:S,validationTimestampMs:Date.now()},string:{bucketizedQueueCount:l,bucketizedTimeSinceLastAck:_,chatJid:h.chatJid,insertionSource:(C=h.insertionSource)!=null?C:"unknown",markerEvents:this.$EBMessageProbe$p_2(h.markers),messageId:h.messageId,messageType:h.messageType,validationIntervalBucket:L(R),version:"v1"}}),instanceKey:v});g.push({qplFlow:x,sample:h})}}try{var $=r("justknobx")._("4947"),P=c(g,function(e){return e.sample.chatJid}),N=Object.entries(P).map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e[0],n=e[1],r=n.map(function(e){return e.sample.messageId}),a=n[0].sample.chatJid,i={chatJid:a,messageIds:r,source:"message_probe"};n.forEach(function(e){var t=e.qplFlow;t!=null&&t.addPoint("point_query_start")});var l=yield o("EBMessagePointQuery").messagePointQuery(i),s=$?yield o("WebMps").mps().batchLoadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-only"},debug:{purpose:"eb-message-probe"},messageIds:r,threadId:o("MpsTypes").toThreadId(a)}):o("WAResultOrError").makeResult([]);return n.forEach(function(e){var t=e.qplFlow;t!=null&&t.addPoint("point_query_end")}),{chatJid:a,mpsLocalResult:s,result:l,samplesWithQplFlow:n}});return function(t){return e.apply(this,arguments)}})()),M=yield(s||(s=n("Promise"))).all(N);for(var w of M){var A,F=w.mpsLocalResult,O=w.result,B=w.samplesWithQplFlow,W=new Set((A=F.value)==null?void 0:A.map(function(e){var t;return e==null||(t=e.toplevelProtobuf)==null?void 0:t.messageId}));if(O.success){var q=new Set(O.value.map(function(e){return e.otid}));for(var U of B){var V=U.qplFlow;V!=null&&(q.has(U.sample.messageId)?V.endSuccess({bool:{messageFound:!0,mpsLocalMessageFound:$?W.has(U.sample.messageId):void 0}}):V.endFail("message_not_found",{bool:{messageFound:!1,mpsLocalMessageFound:$?W.has(U.sample.messageId):void 0},string:{error:"message-not-found"}}))}}else for(var H of B){var G=H.qplFlow;if(G!=null){var z;G.endFail("query_failed",{bool:{messageFound:!1,mpsLocalMessageFound:$?W.has(H.sample.messageId):void 0},string:{error:(z=O.error)!=null?z:"unknown-query-failure"}})}}}}catch(t){var j=r("getErrorSafe")(t);r("FBLogger")("wmi").catching(j).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to validate samples"])));for(var K of g){var Q;K.qplFlow.endFail("validation_exception",{bool:{messageFound:!1},string:{error:(Q=j.message)!=null?Q:"unknown-validation-exception"}})}}}});function a(e){return t.apply(this,arguments)}return a})(),a})(o("EBProbe").EBProbe),C=y.getInstance,b=y.reset;l.EBMessageProbe=y,l.getEBMessageProbeInstance=C,l.resetEBMessageProbeInstance=b}),98);
__d("EBUploadMessagesFromWorkerMutationDeferred",["requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("EBUploadMessagesFromWorkerMutation").__setRef("EBUploadMessagesFromWorkerMutationDeferred");function s(t,n){return e.load().then(function(e){return e.uploadMessagesFromWorker(t,n)})}l.uploadMessagesFromWorker=s}),98);
__d("LSEBPayloadSerializerError",[],(function(t,n,r,o,a,i){var e=Object.freeze({INVALID_BACKUP_OPERATION:-7,INVALID_CONTENT_TYPE:-6,INVALID_PAYLOAD_FORMAT:-5,CQL_DB_ERROR:-4,REQUIRED_COLUMN_NOT_PRESENT_ON_CLIENT:-3,DEPRECATED_SPROC:-2,UNKNOWN_ERROR:-1,NOT_AN_ERROR:0,BACKUP_NOT_FOUND:1,REQUIRED_TABLE_NOT_FOUND:2,NATIVE_OP_NOT_FOUND:3,BACKUP_UPLOAD_KILLSWITCHED:4,TASK_ID_NOT_FOUND:5,NOT_IMPLEMENTED:6,NOT_SUPPORTED_ON_WEB:7,DUPLICATE_TASK:8,CLIENT_STATE_NOT_LOADED:9,RECOVERY_CODE_NOT_FOUND:10,EPOCH_KEYS_NOT_FOUND:11,DEVICE_PAYLOAD_NOT_CREATED:12,NULL_DEVICE_PAYLOAD:13,EPOCH_PAYLOAD_NOT_CREATED:14,NULL_EPOCH_PAYLOAD:15,VIRTUAL_DEVICE_PAYLOAD_NOT_CREATED:16,NULL_VIRTUAL_DEVICE_PAYLOAD:17,DEVICE_METADATA_NOT_FOUND:18,NO_MATCHING_DEVICE_PUBLIC_KEY:19,NULL_MAILBOX_ROOT_KEY:20,NULL_ENCRYPTION_VERSION:21,NULL_OCMF_KEY:22,NULL_EPOCH_KEYS:23,NULL_DEVICE_ID:24,OPE_KEY_DERIVATION_FAILED:25,MESSAGE_KEY_DERIVATION_FAILED:26,NULL_MAILBOX_ROOT_KEY_V2:27,ECHO_DOCUMENT_ENCODING_FAILED:30,ECHO_PAYLOAD_CREATION_DISABLED:31,ECHO_DOCUMENT_ENCODING_SKIPPED:32,MESSAGE_PAYLOAD_ENCRYPTION_FAILED:40,SERVER_THREAD_ID_NOT_FOUND_FOR_JID:52,UNKNOWN_PROTOBUF_TYPE:60,SUPPLEMENTARY_DATA_KEY_UNEXPECTED:61,PROTOBUF_ENCRYPTION_FAILED:62,PROTOBUF_NOT_FOUND_IN_TOPLEVEL_TABLE:63,PROTOBUF_NOT_FOUND_IN_SUPPLEMENTAL_TABLE:64,SUPPLEMENTAL_KEY_NOT_SET_IN_CONTEXT_TABLE:65,SUPPLEMENTAL_ENCRYPTION_FAILED:66,PROTOBUF_CONTEXT_ROW_NOT_FOUND:67,PROTOBUF_FORMATTING_FAILED:68,SUPPLEMENTAL_FORMATTING_FAILED:69,PROTOBUF_ALREADY_DELETED:70,PROTOBUF_NOT_FOUND_IN_DELETED_MESSAGES_TABLE:71,DELETION_PROTOBUF_IS_NULL:72,PROTOBUF_PAYLOAD_IN_CONTEXT_ROW_IS_NOT_FOUND:73,PROTOBUF_ENCRYPTION_FAILED_RETRYABLE:74,VALUE_SECRET_REF_INVALID:75,MINOS_ENCRYPTION_RESULT_NULL:76,SUPPLEMENTAL_OTID_NOT_SET_IN_CONTEXT_TABLE:77,SNAPSHOT_NOT_FOUND_FAILURE:78,THREAD_PK_NOT_FOUND_FOR_JID:100,MESSAGE_DECRYPTION_FAILED:101,EPOCH_KEY_FETCH_FAILED:102,TOO_MANY_OPEN_EPOCHS:103,MESSAGE_RANGE_PREPARE_FAILURE:104,ECHO_DOCUMENT_RESTORE_FAILED:105,MISMATCH_POINT_QUERY_MESSAGE_AND_RANGE_LENGTH:106,INITIAL_THREADS_FETCH_FOR_RESTORE_FAILED:107,MISSING_SUPPLEMENTAL_KEY_CIPHERTEXT:108,SUPPLEMENTAL_KEY_DECRYPTION_FAILURE:109,DEVICE_ID_MISMATCH:110,RESTORE_TO_TAM_INFO:111,MISSING_SERVER_THREAD_KEY:112,EB_ADD_DEVICE_FOUND_NO_LOCAL_THREADS:113,EB_MORE_THREADS_IN_MAPPING_TABLE:114,RESTORE_INTEGRITY_CHECK_FAILED:115,RESTORE_TOP_LEVEL_PROTOBUF_NULL:116,DECRYPT_MINOS_PROTOBUF_FAILURE:117,MESSAGE_PK_NOT_FOUND_IN_CLIENT_MESSAGES:200,OTID_NOT_FOUND_IN_ACT_MESSAGES:201,THREAD_ID_NOT_FOUND_IN_ACT_THREADS:202,THREAD_PK_NOT_FOUND_IN_CLIENT_THREADS:203,FAILED_TO_GET_THREAD_SORT_KEY:204,MEDIA_INFO_INVALID:205,REVERB_DB_NOT_ENABLED_FOR_INSTAMADILLO:206,SKIPPED_EB_DISABLED:300,SKIPPED_THREAD_NOT_ELIGIBLE:301,SKIPPED_MESSAGE_NOT_ELIGIBLE:302,NO_EPOCHS_FOUND:400,LATEST_EPOCH_QUERY_BY_ID_FAILED:401,FOUND_EPOCH_WITH_NULL_ROOT_KEY:402,FOUND_EPOCH_WITH_NULL_ANON_ID:403,NO_RECOVERY_CODE:501,NO_ERROR:601,ERROR_GENERAL:602,UNKNOWN:603,ONBOARDING_MATERIAL_DERIVATION_FAILURE:604,NULL_DEVICE_HMAC:605,MISSING_LATEST_EPOCH_AT_ONBOARDING:606,EPOCH_REPAIR_UNREACHABLE_EPOCH:607,NO_THREADS_TO_COMPARE:701,START_SORT_KEY_FAILURE:702,END_SORT_KEY_FAILURE:703,LOOPING_UPLOAD_PAYLOAD_NOT_FOUND:704,NULL_ECHO_IDENTIFIERS:705,ECHO_TIMESTAMP_CONVERSION_FAILED:706,ECHO_PROTOBUF_THREAD_ID_MISMATCH:707,ECHO_PROTOBUF_TIMESTAMP_MISMATCH:708,ECHO_PROTOBUF_OTID_MISMATCH:709,NULL_ECHO_DOCUMENT:710,INVALID_PROTOBUF_BACKUP_ACTION:711,EMPTY_ENCODED_ECHO_DOCUMENT:712,LOOPING_UPLOAD_TASK_QUEUE_FULL:713,ECHO_DOCUMENT_ENCODING_UNKNOWN_ENCODING_ERROR:750,ECHO_DOCUMENT_ENCODING_MESSAGE_PK_NOT_FOUND_ERROR:751,ECHO_DOCUMENT_ENCODING_DISK_WRITE_CHECK_FAILED:752,ECHO_DOCUMENT_ENCODING_THREAD_TRANSPORT_ID_FETCH_FAILED:753,ECHO_DOCUMENT_ENCODING_FILE_WRITE_FAILED:754,ECHO_DOCUMENT_ENCODING_DISK_WRITE_DISABLED:755,ECHO_DOCUMENT_ENCODING_SHOULD_NOT_PERSIST:756,MISSING_SUPPLEMENTAL_DATA:757,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_REPLY_PROXY_ERROR:758,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_EDIT_MESSAGE_QUERY_ERROR:759,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_EDIT_MESSAGE_ERROR:760,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_RECEIPTS_ERROR:761,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_REACTIONS_ERROR:762,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_VISUAL_MESSAGE_ACTIONS_ERROR:763,ECHO_DOCUMENT_ENCODING_MESSAGE_FIELDS_POLLS_ERROR:764,READ_CLIENT_STATE_FROM_MAIN_DB_ERROR:801,NOT_SUPPORTED_ON_MAIN_DB:802,SKIP_MPS_WRITE_DUE_TO_HIGHER_TIMESTAMP_AVAILABILITY:851,MESSAGE_ALREADY_DELETED:852});i.default=e}),66);
__d("EncryptedBackupsConstructEchoMessages",["$InternalEnum","EBLogger","EBUploadMessagesFromWorkerMutationDeferred","EchoMessage","EncryptedBackupsUploadQueueProcessor","LSEBPayloadSerializerError","MAWBridgeUpload","MAWDbMsgUtil","MAWEBSwitch","MAWEBUploadTrackingUtils","MAWIndexedDb","MAWMediaUtils","MAWMessageSortOrderUtils","MAWMsgType","MAWTransactionMode","MAWUploadMessageTxns","Promise","WALogger","WAProtocolMsgId","asyncToGeneratorRuntime","getErrorSafe","gkx","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y=r("requireDeferred")("EchoSerializationFailureFalcoEvent").__setRef("EncryptedBackupsConstructEchoMessages"),C=r("requireDeferred")("EchoSerializationSuccessFalcoEvent").__setRef("EncryptedBackupsConstructEchoMessages"),b=r("gkx")("12236"),v=n("$InternalEnum").Mirrored(["FATAL","WARN"]);function S(e,t){return R.apply(this,arguments)}function R(){return R=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){e.forEach(function(e){var t=e.uploadTrackingInstanceKey;t!=null&&o("MAWEBUploadTrackingUtils").addPointWorkerOnly(t,"fire_ebls_upload")});var r=yield o("EBUploadMessagesFromWorkerMutationDeferred").uploadMessagesFromWorker(e,t);r.success||o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[labyryth_web] uploadMessagesFromWorker failed with error: ",""])),r.error),yield(h||(h=n("Promise"))).all(e.map(function(e){var t=e.uploadTrackingInstanceKey;return t==null?(h||(h=n("Promise"))).resolve():o("EncryptedBackupsUploadQueueProcessor").ackWithInstanceKeyWorkerOnly(t,r.success)}))}),R.apply(this,arguments)}function L(t,n,r,a,i,l,u){var c=n==null?void 0:n.externalId;if(c==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] extId is null, source: ",""])),u),null;if(n!=null&&r!=null){var d=window.performance.now(),m=o("EchoMessage").encodeEchoMessage(t),p=window.performance.now(),_=l==null?void 0:l.get(c);return _==null&&o("MAWMediaUtils").getMediaTypeFromMsgType(n.type)!=null&&u==="upload_queue"&&o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] attachmentContextArray is null, type: ",""])),n.type),o("MAWEBUploadTrackingUtils").addUploadTrackingByType("point",i,n.externalId,"construct_echo_success"),o("MAWBridgeUpload").createBridgeUploadMessage({actionType:1,attachmentContextArray:_,authTs:n.serverTs,echoDocument:m,echoEncodingLatencyNs:(p-d)*1e6,errorCode:null,errorMessage:null,messageId:c,messageType:n.type,productType:"msgr",protoMsg:a,sortOrderMs:o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(n),threadId:t.threadId,traceId:r,uploadTrackingInstanceKey:o("MAWEBUploadTrackingUtils").getUploadTrackingInstanceKey(i,n.externalId)})}return null}function E(e,t){e!=null&&y.load().then(function(n){return n.log(function(){return{message_id:e,trace_id:t}})})}function k(e,t){e!=null&&C.load().then(function(n){return n.log(function(){return{message_id:e,trace_id:t}})})}function I(e,t){return e==null||t==null?null:e.find(function(e){var n=e.originalMsgProtocolId;if(e.backupActionType===2&&n!=null){var r=n.author,a=n.chat,i=n.externalId;if(r!=null&&a!=null&&i!=null)return o("WAProtocolMsgId").equals({author:r,chat:a,externalId:i},t)}return o("WAProtocolMsgId").equals(e.msgId,t)})}function T(e,t,n,a,i,l,s){var p,_,f=e.echoMessage;if(e.maybeErrorDetail!=null){var g,h,y,C,S=e.maybeErrorDetail,R=S.errorCode,I=S.errorMsg,T=S.uploadErrorType;switch(E((g=a==null||(h=a.msgId)==null?void 0:h.externalId)!=null?g:t.externalId,n),T){case v.WARN:R===r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID?o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["media info invalid thrown from constructEchoMessage, error msg: ",""])),I!=null?I:""):o("WALogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["possible error when constructing echo message: ",""])),I!=null?I:"");break;case v.FATAL:o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["fatal error in the upload message flow, error msg: ",""])),I!=null?I:"");break}if(T===v.WARN||R===r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID){var D=T===v.WARN?"possible error when constructing echo message: "+(I!=null?I:""):"media info invalid thrown from constructEchoMessage, error msg: "+(I!=null?I:"");return o("WALogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] ",""])),D),o("MAWEBUploadTrackingUtils").addUploadTrackingByType("success",i,t.externalId,"construct_echo_success_media/xma_warn/error",{string:{msg:D}}),null}var x=o("MAWBridgeUpload").createBridgeUploadMessage({actionType:1,authTs:t.serverTs,echoDocument:null,echoEncodingLatencyNs:null,errorCode:R,errorMessage:I,messageId:(y=f==null?void 0:f.xOfflineThreadingId)!=null?y:"0",messageType:t.type,protoMsg:a!=null?a:void 0,sortOrderMs:o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(t),threadId:(C=f==null?void 0:f.threadId)!=null?C:"0",traceId:n,uploadTrackingInstanceKey:o("MAWEBUploadTrackingUtils").getUploadTrackingInstanceKey(i,t.externalId)});return o("MAWEBUploadTrackingUtils").addUploadTrackingByType("fail",i,t.externalId,"construct_echo_failed",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.FAILED_TO_CONSTRUCT_ECHO_MESSAGE,errorMsg:I!=null?I:"null error msg, msg type: "+t.type}}),x}if((f==null?void 0:f.xOfflineThreadingId)==null){var $,P,N,M=o("MAWBridgeUpload").createBridgeUploadMessage({actionType:1,authTs:t.serverTs,echoDocument:null,echoEncodingLatencyNs:null,errorCode:r("LSEBPayloadSerializerError").OTID_NOT_FOUND_IN_ACT_MESSAGES,errorMessage:null,messageId:"0",messageType:t.type,protoMsg:a!=null?a:void 0,sortOrderMs:o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(t),threadId:($=f==null?void 0:f.threadId)!=null?$:"0",traceId:n,uploadTrackingInstanceKey:o("MAWEBUploadTrackingUtils").getUploadTrackingInstanceKey(i,t.externalId)});return o("MAWEBUploadTrackingUtils").addUploadTrackingByType("fail",i,t.externalId,"construct_echo_failed",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.FAILED_TO_CONSTRUCT_ECHO_MESSAGE,errorMsg:"oitd not found"}}),k((P=a==null||(N=a.msgId)==null?void 0:N.externalId)!=null?P:t.externalId,n),M}var w=L(f,t,n,a!=null?a:void 0,i,l,s);if(w==null)return null;var A=w;return o("MAWEBUploadTrackingUtils").addUploadTrackingByType("point",i,t.externalId,"issue_message_upload_ui_event",{bool:{echo_deprecation_user:b,echo_document_missing:!b&&!f}}),k((p=a==null||(_=a.msgId)==null?void 0:_.externalId)!=null?p:t.externalId,n),A}function D(e,t,n,r,o){return x.apply(this,arguments)}function x(){return x=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a){var i=new Map;e.forEach(function(e){return i.set(e.dbMsg.externalId,e)});var l=yield N(e);return l.map(function(e){var l=i.get(e.externalId);if(l==null)return null;var s=l.dbMsg,u=l.traceId,c=I(t,o("MAWDbMsgUtil").getProtocolMsgIdFromDbMsg(s));return T(e,s,u,c,n,r,a)}).filter(Boolean)}),x.apply(this,arguments)}function $(e,t,n,r){return P.apply(this,arguments)}function P(){return P=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,a){if(!r("MAWEBSwitch").isEnabled()){o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Cannot proceed with encodeAndSendEchoMessage: Encrypted Backups are not enabled"]))),t.forEach(function(e,t){o("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(e,"upload_tracking_cancelled_eb_turned_off_upload",{string:{externalId:t,from:"uploadMessageFromUploadQueue"}})});return}try{var i=yield D(e.filter(function(e){var n=o("MAWEBUploadTrackingUtils").isUploadSupported(e.dbMsg)&&e.dbMsg.type!==o("MAWMsgType").MSG_TYPE.RAVEN;return n||o("MAWEBUploadTrackingUtils").addUploadTrackingByType("success",t,e.dbMsg.externalId,"upload_not_supported",{string:{msgType:e.dbMsg.type}}),n}),n,t,a,"upload_queue");return S(i,"EncryptedBackupsConstructEchoMessages:uploadMessageFromUploadQueue")}catch(e){var l="[labyrinth_web] Error while encode and upload message to backup: "+String(e),s=r("getErrorSafe")(e);throw o("EBLogger").EBLogger().catching(s).MUSTFIX(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Exception in echo upload: ",""])),l),e}}),P.apply(this,arguments)}var N=o("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:(g=o("MAWTransactionMode")).READONLY,media:g.READONLY,mediaBackup:g.READONLY,messages:g.READONLY,reactions:g.READONLY,receiverFetchInfo:g.READONLY,threads:g.READONLY,xma:g.READONLY},"constructEchoMessage",function(e){return(function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return o("MAWUploadMessageTxns").constructEchoMessage.apply(void 0,[e].concat(n))})});l.UploadErrorType=v,l.uploadMessageFromUploadQueue=$}),98);
__d("EBWorkerEBDBApiDeferred",["requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e=r("requireDeferred")("EBWorkerEBDBApi").__setRef("EBWorkerEBDBApiDeferred");function s(){return e.load().then(function(e){return e.startListeningEBDeviceRegistrations()})}function u(t){return e.load().then(function(e){return e.addNewDevice(t)})}function c(t){return e.load().then(function(e){return e.trackConsistency(t)})}function d(t){return e.load().then(function(e){return e.trackOverprompting(t)})}l.startListeningEBDeviceRegistrations=s,l.addNewDevice=u,l.trackConsistency=c,l.trackOverprompting=d}),98);
__d("EncryptedBackupsMediaRestoreProbeQpl",["MAWQplProxy","WAGetAgeBucketForMediaKeyTimestamp","WAGetPlatformFromStanzaId","justknobx","qpl"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.isRetroactiveUpload,n=e.mediaType,a=e.msgType,i=e.probeDelayMs,l=e.restoreMethod,s=e.sampleRate,u=e.stanzaId,c=e.timestamp,d=e.triggerSource,m=e.version,p=e.xmaType;return o("MAWQplProxy").startQplUserFlow(r("qpl")._(521473213,"27"),{bool:{isRetroactiveUpload:t},int:{probeDelayMs:i,sampleRate:s},string:{e2eePlatform:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(u),mediaKeyAge:o("WAGetAgeBucketForMediaKeyTimestamp").getAgeBucketForMediaKeyTimestamp(c),mediaType:n,msgType:a,restoreMethod:l,triggerSource:d,version:m,xmaType:p==null?"<null>":p}},{providedTimeoutInMs:r("justknobx")._("3047")})}l.startMediaRestoreProbeQPLFlow=e}),98);
__d("MAWGetMediaApi",["MAWDbMediaTxns","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=function(t){var e=t.media,n=t.xmaMediaType;return e==null?null:{media:e,xmaMediaType:n}},c=o("MAWIndexedDb").makeMsgrTransactor({media:(s=o("MAWTransactionMode")).READONLY},"getMediaByPlaintextHash",function(e){return function(t){return o("MAWDbMediaTxns").maybeGetMediaFromPlaintextHash(e,t)}}),d=o("MAWIndexedDb").makeMsgrTransactor({media:s.READONLY},"getMediaByMediaId",function(e){return function(t){return o("MAWDbMediaTxns").maybeGetMediaFromMediaId(e,t)}}),m=o("MAWIndexedDb").makeMsgrTransactor({media:s.READONLY,xma:s.READONLY},"getMediaByXMAId",function(t){return function(n){return t.xma.get(n).then(function(r){return r==null?(o("MWFBLogger").MWMediaLogger().tags(["downloadMediaForUI"]).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["cannot find xma with xmaId ",""])),n),[]):o("MAWDexieTable").dexieAll([o("MAWDbMediaTxns").maybeGetMediaFromMediaId(t,r.defaultPreviewMediaId).then(function(e){return u({media:e,xmaMediaType:"preview"})}),o("MAWDbMediaTxns").maybeGetMediaFromMediaId(t,r.headerMediaId).then(function(e){return u({media:e,xmaMediaType:"headerImage"})}),o("MAWDbMediaTxns").maybeGetMediaFromMediaId(t,r.faviconMediaId).then(function(e){return u({media:e,xmaMediaType:"favicon"})})])})}});l.getMediaByPlaintextHash=c,l.getMediaByMediaId=d,l.getMediaByXMAId=m}),98);
__d("MAWGetMsgByProtocolIdApi",["MAWDbMsgTxns","MAWIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({messages:o("MAWTransactionMode").READONLY},"getMsgsByProtocolMsgIdsTxn",function(e){return(function(t){return o("MAWDbMsgTxns").getMsgsByProtocolMsgId(e,t)})});l.getMsgsByProtocolMsgIdsTxn=e}),98);
__d("MAWDeletedMsgApi",["MAWIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({deletedMessages:o("MAWTransactionMode").READONLY},"getDeletedMsgByProtocolIdApi",function(e){return function(t){return e.deletedMessages.get(babelHelpers.extends({},t))}});l.getDeletedMsgByProtocolIdApi=e}),98);
__d("MAWIsMsgDeletedWithReason",["MAWDbDeletedMessages","MAWDeletedMsgApi","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("MAWDeletedMsgApi").getDeletedMsgByProtocolIdApi(e);return t?t.reason===o("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.ChatDelete||t.reason===o("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.Revoke:!1}),s.apply(this,arguments)}l.isMsgDeletedWithReason=e}),98);
__d("EncryptedBackupsMediaRestoreProbe",["$InternalEnum","EncryptedBackupsMediaRestoreProbeQpl","EncryptedBackupsResignCdnUrl","MAWCastToMsgrServerMediaType","MAWDbXMATxns","MAWGetMediaApi","MAWGetMsgByProtocolIdApi","MAWIndexedDb","MAWIsMsgDeletedWithReason","MAWMsgType","MAWTransactionMode","Promise","WAGlobals","WAJids","WAMediaUtils","WAPromiseDelays","WAResultOrError","WATagsLogger","asyncToGeneratorRuntime","cr:10071","gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h=o("WATagsLogger").TAGS(["MediaRestoreProbe"]),y=r("justknobx")._("2045");function C(e){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.isRetroactiveUpload,a=e.triggerSource,i=e.uploadEntity,l=h.TAGS([i.msgId.externalId]);switch(i.dbMsgType){case o("MAWMsgType").MSG_TYPE.REACTION:case o("MAWMsgType").MSG_TYPE.EDIT_ACTION:return o("WAResultOrError").makeResult("no-attachment-with-msg")}var C=x(),b=i.dbMsgType,v=I(b),L=Math.random()<C*v/100;if(!L)return(g||(g=n("Promise"))).resolve(o("WAResultOrError").makeResult("not-sampled"));var k=n("cr:10071")==null?"sproc":"gql";l.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["start probe media backup through ",", is retroactive upload: ",""])),k,t),yield o("WAPromiseDelays").delayMs(r("gkx")("2067")?5e3:y);var T=babelHelpers.extends({},i.msgId,{author:o("WAGlobals").getMyUserJid()===i.msgId.author?o("WAJids").AUTHOR_ME:i.msgId.author}),D=yield o("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn([T]),$=D[0];if($==null){var P=yield o("MAWIsMsgDeletedWithReason").isMsgDeletedWithReason(T);return P?(l.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["msg is deleted"]))),o("WAResultOrError").makeResult("msg-deleted")):(l.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["no dbMsg found - msgType: "," - source: ",", retroactive: ",""])),i.dbMsgType,a,t),o("WAResultOrError").makeError("missing-db-msg"))}var N=yield E({dbMsg:$,logger:l,protocolMsgId:T});if(N.type==="no-attachment")return l.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["skip restore probe because no attachment found"]))),o("WAResultOrError").makeResult("no-attachment-with-msg");var M=S(N,$.msgId),w=yield(g||(g=n("Promise"))).all(M.map(function(e){if(e.success===!1)return e;var n=o("EncryptedBackupsMediaRestoreProbeQpl").startMediaRestoreProbeQPLFlow({isRetroactiveUpload:t,mediaType:e.value.serverMediaType,msgType:$.type,probeDelayMs:y,restoreMethod:k,sampleRate:C,stanzaId:T.externalId,timestamp:null,triggerSource:a,version:"maw_db",xmaType:e.value.xmaType});return l.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["start probing. serverMediaType: ",", xmaType: "," "])),e.value.serverMediaType,e.value.xmaType),R({dbMsg:$,logger:l,payload:e.value,probeQPL:n,protocolMsgId:T}).then(function(e){return e.success?(l.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Probe success"]))),n.endSuccess(),e):(l.LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Probe failed: "," "])),e.error),n.endFail(e.error,{string:{failReason:e.error}}),e)}).catch(function(e){return l.LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Probe failed: "," "])),e.toString()),n.endFail("runtime-error",{string:{failReason:e.toString()}}),o("WAResultOrError").makeError("runtime-error")})})),A=w.map(function(e){return e.success?null:e.error}).filter(Boolean);return A.length>0?o("WAResultOrError").makeError(A):o("WAResultOrError").makeResult("restore-media-success")}),b.apply(this,arguments)}var v=n("$InternalEnum")({DEFAULT_PREVIEW:"defaultPreview",FAVICON:"favicon",HEADER:"header",PREVIEWS:"previews"});function S(e,t){switch(e.type){case"xma":return e.medias.map(function(e){var n=e.dbMedia,r=e.xmaType,a=D(t,n.mediaEntries);return a.success?o("WAResultOrError").makeResult({mediaKey:a.value.mediaKey,objectId:a.value.objectId,serverMediaType:a.value.serverMediaType,xmaType:r}):o("WAResultOrError").makeError("missing-media-entry")});case"media-with-preview":{var n,r=D(t,e.fullsize.mediaEntries);if(!r.success)return[o("WAResultOrError").makeError("missing-media-entry")];var a=[o("WAResultOrError").makeResult({mediaKey:r.value.mediaKey,objectId:r.value.objectId,serverMediaType:r.value.serverMediaType,xmaType:null})];if(((n=r.value.downloadableThumbnail)==null?void 0:n.directPath)!=null){var i=r.value.downloadableThumbnail;a.push(o("WAResultOrError").makeResult({mediaKey:i.mediaKey,objectId:i.objectId,serverMediaType:"preview",xmaType:null}))}return a}default:{e.type;var l=D(t,e.fullsize.mediaEntries);return l.success?[o("WAResultOrError").makeResult({mediaKey:l.value.mediaKey,objectId:l.value.objectId,serverMediaType:l.value.serverMediaType,xmaType:null})]:[o("WAResultOrError").makeError("missing-media-entry")]}}}function R(e){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.dbMsg,n=e.logger,r=e.payload,a=e.probeQPL,i=e.protocolMsgId,l=t.msgId,s=t.sortOrderMs;if(s==null)return o("WAResultOrError").makeError("missing-sort-order-ms");var u=r.mediaKey,c=r.objectId,d=r.serverMediaType;if(d==null||c==null||u==null)return o("WAResultOrError").makeError("invalid-media-entry");var m=o("MAWCastToMsgrServerMediaType").castToMsgrServerMediaType(d,t.type===o("MAWMsgType").MSG_TYPE.XMA);if(m==null)return o("WAResultOrError").makeError("unsupported-media-type");var p=yield o("EncryptedBackupsResignCdnUrl").resignCdnUrl({deliveryObjectId:c,logger:n,mediaDownloadFlow:a,mediaKey:u,mediaType:m,msgId:l,protocolMsgId:i,sortOrderMs:s});return p.success?o("WAResultOrError").makeResult("restore-media-success"):p}),L.apply(this,arguments)}function E(e){return k.apply(this,arguments)}function k(){return k=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.dbMsg,n=e.logger,r=e.protocolMsgId;switch(t.type){case o("MAWMsgType").MSG_TYPE.IMAGE:case o("MAWMsgType").MSG_TYPE.VIDEO:{if(t.plaintextHash==null)return{type:"no-attachment"};var a=yield o("MAWGetMediaApi").getMediaByPlaintextHash(t.plaintextHash);if(a!=null){var i=a==null?void 0:a.mediaEntries.get(t.msgId);if(i!=null){var l=o("WAMediaUtils").decodeMediaEntryData(i).downloadableThumbnail;if(l!=null&&l.objectId!=null)return{fullsize:a,preview:l,type:"media-with-preview"}}}return a==null?{type:"no-attachment"}:{fullsize:a,type:"media"}}case o("MAWMsgType").MSG_TYPE.PTT:case o("MAWMsgType").MSG_TYPE.GIF:case o("MAWMsgType").MSG_TYPE.STICKER:case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:{if(t.plaintextHash==null)return{type:"no-attachment"};var s=yield o("MAWGetMediaApi").getMediaByPlaintextHash(t.plaintextHash);return s==null?{type:"no-attachment"}:{fullsize:s,type:"media"}}case o("MAWMsgType").MSG_TYPE.RAVEN:case o("MAWMsgType").MSG_TYPE.TEXT:case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:case o("MAWMsgType").MSG_TYPE.ADMIN:case o("MAWMsgType").MSG_TYPE.REVOKED:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:case o("MAWMsgType").MSG_TYPE.ICDC_ALERT:case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:case o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:case o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return{type:"no-attachment"};default:{t.type;var u=yield T(r,n);return u.length===0?{type:"no-attachment"}:{medias:u,type:"xma"}}}}),k.apply(this,arguments)}function I(e){switch(e){case o("MAWMsgType").MSG_TYPE.VIDEO:return 13;case o("MAWMsgType").MSG_TYPE.STICKER:return 10;case o("MAWMsgType").MSG_TYPE.PTT:return 8;case o("MAWMsgType").MSG_TYPE.GIF:return 40;case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return 40;case o("MAWMsgType").MSG_TYPE.XMA:return 2;default:return 1}}var T=o("MAWIndexedDb").makeMsgrTransactor({media:o("MAWTransactionMode").READONLY,messages:o("MAWTransactionMode").READONLY,xma:o("MAWTransactionMode").READONLY},"getMediaByProtocolMsgId",function(t){return function(n,r){return o("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(t,n).then(function(t){if(!t.success)return r.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["cannot find media for xma with protocolMsgId ",""])),n),[];var o=t.value,a=o.defaultPreview,i=o.favicon,l=o.header,s=o.previews;return[a==null?null:{dbMedia:a,xmaType:v.DEFAULT_PREVIEW},i==null?null:{dbMedia:i,xmaType:v.FAVICON},l==null?null:{dbMedia:l,xmaType:v.HEADER}].concat((s!=null?s:[]).map(function(e){return e==null?null:{dbMedia:e,xmaType:v.PREVIEWS}})).filter(Boolean)})}});function D(e,t){var n=t.get(e);return n==null?o("WAResultOrError").makeError("missing-media-entry"):o("WAResultOrError").makeResult(o("WAMediaUtils").decodeMediaEntryData(n))}function x(){return r("gkx")("2067")?100:r("justknobx")._("2722")}l.sampleProbeMediaRestore=C,l.ProbeXmaType=v,l.convertMediaDataToPayload=S,l.getAllMediaForMsg=E,l.getMediaRestoreProbeSamplingRate=x}),98);
__d("MAWCastToMsgType",["MAWMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case"image":return o("MAWMsgType").MSG_TYPE.IMAGE;case"video":return o("MAWMsgType").MSG_TYPE.VIDEO;case"gif":return o("MAWMsgType").MSG_TYPE.GIF;case"sticker":return o("MAWMsgType").MSG_TYPE.STICKER;case"file":return o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE;case"audio":return o("MAWMsgType").MSG_TYPE.PTT;case"xma":return o("MAWMsgType").MSG_TYPE.XMA}}l.castMsgrServerMediaTypeToMsgType=e}),98);
__d("MAWCastToServerMediaType",[],(function(t,n,r,o,a,i){"use strict";function e(e){switch(e){case"document":case"image":case"xma-image":case"video":case"ptt":case"gif":case"sticker":return e;default:return null}}function l(e){switch(e){case"image":case"video":case"gif":case"sticker":case"preview":return e;case"audio":return"ptt";case"xma":return"xma-image";case"file":return"document"}}i.castToServerMediaType=e,i.castMsgrServerMediaTypeToServerMediaType=l}),66);
__d("EncryptedBackupsMediaRestoreProbeV2",["EncryptedBackupsMediaRestoreProbe","EncryptedBackupsMediaRestoreProbeQpl","MAWCastToMsgType","MAWCastToServerMediaType","MAWGetMsgByProtocolIdApi","Promise","Random","WAMediaUtils","WAPromiseDelays","WAResultOrError","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","cr:10071","gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=r("justknobx")._("2045"),g=o("WATagsLogger").TAGS(["MediaRestoreProbeV2"]);function h(e){switch(e){case"video":return 13;case"sticker":return 10;case"audio":return 8;case"gif":return 40;case"file":return 40;case"xma":return 2;case"image":case"preview":return 1}}function y(e){return C.apply(this,arguments)}function C(){return C=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.backupMessage,i=t.chatJid,l=t.protocolMsgId,y=t.sortOrderMs,C=t.stanzaId,v=t.triggerSource;if(n("cr:10071")==null)return o("WAResultOrError").makeResult("not-in-gk");var R=S(a);if(R.success===!1)return R;var L=g.TAGS([C]),E=R.value;if(E==="no-attachment-with-msg")return L.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["skip restore probe because no attachment found"]))),o("WAResultOrError").makeResult(E);var k=E.map(function(e){return e.serverMediaType}).filter(function(e){return e!=="preview"}).find(Boolean);if(k==null)return L.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["skip restore probe because no attachment found"]))),o("WAResultOrError").makeResult("no-attachment-with-msg");var I=o("EncryptedBackupsMediaRestoreProbe").getMediaRestoreProbeSamplingRate(),T=h(k),D=o("Random").coinflip(100/(I*T));if(!D)return(_||(_=n("Promise"))).resolve(o("WAResultOrError").makeResult("not-sampled"));L.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Sampling before delay from source: "," "])),v),yield o("WAPromiseDelays").delayMs(r("gkx")("2067")?5e3:f);var x=yield(_||(_=n("Promise"))).all(E.map(function(e){var t=o("EncryptedBackupsMediaRestoreProbeQpl").startMediaRestoreProbeQPLFlow({isRetroactiveUpload:!1,mediaType:o("MAWCastToServerMediaType").castMsgrServerMediaTypeToServerMediaType(e.serverMediaType),msgType:o("MAWCastToMsgType").castMsgrServerMediaTypeToMsgType(k),probeDelayMs:f,restoreMethod:"gql",sampleRate:I,stanzaId:C,timestamp:e.timestamp,triggerSource:v,version:"protobuf",xmaType:e.xmaType});return L.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["start probing. triggerSource: ",", serverMediaType: ",", xmaType: ",", objectId: "," "])),v,e.serverMediaType,e.xmaType,e.objectId),n("cr:10071").eblsResignCdnUrlWithGraphQL({chatJid:i,deliveryObjectId:e.objectId,externalId:C,mediaDownloadFlow:{addAnnotations:function(n){t.addAnnotations(babelHelpers.extends({},n))},addPoint:function(n,r){t.addPoint(n,babelHelpers.extends({},r))}},mediaKey:e.mediaKey,mediaType:e.serverMediaType,sortOrderMs:y}).then(function(n){return n.success?(L.LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Probe success"]))),{error:null,qpl:t,v2Payload:e}):(L.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Probe failed: "," "])),n.error),{error:n.error,qpl:t,v2Payload:e})}).catch(function(n){return L.LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Probe failed: "," "])),n.toString()),{error:"runtime-error",qpl:t,v2Payload:e}})}));if(x.length>0&&o("Random").coinflip(100)){var $=yield b(l,L),P=function*(t){if($.success===!1){var e;t.qpl.addAnnotations({bool:{isV1PayloadMissing:!0},string:{missingMsgType:(e=$.error)==null?void 0:e.missing_msg_type}})}else{var n=$.value.filter(function(e){return e.serverMediaType===t.v2Payload.serverMediaType}),r=n.length>0&&n[0].objectId===t.v2Payload.objectId,o=t.v2Payload.xmaType==null||n.length>0&&n[0].xmaType===t.v2Payload.xmaType;t.qpl.addAnnotations({bool:{isObjectIdMatching:r,isV1PayloadMissing:!1,isXmaTypeMatching:o},string_array:{v1Types:n.map(function(e){return e.serverMediaType}).filter(Boolean)}})}};for(var N of x)yield*P(N)}for(var M of x)M.error!=null?M.qpl.endFail(M.error,{string:{failReason:M.error}}):M.qpl.endSuccess();return o("WAResultOrError").makeResult("restore-media-success")}),C.apply(this,arguments)}function b(e,t){return v.apply(this,arguments)}function v(){return v=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield o("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn([e]),r=n[0];if(r==null)return o("WAResultOrError").makeError();var a=yield o("EncryptedBackupsMediaRestoreProbe").getAllMediaForMsg({dbMsg:r,logger:t,protocolMsgId:e});return a.type==="no-attachment"?o("WAResultOrError").makeError({missing_msg_type:r.type}):o("WAResultOrError").makeResult(o("EncryptedBackupsMediaRestoreProbe").convertMediaDataToPayload(a,r.msgId).map(function(e){return e.value}).filter(Boolean))}),v.apply(this,arguments)}function S(e){var t,n=e.encryptedTransportMessage();if(n==null)return o("WAResultOrError").makeError("missing-transport");var r=n.consumerMessage();if(r!=null){var a=r.imageMessage();if(a!=null)return E(a,"image");var i=r.videoMessage();if(i!=null){var l,s,u=((l=i.payload.ancillary)==null?void 0:l.gifPlayback)===!0||((s=i.payload.ancillary)==null?void 0:s.gifAttribution)!=null;return E(i,u?"gif":"video")}var c=r.audioMessage();if(c!=null){var d=L(c,"audio");return d.success===!1?d:o("WAResultOrError").makeResult([d.value])}var m=r.stickerMessage();if(m!=null){var p=L(m,"sticker");return p.success===!1?p:o("WAResultOrError").makeResult([p.value])}var _=r.documentMessage();if(_!=null){var f=L(_,"file");return f.success===!1?f:o("WAResultOrError").makeResult([f.value])}}var g=(t=n.armadillo())==null?void 0:t.extendedContentMessage();if(g!=null){var h=g.previews();return o("WAResultOrError").makeResult([R({transport:g.favicon(),xmaType:o("EncryptedBackupsMediaRestoreProbe").ProbeXmaType.FAVICON}),R({transport:g.headerImage(),xmaType:o("EncryptedBackupsMediaRestoreProbe").ProbeXmaType.FAVICON}),h.length>0?R({transport:h[0],xmaType:o("EncryptedBackupsMediaRestoreProbe").ProbeXmaType.DEFAULT_PREVIEW}):null].concat(h.map(function(e){return R({transport:e,xmaType:o("EncryptedBackupsMediaRestoreProbe").ProbeXmaType.PREVIEWS})})).filter(Boolean))}return o("WAResultOrError").makeResult("no-attachment-with-msg")}function R(e){var t,n,r,a=e.transport,i=e.xmaType,l=a==null||(t=a.integral)==null||(t=t.transport)==null||(t=t.ancillary)==null?void 0:t.objectId;if(l==null)return null;var s=a==null||(n=a.integral)==null||(n=n.transport)==null||(n=n.integral)==null?void 0:n.mediaKeyTimestamp,u=a==null||(r=a.integral)==null||(r=r.transport)==null||(r=r.integral)==null?void 0:r.mediaKey;return u==null?null:{mediaKey:o("WAMediaUtils").castToMediaKey(u),objectId:o("WAMediaUtils").stringToDeliveryObjectId(l),serverMediaType:"xma",timestamp:s!=null?o("WATimeUtils").castLongIntToUnixTime(s):null,xmaType:i}}function L(e,t){var n,r,a,i=e==null||(n=e.payload.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.objectId,l=e==null||(r=e.payload.integral)==null||(r=r.transport)==null||(r=r.integral)==null?void 0:r.mediaKeyTimestamp,s=e==null||(a=e.payload.integral)==null||(a=a.transport)==null||(a=a.integral)==null?void 0:a.mediaKey;return s==null?o("WAResultOrError").makeError("missing-media-key"):i!=null?o("WAResultOrError").makeResult({mediaKey:o("WAMediaUtils").castToMediaKey(s),objectId:o("WAMediaUtils").stringToDeliveryObjectId(i),serverMediaType:t,timestamp:l!=null?o("WATimeUtils").castLongIntToUnixTime(l):null}):o("WAResultOrError").makeError("missing-object-id")}function E(e,t){var n,r,a,i=L(e,t);if(i.success===!1)return i;var l=e==null||(n=e.payload.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null||(n=n.thumbnail)==null||(n=n.downloadableThumbnail)==null?void 0:n.objectId,s=e==null||(r=e.payload.integral)==null||(r=r.transport)==null||(r=r.integral)==null?void 0:r.mediaKeyTimestamp,u=e==null||(a=e.payload.integral)==null||(a=a.transport)==null||(a=a.integral)==null?void 0:a.mediaKey;return u==null?o("WAResultOrError").makeError("missing-media-key"):l!=null?o("WAResultOrError").makeResult([i.value,{mediaKey:o("WAMediaUtils").castToMediaKey(u),objectId:o("WAMediaUtils").stringToDeliveryObjectId(l),serverMediaType:"preview",timestamp:s!=null?o("WATimeUtils").castLongIntToUnixTime(s):null}]):o("WAResultOrError").makeResult([i.value])}l.sampleProbeMediaRestoreV2=y}),98);
__d("EncryptedBackupsWorkerScheduler",["WorkerScheduler","gkx"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return e==null&&(e=o("WorkerScheduler").makeScheduler("eb",{concurrency:1,maxTaskLimit:1,maxThrottleMs:r("gkx")("9699")?5e3:1e3,timeoutMs:6e4})),e}l.ebScheduler=s}),98);
__d("MAWTraceUtils",["LSDataTraceTag","LSRequestId","MAWMsgType"],(function(t,n,r,o,a,i,l){"use strict";var e="backup_upload",s="media_backup",u="vesta_registration",c="vesta_login";function d(){return r("LSRequestId").generate()}function m(e){return e}function p(e){switch(e){case o("MAWMsgType").MSG_TYPE.TEXT:return o("LSDataTraceTag").messageTypeText;case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:return o("LSDataTraceTag").messageTypeFutureproof;case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:return o("LSDataTraceTag").messageTypeCiphertext;case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:return o("LSDataTraceTag").messageTypeUnavailable;case o("MAWMsgType").MSG_TYPE.IMAGE:return o("LSDataTraceTag").messageTypeImage;case o("MAWMsgType").MSG_TYPE.VIDEO:return o("LSDataTraceTag").messageTypeVideo;case o("MAWMsgType").MSG_TYPE.PTT:return o("LSDataTraceTag").messageTypePtt;case o("MAWMsgType").MSG_TYPE.ADMIN:return o("LSDataTraceTag").messageTypeAdmin;case o("MAWMsgType").MSG_TYPE.REVOKED:return o("LSDataTraceTag").messageTypeRevoked;case o("MAWMsgType").MSG_TYPE.GIF:return o("LSDataTraceTag").messageTypeGif;case o("MAWMsgType").MSG_TYPE.STICKER:return o("LSDataTraceTag").messageTypeSticker;case o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL:return o("LSDataTraceTag").messageTypeExpiredEphemeral;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return o("LSDataTraceTag").messageTypeEphemeralSettingAdmin;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:return o("LSDataTraceTag").messageTypeEphemeralSyncResponse;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return o("LSDataTraceTag").messageTypeEphemeralScreenshotAction;case o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME:return o("LSDataTraceTag").messageTypeDeleteForMe;case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE:return o("LSDataTraceTag").messageTypeEphemeralSettingChangeFromCurrentDevice;case o("MAWMsgType").MSG_TYPE.ICDC_ALERT:return o("LSDataTraceTag").messageTypeAlertICDC;case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return o("LSDataTraceTag").messageTypeGroupInvite;case o("MAWMsgType").MSG_TYPE.XMA:return o("LSDataTraceTag").messageTypeXMA;case o("MAWMsgType").MSG_TYPE.REACTION:return o("LSDataTraceTag").messageTypeReaction;case o("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION:return o("LSDataTraceTag").messageTypeSenderKeyDistribution;default:return o("LSDataTraceTag").messageTypeNone}}l.CONTEXT_BACKUP_UPLOAD=e,l.CONTEXT_MEDIA_BACKUP=s,l.CONTEXT_VESTA_REGISTRATION=u,l.CONTEXT_VESTA_LOGIN=c,l.createTraceId=d,l.stringToTraceId=m,l.getTagForMsgType=p}),98);
__d("MAWHIMLogger",["MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MWFBLogger").MWLogger().tags(["HandleIncomingMessage"]);l.default=e}),98);
__d("MAWDbRavenActionTxns",["FBLogger","MAWBridgeTypesCreators","MAWDbMsg","MAWIndexedDb","MAWMsg","MAWRavenUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return e.messages.where("externalId").equals(t.ravenActionToMsgExternalId).filter(function(e){return e.threadJid===n.jid}).first().then(function(a){var i=a==null?void 0:a.msgId;if(i==null){r("FBLogger")("maw_incoming_handlers").warn("[MAWDbRavenActionTxns] Cannot Write Raven Action without ID of Raven Message.");return}return s(e,a).then(function(r){var o=babelHelpers.extends({msgId:i,threadJid:n.jid},t);return e.unrenderedMessages.add(o).then(function(e){return babelHelpers.extends({rowId:e},o)})}).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"RavenActionUpdate",value:o("MAWBridgeTypesCreators").createBridgeRavenAction(e)})})})}function s(e,t){if((t==null?void 0:t.type)!=="Raven")throw r("FBLogger")("messenger_web").mustfixThrow("Cannot Modify Message because Message is not Raven Message");var n=[o("MAWMsg").MAWRavenMsgEphemeralMediaState.cast(Number(t.ravenEphemeralMediaState)),o("MAWMsg").MAWRavenMsgEphemeralType.cast(Number(t.ravenEphemeralType))],a=n[0],i=n[1];if(a==null||i==null)throw r("FBLogger")("messenger_web").mustfixThrow("ravenEphemeralMediaStateEnum or ravenEphemeralTypeEnum is null");var l=o("MAWRavenUtils").getNextRavenMessageEphemeralState(a,i);return e.messages.put(babelHelpers.extends({},t,{ravenEphemeralMediaState:l}))}function u(e,t,n){var r=o("MAWDbMsg").isRavenActionMsgType(n)&&(t==null?void 0:t.externalId)!=null?[t.externalId]:[];return e.messages.where("externalId").anyOf(r).filter(function(e){return e.author===(t==null?void 0:t.author)&&e.threadJid===(t==null?void 0:t.chat)}).first()}l.writeRavenActionMsg=e,l.modifyRavenMsgWithActionMsg=s,l.maybeGetRavenMsgQueryByProtocolMsgId=u}),98);
__d("MAWEphemeralAdminMsgBuildTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbMsgTxns","MAWDexieTable","MAWEphemeralUtils","MAWIndexedDb","MAWMsgType","MAWODSProxy","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WAOdsEnums","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,a,i,l,s,u){if(n<0)throw r("FBLogger")("messenger_web").mustfixThrow("Received unexpected ephemeral time setting");var c=o("MAWEphemeralUtils").getEphemeralSettingChangeData(t,n,l,s),d={ack:o("MAWAckLevel").ACK.sent,altIndex:void 0,author:t!=null?t:o("WAJids").AUTHOR_SYSTEM,msgContent:c,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN},m=t!=null?o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,u,i.jid,t):o("MAWDexieTable").dexieResolve();return m.then(function(t){if(t==null){var n=babelHelpers.extends({},d,{externalId:u,sortOrderMs:o("WATimeUtils").castUnixTimeToMillisTime(a),threadJid:i.jid,ts:a});return o("MAWWriteMsgTxns").writeDedupedEphemeralSettingAdminMessage(e,n,i,o("WATimeUtils").castUnixTimeToMillisTime(a)).then(function(e){return babelHelpers.extends({},n,{msgId:e.msgId,protocolMsgId:e.protocolMsgId,rowId:e.rowId})})}else if(t.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT){o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_LS_SYNC_IMPROVEMENTS,key:"ephemeral_setting_admin_msg_ciphertext_replacement"});var r=babelHelpers.extends({},t,d);return e.messages.put(r).then(function(){return o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(r)}),r})}else return null})}function s(e,t,n,r,a,i,l){var s=t===o("MAWUserJidWrapper").getMyUserJid(),u=o("MAWEphemeralUtils").getEphemeralScreenshotActionData(a,t,s),c=u.ephemeralScreenshotActionContent,d=u.ephemeralScreenshotActionType;if(l==null){var m={ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:s?o("WAJids").AUTHOR_ME:t,externalId:i,msgContent:{adminMsgContent:c,adminType:d,screenshotActionType:a,version:1},sortOrderMs:o("WATimeUtils").castUnixTimeToMillisTime(r),threadJid:n.jid,ts:r,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION};return o("MAWWriteMsgTxns").writeDedupedEphemeralSettingAdminMessage(e,m,n,o("WATimeUtils").castUnixTimeToMillisTime(r)).then(function(e){return babelHelpers.extends({},m,{msgId:e.msgId,protocolMsgId:e.protocolMsgId,rowId:e.rowId})})}else if(l.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT){o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_LS_SYNC_IMPROVEMENTS,key:"ephemeral_screenshot_action_msg_ciphertext_replacement"});var p=babelHelpers.extends({},l,{ack:o("MAWAckLevel").ACK.received,altIndex:void 0,author:s?o("WAJids").AUTHOR_ME:t,msgContent:{adminMsgContent:c,adminType:d,screenshotActionType:a,version:1},type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION});return e.messages.put(p).then(function(){return o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(p)}),p})}else return o("MAWDexieTable").dexieResolve(null)}l.writeEphemeralSettingAdminMsg=e,l.writeEphemeralScreenshotActionMsg=s}),98);
__d("MAWMsgActionType",[],(function(t,n,r,o,a,i){"use strict";var e={DELETE_FOR_ME:"DELETE_FOR_ME",NO_ACTION:"NO_ACTION",REVOKE:"REVOKE",UPDATE_CIPHERTEXT:"UPDATE_CIPHERTEXT",UPDATE_CIPHERTEXT_WITH_ASSOCIATED:"UPDATE_CIPHERTEXT_WITH_ASSOCIATED",WRITE:"WRITE",WRITE_WITH_ASSOCIATED:"WRITE_WITH_ASSOCIATED"};i.MSG_ACTION=e}),66);
__d("MAWDbReceiptTxns",["MAWDexieTable","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){return u([{deliveryReceipts:t==="delivered"?n:[],msgId:e,readReceipts:t==="read"?n:[],senderReceipts:t==="sender"?n:[]}]).then(function(e){return e[0]||{type:"missing"}})}function u(t){var n=t.map(function(e){return e.msgId}),r=new Map;t.forEach(function(e){r.set(e.msgId,e)});var a=n.map(function(t){var n=r.get(t);if(n==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly fetched null data from a msgIdToReceiptData map"]))),null;var a=new Set,i=new Map,l=n.deliveryReceipts,s=n.readReceipts,u=n.senderReceipts;return[{receiptType:"delivered",receivers:l},{receiptType:"read",receivers:s},{receiptType:"sender",receivers:u}].forEach(function(e){var t=e.receiptType,n=e.receivers;n.forEach(function(e){var n=e.device,r=e.ts,l=o("WAJids").extractUserJid(n),s=!1;if(t!=="sender"){var u=i.get(l),m=c(u,t,r);i.set(l,m),s=d(u,m)}s&&a.add(l)})}),{affectedUserJids:a,receipt:{msgId:t,statusTsPerUser:i}}}).filter(Boolean);return o("MAWDexieTable").dexieResolve(a.map(function(e){return{affectedUserJids:e.affectedUserJids,receipt:e.receipt}}))}function c(e,t,n){var r,o=(r=e==null?void 0:e.deliveredTs)!=null?r:n,a=e==null?void 0:e.readTs;return t==="read"&&a==null&&(a=n),{deliveredTs:o,readTs:a}}function d(e,t){return((t==null?void 0:t.deliveredTs)||0)>((e==null?void 0:e.deliveredTs)||0)||((t==null?void 0:t.readTs)||0)>((e==null?void 0:e.readTs)||0)}function m(e){if(!(e==null||e.size===0))return e}function p(e,t){return e.receipts.bulkDelete(t)}l.writeReceiptsForDevices=s,l.bulkWriteReceiptsForDevices=u,l.bulkDeleteAllReceiptsForMessages=p}),98);
__d("MAWMessageRequestUtils",["MAWFolderTypes","WADbContact"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e===o("MAWFolderTypes").FOLDER_ID.PENDING||e===o("MAWFolderTypes").FOLDER_ID.OTHER;return t}function s(e,t){return(e===null||e===o("MAWFolderTypes").FOLDER_ID.INBOX)&&(t===o("WADbContact").REVERSED_ONE_WAY_CONTACT||t===o("WADbContact").NON_CONTACT)}l.isMessageRequestOrSpamThread=e,l.isInboxRequest=s}),98);
__d("MAWMarkThreadAsReadTxns",["FBLogger","MAWDbMsgTxns","MAWDexieTable","MAWMessageRequestUtils","MAWTimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,o,a){a===void 0&&(a=!1);var i=new Map;return i.set(t,{msgId:n,sortOrderMs:o}),s(e,i,a).then(function(e){var n=e.get(t);if(n==null)throw r("FBLogger")("messenger_web_devx","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n         in markThreadAsReadUpToMsgSortOrderMs()");return n})}function s(e,t,n){return n===void 0&&(n=!1),c(e,t).then(function(t){var n=t.threadJidToReadReceiptInfo,r=t.updatedThreads;return e.threads.bulkPut(r).then(function(){return r.forEach(function(e){var t,r;n.set(e.jid,{isReadReceiptExpectedToBeSent:(t=(r=n.get(e.jid))==null?void 0:r.isReadReceiptExpectedToBeSent)!=null?t:!1,type:"success"})}),n})})}function u(e,t,n){return o("MAWDbMsgTxns").getThreadOldestMessageId(e,t.jid).then(function(e){if(e==null)return null;var r=o("MAWTimeUtils").ensureValidMillisTime(t.newestMsgTs);return babelHelpers.extends({},t,{lastReadMsg:n.msgId,newestMsgTs:r})})}function c(e,t){var n=new Map,a=Array.from(t.keys()),i=[];return e.threads.where("jid").anyOf(a).toArray().then(function(l){var s=new Map;l.forEach(function(e){return s.set(e.jid,e)}),a.forEach(function(e){s.has(e)||s.set(e,null)});var c=Array.from(s).map(function(o){var a=o[0],l=o[1];if(l==null){n.set(a,{isReadReceiptExpectedToBeSent:!1,type:"missing"});return}var s=d(l.folder);n.set(l.jid,{isReadReceiptExpectedToBeSent:s,type:"success"});var c=t.get(l.jid);if(c==null)throw r("FBLogger")("maw_threads","maw_mark_thread_as_read").warn("ThreadReadReceiptInfo unexpectedly unavailable for thread\n            in getThreadJidToReadReceiptInfo()");return u(e,l,c).then(function(e){e!=null&&i.push(e)})});return o("MAWDexieTable").dexieAll(c).then(function(){return{threadJidToReadReceiptInfo:n,updatedThreads:i}})})}function d(e){return!o("MAWMessageRequestUtils").isMessageRequestOrSpamThread(e)}l.markThreadAsReadUpToMsgSortOrderMs=e,l.bulkMarkThreadAsReadUpToMsgSortOrderMs=s,l.isReadReceiptExpectedToBeSentFor=d}),98);
__d("MAWPendingReceiptProcessingTxns",["MAWDbMsg","MAWDbParticipantTxns","MAWDbReceiptTxns","MAWDexieTable","MAWMarkThreadAsReadTxns","WAJids","WALogger","WAMsg","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,r){var a=o("WAMsg").craftWAMsgIdString({author:r.author,chat:n,externalId:r.externalId});return t.pendingReceipts.get(a).then(function(n){if(n!=null)if(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Processing pending receipts for "," from ",""])),r.externalId,r.author),n.author===o("WAJids").AUTHOR_ME){var i=o("MAWDexieTable").dexieResolve();return n.deliveryReceipts.length>0&&(i=i.then(function(){return o("MAWDbReceiptTxns").writeReceiptsForDevices(r.msgId,"delivered",n.deliveryReceipts)})),n.readReceipts.length>0&&(i=i.then(function(){return o("MAWDbReceiptTxns").writeReceiptsForDevices(r.msgId,"read",n.readReceipts)})),i.then(function(e){var n=[];return e!=null&&e.type!=="missing"&&e.receipt.statusTsPerUser.forEach(function(e,a){var i,l=e.deliveredTs!=null?r.ts:o("WATimeUtils").castToUnixTime(0),s=e.readTs!=null?r.ts:o("WATimeUtils").castToUnixTime(0),u=(i=e.readTs)!=null?i:o("WATimeUtils").castToUnixTime(0);n.push(o("MAWDbParticipantTxns").updateParticipantTimestamps(t,[r.threadJid,a],l,s,u))}),o("MAWDexieTable").dexieAll(n).then(function(){t.pendingReceipts.delete(a)})})}else return o("MAWDexieTable").dexieAll([o("MAWMarkThreadAsReadTxns").markThreadAsReadUpToMsgSortOrderMs(t,r.threadJid,r.msgId,o("WATimeUtils").castToMillisTime(o("MAWDbMsg").getSortOrderWithFallback(r)))]).then(function(){return t.pendingReceipts.delete(a)})})}l.processPendingReceipts=s}),98);
__d("MAWUpdateIsCollapsedMsgTxns",["MAWBridgeMsg","MAWDexieTable","MAWIndexedDb","MWXMAV2IsDataclassLiveLocationXMA"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r){var a=t.collapsibleId;return a==null?o("MAWDexieTable").dexieResolve(t):e.messages.where(["threadJid","collapsibleId","sortOrderMs"]).between([r,a,Number.MIN_SAFE_INTEGER],[r,a,Number.MAX_SAFE_INTEGER],!1,!1).reverse().first().then(function(r){if(r!=null)if(t.serverTs!=null&&t.serverTs>r.serverTs){var a=babelHelpers.extends({},r,{isCollapsed:!0});return e.messages.put(a).then(function(){return o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(a)})}).then(function(){return o("MAWDexieTable").dexieResolve(babelHelpers.extends({},t,{isCollapsed:!1}))})}else return o("MAWDexieTable").dexieResolve(babelHelpers.extends({},t,{isCollapsed:!0}));else return o("MAWDexieTable").dexieResolve(babelHelpers.extends({},t,{isCollapsed:o("MWXMAV2IsDataclassLiveLocationXMA").isExpiredLiveLocationStarted(n,t.serverTs)}))})}l.maybeUpdatePreviousCollapsibleMsgs=e}),98);
__d("MAWWriteEditTxns",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWBulkEditMsgsTxns","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWUnsafeCoerce","MAWUserJidWrapper","MAWWriteMsgTxns","WAJids","WAMsgType","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=t.args,a=t.externalId,i=n.editMsgContent,l=n.originalProtocolMsgId,u=l.chat,c=l.externalId;return o("MAWDexieTable").dexieAll([e.threads.get({jid:u}),o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,l)]).then(function(n){var l=n[0],d=n[1];if(l==null)return o("WAResultOrError").makeError("missing_thread");if(d==null)return o("WAResultOrError").makeError("missing_msg");if(d.type!==o("WAMsgType").MSG_TYPE.TEXT)throw r("FBLogger")("messenger_web").mustfixThrow("Only text or cipher text can be edited. Original msg type: %s",d.type);return o("MAWDexieTable").dexieAll([e.messages.where("quoteExternalId").equals(c).toArray(),e.editMsgHistory.where("originalMsgExternalId").equals(c).toArray()]).then(function(n){var l=n[0],m=n[1],p=m.find(function(e){return e.author===o("WAJids").AUTHOR_ME&&e.threadJid===u&&e.editExternalId===a});if((p==null?void 0:p.sendStatus)!=null&&p.sendStatus>o("MAWAckLevel").ACK.clock)return o("WAResultOrError").makeError("already_sent");var _=[];_.push(s(t,u,c));var f=m.find(function(e){return e.author===o("WAJids").AUTHOR_ME&&e.threadJid===u&&e.editExternalId===c});return f==null&&(d.editCount==null||d.editCount===0)&&_.push(s(d,u,c)),o("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(e,_).then(function(){var t,n=babelHelpers.extends({},d,{ack:o("MAWAckLevel").ACK.clock,editCount:((t=d.editCount)!=null?t:0)+1,msgContent:i}),s=[],m=o("MAWUserJidWrapper").getMyUserJid();return l.filter(function(e){var t,n;return(((t=e.quote)==null?void 0:t.content.author)===o("WAJids").AUTHOR_ME||((n=e.quote)==null?void 0:n.content.author)===m)&&e.threadJid===u}).forEach(function(e){if(e!=null){var t=e.quote,o=e.quoteExternalId;if(t==null)r("FBLogger")("messenger_web").warn("[edit message] Failed to get the quoted content for a msg that has been quoted.",o);else{var a=babelHelpers.extends({},e,{quote:babelHelpers.extends({},t,{content:babelHelpers.extends({},t.content,{msgContent:babelHelpers.extends({},n.msgContent)})})});s.push(a)}}}),e.messages.bulkPut([n].concat(s)).then(function(){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,d)}).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(n,e)})}).then(function(){return s.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e)})}),o("WAResultOrError").makeResult({originalMsgExternalId:c,originalMsgId:d.msgId,protocolMsgId:{author:o("WAJids").AUTHOR_ME,chat:u,externalId:a}})})})})})}function s(e,t,n){var r,a,i;return{author:o("WAJids").AUTHOR_ME,editExternalId:e.externalId,editTs:(r=e.serverTs)!=null?r:e.ts,msgContent:(a=(i=e.args)==null?void 0:i.editMsgContent)!=null?a:o("MAWUnsafeCoerce").unsafeCoerce(e.msgContent),originalMsgExternalId:n,sendStatus:o("MAWAckLevel").ACK.clock,specialTextSize:e.specialTextSize,threadJid:t}}function u(e,t,n,r,a,i){if(t.type!==o("WAMsgType").MSG_TYPE.TEXT||!r||r.length===0)return o("MAWWriteMsgTxns").writeNewIncomingMsg(e,t,n,a,i);var l=r.sort(function(e,t){return t.editTs-e.editTs})[0].msgContent,s=r.length;return o("MAWWriteMsgTxns").writeNewIncomingMsg(e,babelHelpers.extends({},t,{editCount:s,msgContent:l}),n,a,i).then(function(n){return(n.type===o("WAMsgType").MSG_TYPE.TEXT?o("MAWDbEditMsgHistoryTxns").bulkAddEditMsgHistory(e,[o("MAWBulkEditMsgsTxns").getMessageHistory(babelHelpers.extends({},n,{msgContent:t.msgContent}),n.threadJid)]):o("MAWDexieTable").dexieResolve()).then(function(){return n})})}l.writeEdit=e,l.writeNewIncomingMsgAndEditHistory=u}),98);
__d("MAWDbGroupInviteTxns",["MAWDexieTable","MAWMsgType"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return e.groupInvites.put(t).then(function(){return t})}function s(e,t,n){return e.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[t,n]]).delete()}function u(e,t,n){return e.groupInvites.where(["threadJid","inviteeJid"]).equals([t,n]).first()}function c(e,t,n){return e.groupInvites.where(["threadJid","inviteeJid"]).anyOf([[t,n]]).toArray()}function d(e,t){return t.type===o("MAWMsgType").MSG_TYPE.GROUP_INVITE?t.invitedParticipantUserJid==null?o("MAWDexieTable").dexieResolve():u(e,t.threadJid,t.invitedParticipantUserJid):o("MAWDexieTable").dexieResolve()}l.putGroupInvite=e,l.deleteGroupInvitesByThreadAndInvitedParticipant=s,l.maybeGetGroupInvite=u,l.getGroupInvitesByThreadAndInvitedParticipant=c,l.getAndCheckGroupInviteFromMsg=d}),98);
__d("MAWDbGroupInfoTxns",["MAWBridgeTypesCreators","MAWIndexedDb","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return s(e,t.jid).then(function(n){var r=t.participantVersion;n.success&&n.value.participantVersion!=null&&t.participantVersion==null&&(r=n.value.participantVersion);var o=t.subject.content;o!=null&&o.length===0&&(o=void 0);var a={creationTs:t.creationTs,creator:t.creator,groupJid:t.jid,inviter:t.inviter,memberAddMode:t.memberAddMode,name:o,nameOwner:t.subject.user,nameTs:t.subject.ts,participantVersion:r};return u(e,a).then(function(){return a})})}function s(e,t){return e.groupInfo.get({groupJid:t}).then(function(e){return e==null?o("WAResultOrError").makeError("missing"):o("WAResultOrError").makeResult(e)})}function u(e,t){return e.groupInfo.put(t).then(function(){o("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(t)})})}function c(e,t){return e.groupInfo.bulkPut(t).then(function(){t.forEach(function(e){return o("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(e)})})})}function d(e,t){return e.groupInfo.bulkGet(t)}function m(e,t){return e.groupInfo.delete(t)}l.putGroupInfo=e,l.getGroupInfo=s,l.updateGroupInfo=u,l.bulkUpdateGroupInfo=c,l.getGroupInfos=d,l.deleteGroupInfo=m}),98);
__d("MAWGroupInviteManagementTxns",["MAWDbGroupInviteTxns","MAWDbParticipantTxns","MAWDexieTable","MAWUserJidWrapper"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=!1;return o("MAWDbParticipantTxns").getInvitedParticipantsInThread(e,t).then(function(r){if(r.length===0){n=!0;var a=o("MAWUserJidWrapper").getMyUserJid();return o("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(e,t,a).then(function(){return n})}else{var i=[];return r.forEach(function(n){i.push(o("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(e,t,n.userJid))}),o("MAWDexieTable").dexieAll(i).then(function(){return n})}})}l.deleteGroupInvitesByThread=e}),98);
__d("MAWLoadOneToOneMessageRequestCapabilitiesTxn",["MAWDexieTable","MAWIndexedDb","WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.map(o("WAJids").interpretAsUserJid).forEach(function(e){return e!=null&&o("MAWIndexedDb").afterTransaction({tag:"OneToOneMessageRequestLoaded",value:{fbid:o("WAJids").extractUserId(e),threadJid:e}})}),o("MAWDexieTable").dexieResolve()}l.loadOneToOneMessageRequestCapabilities=e}),98);
__d("MAWThreadManagementTxns",["MAWBridgeEventTransmitter","MAWBridgeParticipants","MAWBridgeTypesCreators","MAWDbGroupInfoTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWGetOrCreateThreadTxns","MAWGroupInviteManagementTxns","MAWIndexedDb","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWQplProxy","WAJids","WALogger","WAMsgType","WASortedLists","WATimeUtils","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,a){var i=t.authoritativeThreadKey,l=t.createTs,s=t.description,u=t.folder,c=t.lastActivityTimestamp,d=t.lastReadWatermarkTimestamp,m=t.offlineThreadingId,p=t.skipVerifyThread,f=t.userJid;return o("MAWGetOrCreateThreadTxns").getOrCreateThread(e,{authoritativeThreadKey:i,clientThreadKey:m,createTs:l,description:s,folder:u,instanceKey:a,jid:f,lastActivityTimestamp:c,lastReadWatermarkTimestamp:d,skipVerifyThread:p},n).then(function(t){var i=t.created,l=t.thread;n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"process-setup-thread-start",{instanceKey:n}),a!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(1056836502,"2778"),"process_setup_thread_start",{instanceKey:a});var s=_(e,f,i,l);return n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(25313175,"1551"),"process-setup-thread-end",{instanceKey:n}),a!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r("qpl")._(1056836502,"2778"),"process_setup_thread_end",{instanceKey:a}),s})}function u(e,t,n,r){return o("MAWDbGroupInfoTxns").getGroupInfo(e,t).then(function(t){if(!t.success)return null;var a=t.value;return o("MAWGetOrCreateThreadTxns").getOrCreateThread(e,{createTs:o("WATimeUtils").castUnixTimeToMillisTime(a.creationTs),description:"getOrRepairGroupThread",folder:n,jid:a.groupJid,skipVerifyThread:r}).then(function(e){var t=e.created,n=e.thread;return{created:t,groupInfo:a,thread:n}})})}function c(t,n){var r=[],a=[];return n.forEach(function(e){o("MAWDbMsg").isMediaMsg(e)&&e.mediaId!=null&&(r.push(e.mediaId),a.push(e.msgId))}),t.media.bulkGet(r).then(function(n){var r=[],i=[];n.forEach(function(e,t){if(e!=null){var n=a[t];e.msgIds=o("WASortedLists").filter(e.msgIds,function(e){return e!==n}),e.mediaEntries.delete(n),e.msgIds.length===0&&e.mediaEntries.size===0&&(e.plaintextHash!=null&&r.push(e.hashedPlaintextHash),i.push(e.mediaId))}});var l=t.media.bulkDelete(i),s=t.chunk.where("hashedPlaintextHash").anyOf(r).delete();return o("MAWDexieTable").dexieAll([l,s]).then(function(){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted "," media rows and "," chunk rows"])),i.length,r.length)})})}function d(e,t){return o("MAWDbMsgTxns").getThreadNewestMessageMs(e,t.jid).then(function(n){return e.messages.where("threadJid").equals(t.jid).toArray().then(function(r){return p(e,t,n,r,!0)})})}function m(e,t,n,r){var a=n==null?void 0:n.lastMessageTimestamp;if(n==null)return d(e,t);var i=e.messages.where("threadJid").equals(t.jid).toArray(),l=o("MAWDbMsgTxns").getThreadNewestMessageMs(e,t.jid);return o("MAWDexieTable").dexieAll([i,l]).then(function(i){var l=i[0],s=i[1],u=[],c=new Set;if(a!=null&&l.forEach(function(e){var t,n=(t=e.originalTs)!=null?t:e.ts;n<=a+1&&(c.add(e.msgId),u.push(e))}),(n==null?void 0:n.messages.length)!==0){var d=new Set;n.messages.forEach(function(e){var t;d.add((t=e.key)==null?void 0:t.id)}),l.forEach(function(e){d.has(e.externalId)&&!c.has(e.msgId)&&(c.add(e.msgId),u.push(e))})}if(u.length!==l.length){for(var m of l)if(!c.has(m.msgId)&&m.type!==o("WAMsgType").ADMIN)return p(e,t,s,u,!1,r)}return p(e,t,s,l,!0,r)})}function p(e,t,n,r,a,i){var l=o("WAJids").interpretAsGroupJid(t.jid),s=a?o("MAWDbThreadTxns").deleteThread(e,t.jid):o("MAWDexieTable").dexieResolve(),u=a?o("MAWDbParticipantTxns").deleteAllParticipantsForThread(e,t.jid):o("MAWDexieTable").dexieResolve(),d=o("MAWDexieTable").dexieResolve(!1),m=o("MAWDexieTable").dexieResolve();return l!=null&&a&&(d=o("MAWGroupInviteManagementTxns").deleteGroupInvitesByThread(e,l),m=o("MAWDbGroupInfoTxns").deleteGroupInfo(e,l)),o("MAWDexieTable").dexieAll([c(e,r),o("MAWDbReactionsTxns").deleteAllReactionsForMessages(e,r),o("MAWDbMsgTxns").deleteMessages(e,r,i),s,u,m,d]).then(function(e){var i=e[0],s=e[1],u=e[2],c=e[3],d=e[4],m=e[5],p=e[6];return a&&(o("MAWBridgeEventTransmitter").deleteMessagesOfThreadAfterTxn(t,n),l!=null&&p&&o("MAWIndexedDb").afterTransaction({tag:"DeleteGroupInvite",value:o("MAWBridgeTypesCreators").createBridgeDeleteGroupInvite(t.jid)}),o("MAWIndexedDb").afterTransaction({tag:"ThreadHiddenV2",value:t.jid})),{deletedMessages:r.map(function(e){return o("MAWDbMsg").getWAMsgId(e)})}})}function _(e,t,n,r){var a=o("MAWDbParticipantTxns").bulkRemoveIncorrectAndInsertMissingParticipantsInOneToOneThread(e,t).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:o("MAWBridgeParticipants").createBridgeParticipants(e)})});return o("MAWDexieTable").dexieAll([o("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities([r.jid]),a]).then(function(){return{created:n,thread:r}})}l.getOrSetupOneToOneThread=s,l.getGroupThread=u,l.deleteAllThreadData=d,l.metaSyncChatDeleteThread=m}),98);
__d("WAGroupInviteUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){return e}i.toInviteCode=e}),66);
__d("MAWWriteGroupInviteTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDbParticipant","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLowLevelApiTypes","MAWThreadManagementTxns","MAWUserJidWrapper","WAGroupInviteUtils","WAJids","WAResultOrError","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return o("MAWDbThreadTxns").getThread(e,n).then(function(n){return n.success?o("MAWDbGroupInviteTxns").maybeGetGroupInvite(e,t.threadJid,t.inviteeJid).then(function(n){return n&&!o("WATimeUtils").isInFuture(n.inviteExpirationTs)?o("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.EXISTING_GROUP_INVITE:o("MAWDbGroupInviteTxns").putGroupInvite(e,t)}):o("MAWLowLevelApiTypes").WRITE_GROUP_INVITE_ERROR.MISSING_GROUP})}function s(e,t,n,r){var a=t.caption,i=t.groupJid,l=t.inviteCode,s=t.inviteExpiration,u=o("WAJids").interpretAsUserJid(n);if(i==null||s==null||l==null||u==null)return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError({type:"invalid_args"}));var c=[o("WATimeUtils").castLongIntToUnixTime(s),o("WAJids").toGroupJid(i),o("WAGroupInviteUtils").toInviteCode(l)],d=c[0],m=c[1],p=c[2],_={folder:r,groupJid:m,inviteCode:p,inviteExpireTs:d,inviterJid:u,type:"group_invite"};return o("MAWThreadManagementTxns").getGroupThread(e,m,r,!0).then(function(t){return t==null?o("WAResultOrError").makeError(_):o("MAWDbParticipantTxns").getParticipant(e,t.thread.jid,u)}).then(function(t){if(!t.success)return o("WAResultOrError").makeError(_);var n=o("MAWUserJidWrapper").getMyUserJid(),r=o("MAWDbParticipant").craftParticipantId(t.value.threadJid,n);return o("MAWDbGroupInviteTxns").putGroupInvite(e,{caption:a==null?void 0:a.text,inviteCode:p,invitedParticipantId:r,inviteeJid:n,inviteExpirationTs:d,inviterJid:u,threadJid:t.value.threadJid}).then(function(e){return o("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:o("MAWBridgeTypesCreators").createBridgeGroupInvite(e)}),o("WAResultOrError").makeResult()})})}l.writeGroupInvite=e,l.writeIncomingGroupInviteMsg=s}),98);
__d("MAWWriteGroupPollCreateTxns",["I64","MAWArmadilloPollTableSchema.pb","MAWCurrentUser","MAWDbParticipantTxns","MAWDexieTable","MAWIndexedDb","MAWWriteMsgTxns","WAResultOrError","WATimeUtils","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,r){var a=n.optionsHashed;if(a==null)return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError({type:"invalid_args_poll_option_hashes"}));var i=t.author,l=t.externalId,s=t.ts,d=r.jid;return o("MAWDexieTable").dexieAll([u(e,d,n,i,l),o("MAWWriteMsgTxns").writeNewIncomingMsg(e,t,r)]).then(function(e){var t=e[0],n=e[1];c(t,n.msgId,o("WATimeUtils").castUnixTimeToMillisTime(s))}).then(function(){return o("WAResultOrError").makeResult()})}function u(e,t,n,a,i){var l=n.encKey,s=n.latestSenderTimestampsMs,u=n.name,c=n.optionsHashed,d=n.selectableOptionsCount;return o("MAWDbParticipantTxns").getParticipantsInThread(e,t).then(function(n){var m={chatJid:t,encKey:l,latestSenderTimestampsMs:s,pollAuthor:a,pollOptions:r("nullthrows")(c),pollParticipantCount:n.length,pollStanzaId:i,pollState:o("MAWArmadilloPollTableSchema.pb").POLL_STATE.OPEN,selectableOptionsCount:d,title:u};return e.poll.put(m).then(function(){return m})})}function c(t,n,r){o("MAWIndexedDb").afterTransaction({tag:"NewPoll",value:{contactIdForCurrentUser:(e||(e=o("I64"))).of_string(o("MAWCurrentUser").getID()),dbPoll:t,latestUpdateMsgId:n,latestUpdateTimestampMs:r}})}l.handleIncomingGroupPollCreate=s,l.savePollToDb=u,l.sendPollToUI=c}),98);
__d("MAWDbPollTxns",["MAWIndexedDb","MAWTransactionMode","WAStanzaUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({poll:o("MAWTransactionMode").READONLY},"handleIncomingMessagesStanzas",function(e){return function(t,n){return e.poll.get([t,o("WAStanzaUtils").toStanzaId(n)])}});function s(e,t){return e.poll.put(t).then(function(){return t})}function u(e,t,n){return e.poll.get([t,o("WAStanzaUtils").toStanzaId(n)])}function c(e,t,n){return e.messages.where(["threadJid","pollStanzaId","sortOrderMs"]).between([n,t,Number.MIN_SAFE_INTEGER],[n,t,Number.MAX_SAFE_INTEGER],!1,!1).reverse().first()}l.getDbPoll=e,l.updatePoll=s,l.getPoll=u,l.maybeGetLatestPollUpdateMsg=c}),98);
__d("MAWDbPollUtils",["FBLogger","MAWLocalizationType","WAJids","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,o){var a=e.pollAuthor,i=new Map(e.pollOptions.entries().map(function(e){var n=e[0],o=e[1];return o.optionText==null||!o.voteAuthors.has(t)?null:[n.toString(),r("nullthrows")(o.optionText)]}).filter(Boolean)),l=new Map(o.map(function(e){return[e.hashedOptionName,e.optionName]})),s=o.filter(function(e){return!i.has(e.hashedOptionName)}).map(function(e){return e.optionName}),d=Array.from(i.entries().map(function(e){var t=e[0],n=e[1];return l.has(t)?null:n}).filter(Boolean));if(n.length>0)return s.length>0||d.length>0?u(e,a):c(e,t,n);if(s.length>0)return d.length===0?p(e,t,s):s.length===d.length?g(e,t,s):u(e,a);if(d.length>0)return C(e,t,d);throw r("FBLogger")("messenger_web").mustfixThrow("Not a valid update for poll")}function s(e){if(e===o("WAJids").AUTHOR_SYSTEM||e===o("WAJids").AUTHOR_ME)throw r("FBLogger")("messenger_web").mustfixThrow("Not a valid author for poll vote");return o("WAJids").userIdFromJid(e)}function u(e,t){var n=t===o("WAJids").AUTHOR_ME;return n?{adminMsgContent:[e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_MIXED_POLL_UPDATE,version:1}:{adminMsgContent:[s(t),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_MIXED_POLL_UPDATE,version:1}}function c(e,t,n){return n.length===1?d(e,t,n[0]):m(e,t,n[0],n.length)}function d(e,t,n){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_OPTION,version:1}:{adminMsgContent:[s(t),n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_OPTION,version:1}}function m(e,t,n,r){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_OPTIONS,version:1}:{adminMsgContent:[s(t),n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_OPTIONS,version:1}}function p(e,t,n){return n.length===1?_(e,t,n[0]):f(e,t,n[0],n.length)}function _(e,t,n){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_POLL_VOTE,version:1}:{adminMsgContent:[s(t),n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_POLL_VOTE,version:1}}function f(e,t,n,r){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_ADDED_MULTIPLE_POLL_VOTES,version:1}:{adminMsgContent:[s(t),n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_ADDED_MULTIPLE_POLL_VOTES,version:1}}function g(e,t,n){return n.length===1?h(e,t,n[0]):y(e,t,n[0],n.length)}function h(e,t,n){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CHANGED_POLL_VOTE,version:1}:{adminMsgContent:[s(t),n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CHANGED_POLL_VOTE,version:1}}function y(e,t,n,r){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_CHANGED_MULTIPLE_POLL_VOTES,version:1}:{adminMsgContent:[s(t),n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_CHANGED_MULTIPLE_POLL_VOTES,version:1}}function C(e,t,n){return n.length===1?b(e,t,n[0]):v(e,t,n[0],n.length)}function b(e,t,n){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_POLL_VOTE,version:1}:{adminMsgContent:[s(t),n,e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_POLL_VOTE,version:1}}function v(e,t,n,r){return t===o("WAJids").AUTHOR_ME?{adminMsgContent:[n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.CURRENT_USER_REMOVED_MULTIPLE_POLL_VOTES,version:1}:{adminMsgContent:[s(t),n,r.toString(),e.title],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.PARTICIPANT_REMOVED_MULTIPLE_POLL_VOTES,version:1}}l.getAdminMessageForUpdate=e}),98);
__d("MAWWriteGroupPollMessageTxns",["FBLogger","I64","MAWCurrentUser","MAWDbPoll","MAWDbPollTxns","MAWDbPollUtils","MAWDexieTable","MAWGroupPollsDualEncryptionUtils","MAWIndexedDb","MAWMsgType","MAWWriteMsgTxns","WALongInt","WAResultOrError","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,r,a){var i,l=r.decrypted,s=r.encryptedMessage,d=n.author,m=(i=s.pollCreationMessageKey)==null?void 0:i.id;return m==null||d==null||l==null?o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError({type:"invalid_args_poll_update_message"})):o("MAWDbPollTxns").getPoll(t,a.jid,m).then(function(r){if(r==null)return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError({type:"missing_poll_for_update"}));var i=u(r,l),s=i.optionsToAdd,p=i.selectedOptions,_=o("MAWDbPollUtils").getAdminMessageForUpdate(r,d,s,p),f=o("WAStanzaUtils").toStanzaId(m),g=babelHelpers.extends({},n,{msgContent:_,pollStanzaId:f,type:o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE});return o("MAWDexieTable").dexieAll([c(t,r,d,l),o("MAWWriteMsgTxns").writeNewIncomingMsg(t,g,a)]).then(function(n){var r=n[0],i=n[1];return o("MAWDbPollTxns").maybeGetLatestPollUpdateMsg(t,f,a.jid).then(function(t){var n,a;return o("MAWIndexedDb").afterTransaction({tag:"NewPoll",value:{contactIdForCurrentUser:(e||(e=o("I64"))).of_string(o("MAWCurrentUser").getID()),dbPoll:r,latestUpdateMsgId:(n=t==null?void 0:t.msgId)!=null?n:i.msgId,latestUpdateTimestampMs:o("WATimeUtils").castUnixTimeToMillisTime((a=t==null?void 0:t.ts)!=null?a:i.ts)}}),o("WAResultOrError").makeResult()})})})}function u(e,t){var n,r=t.optionsToAdd,a=t.vote,i=e.pollOptions,l=((n=a==null?void 0:a.selectedOptions)!=null?n:[]).map(function(e){var t,n=o("MAWGroupPollsDualEncryptionUtils").getBase64EncodedHash(e),r=(t=i.get(n))==null?void 0:t.optionText;return r==null?null:{hashedOptionName:o("MAWDbPoll").convertOptionHashToString(n),optionName:r}}).filter(Boolean);return{optionsToAdd:(r!=null?r:[]).map(function(e){return e.optionName}),selectedOptions:l}}function c(e,t,n,a){var i,l,s=a.optionsToAdd,u=a.vote,c=t.pollOptions,p=s;d(p,c);var _=o("WALongInt").maybeNumber((i=u==null?void 0:u.senderTimestampMs)!=null?i:0);if(_!=null&&_>((l=t.latestSenderTimestampsMs.get(n))!=null?l:0)){t.latestSenderTimestampsMs.set(n,o("WATimeUtils").castToMillisTime(_));var f=u;m(f,c,n)}else _===0?r("FBLogger")("GroupPollsE2EE").warn("Poll vote message doesn't have a timestamp"):_==null?r("FBLogger")("GroupPollsE2EE").warn("Poll vote message timestamp is not a valid number"):_===0?r("FBLogger")("GroupPollsE2EE").mustfix("Poll vote message doesn't have a timestamp"):_==null?r("FBLogger")("GroupPollsE2EE").mustfix("Poll vote message timestamp is not a valid number"):r("FBLogger")("GroupPollsE2EE").info("Dropping poll vote message since we already have a newer vote message from this author %s",n);var g=babelHelpers.extends({},t,{pollOptions:c});return o("MAWDbPollTxns").updatePoll(e,g).then(function(){return t})}function d(e,t){e==null||e.forEach(function(e){var n=e.hashedOptionName,r={optionText:e.optionName,voteAuthors:new Set},o=t.get(n);o==null?t.set(n,r):o.optionText===void 0&&t.set(n,{optionText:e.optionName,voteAuthors:o.voteAuthors})})}function m(e,t,n){t.values().forEach(function(e){e.voteAuthors.delete(n)}),e==null||e.selectedOptions.forEach(function(e){var r,a=o("MAWGroupPollsDualEncryptionUtils").getBase64EncodedHash(e);if(!t.has(a)){var i={optionText:void 0,voteAuthors:new Set};t.set(a,i)}(r=t.get(a))==null||r.voteAuthors.add(n)})}l.handleGroupPollUpdate=s,l.writeIncomingGroupPollUpdateMsg=c}),98);
__d("MAWDbReceiverFetchTxns",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e.receiverFetchInfo.get({receiverFetchId:t})}i.maybeGetReceiverFetchInfoFromReceiverFetchId=e}),66);
__d("MAWWriteReceiverFetchTxns",["FBLogger","MAWBridgeReceiverFetchInfo","MAWDbReceiverFetchTxns","MAWDexieTable","MAWIndexedDb","WALogger","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n,a,i,l){return o("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(e,l.receiverFetchId).then(function(s){if(s==null)return e.receiverFetchInfo.add(l).then(function(){o("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:o("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromUnstoredInfo(t,n,a,i,l)})}).catch(function(e){r("FBLogger")("messenger_web_media").mustfix("Failed to add receiver fetch info to db, error: %s",e.message)});var u=babelHelpers.extends({},s,l);return e.receiverFetchInfo.update(l.receiverFetchId,u).then(function(){o("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:o("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromDbInfo(t,n,a,i,u)})}).catch(function(e){r("FBLogger")("messenger_web_media").mustfix("Failed to update receiver fetch info in db, error: %s",e.message)})})}function u(t,n,a,i,l,s,u,c,d){return o("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(t,i).then(function(m){var p=m;if(p==null){if(d==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Receiver fetch info not found for receiver fetch id: ",""])),i),o("MAWDexieTable").dexieResolve();p={mimetype:s,previewHeight:u,previewWidth:c,receiverFetchId:i,type:d}}var _=babelHelpers.extends({},p,{accessibilitySummaryText:l!=null?l:void 0,previewUrl:n,previewUrlExpirationTimestampMs:a});return t.receiverFetchInfo.put(_).then(r("emptyFunction")).catch(function(e){r("FBLogger")("messenger_web_media").mustfix("Failed to update receiver fetch info in db, error: %s",e.message)})})}l.handleUnstoredReceiverFetchInfo=s,l.updateReceiverFetchInfoWithPreviewUrl=u}),98);
__d("MAWExpiredXMACleaner",["FBLogger","MAWMsgCleaner","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=null;function c(e){u==null&&(u=new(o("MAWMsgCleaner")).MsgCleaner(e,o("MAWMsgCleaner").CLEANER_TYPE.XMA))}function d(t){if(u==null){var n="Trying to add new addNewExpiredXMACleanerTimestamp before the cleaner is initialized!";throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",""])),n),r("FBLogger")("messenger_web").mustfixThrow(n)}else o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["ExpiredXMACleaner: Adding timestamps backend(",")"])),t),u.update(t)}function m(){return u}function p(){u=null}l.startExpiredXMACleaner=c,l.addNewExpiredXMACleanerTimestamp=d,l.getExpiredXMACleaner_FOR_TESTING_ONLY=m,l.resetExpiredXMACleaner_FOR_TESTING_ONLY=p}),98);
__d("MAWXMAManagementTxns",["FBLogger","MAWDexieTable","MAWMediaManagementTxns","MAWXMAUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a,i){var l=t.unstoredDbXMA,u=t.unstoredFavicon,c=t.unstoredHeaderMedia,d=t.unstoredPreviews;a===void 0&&(a=!1),i===void 0&&(i="wa-incoming");var m=new Map,p=function(r){return r!=null?o("MAWMediaManagementTxns").handleUnstoredDbMedia(e,r,n,i,!0).then(function(e){return[r.plaintextHash,e]}):o("MAWDexieTable").dexieResolve([void 0,void 0])};a||(m.set(u==null?void 0:u.plaintextHash,p(u)).set(c==null?void 0:c.plaintextHash,p(c)),d==null||d.forEach(function(e){m.set(e==null?void 0:e.plaintextHash,p(e))}));var _=Array.from(m.values());return o("MAWDexieTable").dexieAll(_).then(function(t){var i=new Map(t),m=(d!=null?d:[]).map(function(e){return i.get(e.plaintextHash)}).filter(Boolean);return s(e,a?o("MAWXMAUtils").buildUnstoredTombstonedXMA(l):l,i.get(u==null?void 0:u.plaintextHash),i.get(c==null?void 0:c.plaintextHash),m,n,r).then(function(e){return{dbMedias:t.map(function(e){var t=e[0],n=e[1];return n}).filter(Boolean),dbXMA:e,firstPreview:m[0]}})})}function s(e,t,n,o,a,i,l){var s,u,c=babelHelpers.extends({},t,{associatedMessageId:l!=null?l:void 0,defaultPreviewMediaId:(s=a[0])==null?void 0:s.mediaId,defaultPreviewMediaPlaintextHash:(u=a[0])==null?void 0:u.plaintextHash,faviconMediaId:n==null?void 0:n.mediaId,faviconPlaintextHash:n==null?void 0:n.plaintextHash,headerMediaId:o==null?void 0:o.mediaId,headerMediaPlaintextHash:o==null?void 0:o.plaintextHash,msgId:i.msgId,previewMediaIds:a.map(function(e){return e.mediaId})});return e.xma.add(c).then(function(t){return e.xma.get(t)}).then(function(e){if(e==null)throw r("FBLogger")("messenger_web").mustfixThrow("Failed to write XMA to db");return e})}function u(e,t,n,r,a,i,l,s,u,c,d,m,p){var _=o("MAWXMAUtils").isXMAExpired(!1,u.targetExpiringAtSec),f=babelHelpers.extends({},u,{associatedMessageId:l!=null?l:void 0,author:s.author,externalId:s.externalId,isTombstoned:_,msgId:i,offlineAttachmentId:c,targetType:a,threadJid:s.chat}),g=_?f:babelHelpers.extends({},f,{defaultPreviewMediaId:t!=null?t:void 0,defaultPreviewMediaPlaintextHash:d!=null?d:void 0,faviconMediaId:r!=null?r:void 0,faviconPlaintextHash:p!=null?p:void 0,headerMediaId:n!=null?n:void 0,headerMediaPlaintextHash:m!=null?m:void 0,previewMediaIds:t!=null?[t]:[]});return e.xma.add(g).then(function(e){return babelHelpers.extends({},g,{xmaId:e})})}l.handleUnstoredXMAContent=e,l.saveXMA=u}),98);
__d("MAWWriteXMAMessageTxns",["FBLogger","MAWBridgeMsg","MAWDbXMATxns","MAWDexieTable","MAWExpiredXMACleaner","MAWHandleXmaTransactionUtil","MAWIndexedDb","MAWMsgType","MAWWriteMsgTxns","MAWXMAManagementTxns","MAWXMAUtils","MWPBumpEntityKey","WAJids","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=6*o("WATimeUtils").HOUR_SECONDS,s=new Set([o("MAWMsgType").MSG_TYPE.TEXT,o("MAWMsgType").MSG_TYPE.GIF,o("MAWMsgType").MSG_TYPE.STICKER]);function u(e,t,n,r){var a=n.unstoredAssociatedMedia,i=n.unstoredAssociatedMsg,l=n.unstoredDbXMA;return o("MAWDbXMATxns").maybeGetAssociatedXMAMsg(e,i,r.jid).then(function(n){var s=t;if(n!=null&&n.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT){var u=n.serverTs,c=n.sortOrderMs,d=n.ts;s=babelHelpers.extends({},t,{serverTs:u,sortOrderMs:c!=null?c-1:c,ts:d})}var m=[l.targetExpiringAtSec,l.targetType],p=m[0],_=m[1];o("MAWXMAUtils").isXMAStoryReaction(_)&&(i==null?void 0:i.msgContent)!=null&&(s=babelHelpers.extends({},t,{msgContent:i.msgContent}));var f=o("MAWXMAUtils").isXMAExpired(l.isTombstoned,p);s.isExpiredXmaMsg=f;var g=!o("MAWXMAUtils").isXMAStoryReaction(_)&&i!=null?o("MAWWriteMsgTxns").prepareMsgWriteData(e,i,r):o("MAWDexieTable").dexieResolve(null);return o("MAWDexieTable").dexieAll([o("MAWWriteMsgTxns").prepareMsgWriteData(e,s,r),g]).then(function(e){var t=e[0],n=e[1];return{associatedData:n,associatedMedia:a,associatedMsg:i,xmaData:t,xmaMsg:s}})})}function c(e,t,n,r,a){var i=n.unstoredDbXMA,l=[i.targetExpiringAtSec,i.targetType],s=l[0],u=l[1];return t==null||t.type===o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?o("MAWDexieTable").dexieResolve({dbMedias:null,dbXMA:null}):(t.isExpiredXmaMsg!==!0&&s!=null&&o("MAWExpiredXMACleaner").addNewExpiredXMACleanerTimestamp(s),o("MAWXMAUtils").isXMAStoryReaction(u)&&o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(t)}),o("MAWXMAManagementTxns").handleUnstoredXMAContent(e,babelHelpers.extends({},n,{unstoredDbXMA:i}),t,a,t.isExpiredXmaMsg===!0,r).then(function(n){var r=n.dbMedias,a=n.dbXMA,i=n.firstPreview,l=o("MAWDexieTable").dexieResolve();return a!=null&&!o("MAWXMAUtils").isXMAStoryReply(a.targetType)&&t.isExpiredXmaMsg!==!0&&(l=o("MAWHandleXmaTransactionUtil").checkMediaChunkAndHandleXmaAfterTransaction(e,a,i)),l.then(function(){return{dbMedias:r,dbXMA:a}})}))}function d(e,t,n,a,i,l,u,c){var d,m,p,_,f,g;if(!s.has(i.type))throw r("FBLogger")("messenger_web").mustfixThrow("flow check, this message type is not supported for XMA replies: "+i.type);var h=t.author;if(h==="@system")throw r("FBLogger")("messenger_web").mustfixThrow("wrong author of story reply");var y=o("WAJids").interpretAsUserJid(a);if(y==null)throw r("FBLogger")("messenger_web").mustfixThrow("this is a flow check, participant jid can not be null");var C=(d=c==null||(m=c[0])==null?void 0:m.plaintextHash)!=null?d:i.plaintextHash;(l||n==null?void 0:n.defaultPreviewMediaId)!=null&&C==null&&o("MWPBumpEntityKey").bumpEntityKeyWithAppId("maw.reply_attachment_media_missing_plaintext_hash","write_xma_message_txns_handle_xma_reply_msg");var b={author:h===o("WAJids").AUTHOR_ME?y:o("WAJids").AUTHOR_ME,expirationTs:n.targetExpiringAtSec,externalId:n.externalId,mediaId:l||n==null?void 0:n.defaultPreviewMediaId,plaintextHash:l?void 0:C,sourceId:(p=(_=n.defaultCTA)==null?void 0:_.nativeUrl)!=null?p:(f=n.defaultCTA)==null?void 0:f.actionUrl,ts:t.ts,type:o("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:n.targetType},v=babelHelpers.extends({},i,{mediaId:(g=u==null?void 0:u.mediaId)!=null?g:i.mediaId,quote:{content:b,remoteJid:a}});return e.messages.put(v).then(function(){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:l?o("MAWBridgeMsg").createBridgeMsg(v):o("MAWBridgeMsg").createBridgeMsg(v,{replyPlaintextHash:C})})})}l.REVOKE_CONTENT_EXPIRATION_IN_SEC=e,l.XMA_REPLY_MSG_SUPPORTED_TYPES=s,l.prepareXMAWriteData=u,l.handleIncomingXMA=c,l.handleXMAReplyMsg=d}),98);
__d("MAWHandleIncomingMsgApi",["MAWDbMsgTxns","MAWDbPendingStanzaTxns","MAWDbRavenActionTxns","MAWDexieTable","MAWEphemeralAdminMsgBuildTxns","MAWEphemeralMsgTxns","MAWEphemeralSettingsTxns","MAWHIMLogger","MAWJidUtils","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWODSProxy","MAWPendingReceiptProcessingTxns","MAWUpdateIsCollapsedMsgTxns","MAWUpdateQuotedMsgTxns","MAWUseProtocolMsgIdForMsgId","MAWWriteEditTxns","MAWWriteGroupInviteTxns","MAWWriteGroupPollCreateTxns","MAWWriteGroupPollMessageTxns","MAWWriteMsgTxns","MAWWriteReceiverFetchTxns","MAWWriteRevokeMessageTxns","MAWWriteXMAMessageTxns","MAWXMAUtils","MWXMAV2IsCollapsibleXMA","MWXMAV2XmaDataClass","WAGetPlatformFromStanzaId","WAJids","WAOdsEnums","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult(void 0));function d(e,t,n){var a,i;t.receiveFlow.addPoint("him_write_message_start");var l=((a=t==null||(i=t.msg)==null||(i=i.ephemeralSetting)==null?void 0:i.ephemeralExpirationInSec)!=null?a:0)>0;return m(e,t,n).then(function(e){var n,a,i,s;if(t.receiveFlow.addPoint("him_write_message_end",{bool:{isEphemeralMsg:l,outOfSync:(e==null||(n=e.value)==null?void 0:n.outOfSyncEphemeralSetting)!=null},string:{msgWrittenResultType:(a=e==null||(i=e.value)==null?void 0:i.msgType)!=null?a:"unknown"}}),l&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.TOTAL_INCOMING_MESSAGE,key:"ephemeralMsgs"}),(t.action===o("MAWMsgActionType").MSG_ACTION.WRITE||o("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED)&&(e==null||(s=e.value)==null?void 0:s.msgType)===null){var u,c;r("MAWHIMLogger").warn("write action didn't produce result in DB. msg type: "+((u=t==null||(c=t.msg)==null?void 0:c.type)!=null?u:"unknown"))}return e}).catch(function(e){var n;if(e.name==="ConstraintError")return t.type!==o("MAWMsgType").MSG_TYPE.XMA&&r("MAWHIMLogger").mustfix("encounted a ConstraintError for type %s",t.type),o("WAResultOrError").makeError({type:"constraint_error"});throw e.message="[handleIncomingMsg] ["+((n=t.type)!=null?n:"")+"/"+t.action+"] "+e.message,e})}function m(t,n,a){var i;if(n.action===o("MAWMsgActionType").MSG_ACTION.NO_ACTION)return c;var l=function(r,a,i){return o("MAWEphemeralMsgTxns").syncEphemeralSettingOnIncomingMsg(t,r,a,n.thread,i)};switch(n.type){case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:return o("MAWWriteMsgTxns").writeNewIncomingMsg(t,n.msg,n.thread,a,n.stanzaSource).then(function(){return o("WAResultOrError").makeResult(null)});case o("MAWMsgType").MSG_TYPE.RAVEN_ACTION:return o("MAWDbRavenActionTxns").writeRavenActionMsg(t,n.msg,n.thread).then(function(){return o("WAResultOrError").makeResult(null)});case o("MAWMsgType").MSG_TYPE.REACTION:return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult({reactToExternalId:n.msg.reactToExternalId}));case o("MAWMsgType").MSG_TYPE.GROUP_INVITE:return o("WAJids").isAuthorMe(n.id.author)?c:o("MAWWriteGroupInviteTxns").writeIncomingGroupInviteMsg(t,n.msg,n.thread.jid,n.folder);case o("MAWMsgType").MSG_TYPE.TEXT:case o("MAWMsgType").MSG_TYPE.FUTUREPROOF:case o("MAWMsgType").MSG_TYPE.IMAGE:case o("MAWMsgType").MSG_TYPE.VIDEO:case o("MAWMsgType").MSG_TYPE.PTT:case o("MAWMsgType").MSG_TYPE.GIF:case o("MAWMsgType").MSG_TYPE.STICKER:case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:case o("MAWMsgType").MSG_TYPE.RAVEN:case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:case o("MAWMsgType").MSG_TYPE.ADMIN:return n.action===o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME?o("MAWWriteMsgTxns").handleDeleteForMeMessage(t,n.msg,n.thread,n.pendingDeleteForMeStanza).then(function(e){return _(e)}):y(t,n.msg,n.thread.jid).then(function(e){if(e)return c;var r=n.action===o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT?o("MAWWriteMsgTxns").writeCiphertextUpdate(t,n.msg,n.existingMsg,n.thread,n.existingEditMsgHistory,n.stanzaSource):n.action===o("MAWMsgActionType").MSG_ACTION.REVOKE?o("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(t,n.msg,n.thread,n.pendingRevokedStanza,n.pendingRevokedStanza!=null):o("MAWWriteEditTxns").writeNewIncomingMsgAndEditHistory(t,n.msg,n.thread,n.editMsgHistories,a,n.stanzaSource),i=function(r,a){return o("MAWDexieTable").dexieAll([f(t,n.id,r,r.type!==o("MAWMsgType").MSG_TYPE.FUTUREPROOF),l(r,o("MAWJidUtils").getAuthorJid(n.id.author),n.ts)]).then(function(e){var t=e[0],n=e[1];return _(r,n,a==null?null:[a])}).then(function(e){var a={author:r.author,chat:r.threadJid,externalId:r.externalId};return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,a).then(function(e){if(e!=null)return o("MAWUpdateQuotedMsgTxns").associateAllReplies(t,e,n.thread.jid)}).then(function(){return e})})};if(o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId()){var s=n.thread.jid,u=o("MAWJidUtils").formatProtocolMsgIdFromExternalId(s,n.msg.externalId),d=n.type===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH?o("MAWWriteReceiverFetchTxns").handleUnstoredReceiverFetchInfo(t,s,u,n.msg.sortOrderMs,n.msg.ts,n.receiverFetchInfo):o("MAWDexieTable").dexieResolve(),m=n.media!=null?o("MAWMediaManagementTxns").handleUnstoredDbMediaCreation(t,n.media,u,n.msg.type,void 0):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([r,d,m]).then(function(e){var r=e[0],i=e[1],l=e[2];return o("MAWDexieTable").dexieAll([r,l!=null&&n.media!=null?o("MAWMediaManagementTxns").handleUnstoredDbMediaLinking(t,n.media,r,l,void 0,void 0,a):o("MAWDexieTable").dexieResolve()])}).then(function(e){var t=e[0],r=e[1];return t.quote!=null&&n.receiveFlow.addAnnotations({bool:{isQuote:!0},string:{quoteType:t.quote.content.type}}),i(t,r)})}return r.then(function(e){var r=n.type===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH?o("MAWWriteReceiverFetchTxns").handleUnstoredReceiverFetchInfo(t,e.threadJid,e.msgId,e.sortOrderMs,e.ts,n.receiverFetchInfo):o("MAWDexieTable").dexieResolve(),l=n.media!=null?o("MAWMediaManagementTxns").handleUnstoredDbMedia(t,n.media,e,n.stanzaSource,void 0,void 0,void 0,a):o("MAWDexieTable").dexieResolve();return e.quote!=null&&n.receiveFlow.addAnnotations({bool:{isQuote:!0},string:{quoteType:e.quote.content.type}}),o("MAWDexieTable").dexieAll([r,l]).then(function(t){var n=t[0],r=t[1];return i(e,r)})})});case o("MAWMsgType").MSG_TYPE.REVOKED:return o("MAWWriteRevokeMessageTxns").writeIncomingRevokeMsg(t,n.msg,n.thread,n.originalMsg,n.previousRevokeMsg,n.ebTimestampMs).then(function(e){return o("MAWDexieTable").dexieAll([f(t,n.id,e),l(e,o("MAWJidUtils").getAuthorJid(n.id.author),n.ts)]).then(function(t){var n=t[0],r=t[1];return _(e,r)})});case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN:return o("MAWEphemeralSettingsTxns").handleAndWriteIncomingEphemeralSetting(t,o("MAWJidUtils").getAuthorJid(n.id.author),n.msg.ephemeralExpirationInSec,n.msg.ephemeralLastUpdatedOrSetTimestamp,n.msg.isEphemeralSettingReset,n.thread,n.ts,n.id.externalId,!0).then(function(e){return _(null,e==null?void 0:e.outOfSyncEphemeralSetting)});case o("MAWMsgType").MSG_TYPE.ICDC_ALERT:return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult({msgType:void 0,outOfSyncEphemeralSetting:void 0,plaintextHashs:void 0}));case o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION:return o("MAWEphemeralAdminMsgBuildTxns").writeEphemeralScreenshotActionMsg(t,o("MAWJidUtils").getAuthorJid(n.id.author),n.thread,n.ts,n.screenshotActionType,n.id.externalId,n.existingMsg).then(function(e){return o("MAWDexieTable").dexieAll([f(t,n.id,e),l(e,o("MAWJidUtils").getAuthorJid(n.id.author),n.ts)]).then(function(t){var n=t[0],r=t[1];return _(e,r)})});case o("MAWMsgType").MSG_TYPE.XMA:{var s;if(n.action===o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME)return o("MAWWriteMsgTxns").handleDeleteForMeMessage(t,n.msg,n.thread,n.pendingDeleteForMeStanza).then(function(e){return _(e)});var u=o("MWXMAV2XmaDataClass").parseXmaDataClass((s=n.xma)==null?void 0:s.unstoredDbXMA.xmaDataclass),d=n.xma!=null&&o("MWXMAV2IsCollapsibleXMA").isCollapsibleXMA(u)?o("MAWUpdateIsCollapsedMsgTxns").maybeUpdatePreviousCollapsibleMsgs(t,n.msg,u,n.thread.jid):o("MAWDexieTable").dexieResolve(n.msg),m=n.action===o("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED||n.action===o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?g(t,n,a):n.action===o("MAWMsgActionType").MSG_ACTION.REVOKE?p(t,n,a):d.then(function(e){return p(t,babelHelpers.extends({},n,{msg:e}),a).then(function(e){return o("MAWWriteXMAMessageTxns").handleIncomingXMA(t,e,n.xma,n.stanzaSource,null).then(function(t){return babelHelpers.extends({},t,{dbMsg:e})})})});return m.then(function(a){var i=a.dbAssociatedMsg,s=a.dbMedias,u=a.dbMsg;return r("MAWHIMLogger").DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Finished writing the incoming xma, has associated data = ",""])),n.action===o("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED||n.action===o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED),o("MAWDexieTable").dexieAll([f(t,n.id,u,!0,i),l(u,o("MAWJidUtils").getAuthorJid(n.id.author),n.ts)]).then(function(e){var r=e[0],a=e[1];return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,n.id).then(function(e){if(e!=null)return o("MAWUpdateQuotedMsgTxns").associateAllReplies(t,e,n.thread.jid)}).then(function(){return a})}).then(function(e){return _(u,e,s)})})}case o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE:return o("MAWWriteGroupPollCreateTxns").handleIncomingGroupPollCreate(t,n.msg,n.pollInfo,n.thread);case o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE:return o("MAWWriteGroupPollMessageTxns").handleGroupPollUpdate(t,n.msg,n.pollInfo,n.thread);default:throw r("MAWHIMLogger").mustfixThrow("We do not support handleIncomingMsgInternal with type: "+((i=n.type)!=null?i:""))}}function p(e,t,n){return t.action===o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT||t.action===o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED?o("MAWWriteMsgTxns").writeCiphertextUpdate(e,t.msg,t.existingMsg,t.thread,null,t.stanzaSource):t.action===o("MAWMsgActionType").MSG_ACTION.REVOKE?o("MAWWriteMsgTxns").handleOutOfOrderRevokedMessage(e,t.msg,t.thread,t.pendingRevokedStanza,t.pendingRevokedStanza!=null):o("MAWWriteMsgTxns").writeNewIncomingMsg(e,t.msg,t.thread,n,t.stanzaSource)}function _(e,t,n){return o("WAResultOrError").makeResult({msgType:e==null?void 0:e.type,outOfSyncEphemeralSetting:t!=null?t:void 0,plaintextHashs:n==null?void 0:n.map(function(e){return e.plaintextHash})})}function f(e,t,n,a,i){var l=t.author,u=t.chat;if(a===void 0&&(a=!1),n==null||n==null)return o("MAWDexieTable").dexieResolve();var c=o("MAWPendingReceiptProcessingTxns").processPendingReceipts(e,u,n),d=l===o("WAJids").AUTHOR_ME&&i!=null&&i.type!==o("MAWMsgType").MSG_TYPE.DELETE_FOR_ME?o("MAWPendingReceiptProcessingTxns").processPendingReceipts(e,u,i):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([c,d]).then(function(){r("MAWHIMLogger").DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["handleIncomingMsgInternal: Finished writing the incoming message"])))})}function g(e,t,n){n===void 0&&(n=!0),t.associatedMsg.externalId===t.msg.externalId&&r("MAWHIMLogger").tags(["XMA"]).mustfix("associatedMsg and msg have the same externalId, platform %s",o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(t.msg.externalId));var a=t.existingAssociatedMsg,i;return a!=null?a.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT?i=o("MAWWriteMsgTxns").writeCiphertextUpdate(e,t.associatedMsg,a,t.thread,null,t.stanzaSource):i=o("MAWDexieTable").dexieResolve(a):i=o("MAWWriteMsgTxns").writeNewIncomingMsg(e,t.associatedMsg,t.thread,n,t.stanzaSource),i.then(function(r){return r.type===o("MAWMsgType").MSG_TYPE.REVOKED?o("MAWDexieTable").dexieResolve({dbAssociatedMsg:null,dbMedias:null,dbMsg:null}):p(e,t,n).then(function(n){return t.associatedMedia!=null?o("MAWMediaManagementTxns").handleUnstoredDbMedia(e,t.associatedMedia,r,t.stanzaSource).then(function(o){return h(e,n,r,t.xma,t.msg,t.associatedMsg,t.thread.jid,t.stanzaSource,o)}):h(e,n,r,t.xma,t.msg,t.associatedMsg,t.thread.jid,t.stanzaSource)})})}function h(e,t,n,a,i,l,s,c,d){return o("MAWWriteXMAMessageTxns").handleIncomingXMA(e,t,a,c,n.msgId).then(function(a){var c=a.dbMedias,m=a.dbXMA;return n==null&&r("MAWHIMLogger").MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Could not write dbAssociatedMsg but it exists: ",""])),l.externalId),(n!=null&&m!=null&&o("MAWXMAUtils").isXMAStoryReply(m.targetType)?o("MAWWriteXMAMessageTxns").handleXMAReplyMsg(e,i,m,s,n,i.isExpiredXmaMsg===!0,d,c):o("MAWDexieTable").dexieResolve()).then(function(){return d!=null?{dbAssociatedMsg:n,dbMedias:c!=null?[].concat(c,[d]):[d],dbMsg:t}:{dbAssociatedMsg:n,dbMedias:c,dbMsg:t}})})}function y(e,t,n){var r,a;if(t.type!==o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE)return o("MAWDexieTable").dexieResolve(!1);var i=(r=t.quote)==null||(r=r.content)==null?void 0:r.externalId,l=(a=t.quote)==null?void 0:a.content.author;if(i==null||l==null)return o("MAWDexieTable").dexieResolve(!1);var s=o("MAWJidUtils").maybeToProtocolMsgId(l,n,i);return o("MAWDexieTable").dexieAll([e.deletedMessages.get(babelHelpers.extends({},s)),e.unrenderedMessages.get({externalId:i}),o("MAWDbPendingStanzaTxns").maybeGetPendingRevokedStanza(e,i,l,n),o("MAWDbPendingStanzaTxns").maybeGetPendingDeletedStanza(e,i,l,n)]).then(function(e){var t=e[0],r=e[1],o=e[2],a=e[3],i=r!=null&&r.author===l&&r.threadJid===n;return t!=null||i||o!=null||a!=null})}l.handleIncomingMsg=d,l.processReceipts=f}),98);
__d("MAWLinkReactionsToMsgsTxns",["MAWDbMsgTxns","WAMsgMap"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.reduce(function(e,t){var n,r={author:t.reactToAuthor,chat:t.threadJid,externalId:t.reactToExternalId},o=(n=e.get(r))!=null?n:[];return o.push(t),e.set(r,o)},new(o("WAMsgMap")).MsgMap)}function s(t,n){return t.reactions.where("reactToExternalId").anyOf(n).toArray().then(function(t){return e(t.filter(function(e){return e.reactToMsgId==null}))})}function u(e,t){return s(e,t).then(function(t){return o("MAWDbMsgTxns").getMsgsByProtocolMsgId(e,t.keys()).then(function(e){return e.flatMap(function(e){var n,r={author:e.author,chat:e.threadJid,externalId:e.externalId},o=(n=t.get(r))!=null?n:[];return o.map(function(t){return t.reactToMsgId=e.msgId,t})})})})}function c(e,t){return e.reactions.bulkPut(t).then(function(){})}l.getReactionLinkUpdatesForExternalIds=u,l.updateReactionLinks=c}),98);
__d("MAWOfflineThreadTxns",["I64","MAWBridgeThread","MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbThread","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWThreadMappingQPL","MAWUserJidWrapper","MAWWriteBulkWriteIncomingAdminMsgTxns","MWFBLogger","WAArrayZip","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=new Set;function c(t,n,r){var a=[],i=new Set(n),l=new Map,s=new Map;return r.forEach(function(e){s.set(e.jid,"exists"),l.set(e.jid,e),i.delete(e.jid),a.push(e)}),i.forEach(function(t){u.has(t)&&o("MWFBLogger").MWLogger().tags(["occamadillo","incoming_processing"]).DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Duplicated thread creation for ",""])),t)}),f(t,i).then(function(e){return e.oneToOneThreadsCreationData.forEach(function(e){u.add(e.thread.jid)}),e.groupThreadsCreationData.forEach(function(e,t){u.add(t),e.groupInfo==null&&s.set(t,"missing")}),t.threads.bulkAdd(g(e),{allKeys:!0}).then(function(){return o("MAWDbThreadTxns").getThreads(t,Array.from(i.values())).then(function(e){e.forEach(function(e){return l.set(e.jid,e)}),a.push.apply(a,e),p(a);var n=h(e);return o("MAWDexieTable").dexieAll([d(t,n),o("MAWWriteBulkWriteIncomingAdminMsgTxns").writeE2EEAdminMsgsForIncomingCreatedThreadsWithAfterTxns(t,e)])}).then(function(){return{threadCreationResult:s,threads:l}})})})}function d(e,t){return o("MAWDexieTable").dexieAll([m(e,t),o("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities(Array.from(t.values()).map(function(e){return e.jid}))])}function m(e,t){var n=[],a=o("MAWUserJidWrapper").getMyUserJid();return t.forEach(function(e,t){n.push({chatJid:t,type:"participant",userJid:t}),a!==t&&n.push({chatJid:t,type:"participant",userJid:a})}),o("MAWDbParticipantTxns").bulkAddParticipantsInThreads(e,n).then(r("emptyFunction"))}function p(e){e.forEach(function(e){var t=o("MAWThreadMappingQPL").getInstanceKeyForJidInWorker(e.jid);o("MAWThreadMappingQPL").startInWorker({instanceKey:t,jid:e.jid,threadKey:e.optimisticThreadKey==null?void 0:(s||(s=o("I64"))).of_string(e.optimisticThreadKey),trigger:"createAllThreadsForOfflineMsgs"}),o("MAWThreadMappingQPL").addPoint("verify_optimistic_maw_thread",t),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(e,e.optimisticThreadKey,e.authoritativeThreadKey,"createAllThreadsForOfflineMsgs",t)})})}function _(e,t){return{folder:null,jid:e,lastReadMsg:null,lastReadMsgReceiptSent:null,lastReadMsgTs:null,newestMsgTs:t!=null?o("WATimeUtils").castUnixTimeToMillisTime(t):null,oldestMsg:null,optimisticThreadKey:void 0,threadOrder:o("MAWDbThread").craftThreadOrder(o("WATimeUtils").millisTime(),e)}}function f(e,t){var n=[],r=[];return t.forEach(function(e){o("WAJids").switchOnMsgrChatJidType(e,{group:function(t){return n.push(t)},user:function(t){return r.push(t)}})}),o("MAWDbGroupInfoTxns").getGroupInfos(e,n).then(function(e){var t=new Map(o("WAArrayZip").zip(n,e)),a=new Map(n.map(function(e){var n=t.get(e);return[e,{groupInfo:n,thread:_(e,n==null?void 0:n.creationTs)}]})),i=new Map(r.map(function(e){return[e,{thread:_(e,null)}]}));return{groupThreadsCreationData:a,oneToOneThreadsCreationData:i}})}function g(e){var t=e.groupThreadsCreationData,n=e.oneToOneThreadsCreationData;return Array.from(t.values()).map(function(e){var t=e.thread;return t}).concat(Array.from(n.values()).map(function(e){var t=e.thread;return t}))}function h(e){var t=new Map;return e.forEach(function(e){o("WAJids").switchOnMsgrChatJidType(e.jid,{group:r("emptyFunction"),user:function(r){return t.set(r,e)}})}),t}l.createAllThreadsForOfflineMsgs=c}),98);
__d("MAWPreprocessMsgs",["LSMEBTaskCreationSource","MAWBuildIncomingMsgs","MAWDbMsgTxns","MAWDexieTable","MAWHIMLogger","MAWMediaGalleryEBTaggingUtils","MAWMediaManagementTxns","MAWMsgActionType","MAWMsgType","MAWWriteMsgTxns","MAWWriteXMAMessageTxns","WAGlobals","WAJids"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=r("MAWHIMLogger").tags(["MAWPreprocessMsgs"]);function p(t){var n=[],r=[];return t.forEach(function(t){var o=t.msgData,a=t.unstoredContent;switch(o.type){case"IncomingMsg":{if(a==null){m.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["No unstored content for incoming message: SHOULD NEVER HAPPEN"])));return}var i=a.unstoredDbEditActionMsg,l=a.unstoredDbReaction;if(l!=null){var s={chatJid:o.id.chat,unstoredReaction:l};n.push(s)}i!=null&&r.push({chatJid:o.id.chat,msg:i});break}case"IncomingCiphertextMsg":default:break}}),{editActionMsgs:r,reactionMsgs:n}}function _(e,t,n,r){return t.receiveFlow.addPoint("him_get_preprocessing_data_start"),f(e,t,n,r).then(function(e){var n;return t.receiveFlow.addPoint("him_get_preprocessing_data_end",{string:{action:e.action,type:(n=e.type)!=null?n:""}}),e})}function f(e,t,n,a){var i=t.msgData,l=t.receiveFlow,p=t.stanzaSource,_=t.unstoredContent,f=i.folder,h=i.id,y=i.ts,C={id:h,receiveFlow:l,stanzaSource:p,thread:n,ts:y},b=o("MAWDexieTable").dexieResolve(babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.NO_ACTION,msg:null,type:null}));switch(i.type){case"IncomingMsg":{if(_==null)return b;var v=_.unstoredDbGroupPollCreateInfo,S=_.unstoredDbGroupPollUpdateInfo,R=_.unstoredDbMsg,L=_.unstoredDbRavenActionMsg,E=_.unstoredDbReaction,k=_.unstoredDbReceiverFetchInfo,I=_.unstoredIncomingDbGroupInvite;if(L!=null)return o("MAWDexieTable").dexieResolve(babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:L,type:o("MAWMsgType").MSG_TYPE.RAVEN_ACTION}));if(E!=null)return o("MAWDexieTable").dexieResolve(babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:E,type:o("MAWMsgType").MSG_TYPE.REACTION}));if(I!=null)return o("MAWDexieTable").dexieResolve(babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,folder:f,msg:I,type:o("MAWMsgType").MSG_TYPE.GROUP_INVITE}));if(R==null)return b;if(R.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_ADMIN){var T=i.msg;return T.version==="v3"&&T.type==="ephemeral"?o("MAWDexieTable").dexieResolve(babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:T,type:R.type})):(m.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Unexpected msg type when writing ephemeral setting message. Should not happen"]))),b)}else{if(R.type===o("MAWMsgType").MSG_TYPE.TEXT||R.type===o("MAWMsgType").MSG_TYPE.FUTUREPROOF||R.type===o("MAWMsgType").MSG_TYPE.ADMIN)return o("MAWWriteMsgTxns").prepareTextMsgWriteData(e,R,n).then(function(e){var t=e.editMsgHistories,n=e.existingEditMsgHistory,r=e.existingMsg,a=e.isDeletedWithThread,i=e.isDeleteForMeOrRevoked,l=e.pendingDeleteForMeStanza,s=e.pendingRevokedStanza,u=g(r,R,n);return i||a||r!=null&&u!==!0?b:u&&r!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingEditMsgHistory:n,existingMsg:r,msg:R,type:R.type}):l!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:R,pendingDeleteForMeStanza:l,type:R.type}):s!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.REVOKE,msg:R,pendingRevokedStanza:s,type:R.type}):babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,editMsgHistories:t,msg:p==="ebrestore"?babelHelpers.extends({},R,{source:"eb_restore"}):R,type:R.type})});if(R.type===o("MAWMsgType").MSG_TYPE.IMAGE||R.type===o("MAWMsgType").MSG_TYPE.VIDEO||R.type===o("MAWMsgType").MSG_TYPE.PTT||R.type===o("MAWMsgType").MSG_TYPE.GIF||R.type===o("MAWMsgType").MSG_TYPE.STICKER||R.type===o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE||R.type===o("MAWMsgType").MSG_TYPE.RAVEN){var D,x;return R.type===o("MAWMsgType").MSG_TYPE.IMAGE&&((D=i.msg.metadata)==null?void 0:D.groupId)!=null&&(R.groupId=i.msg.metadata.groupId,R.groupIndex=i.msg.metadata.groupIndex,R.groupSize=i.msg.metadata.groupSize),R.type===o("MAWMsgType").MSG_TYPE.IMAGE&&(_==null||(x=_.unstoredDbMedia)==null||(x=x.validatedImageInfo)==null?void 0:x.hdType)!=null&&(R.hdType=_==null?void 0:_.unstoredDbMedia.validatedImageInfo.hdType),m.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Preparing media for msg with StanzaID ",""])),R.externalId),o("MAWMediaManagementTxns").prepareMediaWriteData(e,R,_==null?void 0:_.unstoredDbMedia,n).then(function(e){var t=e.existingMsg,n=e.isDeletedWithThread,i=e.isDeleteForMeOrRevoked,l=e.pendingDeleteForMeStanza,s=e.pendingRevokedStanza,u=e.shouldDropDocument,d=[_==null?void 0:_.unstoredDbMedia,g(t,R)],f=d[0],h=d[1];if(f==null&&m.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Media is null for StanzaID ",""])),R.externalId),p==="ebrestore"&&t!=null&&f!=null&&t.source==="media_restore"&&(!o("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled()||a!==r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE)){var y=!o("MAWMediaGalleryEBTaggingUtils").isMediaGalleryEBTaggingRestoreEnabled()&&a===r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE?"media_restore":"eb_restore";return babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingMsg:t,media:f,msg:babelHelpers.extends({},R,{source:y}),type:R.type})}return u===!0||i||n||f==null||t!=null&&!h?b:h&&t!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingMsg:t,media:f,msg:R,type:R.type}):l!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:R,pendingDeleteForMeStanza:l,type:R.type}):s!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.REVOKE,msg:R,pendingRevokedStanza:s,type:R.type}):babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,media:f,msg:p==="ebrestore"?babelHelpers.extends({},R,{source:a===r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE?"media_restore":"eb_restore"}):R,type:R.type})})}else if(R.type===o("MAWMsgType").MSG_TYPE.XMA){var $=_==null?void 0:_.unstoredXMA;return $==null?b:o("MAWWriteXMAMessageTxns").prepareXMAWriteData(e,R,$,n).then(function(e){var t=e.xmaData.existingMsg,n=g(t,R),r=p==="ebrestore"?babelHelpers.extends({},e.xmaMsg,{source:"eb_restore"}):e.xmaMsg;if(e.associatedMsg!=null&&e.associatedData!=null&&!e.associatedData.isDeletedWithThread&&!e.associatedData.isDeleteForMeOrRevoked){var a,i=e.associatedMsg,l=e.associatedData.existingMsg;if(n&&t!=null)return babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED,associatedMsg:i,existingAssociatedMsg:l,existingMsg:t,msg:r,type:R.type,xma:$});if(t!=null&&e.associatedData.existingMsg!=null)return b;if([t,(a=e.associatedData)==null?void 0:a.existingMsg].filter(function(e){return e==null}).length===1){var s,u,c,d,_,f,h,y;m.mustfix("[duplicate msgs] XMA and associated inconsistency: existing message not found for %s, xmaMessageType: %s, authorMe: %s, xma data: existingMsgType: %s, isDeletedWithThread: %s, isDeleteForMeOrRevoked: %s, hasPendingDeleteForMeStanza: %s, hasPendingRevokedStanza: %s, associated data: existingMsgType: %s, isDeletedWithThread: %s, isDeleteForMeOrRevoked: %s, hasPendingDeleteForMeStanza: %s, hasPendingRevokedStanza: %s",t==null?"XMA":"Associated",r==null?void 0:r.xmaMessageType,o("WAJids").isAuthorMe(r==null?void 0:r.author),t==null?void 0:t.type,(s=e.xmaData)==null?void 0:s.isDeletedWithThread,(u=e.xmaData)==null?void 0:u.isDeleteForMeOrRevoked,((c=e.xmaData)==null?void 0:c.pendingDeleteForMeStanza)!=null,((d=e.xmaData)==null?void 0:d.pendingRevokedStanza)!=null,l==null?void 0:l.type,(_=e.associatedData)==null?void 0:_.isDeletedWithThread,(f=e.associatedData)==null?void 0:f.isDeleteForMeOrRevoked,((h=e.associatedData)==null?void 0:h.pendingDeleteForMeStanza)!=null,((y=e.associatedData)==null?void 0:y.pendingRevokedStanza)!=null)}return babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED,associatedMedia:e.associatedMedia,associatedMsg:i,existingAssociatedMsg:l,msg:r,type:R.type,xma:$})}if(n&&t!=null)return babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT,existingMsg:t,msg:r,type:R.type,xma:$});var v=e.xmaData,S=v.isDeletedWithThread,L=v.isDeleteForMeOrRevoked,E=v.pendingDeleteForMeStanza,k=v.pendingRevokedStanza;return S||L||t!=null?b:E!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME,msg:e.xmaMsg,pendingDeleteForMeStanza:E,type:R.type}):k!=null?babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.REVOKE,msg:e.xmaMsg,pendingRevokedStanza:k,type:R.type}):babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:r,type:R.type,xma:$})})}else{if(R.type===o("MAWMsgType").MSG_TYPE.REVOKED)return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,R.revokedExternalId,n.jid,h.author),o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,R.externalId,n.jid,h.author)]).then(function(e){var t=e[0],n=e[1];return n!=null?b:babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,ebTimestampMs:R.ebTimestampMs,msg:R,originalMsg:t,previousRevokeMsg:n,type:R.type})});if(R.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SCREENSHOT_ACTION){var P=o("WAJids").isAuthorMe(h.author)?o("WAGlobals").getMyUserJid():h.author;return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,h.externalId,n.jid,P)]).then(function(e){var t=e[0];return babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,existingMsg:t,screenshotActionType:R.msgContent.screenshotActionType,type:R.type})})}else return R.type===o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE?o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,h.externalId,n.jid,h.author).then(function(e){return e!=null?b:babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:R,type:R.type})}):R.type===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH&&k!=null?o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,h.externalId,n.jid,h.author).then(function(e){return e!=null?b:babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:R,receiverFetchInfo:k,type:R.type})}):R.type===o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE?o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,h.externalId,n.jid,h.author).then(function(e){return e!=null||v==null?b:babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:R,pollInfo:v,type:R.type})}):R.type===o("MAWMsgType").MSG_TYPE.GROUP_POLL_UPDATE?S==null||S.decrypted===void 0?b:o("MAWDexieTable").dexieResolve(babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:R,pollInfo:S,type:R.type})):(m.MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Unsupported message type on preprocessing ",""])),R.type),b)}}}case"IncomingCiphertextMsg":{var N;if(!((N=i==null?void 0:i.createPlaceholder)!=null&&N))return b;var M=o("MAWBuildIncomingMsgs").buildUnstoredCiphertextMsg(h,y);return o("MAWWriteMsgTxns").prepareMsgWriteData(e,M,n).then(function(e){var t=e.existingMsg,n=e.isDeletedWithThread,r=e.isDeleteForMeOrRevoked;return r||n||t!=null?b:babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:M,type:o("MAWMsgType").MSG_TYPE.CIPHERTEXT})})}case"UnavailableMsg":case"FrankingInvalidMsg":{var w=o("MAWBuildIncomingMsgs").buildUnstoredUnavailableMsg(h,y);return o("MAWWriteMsgTxns").prepareMsgWriteData(e,w,n).then(function(e){var t=e.existingMsg,n=e.isDeletedWithThread,r=e.isDeleteForMeOrRevoked;return r||n||t!=null?b:babelHelpers.extends({},C,{action:o("MAWMsgActionType").MSG_ACTION.WRITE,msg:w,type:o("MAWMsgType").MSG_TYPE.UNAVAILABLE})})}}}function g(e,t,n){return e==null&&n==null||t.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT?!1:(e==null?void 0:e.type)===o("MAWMsgType").MSG_TYPE.CIPHERTEXT||(n==null?void 0:n.msgContent.content)===""}l.classifyIncomingMsgs=p,l.getMessageDataByType=_,l.isCiphertextUpdate=g}),98);
__d("MAWSharedOfflineResumeUINotifier",["MAWBridge","MAWQplProxy","MAWSharedProtocolQueueConst","MWFBLogger","WAOfflineUtils","WAThrottle","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=333.3333333333333,m=o("MWFBLogger").MWLogger().tags(["ProtocolQueue","MAWConsumer"]),p=(function(){function t(){var e=this;this.$1={},this.$2={},this.$3=0,this.$4="wa",this.$5=!1,this.$6=0,this.$7=0,this.$8=0,this.$9=0,this.$10=null,this.$16=o("WAThrottle").throttle(function(){e.$5||e.$15(o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)},d),this.$12=o("WAThrottle").throttle(function(){e.$4==="wa"&&e.$5===!1&&e.$11(o("WAOfflineUtils").WAClientInfraOfflineProgress.Processing)},d)}var n=t.prototype;return n.subscribeToWAEvents=function(t){var e=this;t.subscribe(function(t){switch(t.type){case"offline-start":{e.$10=o("MAWQplProxy").performanceAbsoluteNow(),e.$6=t.offlineStats.count,e.$8=t.offlineStats.message,e.$11(o("WAOfflineUtils").WAClientInfraOfflineProgress.Initializing,e.$10),e.$5=!1,e.$4="wa";break}case"offline-processed":break;case"offline-entity":{e.$7++,e.$12();break}case"offline-end":{e.$11(o("WAOfflineUtils").WAClientInfraOfflineProgress.Complete),e.$4="maw";break}case"connection-lost":{e.$11(o("WAOfflineUtils").WAClientInfraOfflineProgress.Failed);break}default:}})},n.subscribeToMawEvents=function(t){var e=this;t.subscribe(function(t){switch(t.type){case"maw-infra-start":{e.$10==null&&(e.$10=o("MAWQplProxy").performanceAbsoluteNow()),e.$13();break}case"maw-infra-end":{t.success?e.notifyUICurrentProcessingSucceeded():e.$14(),e.$10=null;break}}})},n.subscribeToMessageEvents=function(t){var e=this;t.subscribe(function(t){switch(t.type){case"new-message":{if(t.commonMessageBase.offline==null)return;e.addWAMessage();break}}})},n.addWAMessage=function(){this.$9++,this.$12()},n.$13=function(){this.$3=0,this.$5=!1,this.$15(o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Initializing)},n.setThreadMetadata=function(n){var t=n.reduce(function(e,t){return e[t.from]=t.t,e},{}),r=n.reduce(function(e,t){var n=t.from;return e[n]={chatStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing,snippetStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing},e},{});m.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Set thread metadata: ",", ",""])),JSON.stringify(t),JSON.stringify(r)),this.$1=t,this.$2=r},n.notifyUIChatReady=function(t){this.$2[t]={chatStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete},this.$15(o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Processing)},n.updateChatState=function(t){var e=this;Object.entries(t).forEach(function(t){var n=t[0],r=t[1];if(e.$1[n]!=null){var a=e.$1[n];r>=a&&(e.$2[n]={chatStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete})}}),this.$16()},n.addMAWEntity=function(t){this.$3+=t,this.$16()},n.notifyUICurrentProcessingSucceeded=function(){var e=this;Object.keys(this.$2).forEach(function(t){e.$2[t]={chatStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}}),this.$5=!0,this.$15(o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete),this.$1={},this.$2={}},n.$14=function(){var e=this;Object.keys(this.$2).forEach(function(t){e.$2[t]={chatStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete,snippetStatus:o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete}}),this.$15(o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Failed),this.$1={},this.$2={}},n.maybeNotifyUI=function(){this.$16()},n.$11=function(t,n){o("MAWBridge").getBridge().fireAndForget("event","offlineSnapshot",{downloaded:{count:this.$7,message:this.$9},expected:{count:this.$6,message:this.$8},status:t,timestamp:n!=null?n:o("MAWQplProxy").performanceAbsoluteNow()})},n.$15=function(t){var e=o("MAWQplProxy").performanceAbsoluteNow(),n={chatJidStatus:this.$2,startTime:this.$10!=null?this.$10:null,status:t,timestamp:e,totalExpectedCount:this.$6,totalProcessedCount:this.$3};m.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["MAW UI: ",""])),JSON.stringify(n)),t===o("MAWSharedProtocolQueueConst").OfflineConsumerStatus.Complete?r("promiseDone")(o("MAWBridge").getBridge().sendAndReceive("event","offlineConsumerProgress",n),function(){m.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose([' -> "Offline Complete" bridge event sent'])))},function(e){m.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose([' -> Unable to send "Offline Complete" event ',""])),e)}):o("MAWBridge").getBridge().fireAndForget("event","offlineConsumerProgress",n)},t})(),_=new p;l.ConsumerUINotifier=p,l.offlineResumeUINotifier=_}),98);
__d("MAWLoadGroupInvitesTxns",["MAWBridgeTypesCreators","MAWDbGroupInviteTxns","MAWDexieTable","MAWIndexedDb","MAWUserJidWrapper","WAJids","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=[],a=o("MAWUserJidWrapper").getMyUserJid();return t.forEach(function(t){return o("WAJids").switchOnMsgrChatJidType(t.jid,{group:function(){n.push(o("MAWDbGroupInviteTxns").getGroupInvitesByThreadAndInvitedParticipant(e,t.jid,a))},user:r("emptyFunction")})}),o("MAWDexieTable").dexieAll(n).then(function(e){e.forEach(function(e,t){e.forEach(function(e,t){o("MAWIndexedDb").afterTransaction({tag:"GroupInviteUpdate",value:o("MAWBridgeTypesCreators").createBridgeGroupInvite(e)})})})})}l.loadGroupInvites=e}),98);
__d("MessagesRangesV2ExternalIds",[],(function(t,n,r,o,a,i){"use strict";var e="",l="9999999999999999";i.MIN_EXTERNAL_ID=e,i.MAX_EXTERNAL_ID=l}),66);
__d("MAWLoadMessagesRequest",["FBLogger","MAWMessagesCompare","MAWMessagesDirection","MessagesRangesV2ExternalIds","WAStanzaUtils"],(function(t,n,r,o,a,i,l){"use strict";var e={admin:!1,editMsgHistory:!1,media:!1,polls:!1,reactions:!1,receiverFetch:!1,xma:!1};function s(e,t,n){var a,i;if(e.length===0)return[];var l=o("MAWMessagesCompare").getSortComparisonFunctionForDirection(o("MAWMessagesDirection").translateMawDirectionToMwpDirection(n)),s=[].concat(e).sort(l);if(t.lowerBoundExternalId!=null&&((a=t.lowerBoundExternalId)==null?void 0:a.toString())!==o("MessagesRangesV2ExternalIds").MIN_EXTERNAL_ID&&((i=t.lowerBoundExternalId)==null?void 0:i.toString())!==o("MessagesRangesV2ExternalIds").MAX_EXTERNAL_ID){var u=s.findIndex(function(e){return e.externalId===t.lowerBoundExternalId});u!==-1?s=s.slice(u):r("FBLogger")("messenger_web").mustfix("Get messages for range: no external id in source msgs list")}return s=c(s,t),s.slice(0,t.numMsgs)}function u(e,t,n,r){var a=e.filter(function(e){var n,r;return((n=e.sortOrderMs)!=null?n:Number.MAX_SAFE_INTEGER)>=t.gte[0]&&((r=e.sortOrderMs)!=null?r:Number.MIN_SAFE_INTEGER)<=t.lte[0]}),i=o("MAWMessagesDirection").switchOnMAWMessagesDirection(n,{after:[t.gte,t.lte],before:[t.lte,t.gte]}),l=i[0],u=l[0],c=l[1],d=i[1],m=d[0],p=d[1],_=s(a,{includeLowerBoundMsg:!0,lowerBoundExternalId:o("WAStanzaUtils").toStanzaId(c),lowerBoundSortOrderMs:u,numMsgs:r},n);if(p!==o("MessagesRangesV2ExternalIds").MIN_EXTERNAL_ID&&p!==o("MessagesRangesV2ExternalIds").MAX_EXTERNAL_ID){var f=_.findIndex(function(e){return e.externalId===p});if(f!==-1)return _.slice(0,f)}return _}function c(e,t){return t.includeLowerBoundMsg||e.length===0?e:e[0].externalId===t.lowerBoundExternalId||e[0].sortOrderMs===t.lowerBoundSortOrderMs?e.slice(1):e}l.loadMsgsConfigForCheckingOnly=e,l.getMsgsForRange=s,l.getMsgsForBounds=u}),98);
__d("MAWLoadMsgsDedupper",["MAWDbMsgUtil","WAMsg"],(function(t,n,r,o,a,i,l){"use strict";function e(){var e=new Set;return function(t){var n=o("MAWDbMsgUtil").getProtocolMsgIdFromDbMsg(t);if(n==null)return!0;var r=o("WAMsg").craftWAMsgIdString(n);if(r!=null){if(e.has(r))return!1;e.add(r)}return!0}}l.default=e}),98);
__d("MAWLoadMsgsUtil",[],(function(t,n,r,o,a,i){"use strict";function e(e,t,n){var r=0,o=0,a=!1,i=null;return function(l){return o++,i!=null&&i===l.sortOrderMs?!1:o>t&&l.sortOrderMs!==e||(l.msgId===n&&(a=!0),a&&r++,r>t)?!0:(i=l.sortOrderMs,!1)}}function l(e){var t=!0,n=0,r=null;return function(o){if(r===null)n++;else{if(r===o.sortOrderMs)return n+=t?0:1,!1;n++,t=!1}return n>e?!0:(r=o.sortOrderMs,!1)}}i.makeUntilWithRangeExtension=e,i.makeUntilWithRangeExtensionBothDirections=l}),66);
__d("MAWLoadMsgsTxnsV2",["I64","MAWBridgeMsg","MAWBridgeMsgCountdown","MAWBridgeReceiverFetchInfo","MAWBridgeTypesCreators","MAWBridgeXMA","MAWCurrentUser","MAWDbChunkTxns","MAWDbEditMsgHistoryTxns","MAWDbMediaTxns","MAWDbMsgTxns","MAWDbPollTxns","MAWDbReactionsTxns","MAWDbReceiverFetchTxns","MAWDbXMATxns","MAWDexieTable","MAWLoadMessagesRequest","MAWLoadMsgsDedupper","MAWLoadMsgsUtil","MAWLoadReplyMediaTxns","MAWLoggerUtils","MAWMediaUtils","MAWMessagesDirection","MAWODSProxy","MAWRavenUtils","MAWXMAUtils","MWFBLogger","MsgrWebGating","WAMsgType","WAOdsEnums","WATimeUtils","gkx","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m;function p(e,t,n,o,a,i){switch(n){case"before":return l();case"after":return s().then(function(e){return e.reverse()})}function l(){var n=r("MAWLoadMsgsDedupper")();return e.messages.where(["threadJid","sortOrderMs"]).between([t,0],[t,o],!0,!0).reverse().filter(a).filter(n).filter(function(e){return r("justknobx")._("3227")?e.source!=="media_restore":e!=null}).until(i,!0).toArray()}function s(){var n=r("MAWLoadMsgsDedupper")();return e.messages.where(["threadJid","sortOrderMs"]).between([t,o],[t,Number.MAX_SAFE_INTEGER],!0,!0).filter(a).filter(n).filter(function(e){return r("justknobx")._("3227")?e.source!=="media_restore":e!=null}).until(i,!0).toArray()}}function _(e,t){return o("MAWDbReactionsTxns").getReactionsFromMessages(e,t).then(function(e){return e.map(function(e){var t=e.author,n=e.reaction,r=e.reactToMsgId,a=e.threadJid,i=e.ts;if(r!=null)return n==null?{reaction:o("MAWBridgeTypesCreators").createBridgeDeleteReaction({author:t,chatJid:a,reactToMsgId:r}),type:"delete"}:{reaction:o("MAWBridgeTypesCreators").createBridgeUpsertReaction({author:t,chatJid:a,reaction:n||"",reactToMsgId:r,ts:i}),type:"upsert"}}).filter(Boolean)})}function f(e,t){return o("MAWDbMediaTxns").getMsgMediaPairFromMsgs(e,t).then(function(t){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=t[0],r=t[1];return o("MAWDbChunkTxns").hasMediaChunk(e,r.hashedPlaintextHash).then(function(t){return g(e,n.threadJid,r).then(function(a){var i=a.map(function(e){return e.msgId}),l=o("MAWMediaUtils").createHdTypesForBridgeMedia(a),s=n.ravenEphemeralType!=null&&n.ravenEphemeralMediaState!=null?o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:n.threadJid,filteredMsgIds:i,hasMediaForUI:t,hdTypes:l,media:r,ravenSettings:o("MAWRavenUtils").deriveRavenSettings(n.ravenEphemeralType,n.ravenEphemeralMediaState),sortOrderMs:n.sortOrderMs}):o("MAWBridgeTypesCreators").createBridgeMedia({chatJid:n.threadJid,filteredMsgIds:i,hasMediaForUI:t,hdTypes:l,media:r,sortOrderMs:n.sortOrderMs});return o("MAWMediaUtils").getBridgeMediaAnnotatedForDisplay(e,s,a)})})}))})}function g(e,t,n){return e.messages.where("msgId").anyOf(n.msgIds).toArray().then(function(e){return e.filter(function(e){return e.threadJid===t})})}function h(e,t){return o("MAWDbXMATxns").getXMAFromMsgs(e,t).then(function(t){return o("MAWDexieTable").dexieAll(t.map(function(t){return o("MAWXMAUtils").isXMAStoryReply(t.targetType)?o("MAWDexieTable").dexieResolve(null):o("MAWDbMediaTxns").maybeGetMediaFromMediaId(e,t.defaultPreviewMediaId).then(function(n){return n==null?o("MAWBridgeXMA").createBridgeXMA(n,t,{hasMedia:!1,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1}):o("MAWDexieTable").dexieAll([n,o("MAWDbChunkTxns").hasMediaChunk(e,n==null?void 0:n.hashedPlaintextHash)]).then(function(e){var n=e[0],r=e[1];return o("MAWBridgeXMA").createBridgeXMA(n,t,{hasMedia:r,hasXmaFaviconMedia:!1,hasXmaHeaderMedia:!1})})})}))}).then(function(e){return e.filter(Boolean)})}function y(e,t){return o("MAWDexieTable").dexieAll(t.map(function(t){return t.receiverFetchId==null?o("MAWDexieTable").dexieResolve(null):o("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(e,t.receiverFetchId).then(function(e){return e==null?o("MAWDexieTable").dexieResolve(null):o("MAWBridgeReceiverFetchInfo").createBridgeReceiverFetchInfoPayloadFromDbInfo(t.threadJid,t.msgId,t.sortOrderMs,t.ts,e)})})).then(function(e){return e.filter(Boolean)})}function C(e,t){var n=new Map;return o("MAWDexieTable").dexieAll(t.map(function(t){if(t.type!==o("WAMsgType").MSG_TYPE.GROUP_POLL_CREATE&&t.type!==o("WAMsgType").MSG_TYPE.GROUP_POLL_UPDATE)return null;var r=t.type===o("WAMsgType").MSG_TYPE.GROUP_POLL_CREATE?t.externalId:t.pollStanzaId;if(r==null)return o("MWFBLogger").MWMediaLogger().tags(["GroupPollsE2EE"]).mustfix("pollStanzaId is null for poll msg in MLV2"),null;var a=n.get(r);if(a!=null){if(a.externalId===t.externalId){var i;return b(e,t.threadJid,r,a.msgId,o("WATimeUtils").castToMillisTime((i=a==null?void 0:a.sortOrderMs)!=null?i:0))}return null}return o("MAWDbPollTxns").maybeGetLatestPollUpdateMsg(e,r,t.threadJid).then(function(a){if(a==null){var i;return b(e,t.threadJid,r,t.msgId,o("WATimeUtils").castToMillisTime((i=t.sortOrderMs)!=null?i:0))}if(n.set(r,a),a.externalId===t.externalId){var l;return b(e,t.threadJid,r,a.msgId,o("WATimeUtils").castToMillisTime((l=a==null?void 0:a.sortOrderMs)!=null?l:0))}else return null})})).then(function(e){return e.filter(Boolean)}).finally(function(){n.clear()})}function b(e,t,n,r,a){return e.poll.get([t,n]).then(function(e){return e==null?(o("MWFBLogger").MWMediaLogger().tags(["GroupPollsE2EE"]).mustfix("Poll is null in MLV2"),null):{contactIdForCurrentUser:(m||(m=o("I64"))).of_string(o("MAWCurrentUser").getID()),dbPoll:e,latestUpdateMsgId:r,latestUpdateTimestampMs:a}})}function v(e,t,n){if(!o("MsgrWebGating").isQuotedMessagesInLsEnabled())return o("MAWDexieTable").dexieResolve([n,[]]);var r=n.map(function(n){var r;return n.quote==null?null:o("MAWDbMsgTxns").maybeGetMsgByExternalId(e,n.quote.content.externalId,t,(r=n.quote)==null?void 0:r.content.author)}).filter(Boolean);return r.length<=0?o("MAWDexieTable").dexieResolve([n,[]]):o("MAWDexieTable").dexieAll(r).then(function(e){return[n,e.filter(Boolean)]})}function S(e,t,n,r,a,i,l){l===void 0&&(l=function(){return!0});var s=o("WATimeUtils").unixTime(),u=function(t){return t.messageExpirationTs==null||t.messageExpirationTs>s},c=o("MAWLoadMsgsUtil").makeUntilWithRangeExtension(a,n,i);return p(e,t,r,a,function(e){return l(e)&&u(e)},c).then(function(n){return v(e,t,n)}).then(function(t){var n=t[0],r=t[1];return o("MAWDexieTable").dexieAll([].concat(n,r).map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t)})).then(function(e){return{msgs:n,quoteMsgs:r,replyMediaInfo:e}})})}function R(e,t){return e.messages.where("externalId").equals(t).toArray()}function L(e,t){return R(e,t).then(function(n){return n.length>1&&o("MWFBLogger").MWLogger().tags(["Pinned"]).warn("duplicate MAW msg returned for externalId",t),o("MAWDexieTable").dexieAll(n.map(function(t){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,t)})).then(function(e){return{msgs:n,replyMediaInfo:e}})})}function E(t){var n=t.filter(function(e){return e.ephemeralCounterStarted});return n.length>0?(o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.Countdown,o("MAWLoggerUtils").Tag.OnLoad]).DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EphemeralCounter: Showing UI counter for ",""])),String(n.map(function(e){return e.msgId}))),o("MAWBridgeMsgCountdown").createBridgeMsgsStartCountdown(n).msgs):[]}function k(e,t){return e!=null?e:o("MAWMessagesDirection").switchOnMAWMessagesDirection(t,{after:Number.MIN_SAFE_INTEGER,before:Number.MAX_SAFE_INTEGER})}function I(e){var t=e.chatJid,n=e.config,r=e.db,a=e.direction,i=e.range,l=o("WATimeUtils").unixTime(),u=function(t){var e=t.messageExpirationTs!=null&&t.messageExpirationTs<l,r=t.type===o("WAMsgType").MSG_TYPE.ADMIN&&!n.admin,a=t.isCollapsed===!0;return!e&&!r&&!a},c=i.includeLowerBoundMsg?i.numMsgs:i.numMsgs+1,d=o("MAWLoadMsgsUtil").makeUntilWithRangeExtensionBothDirections(c),m=k(i.lowerBoundSortOrderMs,a);return p(r,t,a,m,u,d).then(function(e){return v(r,t,e)}).then(function(e){var t=e[0],n=e[1],l=o("MAWLoadMessagesRequest").getMsgsForRange(t,i,a);return o("MAWDexieTable").dexieAll([].concat(l,n).map(function(e){return o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(r,e)})).then(function(e){return{msgsForRange:l,quotedMsgs:n,replyMediaInfo:e}})}).then(function(e){var l=e.msgsForRange,u=e.quotedMsgs,c=e.replyMediaInfo;return o("MWFBLogger").MWLogger().tags(["MAWSecureLocalDBDataSource"]).DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["LoadMoreMsgs, chatJid: ",", range: ",".}"])),t,String(i)),D(r,l,u,c,a,i.numMsgs,n,t)})}function T(e,t,n,r,a,i,l,s){var c=k(a,r);return S(e,t,n,r,c,l,function(e){var t=e.isCollapsed===!0,n=!s.admin&&e.type===o("WAMsgType").MSG_TYPE.ADMIN;return!(t||n)}).then(function(a){var d=a.msgs,m=a.quoteMsgs,p=a.replyMediaInfo,_=d;return i||(_=_.filter(function(e){return e.msgId!==l}),_.length===d.length&&d.length!==0&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.LOAD_MORE_NO_ORIGINAL_MSG_IN_MAW,key:"mismatch"})),o("MWFBLogger").MWLogger().tags(["MAWSecureLocalDBDataSource"]).DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["LoadMoreMsgs: From:"," orignalMsgId:",", chatJid: ",""])),c,l,t),D(e,_,m,p,r,n,s,t)})}function D(e,t,n,a,i,l,s,u){var d=t.length;if(d===0)return o("MAWDexieTable").dexieResolve({editMsgHistory:[],expiringCountdown:[],hasMoreAfter:$(d,l,i),hasMoreBefore:x(d,l,i),medias:[],msgs:[],noteReplyCountdown:[],polls:[],quotedMsgs:[],reactions:[],receiverFetchInfoPayloads:[],xmaCountdown:[],xmas:[]});var m=t.map(function(e,t){if(!o("MAWXMAUtils").isXMAStoryReply(e.xmaMessageType))return o("MAWBridgeMsg").createBridgeMsg(e,(a||[])[t])}).filter(Boolean),p=E(t);return o("MWFBLogger").MWLogger().tags(["MAWSecureLocalDBDataSource"]).DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["LoadMoreMsgs, chatJid: ",", result: ",""])),u,String(m.map(function(e){return e.msgId+":"+e.sortOrderMs}))),o("MAWDexieTable").dexieAll([s.reactions?_(e,t):o("MAWDexieTable").dexieResolve([]),s.media?f(e,r("gkx")("17154")?[].concat(t,n):t):o("MAWDexieTable").dexieResolve([]),s.xma?h(e,t):o("MAWDexieTable").dexieResolve([]),s.editMsgHistory?o("MAWDbEditMsgHistoryTxns").loadEditMsgHistory(e,t):o("MAWDexieTable").dexieResolve([]),s.receiverFetch?y(e,t):o("MAWDexieTable").dexieResolve([]),s.polls?C(e,t):o("MAWDexieTable").dexieResolve([])]).then(function(e){var t=e[0],r=e[1],a=e[2],s=e[3],u=e[4],c=e[5];return{editMsgHistory:s,expiringCountdown:p,hasMoreAfter:$(d,l,i),hasMoreBefore:x(d,l,i),medias:r,msgs:m,noteReplyCountdown:[],polls:c,quotedMsgs:n.map(function(e){return o("MAWBridgeMsg").createBridgeMsg(e,null,!0)}),reactions:t,receiverFetchInfoPayloads:u,xmaCountdown:[],xmas:a}})}function x(e,t,n){switch(n){case"before":return e>=t;default:return!0}}function $(e,t,n){switch(n){case"after":return e>=t;default:return!0}}function P(e,t,n){return L(e,t).then(function(r){var a=r.msgs,i=r.replyMediaInfo;if(a.length===0)return{editMsgHistory:[],medias:[],msgs:[],polls:[],reactions:[],receiverFetchInfoPayloads:[],xmas:[]};var l=a.map(function(e,t){if(!o("MAWXMAUtils").isXMAStoryReply(e.xmaMessageType))return o("MAWBridgeMsg").createBridgeMsg(e,(i||[])[t])}).filter(Boolean);return o("MWFBLogger").MWLogger().tags(["MAWFetchMessageByPinnedExternalId"]).DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["LoadMsgsByExternalId: From: externalId:",". ",""])),t,String(l.map(function(e){return""+e.msgId}))),o("MAWDexieTable").dexieAll([n.reactions?_(e,a):o("MAWDexieTable").dexieResolve([]),n.media?f(e,a):o("MAWDexieTable").dexieResolve([]),n.xma?h(e,a):o("MAWDexieTable").dexieResolve([]),n.editMsgHistory?o("MAWDbEditMsgHistoryTxns").loadEditMsgHistory(e,a):o("MAWDexieTable").dexieResolve([]),n.receiverFetch?y(e,a):o("MAWDexieTable").dexieResolve([]),n.polls?C(e,a):o("MAWDexieTable").dexieResolve([])]).then(function(e){var t=e[0],n=e[1],r=e[2],o=e[3],a=e[4],i=e[5];return{editMsgHistory:o,medias:n,msgs:l,polls:i,reactions:t,receiverFetchInfoPayloads:a,xmas:r}})})}l.loadMoreMsgsAndMediaForRange=I,l.loadMoreMsgsAndMediaFromTs=T,l.loadMsgsAndMediaByExternalId=P}),98);
__d("MAWLoadMsgsTxns",["MAWIndexedDb","MAWLoadMsgsTxnsV2"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r,a){return r===void 0&&(r=!1),a===void 0&&(a="before"),o("MAWLoadMsgsTxnsV2").loadMoreMsgsAndMediaFromTs(e,t,n,a,null,r,null,{admin:!0,editMsgHistory:!0,media:!0,polls:!0,reactions:!0,receiverFetch:!0,xma:!0}).then(function(e){var t=e.expiringCountdown,n=e.hasMoreAfter,r=e.hasMoreBefore,a=e.medias,i=e.msgs,l=e.quotedMsgs,s=e.receiverFetchInfoPayloads,u=e.xmas;return l!=null&&l.length>0&&o("MAWIndexedDb").afterTransaction({tag:"NewMsgs",value:{msgs:l}}),i.length>0&&o("MAWIndexedDb").afterTransaction({tag:"NewMsgs",value:{msgs:i}}),t.length>0&&o("MAWIndexedDb").afterTransaction({tag:"MsgsStartCountdown",value:{msgs:t}}),u.forEach(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewXMA",value:e})}),a.forEach(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewMedia",value:e})}),s.forEach(function(e){return o("MAWIndexedDb").afterTransaction({tag:"NewReceiverFetchInfo",value:e})}),{hasMoreAfter:n,hasMoreBefore:r}})}l.loadMsgAndMedia_COMPAT=e}),98);
__d("MAWLoadThreadsTxns",["FBLogger","I64","MAWBridgeThread","MAWBridgeTypesCreators","MAWDbParticipantTxns","MAWDexieTable","MAWIndexedDb","MAWLoadGroupInvitesTxns","MAWLoadMsgsTxns","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWMpsGating","MAWThreadMappingQPL","MAWTransactionMode","MAWUserJidWrapper","WAJids","WALogger","emptyFunction","err"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t,n,r,a,i){return i===void 0&&(i="unknown"),n.forEach(function(t){var n=o("MAWThreadMappingQPL").getInstanceKeyForJidInWorker(t.jid);o("MAWThreadMappingQPL").startInWorker({instanceKey:n,jid:t.jid,threadKey:t.optimisticThreadKey==null?void 0:(e||(e=o("I64"))).of_string(t.optimisticThreadKey),trigger:"loadContentsForThreads_"+i}),o("MAWIndexedDb").afterTransaction({tag:"VerifyThreadExists",value:o("MAWBridgeThread").createBridgeThread(t,a==null?void 0:a.get(t.jid),void 0,"loadContentsForThreads_"+i,n)})}),o("MAWMpsGating").isFullMpsEnabled()?o("MAWDexieTable").dexieResolve(n):o("MAWDexieTable").dexieAll([].concat(n.map(function(e){return o("MAWLoadMsgsTxns").loadMsgAndMedia_COMPAT(t,e.jid,r,!0)}),[u(t,n),o("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities(n.map(function(e){return e.jid})),o("MAWLoadGroupInvitesTxns").loadGroupInvites(t,n)])).then(function(){return n})}function u(e,t){var n=[];return t.forEach(function(e){return o("WAJids").switchOnMsgrChatJidType(e.jid,{group:function(t){return n.push(t)},user:r("emptyFunction")})}),e.groupInfo.bulkGet(n).then(function(e){e.forEach(function(e){e!=null&&o("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(e)})})})}var c=function(t){var e=t.threadJid;return d(e)},d=o("MAWIndexedDb").makeMsgrTransactor({participants:o("MAWTransactionMode").READONLY},"checkIfGroupParticipant",function(e){return(function(){for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return m.apply(void 0,[e].concat(n))})});function m(e,t,n,a,i,l){n===void 0&&(n=!0),a===void 0&&(a=!0);var s=o("MAWUserJidWrapper").getMyUserJid();return o("MAWDbParticipantTxns").getParticipant(e,t,s).then(function(e){if(!e.success){var u=n?"group":"one_to_one";if(o("WALogger").LOG(["[Occamadillo] User is not a participant of "+u+" thread\n        "+t.toString()+", showing a VIEWER_NOT_SUBSCRIBED composer blocker"]),i==null){var c;r("FBLogger")("maw_db","checkIfParticipant").catching((c=e.payload)!=null?c:r("err")(e.error)).warn("[Occamadillo] User %s is not a participant of %s thread %s, occam: %s, archived: %s, cannotReplyReason null.",s,u,t.toString(),a,l)}r("FBLogger")("labyrinth_web","checkIfParticipant").warn("[Occamadillo] User not a participant from checkIfParticipant");var d={cannotReplyReason:"viewer_not_subscribed",threadJid:t};o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread(d)})}})}l.loadContentsForThreads=s,l.loadGroups=u,l.checkIfGroupParticipant=c}),98);
__d("MAWThreadFetchAndEmitTxns",["MAWDexieTable","MAWLoadGroupInvitesTxns","MAWLoadOneToOneMessageRequestCapabilitiesTxn","MAWLoadThreadsTxns","MAWThreadManagementTxns","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return n===void 0&&(n="getOrCreateThread"),o("WAJids").switchOnMsgrChatJidType(t,{group:function(n){return o("MAWThreadManagementTxns").getGroupThread(e,n,void 0).then(function(e){return e==null?null:{created:e.created,thread:e.thread}})},user:function(r){return o("MAWThreadManagementTxns").getOrSetupOneToOneThread(e,{createTs:void 0,description:n,folder:void 0,userJid:r})}})}function s(e,t,n,r,a){return a===void 0&&(a="fetchAndEmitThread"),o("WAJids").switchOnMsgrChatJidType(t,{group:function(r){return o("MAWThreadManagementTxns").getGroupThread(e,r,n).then(function(e){return e==null?null:{created:e.created,thread:e.thread}})},user:function(i){return o("MAWThreadManagementTxns").getOrSetupOneToOneThread(e,{createTs:r==null?void 0:o("WATimeUtils").castUnixTimeToMillisTime(r),description:a,folder:n!=null?n:void 0,userJid:i})}}).then(function(t){return t==null||t.thread==null?null:o("MAWLoadThreadsTxns").loadContentsForThreads(e,[t.thread],1,null,a).then(function(){return t})})}function u(e,t){if(t.size===0)return o("MAWDexieTable").dexieResolve();var n=Array.from(t);return e.threads.where("jid").anyOf(n).toArray().then(function(t){var n=t.filter(Boolean);return o("MAWDexieTable").dexieAll([o("MAWLoadThreadsTxns").loadGroups(e,n),o("MAWLoadOneToOneMessageRequestCapabilitiesTxn").loadOneToOneMessageRequestCapabilities(n.map(function(e){return e.jid})),o("MAWLoadGroupInvitesTxns").loadGroupInvites(e,n)])}).then(r("emptyFunction"))}l.getOrCreateThread=e,l.fetchAndEmitThread=s,l.emitThreadContents=u}),98);
__d("MAWBulkHandleIncomingMsgApi",["LSMEBTaskCreationSource","MAWBulkEditMsgsTxns","MAWBulkWriteReactionsTxns","MAWDbThreadTxns","MAWDexieTable","MAWHIMLogger","MAWHandleIncomingMsgApi","MAWIndexedDb","MAWLinkReactionsToMsgsTxns","MAWMsgActionType","MAWMsgType","MAWODSProxy","MAWOfflineThreadTxns","MAWPreprocessMsgs","MAWSharedOfflineQueueMetric","MAWSharedOfflineResumeUINotifier","MAWThreadFetchAndEmitTxns","MAWTransactionMode","MAWUseProtocolMsgIdForMsgId","WAMsgMap","WAOdsEnums","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f;function g(t,n){var a;return o("MAWIndexedDb").makeMsgrTransactor({chunk:(a=o("MAWTransactionMode")).READONLY,deletedMessages:a.READWRITE,deviceChangeAlerts:a.READWRITE,editMsgHistory:a.READWRITE,ephemeralSettings:a.READWRITE,ftsBackloggedMessages:a.READWRITE,ftsPurgeBacklog:a.READWRITE,groupInfo:a.READWRITE,groupInvites:a.READWRITE,media:a.READWRITE,mediaBackup:a.READWRITE,messages:a.READWRITE,participants:a.READWRITE,pendingReceipts:a.READWRITE,pendingStanzas:a.READWRITE,poll:a.READWRITE,reactions:a.READWRITE,receiverFetchInfo:a.READWRITE,threads:a.READWRITE,unrenderedMessages:a.READWRITE,xma:a.READWRITE},"bulkHandleIncomingMsgs",function(a){return function(){var i=new(o("WAMsgMap")).MsgMap;o("MAWODSProxy").odsBumpEntityKey({amount:t.length,entity:o("WAOdsEnums").Entity.TOTAL_INCOMING_MESSAGE,key:"msgs"}),o("MAWDexieTable").setDexiePSDItem("offlineQueueSize",t.length);var l=new Set(t.map(function(e){var t=e.msgData;return t.id.chat})),d=o("MAWPreprocessMsgs").classifyIncomingMsgs(t),m=d.editActionMsgs,p=d.reactionMsgs,_=function(n,a){var t=i.get(n);a.success?t==null?r("MAWHIMLogger").MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["ERROR!!! At this point we must have fields in the map, ",""])),String(a)):t.success?i.set(n,o("WAResultOrError").makeResult(babelHelpers.extends({},t.value,a.value))):r("MAWHIMLogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Previous message processing action failed so subsequent one can't succeed"]))):i.set(n,a)},f=function(t,n){i.set(t,o("WAResultOrError").makeResult({protocolMsgId:t,unknownGroup:n==="missing"}))},g=function(i){var e=i.threadCreationResult,l=i.threads;return o("MAWDexieTable").dexieAll(t.map(function(t){var i,s=l.get(t.msgData.id.chat),d=(i=e.get(t.msgData.id.chat))!=null?i:"missing";if(s==null){r("MAWHIMLogger").MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ","."])),d),r("MAWHIMLogger").DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Cannot create thread for message. Reason: ",". StanzaID ",""])),d,t.msgData.id.externalId);return}return f(t.msgData.id,d),o("MAWPreprocessMsgs").getMessageDataByType(a,t,s,n)}).filter(Boolean)).catch(function(e){throw e.message="[getAllMessagesProcessingData] "+e.message,e})},C=n!==r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE,S=function(t){var e=b(t),n=o("MAWDexieTable").dexieResolve();return e.forEach(function(e){n=n.then(function(){return o("MAWHandleIncomingMsgApi").handleIncomingMsg(a,e,C)}).then(function(t){_(e.id,t),y(e.id,e.ts)})}),n.catch(function(e){throw e.message="[writeIncomingMsgs] "+e.message,e}),n},R=function(){return m.length===0?o("MAWDexieTable").dexieResolve():o("MAWBulkEditMsgsTxns").prepareDataForMessageEdit(a,m).then(function(e){return o("MAWBulkEditMsgsTxns").bulkEditMsgs(a,m,e)})};return h(a,l).then(function(e){return o("MAWDexieTable").dexieAll([g(e),o("MAWBulkWriteReactionsTxns").prepareReactionsData(a,p)]).then(function(e){var t=e[0],n=e[1];return o("MAWBulkWriteReactionsTxns").bulkWriteReactions(a,n).then(function(){return S(t)}).then(function(){return R()}).then(function(){return o("MAWThreadFetchAndEmitTxns").emitThreadContents(a,l)}).then(function(){return v(a,i)}).then(function(){return{msgResults:i}})})})}})()}function h(e,t){var n=Array.from(t);return o("MAWDbThreadTxns").getThreads(e,n).then(function(t){return o("MAWOfflineThreadTxns").createAllThreadsForOfflineMsgs(e,n,t)})}function y(e,t){var n,r,a=e.chat.toString();o("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.updateChatState((n={},n[a]=t,n)),o("MAWSharedOfflineResumeUINotifier").offlineResumeUINotifier.addMAWEntity(1),(r=o("MAWSharedOfflineQueueMetric").getOfflineQueueMetric())==null||r.addMAWEntity(1)}var C=r("MAWHIMLogger").tags(["MergeActions"]);function b(e){C.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Handling "," messages"])),e.length);var t=new(o("WAMsgMap")).MsgMap;for(var n of e){C.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Handling message with StanzaID ",", action "," and type ",""])),n.id.externalId,n.action,n.type),n.receiveFlow.addPoint("him_merge_actions");var r=t.get(n.id);if(r==null){t.set(n.id,n);continue}if(r.action===n.action&&r.type===n.type){n.receiveFlow.addAnnotations({bool:{merge_actions_duplicate:!0}});continue}switch(n.action){case o("MAWMsgActionType").MSG_ACTION.NO_ACTION:continue;case o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT:case o("MAWMsgActionType").MSG_ACTION.UPDATE_CIPHERTEXT_WITH_ASSOCIATED:{if(r.action===o("MAWMsgActionType").MSG_ACTION.REVOKE||r.action===o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){C.MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'update ciphertext' and 'delete' in same OQ batch"])));continue}t.set(n.id,n);continue}case o("MAWMsgActionType").MSG_ACTION.WRITE:case o("MAWMsgActionType").MSG_ACTION.WRITE_WITH_ASSOCIATED:{if(r.action===o("MAWMsgActionType").MSG_ACTION.REVOKE||r.action===o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME){C.MUSTFIX(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Should never have 'write' and 'delete' in same OQ batch"])));continue}switch(n.type){case o("MAWMsgType").MSG_TYPE.UNAVAILABLE:break;case o("MAWMsgType").MSG_TYPE.CIPHERTEXT:{r.type===o("MAWMsgType").MSG_TYPE.UNAVAILABLE&&t.set(n.id,n);break}default:r.type!==o("MAWMsgType").MSG_TYPE.CIPHERTEXT&&C.MUSTFIX(f||(f=babelHelpers.taggedTemplateLiteralLoose(["Unexpected overwrite on WRITE action. Current type: ",", next type: ",""])),r.type,n.type),t.set(n.id,n)}break}case o("MAWMsgActionType").MSG_ACTION.DELETE_FOR_ME:case o("MAWMsgActionType").MSG_ACTION.REVOKE:{r.action!==o("MAWMsgActionType").MSG_ACTION.REVOKE&&t.set(n.id,n);break}}}var a=[];for(var i of e){var l,s,u=t.get(i.id);i.receiveFlow.addAnnotations({string:{final_action:(l=u==null?void 0:u.action)!=null?l:"undefined",final_msg_type:(s=u==null?void 0:u.type)!=null?s:"undefined",has_replaced_action:(i!==u).toString(),initial_action:i.action,initial_msg_type:i.type}}),!(u==null||u.action===o("MAWMsgActionType").MSG_ACTION.NO_ACTION)&&(a.push(u),t.delete(i.id))}return a}function v(e,t){if(o("MAWUseProtocolMsgIdForMsgId").shouldUseProtocolMsgIdForMsgId())return o("MAWDexieTable").dexieResolve();var n=new Set;return t.values().forEach(function(e){if(e.success){var t=e.value,r=t.protocolMsgId,o=t.reactToExternalId;o!=null?n.add(o):r!=null&&n.add(r.externalId)}}),o("MAWLinkReactionsToMsgsTxns").getReactionLinkUpdatesForExternalIds(e,Array.from(n)).then(function(t){return o("MAWLinkReactionsToMsgsTxns").updateReactionLinks(e,t)})}l.bulkHandleIncomingMsgs=g,l.linkMsgsToReactions=v}),98);
__d("MAWCommonScheduler",["WorkerScheduler"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return e==null&&(e=o("WorkerScheduler").makeScheduler("msgr-common",{concurrency:1,maxTaskLimit:10,maxThrottleMs:5e3})),e}l.mawCommonScheduler=s}),98);
__d("MAWDebugMsg",["MAWBridge","MAWBridgeMsg","MAWExternalId","MAWJidUtils","MAWLocalizationType","MAWLocalizationUtils","OfflineThreadingId","WAStanzaUtils","WATimeUtils","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){if(r("gkx")("23915")){var a=o("MAWJidUtils").formatProtocolMsgIdFromExternalId(e,o("WAStanzaUtils").toStanzaId(o("OfflineThreadingId").createOfflineThreadingID())),i=(n==null?void 0:n.decryptionError)==="errDuplicateMsg"?", existing message":"",l=o("WATimeUtils").unixTimeMs(),u=s(e,a,t+i,l),c=[u];o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:c})}}function s(e,t,n,r){var a=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:["[fb-only][DEBUG]: "+n],adminType:o("MAWLocalizationType").LOCALIZATION_TYPE.DEBUG_MSG,version:0},e,o("MAWExternalId").generateExternalId());return{tag:"NewMsg",value:o("MAWBridgeMsg").createBridgeMsg(babelHelpers.extends({},a,{msgId:t,sortOrderMs:r}))}}l.writeDebugMsg=e}),98);
__d("MAWIsQuotaExceededError",[],(function(t,n,r,o,a,i){"use strict";var e=function(t){return t.name==="QuotaExceededError"||t.inner&&t.inner.name==="QuotaExceededError"};i.isQuotaExceededError=e}),66);
__d("MAWSharedCOPLogger",["MWFBLogger"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MWFBLogger").MWLogger().tags(["COP"]);l.default=e}),98);
__d("WAParseV3Protocol",["WAAckLevel","WAAssertUnreachable","WAHex","WAMsgType","WAParseConsumerMessageProtocol","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return function(t,n,a,i,l,s){var u,c,d={id:{chat:n,author:i,externalId:a},ts:l,serverTs:l,ack:o("WAAckLevel").ACK.RECEIVED,forwardingScore:t.type!=="futureProof"&&(u=t==null||(c=t.metadata)==null?void 0:c.forwardingScore)!=null?u:0};if(t.type==="futureProof")return{unstoredMsg:{type:o("WAMsgType").FUTUREPROOF,msgContent:{subtype:null,protobuf:o("WAHex").bytesToBuffer(t.protobuf)},id:d.id,ts:d.ts,sentTs:d.sentTs,serverTs:d.serverTs,ack:d.ack,reportingMeta:d.reportingMeta},unstoredMedia:null,unstoredQuotedMedia:null};if(t.type==="subprotocol"){var m=e==null?void 0:e.get(t.subprotocolType);if(m!=null)return m(n,t.subprotocol,d,t.protobuf,t.metadata,s);switch(t.subprotocolType){case"consumerMessage":return o("WAParseConsumerMessageProtocol").parseConsumerMessageProtocol(n,t.subprotocol,d,t.protobuf,t.metadata,s);case"businessMessage":throw r("err")("unsupported subprotocolType: "+t.subprotocolType);case"paymentMessage":throw r("err")("unsupported subprotocolType: "+t.subprotocolType);case"multiDevice":throw r("err")("unsupported subprotocolType: "+t.subprotocolType);case"voip":throw r("err")("unsupported subprotocolType: "+t.subprotocolType);default:throw r("err")("Subprotocol parser for: "+t.subprotocolType+" was not found")}}else return r("WAAssertUnreachable")(t.type)}}l.createV3ProtocolParser=e}),98);
__d("MAWIncomingMsgUtils",["FBLogger","MAWCurrentUser","MAWEphemeralUtil","MAWLocalizationUtils","MAWParseArmadilloProtocol","MAWSharedCOPLogger","MAWUnstoredContentToUnstoredDbContentUtils","MpsAdminMsgToBridge","WAJids","WAParseV3Protocol","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e=["threadJid"],s=null;function u(){if(s==null){var e=function(t,n,r,a,i,l){return o("MAWParseArmadilloProtocol").parseArmadilloProtocol(t,n,r,a,i,l)};s=o("WAParseV3Protocol").createV3ProtocolParser(new Map([["armadillo",e]]))}return s}function c(e){var t=e.author,n=e.chat,a=e.ebTimestampMs,i=e.externalId,l=e.msg,s=e.reportingMeta,c=e.serverTs;if(l.version==="v2")throw r("FBLogger")("messenger_web").mustfixThrow("Armadillo does not support protobuf v2");if(l.type==="ephemeral"){var m=o("MAWEphemeralUtil").buildUnstoredDbEphemeralSettingMsgWithoutContentPlaceholder(c);return s!=null&&m.unstoredDbMsg!=null&&(m.unstoredDbMsg.reportingMeta=s),m}if(l.type==="admin"){var p=t==="@me"?o("MAWCurrentUser").getID():o("WAJids").extractUserId(t);return d(p,n,i,l,c,a)}var _=babelHelpers.extends({unstoredXMA:null},u()(l,n,i,t,c,a));return s!=null&&_.unstoredMsg!=null&&(_.unstoredMsg.reportingMeta=s),o("MAWUnstoredContentToUnstoredDbContentUtils").unstoredContentToUnstoredDbContent(_)}function d(t,n,a,i,l,s){var u;try{u=o("MpsAdminMsgToBridge").getMessageContent(t,i.content)}catch(e){r("MAWSharedCOPLogger").catching(r("getErrorSafe")(e)).mustfix("Failed to get admin message content")}if(u==null)return{unstoredDbMedia:null,unstoredDbMsg:null,unstoredDbReaction:null};var c=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:u.adminMsgContent,adminType:u.adminType,version:1},n,a,l,void 0,s!=null?s:l*1e3),d=c.threadJid,m=babelHelpers.objectWithoutPropertiesLoose(c,e);return{unstoredDbMedia:null,unstoredDbMsg:m,unstoredDbReaction:null}}l.getDbMsg=c,l.getMiTransportAdminDbMsg=d}),98);
__d("MAWProtocolQueueDecodeProto",["MAWIncomingMsgUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){switch(e.type){case"IncomingMsg":{var n=e.folder,r=e.id,a=e.msg,i=e.reportingMeta,l=e.ts,s=r.author,u=r.chat,c=r.externalId;return o("MAWIncomingMsgUtils").getDbMsg({author:s,chat:u,ebTimestampMs:t,externalId:c,folder:n,msg:a,reportingMeta:i,serverTs:l})}case"InvisibleMsg":case"IncomingCiphertextMsg":default:return}}l.decodeMsg=e}),98);
__d("isUseridAnnotationEnabled",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("24163")}l.default=e}),98);
__d("MAWUserHash",["MAWCurrentUser","WAGlobals","WAJids","isUseridAnnotationEnabled"],(function(t,n,r,o,a,i,l){"use strict";function e(){return o("MAWCurrentUser").isEmployee()&&r("isUseridAnnotationEnabled")()?o("WAJids").extractUserId(o("WAGlobals").getMyUserJid()).slice(-5):null}l.getUserHash=e}),98);
__d("MAWIncomingMsg",["MAWUserHash","MWFBLogger","WAGetPlatformFromStanzaId","WAHashStringToNumber","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MWFBLogger").MWLogger().tags(["ServerRPC","HandleIncomingMsg"]),s=function(t){var e=t.encTypes,n=t.incomingType,r=t.msg,a=t.queueType,i=t.retryCount,l=t.taskSource,s=r.details,u=r.decrypted;return{int:{messageAge:o("WATimeUtils").unixTime()-s.ts,msgId:o("WAHashStringToNumber").hashStringToNumber(s.externalId.toString()),offlineDelivery:s.offline,retryCount:i,taskSource:l},string:{e2eePlatform:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(s.externalId),incomingType:n,jid:s.from.chat,msgDecryptedDataType:u.type,msgType:s.type,queueType:a,threadType:s.from.type,userHash:o("MAWUserHash").getUserHash()},string_array:{encTypes:e}}};l.logger=e,l.prepareAnnotationsForIncomingMessage=s}),98);
__d("WAQPLProxy",["WALogger","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n,a,i,l){if(l===void 0&&(l=!0),d==null)throw o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["WAQPLProxy: Proxy implementation is not provided for ",""])),t),r("err")("WAQPLProxy: Proxy implementation is not provided");return d.start(t,n,a,i,l)}function c(e,t){if(d==null)throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["WAQPLProxy: Proxy implementation is not provided for ",""])),e),r("err")("WAQPLProxy: Proxy implementation is not provided");return d.resume(e,t)}var d=null;function m(e){d=e}l.waQPLProxyStart=u,l.waQPLProxyStartResume=c,l.provideProxyImplementationForWAQPLProxy=m}),98);
__d("MAWMessageReceiveReliabilityLogger",["WAHashStringToNumber","WAQPLProxy","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e=r("qpl")._(1056840931,"814"),s=r("qpl")._(521477947,"2395"),u=60*1e3;function c(t){return o("WAQPLProxy").waQPLProxyStart(t.incomingType==="ebrestore"?s:e,{int:{msgId:o("WAHashStringToNumber").hashStringToNumber(t.stanzaId)},string:{incomingType:t.incomingType,jid:t.jid,msgType:t.type}},o("WAHashStringToNumber").hashStringToNumber(t.stanzaId),u)}var d=300*1e3;l.logRRStartForMessage=c,l.RECEIVE_RELIABILITY_TIMEOUT=d}),98);
__d("MAWProtocolQueueUtils",["MAWIncomingMsg","MAWMessageReceiveReliabilityLogger","WAGetStorageQplAnnotations","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=o("MAWMessageReceiveReliabilityLogger").logRRStartForMessage(e);return n.addAnnotations(o("MAWIncomingMsg").prepareAnnotationsForIncomingMessage({incomingType:e.incomingType,msg:e.message,queueType:e.message.details.offline!=null?"offline":"online",retryCount:e.message.details.retryCount,taskSource:t})),n}function s(e,t){return r("promiseDone")(o("WAGetStorageQplAnnotations").getStorageQplAnnotations().then(function(e){t.addAnnotations(e)})),t.addPoint("consumer_handle_message_stanza_start"),babelHelpers.extends({},e,{receiveFlow:t})}l.startMetricForIncomingMsgV2=e,l.addAnnotationsToMessage=s}),98);
__d("MAWGetSyncResponseBackoffInfoByJidApi",["MAWIndexedDb","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({ephemeralSettings:o("MAWTransactionMode").READONLY},"getSyncResponseBackoffInfoByJid",function(e){return function(t){return e.ephemeralSettings.get({userJid:t}).then(function(e){return e==null?null:e.ephemeralSyncResponseBackoffInfo})}});l.getSyncResponseBackoffInfoByJid=e}),98);
__d("MAWMarkMsgDroppedApi",["MAWAckLevel","MAWDbMsgTxns","MAWDbReactionsTxns","MAWDexieTable","MAWIndexedDb","MAWQplProxy","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MAWIndexedDb").makeMsgrTransactor({chunk:(e=o("MAWTransactionMode")).READONLY,media:e.READONLY,messages:e.READWRITE,reactions:e.READWRITE,receiverFetchInfo:e.READONLY,threads:e.READWRITE,xma:e.READONLY},"markMsgDropped",function(e){return(function(t,n,r){return r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_msg_and_reaction_fetch_start",{instanceKey:r.qplInstanceKey}),o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,t),o("MAWDbReactionsTxns").maybeGetReactionByProtocolMsgId(e,t)]).then(function(t){var a=t[0],i=t[1];if(r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_msg_and_reaction_fetch_end",{instanceKey:r.qplInstanceKey}),a!=null){var l=(n==null?void 0:n.isRetriable)===!0?o("MAWAckLevel").ACK.failedRetryable:o("MAWAckLevel").ACK.expired;return r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_update_system_ack_start",{annotations:{int:{ack:l}},instanceKey:r.qplInstanceKey}),o("MAWDbMsgTxns").updateSystemAck(e,a.msgId,l,void 0,void 0,void 0).then(function(e){return r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_update_system_ack_end",{instanceKey:r.qplInstanceKey}),e==null?"missing":e.ack<=o("MAWAckLevel").ACK.clock?"dropped":"sent"})}return i!=null?(r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_update_delete_reaction_start",{instanceKey:r.qplInstanceKey}),o("MAWDbReactionsTxns").deleteReaction(e,i).then(function(){return r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_update_delete_reaction_end",{instanceKey:r.qplInstanceKey}),"dropped"})):(r!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r.qplEventType,"mark_msg_dropped_msg_and_reaction_missing",{instanceKey:r.qplInstanceKey}),"missing")})})});l.markMsgDropped=s}),98);
__d("MAWMessageSendScheduler",["WorkerScheduler"],(function(t,n,r,o,a,i,l){"use strict";var e=24e4,s;function u(){return s==null&&(s=o("WorkerScheduler").makeScheduler("message-send",{concurrency:5,defaultSamplingRate:500,maxTaskLimit:5,maxThrottleMs:500,timeoutMs:e})),s}l.messageSendScheduler=u}),98);
__d("MAWMessageSendsCommon",["MAWMarkMsgDroppedApi","MAWMessageSendScheduler","MAWQplProxy","MWFBLogger","WAPromiseDelays","WAResultOrError","WATimeUtils","WAWaitForComms","WorkerScheduler","asyncToGeneratorRuntime","getErrorSafe","getSafeQplErrorMessage","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=1e3,c=o("MWFBLogger").MWLogger().tags(["MessageSend"]);function d(){if(!r("justknobx")._("4635"))return{activeTasks:[],pendingTasks:[]};var e=o("MAWMessageSendScheduler").messageSendScheduler().getDebugState();return{activeTasks:e.activeTasks.map(function(e){return"executionTimeMs"+e.executionTimeMs+" priority: "+e.priority+" name: "+e.task+" waitTimeMs:"+e.waitTimeMs}),pendingTasks:e.pendingTasksByPriority.map(function(e){return e.map(function(e){return"name: "+e.task+" waitTimeMs:"+e.waitTimeMs})}).flat()}}function m(e,t,n,r,o){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l){var p;o("MAWQplProxy").sendQplPointThroughBridge(t,"backend_reached",{annotations:{bool:{backendSetupReadyFromWorker:!o("WAWaitForComms").isStillWaitingForComms()}},instanceKey:n});var _;try{o("MAWQplProxy").sendQplPointThroughBridge(t,"wait_for_comms_start",{annotations:{},instanceKey:n}),yield o("WAWaitForComms").waitForComms(),o("MAWQplProxy").sendQplPointThroughBridge(t,"wait_for_comms_end",{annotations:{},instanceKey:n});var f=d(),g=f.activeTasks,h=f.pendingTasks;if(o("MAWQplProxy").sendQplPointThroughBridge(t,"message_send_start",{annotations:r("justknobx")._("4635")?{string_array:{activeTasksBeforeSchedule:g,pendingTasksByPriorityBeforeSchedule:h}}:{},instanceKey:n}),_=yield o("MAWMessageSendScheduler").messageSendScheduler().runTask({customFlags:{runtimeReliability:!0},fn:function(){return a(o("WATimeUtils").unixTime())},name:i,priority:o("WorkerScheduler").BLOCKING_PRIORITY}),_.success===!0)o("MAWQplProxy").sendQplPointThroughBridge(t,"message_send_end",{instanceKey:n});else{var y,C,b=d(),v=b.activeTasks,S=b.pendingTasks;o("MAWQplProxy").sendQplPointThroughBridge(t,"message_send_fail",{annotations:{string:{errorType:(y=(C=_.error)==null?void 0:C.type)!=null?y:"unknown-error"},string_array:r("justknobx")._("4635")?{activeTasksBeforeSchedule:v,pendingTasksByPriorityBeforeSchedule:S}:{}},instanceKey:n})}}catch(a){var R=r("getErrorSafe")(a),L=d(),E=L.activeTasks,k=L.pendingTasks;throw c.catching(R).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Message send fail. Error: ",""])),o("getSafeQplErrorMessage").getSafeQPLErrorMessage(R)),o("MAWQplProxy").sendQplPointThroughBridge(t,"message_send_fail",{annotations:{string:{errorDescription:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(R),errorType:"runtime-error",sendFailureError:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(R)},string_array:r("justknobx")._("4635")?{activeTasksBeforeSchedule:E,pendingTasksByPriorityBeforeSchedule:k}:{}},instanceKey:n}),l!=null&&(yield o("MAWMarkMsgDroppedApi").markMsgDropped(l,void 0,{qplEventType:t,qplInstanceKey:n})),R}if(!_){var I="null-response-from-message-send";return c.MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Guard: should not happen, result is null"]))),o("MAWQplProxy").sendQplPointThroughBridge(t,"message_send_fail",{instanceKey:n}),o("WAResultOrError").makeError({applicationErrorCode:null,details:I,isRetriable:!0,type:"unexpected-message-codepath"})}if(_.success===!0)return _;if(_.success,l!=null&&(yield o("MAWMarkMsgDroppedApi").markMsgDropped(l,_.error,{qplEventType:t,qplInstanceKey:n})),((p=_.error)==null?void 0:p.type)==="retryable-error"){var T,D=(T=_.error.backoff)!=null?T:u;return yield o("WAPromiseDelays").delayMs(D),m(t,n,a,i,l)}else return _}),p.apply(this,arguments)}l.messageSendLogger=c,l.messageSendObserver=m}),98);
__d("MAWGetEditMsgForSending",["FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWTransactionMode","WAJids","WALogger","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=o("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:(d=o("MAWTransactionMode")).READONLY,messages:d.READONLY,reactions:d.READONLY,threads:d.READONLY},"getEditMsgForSending",function(e){return(function(t,n){return p(e,t,n).then(function(e){if(!e.success)return{type:e.error};var n=e.value.msg,a=o("MAWAsMessageApplication").asEditMessageApplication(n);if(o("WAJids").isAuthorSystem(n.author))throw r("FBLogger")("messenger_web").mustfixThrow("This cannot happen because there are no system edit");return{dbMsg:n,editOriginalExternalId:n.originalMsgExternalId,messageApplication:a,messageType:{isEdit:!0,isRevoked:!1,type:"text"},protocolMsgId:t,type:"unsent"}})})});function p(t,n,r){return o("MAWDbEditMsgHistoryTxns").getEditHistoryMsgByEditedProtocolMsgId(t,n,r).then(function(n){if(n==null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get edit history"]))),o("WAResultOrError").makeError("missing_history");if(n.sendStatus!=null&&n.sendStatus>o("MAWAckLevel").ACK.clock)return o("WAResultOrError").makeError("sent");var r=o("MAWJidUtils").maybeToProtocolMsgId(n.author,n.threadJid,n.originalMsgExternalId);return r==null?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get originalMsgProtocolMsgId"]))),o("WAResultOrError").makeError("missing_msg")):o("MAWDexieTable").dexieAll([o("MAWDbThreadTxns").getThread(t,n.threadJid),o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,r)]).then(function(e){var t=e[0],r=e[1];return t.success?r==null?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get originalMsg"]))),o("WAResultOrError").makeError("missing_msg")):r.ack>o("MAWAckLevel").ACK.clock?o("WAResultOrError").makeError("sent"):o("WAResultOrError").makeResult({msg:n,thread:t.value}):(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[SendEditMsg] Failed to get thread (success:",")"])),t.success),o("WAResultOrError").makeError("missing_thread"))})})}l.getEditMsgForSending=m}),98);
__d("MAWSendMsgUtil",["MAWMediaType","WAArmadilloApplication.pb","WAConsumerApplication.pb","WAMsgType","decodeProtobuf","getMediaTypeFromConsumerMessage"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=o("MAWMediaType").getMediaType(e),n=e===o("WAMsgType").MSG_TYPE.REVOKED;return t!=null?{mediaType:t,type:"media"}:e===o("WAMsgType").MSG_TYPE.SK_DISTRIBUTION?{isInvisible:!0,isRevoked:!1,type:"text"}:{isRevoked:n,type:"text"}}function s(t){var n=o("MAWMediaType").getMediaType(t);if(n!=null)return{mediaType:n,type:"media"};switch(t){case"XMA":case"Raven":case"RavenAction":case"EphemeralScreenshotAction":case"EditAction":case"BumpExistingMessage":return{isRevoked:!1,type:"text"};default:return e(t)}}function u(e){var t,n,r=(t=e.payload)==null||(t=t.subProtocol)==null?void 0:t.consumerMessage,a=(n=e.payload)==null||(n=n.subProtocol)==null?void 0:n.armadillo;if(r!=null){var i,l,s=o("decodeProtobuf").decodeProtobuf(o("WAConsumerApplication.pb").ConsumerApplicationSpec,r.payload);if((s==null||(i=s.payload)==null||(i=i.content)==null?void 0:i.reactionMessage)!=null)return{type:"reaction"};if(s!=null&&(l=s.payload)!=null&&(l=l.applicationData)!=null&&l.revoke)return{isRevoked:!0,type:"text"};var u=o("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(s);if(u!=null)return{mediaType:u,type:"media"}}if(a!=null){var c=o("decodeProtobuf").decodeProtobuf(o("WAArmadilloApplication.pb").ArmadilloSpec,a.payload),d=o("getMediaTypeFromConsumerMessage").getMediaTypeFromConsumerMessage(c);if(d!=null)return{mediaType:d,type:"media"}}return{isRevoked:!1,type:"text"}}l.waGetMessageTypeFromMsg=e,l.getMessageTypeFromMsg=s,l.getMessageTypeFromMessageApplication=u}),98);
__d("MAWGetMsgForSendingApi",["FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWDbGroupInviteTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbUnrenderedMsgTxns","MAWDbXMATxns","MAWDexieTable","MAWIndexedDb","MAWMsgType","MAWSendMsgUtil","MAWTransactionMode","MAWXMAUtils","WAJids","WALogger","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p=o("MAWIndexedDb").makeMsgrTransactor({groupInvites:(m=o("MAWTransactionMode")).READONLY,media:m.READONLY,messages:m.READONLY,reactions:m.READONLY,threads:m.READONLY,unrenderedMessages:m.READONLY,xma:m.READONLY},"getMsgForSending",function(t){return(function(n){return _(t,n).then(function(t){if(!t.success)return o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg "," -- MAWGetMsgForSendingAPI -- Error: ",""])),n,t.error),{type:t.error};var a=t.value,i=a.groupInvite,l=a.isReplyMsg,c=a.media,d=a.msg,m=a.xmaPayload;if(!o("MAWDbMsg").NO_CONTENT_MESSAGE_TYPES_ALLOWLIST.includes(d.type)&&!o("MAWDbMsg").isContentMsg(d))throw o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg "," -- MAWGetMsgForSendingAPI -- Unrecognized type ",""])),n,d.type),r("FBLogger")("messenger_web").mustfixThrow("We do not support message sending with "+d.type+" type");var p=o("MAWAsMessageApplication").asMessageApplication(d,c,i,m,d.threadJid),_;if(d.type===o("MAWMsgType").MSG_TYPE.GROUP_INVITE&&i?_={invitedParticipantUserJid:i.inviteeJid,isRevoked:!1,type:"text"}:_=o("MAWSendMsgUtil").getMessageTypeFromMsg(d.type),o("WAJids").isAuthorSystem(d.author))throw r("FBLogger")("messenger_web").mustfixThrow("A system message cannot be sent");return o("WALogger").LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg "," -- MAWGetMsgForSendingAPI -- Done"])),n),{dbMsg:d,isReplyMsg:l,isXMAMsg:m!=null,media:c,messageApplication:p,messageType:_,protocolMsgId:{author:d.author,chat:d.threadJid,externalId:m!=null&&m.associatedMessage!=null?m.associatedMessage.externalId:d.externalId},type:"unsent",xmaPayload:m}})})});function _(e,t){return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,t),o("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(e,t)]).then(function(n){var r=n[0],a=n[1],i=a.value,l=r||i;if(l==null)return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[SendMsg] Failed to get message"]))),o("WAResultOrError").makeError("missing_msg");if(l.ack>o("MAWAckLevel").ACK.clock)return o("WAResultOrError").makeError("sent");var s=o("MAWXMAUtils").maybeXMAMessage(r),u=l.quote!=null;return o("MAWDexieTable").dexieAll([r?o("MAWDbMediaTxns").getAndCheckMediaFromMsg(e,r):o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeResult()),a.success?o("MAWDbGroupInviteTxns").getAndCheckGroupInviteFromMsg(e,a.value):o("MAWDexieTable").dexieResolve(),s?o("MAWDbXMATxns").maybeGetXMAPayloadFromProtocolMsgId(e,t):null]).then(function(e){var t=e[0],n=e[1],r=e[2];if(!t.success)return t;if(r!=null&&!r.success)return o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[SendMsg] Failed to get XMA: isXma: ",", type: "," "])),s,l.type),o("WAResultOrError").makeError("missing_xma");var a=t.value;return o("WAResultOrError").makeResult({groupInvite:n,isReplyMsg:u,media:a,msg:l,xmaPayload:r!=null?r.value:null})})})}l.getMsgForSending=p}),98);
__d("MAWGetNoteReplyMsgForSendingApi",["MAWAckLevel","MAWAsMessageApplication","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWSendMsgUtil","MAWTransactionMode","WAJids","WALogger","WAResultOrError","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t,n){return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,n)]).then(function(t){var n=t[0],r=n;return r==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[SendMsg] Failed to get message"]))),o("WAResultOrError").makeError("missing_msg")):r.ack>o("MAWAckLevel").ACK.clock?o("WAResultOrError").makeError("sent"):o("WAResultOrError").makeResult({msg:r})})}var c=o("MAWIndexedDb").makeMsgrTransactor({media:(s=o("MAWTransactionMode")).READONLY,messages:s.READONLY,threads:s.READONLY,unrenderedMessages:s.READONLY},"getNoteReplyForSending",function(e){return(function(t){return u(e,t).then(function(e){if(!e.success)return{type:e.error};var t=e.value.msg,n=o("MAWAsMessageApplication").asNoteReplyMessageApplication(t),a=o("MAWSendMsgUtil").getMessageTypeFromMsg(t.type);if(o("WAJids").isAuthorSystem(t.author))throw r("err")("A system message cannot be sent");return{dbMsg:t,messageApplication:n,messageType:a,protocolMsgId:{author:t.author,chat:t.threadJid,externalId:t.externalId},type:"unsent"}})})});l.getNoteReplyForSending=c}),98);
__d("MAWGetReactionForSending",["FBLogger","MAWAckLevel","MAWAsMessageApplication","MAWDbReactionsTxns","MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode","WAJids","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return o("MAWDbReactionsTxns").maybeGetReactionByProtocolMsgId(e,t).then(function(t){return t==null?o("WAResultOrError").makeError("missing"):t.ack>o("MAWAckLevel").ACK.clock?o("WAResultOrError").makeError("sent"):o("MAWDbThreadTxns").getThread(e,t.threadJid).then(function(e){return e.success?o("WAResultOrError").makeResult({msg:t}):o("WAResultOrError").makeError(e.error)})})}var s=o("MAWIndexedDb").makeMsgrTransactor({reactions:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"getReactionForSending",function(t){return(function(n){return e(t,n).then(function(e){if(!e.success)return{type:e.error};var t=e.value.msg,n=o("MAWAsMessageApplication").asReactionMessageApplication(t);if(o("WAJids").isAuthorSystem(t.author))throw r("FBLogger")("messenger_web").mustfixThrow("This cannot happen because there are no system reactions");return{chat:t.threadJid,dbMsg:t,externalId:t.externalId,messageApplication:n,messageType:{isInvisible:!0,type:"reaction"},protocolMsgId:{author:t.author,chat:t.threadJid,externalId:t.externalId},type:"unsent"}})})});l.getReactionForSending=s}),98);
__d("MAWLoadThreadParticipantsApi",["MAWDbParticipantTxns","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MAWIndexedDb").makeMsgrTransactor({participants:o("MAWTransactionMode").READONLY,threads:o("MAWTransactionMode").READONLY},"loadThreadParticipants",function(t){return(function(n){return t.threads.get({jid:n}).then(function(n){return n==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["MAWLoadThreadParticipantsApi -- loadThreadParticipants -- there is no thread in db"]))),[]):o("MAWDbParticipantTxns").getParticipantsInThread(t,n.jid).then(function(e){return e.map(function(e){return e.userJid})})})})});l.loadThreadParticipants=s}),98);
__d("MAWMarkEditMsgDroppedApi",["FBLogger","MAWAckLevel","MAWBridgeMsg","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWIndexedDb","MAWJidUtils","MAWTransactionMode","WAGlobals","WAJids","WALogger","WAMsgType","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("MAWIndexedDb").makeMsgrTransactor({editMsgHistory:o("MAWTransactionMode").READWRITE,messages:o("MAWTransactionMode").READWRITE,threads:o("MAWTransactionMode").READWRITE},"markEditMsgDropped",function(t){return(function(n,a){var i=o("MAWJidUtils").maybeToProtocolMsgId(n.author,n.chat,a);return i==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] originalProtocolMsgId is null"]))),o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("missing_original_protocol_msg_id"))):o("MAWDexieTable").dexieAll([t.threads.get({jid:n.chat}),o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,i),o("MAWDbEditMsgHistoryTxns").maybeGetEditMsgHistoryFromProtocolMsgId(t,i)]).then(function(e){var i=e[0],l=e[1],f=e[2],g=f.sort(function(e,t){return t.editTs-e.editTs}),h=f.find(function(e){return e.editExternalId===n.externalId}),y=g[1];return l==null?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] originalMsg is null"]))),o("WAResultOrError").makeError("missing_original_msg")):h==null?(o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] newestEditedMsg is null"]))),o("WAResultOrError").makeError("missing_newest_edited_msg")):y==null?(o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] previousEditedMsg is null"]))),o("WAResultOrError").makeError("missing_previous_edited_msg")):h.editExternalId!==g[0].editExternalId?(o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] newestEditedMsg is not the newest edit"]))),o("WAResultOrError").makeError("invalid_newest_edited_msg")):i==null?(o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] thread is null"]))),o("WAResultOrError").makeError("missing_thread")):l.type!==o("WAMsgType").MSG_TYPE.TEXT?(o("WALogger").ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] originalMsg is not a text message"]))),o("WAResultOrError").makeError("invalid_original_msg")):t.messages.where("quoteExternalId").equals(a).toArray().then(function(e){var a,i=babelHelpers.extends({},l,{ack:o("MAWAckLevel").ACK.sent,editCount:((a=l.editCount)!=null?a:0)-1,msgContent:y.msgContent}),s=o("WAGlobals").getMyUserJid(),u=[],c=e.find(function(e){var t,r;return(((t=e.quote)==null?void 0:t.content.author)===o("WAJids").AUTHOR_ME||((r=e.quote)==null?void 0:r.content.author)===s)&&e.threadJid===n.chat});if(c!=null){var d=c.quote,m=c.quoteExternalId;if(d==null)r("FBLogger")("messenger_web").warn("[markEditMsgDropped] Failed to get the quoted content for a msg that has been quoted.",m);else{var p=babelHelpers.extends({},c,{quote:babelHelpers.extends({},d,{content:babelHelpers.extends({},d.content,{msgContent:babelHelpers.extends({},i.msgContent)})})});u.push(p)}}var g=[];return l.editCount===1&&f.length===2&&g.push(y.editMsgHistoryId),g.push(h.editMsgHistoryId),o("MAWDexieTable").dexieAll([t.messages.put(i),t.editMsgHistory.bulkDelete(g)]).then(function(){return o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgDropped] editMsgHistory updated"]))),o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(i)}),u.forEach(function(e){o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(e)})}),o("WAResultOrError").makeResult()})})})})});l.markEditMsgDropped=f}),98);
__d("MAWMarkEditMsgSentApi",["ArmadilloDataTraceType","MAWAckLevel","MAWBridgeMsg","MAWBridgeTrace","MAWBridgeTraceEvent","MAWDbEditMsgHistoryTxns","MAWDbMsgTxns","MAWDexieTable","MAWFTSTxns","MAWIndexedDb","MAWJidUtils","MAWLoadReplyMediaTxns","MAWTransactionMode","WAJids","WALogger","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f=o("MAWIndexedDb").makeMsgrTransactor({chunk:(_=o("MAWTransactionMode")).READONLY,editMsgHistory:_.READWRITE,ftsBackloggedMessages:_.READWRITE,media:_.READONLY,messages:_.READWRITE,receiverFetchInfo:_.READONLY,xma:_.READONLY},"markEditMsgSent",function(t){return(function(n,a,i,l){var _=o("MAWJidUtils").maybeToProtocolMsgId(n.author,n.chat,a);return _==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] originalProtocolMsgId is null"]))),o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("missing_original_protocol_msg_id"))):o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,_),o("MAWDbEditMsgHistoryTxns").maybeGetEditMsgHistoryFromProtocolMsgId(t,_),o("MAWFTSTxns").maybePutMessageToBacklog(t,a)]).then(function(e){var _=e[0],f=e[1],g=f.find(function(e){return e.editExternalId===a}),h=f.find(function(e){return e.editExternalId===n.externalId});if(_==null)return o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] originalMsg is null"]))),o("WAResultOrError").makeError("missing_original_msg");if(g==null)return o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] originalMsgHistory is null"]))),o("WAResultOrError").makeError("missing_original_msg_edit_history");if((h==null?void 0:h.editExternalId)==null)return o("WALogger").ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] editedMsg?.editExternalId is null"]))),o("WAResultOrError").makeError("missing_edit_external_id");if(h.sendStatus!=null&&h.sendStatus>o("MAWAckLevel").ACK.clock&&_.ack>o("MAWAckLevel").ACK.clock)return o("WALogger").LOG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] editMsgHistory has already been sent"]))),o("WAResultOrError").makeError("already_sent");if(h.author!==o("WAJids").AUTHOR_ME)return o("WALogger").ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] on incoming message"]))),o("WAResultOrError").makeError("not_author");o("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:o("MAWBridgeTrace").createBridgeUpdateTraceData([h.editExternalId],r("MAWBridgeTraceEvent").ReceivedSent,o("ArmadilloDataTraceType").armadilloMessageSend)});var y=[];if(f.length===2&&_.editCount===1){var C=babelHelpers.extends({},g,{sendStatus:o("MAWAckLevel").ACK.sent});y.push(C)}var b=babelHelpers.extends({},h,{editTs:i,sendStatus:o("MAWAckLevel").ACK.sent});y.push(b);var v=babelHelpers.extends({},_,{ack:o("MAWAckLevel").ACK.sent});return l!=null&&(v.reportingMeta=l),o("MAWDexieTable").dexieAll([t.editMsgHistory.bulkPut(y),t.messages.put(v),o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(t,v)]).then(function(e){var t=e[0],n=e[2];return o("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[markEditMsgSent] editMsgHistory updated"]))),o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(v,n)}),o("WAResultOrError").makeResult()})})})});l.markEditMsgSent=f}),98);
__d("MAWMarkMsgSentApi",["ArmadilloDataTraceType","MAWAckLevel","MAWBridgeTrace","MAWBridgeTraceEvent","MAWDbMsgTxns","MAWDbThread","MAWDbThreadTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWEphemeralMsgTxns","MAWEphemeralSettingsTxns","MAWIndexedDb","MAWMsgType","MAWTransactionMode","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("MAWIndexedDb").makeMsgrTransactor({chunk:(c=o("MAWTransactionMode")).READONLY,ephemeralSettings:c.READWRITE,groupInfo:c.READONLY,media:c.READONLY,messages:c.READWRITE,reactions:c.READONLY,receiverFetchInfo:c.READONLY,threads:c.READWRITE,unrenderedMessages:c.READWRITE,xma:c.READONLY},"markMsgSent",function(t){return(function(n,a,i){return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(t,n),o("MAWDbUnrenderedMsgTxns").maybeGetUnrenderedMsgByProtocolMsgId(t,n)]).then(function(l){var c=l[0],d=l[1];if(c==null&&!d.success){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Msg missing from DB"])));return}else if(c!=null){o("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:o("MAWBridgeTrace").createBridgeUpdateTraceData([c.externalId],r("MAWBridgeTraceEvent").ReceivedSent,o("ArmadilloDataTraceType").armadilloMessageSend)}),d.success&&o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Found both regular and unrendered message with the same protocol msg ID"])));var m=c.ack<o("MAWAckLevel").ACK.sent;return o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").updateSystemAck(t,c.msgId,o("MAWAckLevel").ACK.sent,a,i),o("MAWDbThreadTxns").getThread(t,c.threadJid)]).then(function(e){var n=e[0],r=e[1];if(!r.success){o("WALogger").ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Thread missing from DB"])));return}var i=r.value,l=o("WATimeUtils").castUnixTimeToMillisTime(a),s=babelHelpers.extends({},i,{lastReadMsgTs:l,newestMsgTs:l,threadOrder:o("MAWDbThread").craftThreadOrder(l,i.jid)}),c=m?o("MAWDbThreadTxns").updateThread(t,s):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([o("MAWEphemeralMsgTxns").markEphemeralMessageAsSent(t,n),c]).then(function(){})})}else if(d.success){var p=d.value;return o("MAWDbUnrenderedMsgTxns").updateSystemAckForUnrenderedMsg(t,p.msgId,o("MAWAckLevel").ACK.sent).then(function(){if(p.type===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE)return o("MAWEphemeralSettingsTxns").updateContactWhenEphemeralSettingChangeMarkedSent(t,n.chat,a)})}})})});l.markMsgSent=d}),98);
__d("MAWSendWrittenMsg",["EBLogger","MAWBridge","MAWDebugMsg","MAWGetEditMsgForSending","MAWGetMsgForSendingApi","MAWGetNoteReplyMsgForSendingApi","MAWGetReactionForSending","MAWJids","MAWLoadThreadParticipantsApi","MAWMarkEditMsgDroppedApi","MAWMarkEditMsgSentApi","MAWMarkMsgDroppedApi","MAWMarkMsgSentApi","MAWMessageSendsCommon","MAWODSProxy","MAWSendMsgUtil","MpsTypes","WAAPI","WAAsMessageApplication","WABuildMpsPayload","WAFrankingTypes","WAGlobals","WAMsgApplication.pb","WAOdsEnums","WAResultOrError","WebMps","asyncToGeneratorRuntime","encodeProtobuf","err","getErrorSafe","getSafeQplErrorMessage"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c;function d(e,t,n){return m.apply(this,arguments)}function m(){return m=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a){var i,l,d,m;o("MAWMessageSendsCommon").messageSendLogger.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg ",""])),String(t.protocolMsgId)),n.addPoint("get_msg_for_sending_start",{string:{type:t.type}});var p,_,f,g,h=null,y;if(a==null){var C,b;if(t.type==="message"||t.type==="revoke"||t.type==="bump")h=yield o("MAWGetMsgForSendingApi").getMsgForSending(t.protocolMsgId);else if(t.type==="reaction")h=yield o("MAWGetReactionForSending").getReactionForSending(t.protocolMsgId);else if(t.type==="edit")h=yield o("MAWGetEditMsgForSending").getEditMsgForSending(t.protocolMsgId,t.referencedOriginalExternalId);else if(t.type==="noteReply")h=yield o("MAWGetNoteReplyMsgForSendingApi").getNoteReplyForSending(t.protocolMsgId);else throw t.type,r("err")("This cannot happen because type has `message` as default argument but flow does not know that");if(h.type!=="unsent")return o("MAWMessageSendsCommon").messageSendLogger.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg not sending message: ",""])),h.type),o("WAResultOrError").makeError({details:h.type,isRetriable:!0,type:"wrong-message-state"});var v=h,S=v.dbMsg,R=v.isReplyMsg,L=v.isXMAMsg;y=h.protocolMsgId,p=h.messageApplication,f=h.messageType,_=S==null?void 0:S.type,g=h.editOriginalExternalId;var E=(S==null?void 0:S.ephemeralSetting)!=null&&((C=(b=S.ephemeralSetting)==null?void 0:b.ephemeralExpirationInSec)!=null?C:0)>0;n.addPoint("get_msg_for_sending_end",{bool:{isEditMsg:g!=null,isEphemeralMsg:E,isReplyMsg:R,isXMAMsg:L},string:{msgType:f.type}}),E&&o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.MAW_OLD_MESSAGE_SEND,key:"sendEphemeralMsg"})}else p=a.messageApplication,f=o("MAWSendMsgUtil").getMessageTypeFromMessageApplication(p),g=null,y=t.protocolMsgId;var k=o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,p).readBuffer(),I={bytes:o("WAAsMessageApplication").castToMessageApplicationBytes(new Uint8Array(k)),version:"v3"};n.addPoint("wa_send_msg_start");var T=yield r("WAAPI").sendChatMessage({loadThreadParticipants:o("MAWLoadThreadParticipantsApi").loadThreadParticipants,messagePayload:{backupDirective:null,frankingKey:(i=p.metadata)!=null&&i.frankingKey?o("WAFrankingTypes").castToFrankingKey(new Uint8Array((l=p.metadata)==null?void 0:l.frankingKey)):null,frankingVersion:(d=p.metadata)==null?void 0:d.frankingVersion,messageBytes:I,messageType:f,protocolMsgId:y}},n);if(T.success===!1){var D;switch(n.addPoint("wa_send_msg_fail",{string:{errorType:T.error.type,msgType:_}}),g!=null?yield o("MAWMarkEditMsgDroppedApi").markEditMsgDropped(y,g):yield o("MAWMarkMsgDroppedApi").markMsgDropped(y,T.error),o("MAWMessageSendsCommon").messageSendLogger.MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["sendWrittenMsg END "," : ",""])),T.error.type,String((D=T.payload)!=null?D:"")),T.error.type){case"non-retryable-error":{if(T.error.applicationErrorCode!=null&&T.error.applicationErrorCode===10009)try{o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:[{tag:"RefreshContact",value:o("MAWJids").convertChatJidToIntJid(y.chat)}]})}catch(e){var x=r("getErrorSafe")(e);o("EBLogger").EBLogger().catching(x).mustfix("Failed to call bridge handler RefreshContact for JID %s and mediaType %s",y.chat,_)}return T}case"missing-receipt":case"wrong-message-state":case"unexpected-message-codepath":case"result-parsing-error":case"retryable-error":case"no-recipients":case"encryption-error":case"too-many-retries":return T;default:throw T.error.type,r("err")("Unreachable code")}}T.success,n.addPoint("wa_send_msg_end"),(m=T.value.meta)!=null&&m.pOrDhashMismatch&&(n.addPoint("dhash_phash_mismatch"),o("MAWDebugMsg").writeDebugMsg(y.chat,"Outgoing msg "+y.externalId+" got a phash mismatch")),h!=null&&(n.addPoint("mark_edit_msg_sent_start"),g!=null?yield o("MAWMarkEditMsgSentApi").markEditMsgSent(y,g,T.value.serverTs,T.value.reportingMeta):yield o("MAWMarkMsgSentApi").markMsgSent(y,T.value.serverTs,T.value.reportingMeta),n.addPoint("mark_edit_msg_sent_end"));try{var $,P;yield o("WebMps").mps().saveNewMessages([{directive:null,insertionSource:o("MpsTypes").InsertionSource.Send,message:o("WABuildMpsPayload").buildMpsMessage({encryptedTransportMessage:k},{externalId:y.externalId,frankingTag:($=T.value.reportingMeta)==null?void 0:$.frankingTag,reportingTag:(P=T.value.reportingMeta)==null?void 0:P.reportingTag,senderJid:o("WAGlobals").getMyUserJid(),serverTs:T.value.serverTs,threadId:y.chat})}],{source:"wa-message-sent"})}catch(e){o("MAWMessageSendsCommon").messageSendLogger.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to save message to MPS: ",""])),o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e))}return T}),m.apply(this,arguments)}function p(e,t,n,r){return t.addAnnotations({bool:{is_secure:!0},string:{description:n,jid:e.protocolMsgId.chat}}),d(e,t,r)}l.sendWrittenMsgExternal=p}),98);
__d("MAWBuildNewMsgPayload",["FBLogger","MAWAdminMsgType","MAWAuthor","MAWDbMsg","MAWJids","MAWMsgType","WAArmadilloXMA.pb","WAAssertUnreachable","WAJids","WALogger","WAMsgType","WAStanzaUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n,a){var i;if(o("MAWDbMsg").isUnrenderedMsgType(e))throw r("FBLogger")("messenger_web").mustfixThrow("getNewMsg called for wrong message type "+e);var l,s;if(n.quote!=null&&(a==null?void 0:a.content)!=null){var u,c;s=a==null||(u=a.content)==null?void 0:u.externalId,l={content:a==null?void 0:a.content,remoteJid:(c=a==null?void 0:a.remoteJid)!=null?c:void 0}}if(n.noteContent!=null){var d=o("MAWJids").toUserJid(t.threadJid);l={content:{author:d,expirationTs:o("WATimeUtils").castToUnixTime(n.noteExpirationTs),externalId:t.externalId,msgContent:{content:n.noteContent},ts:t.ts,type:o("WAMsgType").NOTE_REPLY},remoteJid:void 0}}var m=babelHelpers.extends({},t,{quote:l,quoteExternalId:s}),p,_=n.mediaGroupMetadata;switch(e){case"Text":return babelHelpers.extends({},m,{msgContent:{commands:n.commands,content:n.content!=null?n.content:"",mentionedJids:n.mentionedJids},type:o("MAWMsgType").MSG_TYPE.TEXT});case"Image":return babelHelpers.extends({},m,{hdType:n.hdType,type:o("MAWMsgType").MSG_TYPE.IMAGE},_);case"Video":return babelHelpers.extends({},m,{type:o("MAWMsgType").MSG_TYPE.VIDEO});case"Ptt":return babelHelpers.extends({},m,{type:o("MAWMsgType").MSG_TYPE.PTT});case"Gif":return babelHelpers.extends({},m,{type:o("MAWMsgType").MSG_TYPE.GIF});case"Sticker":return babelHelpers.extends({},m,{type:o("MAWMsgType").MSG_TYPE.STICKER});case"DocumentFile":return babelHelpers.extends({},m,{type:o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE});case"XMA":if(n.xmaMessageType==null)throw r("FBLogger")("messenger_web").mustfixThrow("XMA Message Missing xmaMessageType");return p=n.content!=null&&n.xmaMessageType===o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE?n.content:"",babelHelpers.extends({},m,{msgContent:{commands:n.commands,content:p,mentionedJids:n.mentionedJids},type:o("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:n.xmaMessageType});case"EditAction":throw r("FBLogger")("messenger_web").mustfixThrow("EditAction is not supported yet");case"BumpExistingMessage":return babelHelpers.extends({},m,{type:o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE});case"ReceiverFetch":throw r("FBLogger")("messenger_web").mustfixThrow("ReceiverFetch is not supported yet");case"GroupPollCreate":return babelHelpers.extends({},t,{msgContent:{adminMsgContent:[(i=n.title)!=null?i:""],adminType:o("MAWAdminMsgType").CURRENT_USER_CREATED_POLL,version:1},type:o("MAWMsgType").MSG_TYPE.GROUP_POLL_CREATE});case"GroupPollUpdate":throw r("FBLogger")("messenger_web").mustfixThrow("GroupPollUpdate is not supported yet");case"Revoked":case"DeleteForMe":case"Ciphertext":case"Futureproof":case"Unavailable":case"Admin":case"ExpiredEphemeral":case"EphemeralSettingAdmin":case"EphemeralScreenshotAction":case"AlertICDC":case"GroupInvite":case"Reaction":case"Raven":case"RavenAction":case"NoteReply":throw r("FBLogger")("messenger_web").mustfixThrow("Should not be writing ciphertext, futureproof, unsent, admin,\n        ephemeral setting messages, ephemeral screenshot action, group invite messages");default:throw r("WAAssertUnreachable")(e)}}function c(e,t,n,a){if(!o("MAWDbMsg").isUnrenderedMsgType(e))throw r("FBLogger")("messenger_web").mustfixThrow("getNewUnrenderedMsg called for wrong message type "+e);switch(e){case"EphemeralSyncResponse":{if(n.ephemeralSetting==null)throw r("FBLogger")("messenger_web").mustfixThrow("Ephemeral Sync Response without ephemeral settings");return babelHelpers.extends({},t,{ephemeralSetting:n.ephemeralSetting,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE})}case"EphemeralSettingChangeFromCurrentDevice":{var i;if(n.ephemeralSetting==null)throw r("FBLogger")("messenger_web").mustfixThrow("Ephemeral Setting Change without ephemeral settings");return babelHelpers.extends({},t,{ephemeralSetting:n.ephemeralSetting,isEphemeralSettingReset:(i=n.isEphemeralSettingReset)!=null?i:!1,type:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE})}case"GroupInvite":{var l=o("WAJids").interpretAsGroupJid(t.threadJid);if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("Group Invite without valid group jid");if(n.invitedParticipantUserJid==null)throw r("FBLogger")("messenger_web").mustfixThrow("Group Invite without invited user jid");return babelHelpers.extends({},t,{groupName:n.groupName==null?void 0:n.groupName,invitedParticipantUserJid:n.invitedParticipantUserJid,type:o("MAWMsgType").MSG_TYPE.GROUP_INVITE})}case"SenderKeyDistribution":return babelHelpers.extends({},t,{type:o("MAWMsgType").MSG_TYPE.SK_DISTRIBUTION});case"RavenAction":{if(a==null)throw r("FBLogger")("messenger_web").mustfixThrow("Raven Action without Raven Message External Id");if(n.actionType==null)throw r("FBLogger")("messenger_web").mustfixThrow("Raven Action without Action Type");return babelHelpers.extends({},t,{actionType:n.actionType,ravenActionToMsgExternalId:o("WAStanzaUtils").toStanzaId(a),type:o("MAWMsgType").MSG_TYPE.RAVEN_ACTION})}case"EditAction":throw r("FBLogger")("messenger_web").mustfixThrow("Edit action not implemented yet");default:throw r("WAAssertUnreachable")(e)}}function d(t){var n,a={author:o("MAWAuthor").getAuthorUserJid(t.author)||o("WAJids").AUTHOR_ME,externalId:t.externalId,mediaId:t.mediaId,msgId:t.msgId,plaintextHash:t.plaintextHash,specialTextSize:t.specialTextSize,ts:t.ts,xmaMessageType:t.xmaMessageType};switch(t.type){case o("MAWMsgType").MSG_TYPE.IMAGE:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.IMAGE});case o("MAWMsgType").MSG_TYPE.VIDEO:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.VIDEO});case o("MAWMsgType").MSG_TYPE.PTT:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.PTT});case o("MAWMsgType").MSG_TYPE.TEXT:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.TEXT});case o("MAWMsgType").MSG_TYPE.STICKER:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.STICKER});case o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.DOCUMENT_FILE});case o("MAWMsgType").MSG_TYPE.GIF:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.GIF});case o("MAWMsgType").MSG_TYPE.XMA:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.XMA,xmaMessageType:t.xmaMessageType});case o("MAWMsgType").MSG_TYPE.REVOKED:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.UNAVAILABLE});case o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE:return((n=t.quote)==null?void 0:n.content)==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["BumpExistingMessage does not have quote content when replying"]))),null):babelHelpers.extends({},t.quote.content,{author:o("MAWAuthor").getAuthorUserJid(t.quote.content.author)||o("WAJids").AUTHOR_ME});case o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH:return babelHelpers.extends({},a,{msgContent:t.msgContent,type:o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH});case o("MAWMsgType").MSG_TYPE.RAVEN:return babelHelpers.extends({},a,{ravenEphemeralMediaState:t.ravenEphemeralMediaState,ravenEphemeralType:t.ravenEphemeralType,ravenMediaType:t.ravenMediaType,type:o("MAWMsgType").MSG_TYPE.RAVEN});default:throw o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["msgToQuotedMsg: Unsupported message type ",""])),t.type),r("FBLogger")("messenger_web").mustfixThrow("Trying to reply to a message type that does not support replies")}}l.buildNewMsg=u,l.getNewUnrenderedMsg=c,l.msgToQuotedMsg=d}),98);
__d("MAWWriteOutgoingMsgApi",["MAWAckLevel","MAWBuildNewMsgPayload","MAWDbMsg","MAWDbMsgTxns","MAWDbRavenActionTxns","MAWDexieTable","MAWIndexedDb","MAWLoadReplyMediaTxns","MAWMsgType","MAWQplProxy","MAWTransactionMode","MAWVault","MAWWriteMsgTxns","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(t,n,r,a){n!=null&&o("MAWQplProxy").sendQplPointThroughBridge(r,t,{annotations:a,instanceKey:n})},u=o("MAWIndexedDb").makeMsgrTransactor({chunk:(e=o("MAWTransactionMode")).READONLY,ephemeralSettings:e.READWRITE,ftsBackloggedMessages:e.READWRITE,groupInfo:e.READONLY,media:e.READONLY,messages:e.READWRITE,receiverFetchInfo:e.READONLY,threads:e.READWRITE,unrenderedMessages:e.READWRITE,xma:e.READONLY},"writeOutgoingMsg",function(e){return(function(t,n,r,o,a,i,l){return c(e,t,n,r,o,a,i,l)})});function c(e,t,n,r,a,i,l,u){return a.content!=null&&(a.content=o("MAWVault").vault(a.content)),s("write_outgoing_msg_start",u,l),o("MAWDexieTable").dexieAll([e.threads.get({jid:n}),e.messages.where("externalId").equals(t).toArray(),d(e,a.quote,n),o("MAWDbRavenActionTxns").maybeGetRavenMsgQueryByProtocolMsgId(e,a.ravenProtocolMsgId,i)]).then(function(n){var c=n[0],d=n[1],p=n[2],_=n[3];if(s("write_outgoing_msg_data_fetched",u,l,{bool:{isUnrenderedMsgType:o("MAWDbMsg").isUnrenderedMsgType(i)}}),c==null)return{type:"missing_thread"};var f=d.find(function(e){return e.threadJid===c.jid&&e.author===o("WAJids").AUTHOR_ME});if(f!=null)return f.ack>=o("MAWAckLevel").ACK.sent?{msgId:f.msgId,protocolMsgId:{author:o("WAJids").AUTHOR_ME,chat:c.jid,externalId:f.externalId},type:"already_sent"}:{msgId:f.msgId,protocolMsgId:{author:o("WAJids").AUTHOR_ME,chat:c.jid,externalId:f.externalId},type:"not_sent"};var g;if(o("MAWDbMsg").isUnrenderedMsgType(i)){var L={ack:o("MAWAckLevel").ACK.clock,author:o("WAJids").AUTHOR_ME,externalId:t,threadJid:c.jid,ts:r},E=o("MAWBuildNewMsgPayload").getNewUnrenderedMsg(i,L,a,_==null?void 0:_.externalId);g=o("MAWWriteMsgTxns").writeUnrenderedMsg(e,E,c)}else{var h={ack:o("MAWAckLevel").ACK.clock,altIndex:void 0,author:o("WAJids").AUTHOR_ME,ephemeralSetting:a.ephemeralSetting,externalId:t,isForwarded:a.isForwarded,specialTextSize:a.specialTextSize,threadJid:c.jid,ts:r},y=o("MAWBuildNewMsgPayload").buildNewMsg(i,h,a,p),C=a.isFirstMsg,b=a.openMessageOtid,v=a.openMessageParticipantCount,S=a.optimisticMsg,R=a.participantCount;g=o("MAWLoadReplyMediaTxns").getReplyMediaForMsgQuote(e,y).then(function(t){return o("MAWWriteMsgTxns").writeMsg(e,y,c,{isFirstMsg:C,isOutgoing:!0,openMessageOtid:b,openMessageParticipantCount:v,optimisticMsg:S,participantCount:R,quotedReplyAttachmentMeta:t})})}return g.then(function(n){return s("write_outgoing_msg_promise_resolved",u,l),m(e,i,c.jid,r).then(function(){return{msgId:n.msgId,protocolMsgId:{author:o("WAJids").AUTHOR_ME,chat:c.jid,externalId:t},type:"not_sent"}})})})}function d(e,t,n){return t==null?o("MAWDexieTable").dexieResolve(null):o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,t).then(function(t){return t==null?null:e.threads.get({jid:t.threadJid}).then(function(e){var r=o("MAWBuildNewMsgPayload").msgToQuotedMsg(t);if(r==null)return null;if(t.messageExpirationTs!=null&&t.messageExpirationTs<o("WATimeUtils").unixTime()&&(r=babelHelpers.extends({},r,{mediaId:void 0,msgContent:void 0,type:o("MAWMsgType").MSG_TYPE.EXPIRED_EPHEMERAL,xmaMessageType:void 0})),e==null||e.jid===n)return{content:r,remoteJid:null};var a=o("WAJids").interpretAndValidateJid(e.jid),i=a.jidType==="group"?a.groupJid:null;return{content:r,remoteJid:i}})})}function m(e,t,n,a){return t===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE?o("WAJids").switchOnMsgrChatJidType(n,{group:function(){return o("MAWDexieTable").dexieResolve()},user:function(n){return e.ephemeralSettings.get({userJid:n}).then(function(t){var n,r;return t==null?o("MAWDexieTable").dexieResolve():(t.ephemeralSyncResponseBackoffInfo={syncResponseRetries:((n=(r=t.ephemeralSyncResponseBackoffInfo)==null?void 0:r.syncResponseRetries)!=null?n:0)+1,syncResponseSentTs:a},e.ephemeralSettings.put(t))}).then(r("emptyFunction"))}}):t===o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE?o("WAJids").switchOnMsgrChatJidType(n,{group:function(){return o("MAWDexieTable").dexieResolve()},user:function(n){return e.ephemeralSettings.get({userJid:n}).then(function(t){return t==null||t.ephemeralSyncResponseBackoffInfo==null?o("MAWDexieTable").dexieResolve():(t.ephemeralSyncResponseBackoffInfo=void 0,e.ephemeralSettings.put(t).then(r("emptyFunction")))})}}):o("MAWDexieTable").dexieResolve()}l.writeOutgoingMsg=u,l.writeOutgoingMsgImpl=c,l.getQuoteInfo=d}),98);
__d("MAWSendEphemeralSettingMsg",["MAWGetSyncResponseBackoffInfoByJidApi","MAWLoggerUtils","MAWMessageSendsCommon","MAWMsgType","MAWSendWrittenMsg","MAWWriteOutgoingMsgApi","MWFBLogger","WAAPI","WAJids","WAQPLProxy","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.SettingSync]);function m(e,t,n,r,o,a){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l,m){if(t.isForSyncResponse){var p=yield o("WAJids").switchOnMsgrChatJidType(n,{group:function(){throw d.mustfixThrow("ChatJid is not supposed to be a group")},user:function(t){return o("MAWGetSyncResponseBackoffInfoByJidApi").getSyncResponseBackoffInfoByJid(t)}});if(f(i,p))return d.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["ephemeral sync response backed off"]))),o("WAResultOrError").makeResult({description:"send not needed",messageType:"fixMe"})}var _=t.isForSyncResponse?o("MAWMsgType").MSG_TYPE.EPHEMERAL_SYNC_RESPONSE:o("MAWMsgType").MSG_TYPE.EPHEMERAL_SETTING_CHANGE_FROM_CURRENT_DEVICE;yield r("WAAPI").getDevicesBeforeSend({chatJid:n,reason:"SendEphemeralSettings"});var g=yield o("MAWWriteOutgoingMsgApi").writeOutgoingMsg(a,n,i,t,_,l,m);if(d.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["send ephemeral setting message: chatJid ",", type ",", externalId ",""])),n,_,a),g.type==="already_sent")return d.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["sendMsg already sent message"]))),o("WAResultOrError").makeError({isRetriable:!1,type:"already-sent"});if(g.type==="missing_thread")return d.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["sendMsg cannot send to a non-existent thread"]))),o("WAResultOrError").makeError({isRetriable:!1,type:"missing-thread"});var h=yield o("MAWSendWrittenMsg").sendWrittenMsgExternal({protocolMsgId:g.protocolMsgId,type:"message"},o("WAQPLProxy").waQPLProxyStartResume(l,m),"MAWSendEphemeralSettingMsg");return h.success===!1?o("WAResultOrError").makeError(h.error):o("WAResultOrError").makeResult({chatJid:g.protocolMsgId.chat,content:t.content,ephemeralSetting:t.ephemeralSetting,externalId:g.protocolMsgId.externalId,initiatingSource:t.initiatingSource,messageType:"sendMsg",quote:t.quote,source:t.source,specialTextSize:t.specialTextSize,xmaMessageType:t.xmaMessageType})}),p.apply(this,arguments)}function _(e){var t=e.args,n=e.chatJid,r=e.externalId,a=e.qplEventType,i=e.qplInstanceKey;return o("MAWMessageSendsCommon").messageSendObserver(a,i,function(e){return m(t,n,r,e,a,i)},"ephemeral",{author:o("WAJids").AUTHOR_ME,chat:n,externalId:r})}function f(e,t){if(t==null)return!1;var n=t.syncResponseRetries,r=t.syncResponseSentTs;switch(n){case 1:return o("WATimeUtils").happenedWithinAt(e,r,180);case 2:return o("WATimeUtils").happenedWithinAt(e,r,900);default:return!0}}l.sendEphemeralSettingMsgFn=_}),98);
__d("WAGroupParserUtils",["WAGroupInviteUtils","WAJids","WALogger","WAResultOrError","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s={superadmin:"superadmin",admin:"admin",participant:"participant",nonparticipant:"nonparticipant"};function u(t){if(!t.hasAttr("error"))throw r("err")("Expected participant node to have error attr");var n=t.attrInt("error"),a=t.attrUserJid("jid");switch(n){case 401:return{errorCode:n,text:"not-authorized",user:a};case 403:{var i=t.child("add_request");return{errorCode:n,text:"request-code",code:o("WAGroupInviteUtils").toInviteCode(i.attrString("code")),expiration:i.attrTime("expiration"),user:a}}case 404:return{errorCode:n,text:"not-found",user:a};case 406:return{errorCode:n,text:"enterprise-not-allowed",user:a};case 408:return{errorCode:n,text:"temporarily-blocked",user:a};case 409:return{errorCode:n,text:"conflict",user:a};case 500:return{errorCode:n,text:"resource-constraint",user:a};default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["received unknown participant error code: ",""])),n),{errorCode:-1,text:"unknown",user:a}}}function c(e,t){e.assertTag("participant");var n="participant";switch(t){case"add":case"demote":n="participant";break;case"promote":n="admin";break;case"remove":n="nonparticipant";break}var r=e.attrUserJid("jid");if(e.hasAttr("error")){var a=u(e);return o("WAResultOrError").makeError(a)}else{var i=e.attrEnumOrDefault("type",s,n),l=e.maybeAttrString("addressable")!=="false";return o("WAResultOrError").makeResult({user:r,type:i,addressable:l})}}function d(e){e.assertTag("group");var t=null,n=e.attrString("id");return n.includes("@")?t=e.attrGroupJid("id"):t=o("WAJids").toGroupJid(n),{jid:t,creator:e.maybeAttrUserJid("creator")||void 0,creationTs:e.attrTime("creation"),subject:{content:e.maybeAttrString("subject")||void 0,user:e.maybeAttrUserJid("s_o")||void 0,ts:e.hasAttr("s_t")?e.attrTime("s_t"):void 0},description:p(e)||void 0,participantVersion:e.maybeAttrString("p_v_id")||void 0,participants:e.mapChildrenWithTag("participant",function(e){return c(e)}),memberAddMode:m(e)||void 0}}function m(e){if(e.hasChild("member_add_mode")){var t=e.child("member_add_mode");if(t.hasContent()){var n=t.contentString();if(n==="admin_add"||n==="all_member_add")return n}}return null}function p(e){if(e.hasChild("description")){var t=e.child("description");if(t.hasChild("body")){var n=t.child("body");if(n.hasContent())return{id:t.attrString("id"),ts:t.attrTime("t"),content:n.contentString(),user:n.maybeAttrUserJid("participant")||void 0}}}return null}l.PARTICIPANT_TYPES=s,l.parseProtocolGroupParticipantNode=c,l.parseGroupNode=d}),98);
__d("WAWaterFlow",["$InternalEnum","WAMapWithDefault","WAPREMetrics","WATagsLogger","WATimeUtils","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h=o("WATagsLogger").TAGS(["WAWaterflow"]),y=n("$InternalEnum").Mirrored(["INIT","ON_GOING","COMPLETED"]),C=(function(){function t(e,t,n){this.$1=y.INIT,this.$7=[],this.$9=new(o("WAMapWithDefault")).MapWithDefault(function(){return[]}),this.$5=h.TAGS([e]),this.$8=t,this.$3={},this.$4=new Set,this.$10=!n,this.$6=o("WATimeUtils").performanceAbsoluteNow()}var n=t.prototype;return n.$11=function(){var e=this,t={int:{},bool:{},string:{},string_array:{}};return this.$4.forEach(function(n){var r=e.$3[n];Array.isArray(r)&&(t.string_array[n]=r),typeof r=="boolean"&&(t.bool[n]=r),typeof r=="number"&&(t.int[n]=r),typeof r=="string"&&(t.string[n]=r)}),t},n.$12=function(t){if(t!=null)for(var e in t){var n=t[e];n!==this.$3[e]&&(this.$4.add(e),this.$3[e]=n)}},n.$13=function(n,r){this.$6=o("WATimeUtils").performanceAbsoluteNow(),this.$12(n);var t=this.$11();return this.$4.clear(),this.$10&&this.$5.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose([" -> Start.",""])),v(this.$3)),this.$1=y.ON_GOING,this.$8==null?this:(this.$2=o("WAPREMetrics").startMetric(this.$8,t,r),this)},n.startMetric=function(t){return this.$13(t)},n.reStartMetric=function(t,n){return this.$13(n,t)},n.startPoint=function(t,n){var e;if(typeof t!="string")throw this.$5.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Step should be a enum type"]))),r("err")("Step should be a enum type");this.$12(n);var a=this.$11();(e=this.$2)==null||e.addPoint(t+"_start",a),this.$4.clear();var i={step:t,from:o("WATimeUtils").performanceAbsoluteNow()};this.$7.push(i),this.$9.get(t).push(i),this.$10&&this.$5.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose([""," -> Start.","",""])),t,S(this.$7,this.$6),v(this.$3))},n.endPoint=function(t,n){var e,a=o("WATimeUtils").performanceAbsoluteNow(),i=this.$9.get(t).pop();if(i==null?this.$5.WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["No start point was found for step: ","."])),t):i.to=a,typeof t!="string")throw this.$5.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Step should be a enum type"]))),r("err")("Step should be a enum type");this.$12(n);var l=this.$11();(e=this.$2)==null||e.addPoint(t+"_end",l),this.$4.clear(),this.$10&&this.$5.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose([""," -> Done.;\nTime taken: ",";\nTime from start: ",";","","\n"])),t,R(i!=null?a-i.from:0),R(a-this.$6),S(this.$7,this.$6),v(this.$3))},n.isOnGoing=function(){return this.$1===y.ON_GOING},n.isCompleted=function(){return this.$1===y.COMPLETED},n.annotate=function(t){this.$12(t)},n.reAnnotate=function(t){this.$12(t(this.$3))},n.getAnnotations=function(){return this.$3},n.annotateImmediately=function(t){var e;this.$12(t);var n=this.$11();(e=this.$2)==null||e.addAnnotations(n),this.$4.clear()},n.addPoint=function(t,n){var e;if(typeof t!="string")throw this.$5.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Step should be a enum type"]))),r("err")("Step should be a enum type");this.$12(n);var o=this.$11();(e=this.$2)==null||e.addPoint(t,o),this.$4.clear()},n.getStartTime=function(){return this.$6},n.log=function(){this.$10&&this.$5.LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose([" -> in progress.\nTime passed: "," sec;","","\n"])),(o("WATimeUtils").performanceAbsoluteNow()-this.$6)/1e3,S(this.$7,this.$6),v(this.$3))},n.endSuccess=function(t){var e;this.$12(t);var n=this.$11();(e=this.$2)==null||e.endSuccess(n),this.$4.clear(),this.$10&&this.$5.LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose([" -> Done. Success: true\nTime taken: "," sec;","","\n"])),(o("WATimeUtils").performanceAbsoluteNow()-this.$6)/1e3,S(this.$7,this.$6),v(this.$3)),this.$1=y.COMPLETED},n.endFail=function(t,n){var e;this.$12(n);var r=this.$11();(e=this.$2)==null||e.endFail(t,r),this.$4.clear(),this.$10&&this.$5.LOG(g||(g=babelHelpers.taggedTemplateLiteralLoose([" -> Done. Success: false\nTime taken: "," sec;","","\n"])),(o("WATimeUtils").performanceAbsoluteNow()-this.$6)/1e3,S(this.$7,this.$6),v(this.$3)),this.$1=y.COMPLETED},t})();function b(e){if(e==null)return{};var t={bool:{},int:{},string:{},string_array:{}};for(var n in e)Array.isArray(e[n])&&(t.string_array[n]=e[n]),typeof e[n]=="number"&&(t.int[n]=e[n]),typeof e[n]=="boolean"&&(t.bool[n]=e[n]),typeof e[n]=="string"&&(t.string[n]=e[n]);return t}function v(e){var t=Object.entries(e).map(function(e){var t=e[0],n=e[1];return t+": "+String(n)});return t.length>0?"\n"+t.join("\n"):""}function S(e,t){var n=e.map(function(e){var n=e.step,r=e.from,a=e.to;return typeof n=="string"?n+" => Started after: "+R(r-t)+"; "+(a!=null?"Completed after: "+R(a-r):"In progress: "+R(o("WATimeUtils").performanceAbsoluteNow()-r)):""}).filter(Boolean);return n.length>0?"\n"+n.join("\n"):""}function R(e){return e/1e3+"s"}function L(e,t,n){return new C(e,t,n!=null?n:!1)}l.WAWaterflow=C,l.convertToPREAnnotation=b,l.makeWaterflow=L}),98);
__d("WAQueryGroupOverChatD",["$InternalEnum","WADeprecatedSendIq","WADeprecatedWapParser","WAGroupParserUtils","WAPREList","WAPREMetrics","WAResultOrError","WAWap","WAWaterFlow","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=new(r("WADeprecatedWapParser"))("queryAllGroupsResponse",function(e){return e.assertTag("iq"),{groups:e.child("groups").mapChildren(o("WAGroupParserUtils").parseGroupNode)}});function s(){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t,n=o("WAPREMetrics").startMetric(o("WAPREList").PRE_METRIC.QUERY_GROUPS),r=(t=o("WAWap")).wap("iq",{id:t.generateId(),to:t.G_US,type:"get",xmlns:"w:g2"},t.wap("participating",null,t.wap("participants",null),t.wap("description",null))),a=yield o("WADeprecatedSendIq").deprecatedSendIq(r,e);return a.success?(n.endSuccess(),o("WAResultOrError").makeResult(a.result)):(n.endFail("query_groups_fail"),o("WAResultOrError").makeError(a))}),u.apply(this,arguments)}var c=new(r("WADeprecatedWapParser"))("queryAllGroupsResponse",function(e){return e.assertTag("iq"),{group:o("WAGroupParserUtils").parseGroupNode(e.child("group"))}}),d=n("$InternalEnum").Mirrored(["IQ_REQUEST"]);function m(e){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n=e.groupJid,r=o("WAWaterFlow").makeWaterflow("query-group",o("WAPREList").PRE_METRIC.QUERY_GROUP).startMetric();r.addPoint(d.IQ_REQUEST);var a=yield o("WADeprecatedSendIq").deprecatedSendIq((t=o("WAWap")).wap("iq",{id:t.generateId(),to:t.GROUP_JID(n),type:"get",xmlns:"w:g2"},t.wap("query",null)),c);return a.success?(r.endSuccess(),o("WAResultOrError").makeResult(a.result.group)):(r.endFail("Fail-"+a.errorCode),o("WAResultOrError").makeError(a.errorText))}),p.apply(this,arguments)}l.queryAllGroups=s,l.parseQueryGroupResponse=c,l.queryGroupOverChatD=m}),98);
__d("WAQueryGroupInvite",["WADeprecatedSendIq","WAPREList","WAPREMetrics","WAQueryGroupOverChatD","WAResultOrError","WAWap","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n,r){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){var a,i=o("WAPREMetrics").startMetric(o("WAPREList").PRE_METRIC.QUERY_GROUP,{string:{key:"query_group_invite"}}),l=(a=o("WAWap")).wap("iq",{id:a.generateId(),to:a.GROUP_JID(e),type:"get",xmlns:"w:g2"},a.wap("query",null,a.wap("add_request",{admin:a.USER_JID(r),code:a.CUSTOM_STRING(t),expiration:a.CUSTOM_STRING(n.toString(10))}))),s=yield o("WADeprecatedSendIq").deprecatedSendIq(l,o("WAQueryGroupOverChatD").parseQueryGroupResponse);return s.success?(i.endSuccess(),o("WAResultOrError").makeResult(s.result.group)):(i.endFail("query_group_for_invitee_fail"),o("WAResultOrError").makeError(s))}),s.apply(this,arguments)}l.queryGroupInvite=e}),98);
__d("MAWCOPMessagesHandler",["FBLogger","LSMEBTaskCreationSource","LSMessagingThreadAttributionType","MAWBridge","MAWCommonScheduler","MAWDebugMsg","MAWExternalId","MAWIsQuotaExceededError","MAWJobDefinitions","MAWJobManager","MAWLoggerUtils","MAWMessageDropError","MAWMessageParseError","MAWMsgType","MAWODSProxy","MAWProtocolQueueDecodeProto","MAWProtocolQueueMsg","MAWProtocolQueueUtils","MAWQplProxy","MAWSendEphemeralSettingMsg","MAWSharedCOPLogger","MWSharedS2SBaseAnnotations","Promise","WACreateGroup","WAGlobals","WAHashUtils","WAJids","WAMsgMap","WAOdsEnums","WAProtocolQueue","WAQueryGroupInvite","WAQueryGroupsAndSync","WAResultOrError","WATimeUtils","WorkerScheduler","asyncToGeneratorRuntime","err","getErrorSafe","gkx","promiseDone","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f;function g(t,n){return n===void 0&&(n=r("LSMEBTaskCreationSource").UNKNOWN),h(t,n).catch(function(t){if(o("MAWIsQuotaExceededError").isQuotaExceededError(t))throw t;return r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Message consumer error"]))),[]})}function h(e,t){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){if(e.length===0)return[];var n=new Set;R(e);var a=new(o("WAMsgMap")).MsgMap,i=new Map(e.map(function(i){var l=L(i),s=o("WAProtocolQueue").mapProcolQueueMessageV2toV1(l),u=s.incomingType==="ebrestore",c=o("MAWProtocolQueueUtils").startMetricForIncomingMsgV2(s,t);c.addAnnotations({int:{batchSize:e.length}});try{if(s.message.decrypted.type==="InstamadilloMsg"){if(r("gkx")("3577"))return o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.IGDW_INSTAMADILLO_MESSAGE_ON_OLD_WORKER,key:"message"}),n.add(s.stanzaQueueId),c.endFail("instamadillo_msg_on_old_worker"),null;throw c.endFail("instamadillo_msg_not_supported_on_msgr"),r("FBLogger")("messenger_web").mustfixThrow("InstamadilloMsg is not supported in MSGR. Should never happen.}")}var m=o("MAWProtocolQueueDecodeProto").decodeMsg(s.message.decrypted,s.ebTimestampMs);return a.set(s.message.decrypted.id,s.incomingType),u&&(s.message.details.type=(m==null?void 0:m.unstoredDbReaction)!=null?"reaction":(m==null?void 0:m.unstoredXMA)!=null||(m==null?void 0:m.unstoredDbMedia)!=null?"media":"text"),[s.stanzaQueueId,o("MAWProtocolQueueUtils").addAnnotationsToMessage({decodedMsg:m!=null?m:void 0,stanza:babelHelpers.extends({},s)},c)]}catch(e){var p,_,f=e instanceof Error?e:r("err")("Unknown error");r("MAWSharedCOPLogger").catching(f).MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Decode error"])));var g=e instanceof o("MAWMessageParseError").MAWMessageParseError?e:null,h=e instanceof o("MAWMessageDropError").MAWMessageDropError;return h?(n.add(s.stanzaQueueId),c.addPoint("network_verification_msg_dropped"),c.endSuccess({string:{isDropped:"true"}}),null):(n.add(s.stanzaQueueId),c.endFail("decoding_error",{string:{errorDescription:(p=(_=g==null?void 0:g.message)!=null?_:f==null?void 0:f.message)!=null?p:"",isDropped:"true"}}),null)}}).filter(Boolean)),l=function(t,n){i.forEach(function(e){e.receiveFlow.addPoint(t,n)})};l("cop_him_start");var s=yield o("MAWProtocolQueueMsg").handleIncomingMessagesStanzas(Array.from(i.values()),t).catch(function(e){var t=r("getErrorSafe")(e);throw r("FBLogger")("messenger_web").catching(t).mustfix("COPMessagesHandler: Failed to handle batch"),i.forEach(function(e){e.receiveFlow.endFail("cop_him_fail",{string:{copHimError:t.message}})}),t});l("cop_him_end"),s.toAck.forEach(function(e){return n.add(e)});var u=e.map(function(e){var t=i.get(e.stanzaQueueId);if(t==null)return null;var r=t,o=s.followUpParams.incomingMsgResults.get(r.stanza.message.decrypted.id);return[r,n.has(e.stanzaQueueId),o]}).filter(Boolean);n.size!==e.length&&r("MAWSharedCOPLogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing messages batch, see transactor error reports."])));var c=new Map,f=new Set;return u.forEach(function(e){var n=e[0],i=e[1],l=e[2];if(n.receiveFlow.addPoint("consumer_handle_message_stanza_end",{bool:{dbSuccess:!!(l!=null&&l.success)}}),i){n.receiveFlow.addPoint("ack_received");var s=n.stanza.message.decrypted.type;s==="UnavailableMsg"||s==="IncomingCiphertextMsg"?n.receiveFlow.endFail(s):(n.stanza.message.details.type==="media"&&n.receiveFlow.addPoint("message_with_media"),n.receiveFlow.endSuccess())}if(!l&&!i){r("MAWSharedCOPLogger").MUSTFIX(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Cannot find db result for message"]))),n.receiveFlow.endFail("db_result_not_found");return}if(l){if(l.success===!1){var u=l.error;switch(u.type){case"group_invite":{n.receiveFlow.endFail("end_with_db_error_group_invite"),c.set(u.groupJid,{folder:u.folder,inviteCode:u.inviteCode,inviteExpireTs:u.inviteExpireTs,inviterJid:u.inviterJid}),n.receiveFlow.endFail("need_group_invite");break}case"invalid_args":{n.receiveFlow.endFail("invlid_args");break}default:{n.receiveFlow.endFail(u.type);break}}return}if(l.success,l.value!=null){var d=l.value,m=d.msgType,g=d.outOfSyncEphemeralSetting,h=d.plaintextHashs,y=d.protocolMsgId,v=d.unknownGroup;if(v){var S=o("WAJids").interpretAsGroupJid(y.chat);S!=null&&f.add(S)}C(g,y);var R=n.stanza.message.details.from.author===o("WAGlobals").getMyDeviceJid(),L=t!==r("LSMEBTaskCreationSource").MEDIA_GALLERY_RESTORE&&(r("gkx")("20157")?!R:!0);L&&(h==null||h.forEach(function(e){var t;r("MAWSharedCOPLogger").DEBUG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["Media: externalId="," - plaintextFollowUp - plaintextHash=",""])),n.stanza.message.details.externalId,o("WAHashUtils").sanitisePlaintextHash(e)),b({msgType:m,plaintextHash:e,protocolMsgId:y,source:(t=a.get(y))!=null?t:"wa-incoming"})}))}}}),v(f),S(c),Array.from(n)}),y.apply(this,arguments)}function C(e,t){e!=null&&(r("MAWSharedCOPLogger").tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.SettingSync]).DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["handleMsg: detected out-of-sync ephemeral setting for ",", sending EPHEMERAL_SYNC_RESPONSE"])),t==null?void 0:t.externalId),r("promiseDone")(o("MAWCommonScheduler").mawCommonScheduler().runTask({fn:(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=o("MAWLoggerUtils").getInstanceKey(),n=o("MAWQplProxy").startQplUserFlow(r("qpl")._(25313175,"1551"),yield o("MWSharedS2SBaseAnnotations").getSendToSentBaseAnnotations(o("MWSharedS2SBaseAnnotations").getMessageTypeParams({isEphemeralSetting:!0}),r("LSMessagingThreadAttributionType").UNKNOWN),{providedInstanceKey:t});try{var a=yield o("MAWSendEphemeralSettingMsg").sendEphemeralSettingMsgFn({args:{ephemeralSetting:{ephemeralExpirationInSec:e.correctEphemeralExpirationInSec,ephemeralLastUpdatedOrSetTimestamp:e.correctEphemeralLastUpdatedOrSetTimestamp},isEphemeralSettingReset:!1,isForSyncResponse:!0},chatJid:e.chatJid,externalId:o("MAWExternalId").generateExternalId(),qplEventType:r("qpl")._(25313175,"1551"),qplInstanceKey:t});if(a.success){if(n.endSuccess(),a.value!=null){var i=a.value;o("MAWBridge").getBridge().fireAndForget("event","handleMessageSendResult",{report:i,success:!0},!0)}}else n.endFail(a.error.type)}catch(e){var l,s=e instanceof Error?e:null;n==null||n.endFail("failed_to_send_empemeral_settings",{string:{errorDescription:(l=s==null?void 0:s.message)!=null?l:""}})}});function a(){return t.apply(this,arguments)}return a})(),name:"ephemeral_sync_response",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})))}function b(e){var t=e.msgType,n=e.plaintextHash,a=e.protocolMsgId,i=e.source;if(a!=null&&n!=null&&t!==o("MAWMsgType").MSG_TYPE.RAVEN){r("MAWSharedCOPLogger").tags(["downloadAndHandleMedia"]).DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Scheduling job for ",", plaintextHash: ",""])),String(a),o("WAHashUtils").sanitisePlaintextHash(n));var l=i==="ebrestore"?"EBRestore":"WAIncomingMsg";o("MAWJobManager").getJobManager().fireAndForget(o("MAWJobDefinitions").jobSerializers.downloadAndHandleMedia(a,n,l,t,"fullsizeAndPreview",null))}}function v(e){e.size!==0&&r("promiseDone")(o("MAWCommonScheduler").mawCommonScheduler().runTask({fn:(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){try{yield o("WAQueryGroupsAndSync").queryGroupsAndSync({groupJids:Array.from(e)})}catch(e){throw r("MAWSharedCOPLogger").catching(r("getErrorSafe")(e)).MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to query groups"]))),e}});function a(){return t.apply(this,arguments)}return a})(),name:"queryGroup",priority:o("WorkerScheduler").BACKGROUND_PRIORITY}))}function S(e){if(e.size===0)return;r("promiseDone")(o("MAWCommonScheduler").mawCommonScheduler().runTask({fn:function(){return t()},name:"queryGroupInvite",priority:o("WorkerScheduler").BACKGROUND_PRIORITY}));function t(){return a.apply(this,arguments)}function a(){return a=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var t=yield(f||(f=n("Promise"))).all(Array.from(e.entries()).map(function(e){var t=e[0],n=e[1],r=n.inviteCode,a=n.inviteExpireTs,i=n.inviterJid;return o("WAQueryGroupInvite").queryGroupInvite(t,r,a,i).catch(function(e){return o("WAResultOrError").makeError()})})),r=t.map(function(e){if(e.success===!0){var t={extras:null,folder:null,groupStatus:"added",groupToCreate:e.value,key:null,serverTs:o("WATimeUtils").unixTime()};return t}return null}).filter(Boolean);yield o("WACreateGroup").createGroups(r)}),a.apply(this,arguments)}}function R(e){if(r("gkx")("23915"))for(var t of e)t.subtype==="ciphertext"&&o("MAWDebugMsg").writeDebugMsg(t.jid,"Message "+t.stanzaId+" has decryption error: "+t.decryptionError+" from user "+t.from,{decryptionError:t.decryptionError,protocolMsgId:{author:o("WAGlobals").getMyDeviceJid()===t.from?"@me":o("WAJids").extractUserJid(t.from),chat:t.jid,externalId:t.stanzaId}})}function L(e){if(e.message==null||e.message.type!=="ephemeral")return e;var t=e.serverTs;return e.message.ephemeralLastUpdatedOrSetTimestamp=e.message.ephemeralLastUpdatedOrSetTimestamp===o("WATimeUtils").DEFAULT_UNIXTIME?t:e.message.ephemeralLastUpdatedOrSetTimestamp,e}l.copIncomingMsgsHandler=g}),98);
__d("MAWDbHistorySyncQRCodeData",[],(function(t,n,r,o,a,i){"use strict";var e="qrCodeRowId";i.qrCodeRowId=e}),66);
__d("MAWHandleEncryptedBackupsSecretsApi",["MAWDbHistorySyncQRCodeData","MAWIndexedDb","MAWTransactionMode","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({historySyncQRCodeData:o("MAWTransactionMode").READWRITE},"handleEncryptedBackupsSecret",function(e){return(function(t){var n=t.backupId,a=t.epoch,i=t.mailboxRootKey,l=t.obliviousValidationToken,u=t.serverDataId,c=t.tempOcmfClientState;return e.historySyncQRCodeData.get(o("MAWDbHistorySyncQRCodeData").qrCodeRowId).then(function(t){if(!(t!=null&&t.isQRScanned))return e.historySyncQRCodeData.put({isQRScanned:!0,rowId:o("MAWDbHistorySyncQRCodeData").qrCodeRowId}).then(function(e){o("MAWIndexedDb").afterTransaction({tag:"CallFinishAddDevice",value:{backupId:n.toString(),epoch:s(a),mailboxRootKey:i,obliviousValidationToken:l,serverDataId:u.toString(),tempOcmfClientState:c}})}).catch(function(t){return e.historySyncQRCodeData.put({isQRScanned:!1,rowId:o("MAWDbHistorySyncQRCodeData").qrCodeRowId}).then(r("emptyFunction"))})})})});function s(e){return e.map(function(e){var t=e.anonId,n=e.id,r=e.rootKey,o=e.status;return{epoch_anon_id:t,epoch_id:n.toString(),epoch_root_key:r,epoch_status:o.toString()}})}l.handleEncryptedBackupsSecret=e}),98);
__d("MAWWriteMetaSyncsTxns",["MAWDbDeletedMessages","MAWDbPendingStanza","MAWDbPendingStanzaTxns","MAWDbThreadTxns","MAWDexieTable","MAWFTSTxns","MAWThreadManagementTxns","WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=30*o("WATimeUtils").DAY_SECONDS;function c(t,n){o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Received chatDelete: ",""])),n);var r=n.messageRange,a=r!=null?o("MAWDbPendingStanzaTxns").putPendingStanza(t,{content:{metaSyncMessageRange:r},type:o("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD},u,n.chatJid,o("MAWDbPendingStanza").PENDING_TYPE.DELETE_THREAD):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([o("MAWDbThreadTxns").getThread(t,n.chatJid),a,o("MAWFTSTxns").maybePutThreadToPurgeBacklog(t,n.chatJid)]).then(function(e){var r=e[0];return r.success?o("MAWThreadManagementTxns").metaSyncChatDeleteThread(t,r.value,n.messageRange,o("MAWDbDeletedMessages").DbDeletedMsgReasonEnum.cast(n.type)):(o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[MAWWriteMetaSyncsTxns] Thread delete stanza was processed before thread insertion ",""])),n.chatJid),{deletedMessages:[]})})}l.PENDING_DELETE_THREAD_EXPIRATION_IN_SEC=u,l.handleChatDelete=c}),98);
__d("WADeleteReceiptsApi",["MAWTransactionMode","WADbTransactor"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return e.receipts.where("waMsgId").anyOf(t).delete().then(function(){})}var s=o("WADbTransactor").makeSignalTransactor({receipts:o("MAWTransactionMode").READWRITE},"deleteReceipts",function(t){return function(n){return e(t,n)}});l.deleteAllReceiptsForWAMsgIds=e,l.deleteReceipts=s}),98);
__d("MAWHandleMetaSyncAction",["MAWIndexedDb","MAWTransactionMode","MAWWriteDeleteMessageTxns","MAWWriteMetaSyncsTxns","Promise","WAAssertUnreachable","WADeleteReceiptsApi","WALogger","asyncToGeneratorRuntime","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){for(var t of e.actions)t.chatAction?yield m(t.chatAction):t.messageAction&&(yield f(t.messageAction))}),d.apply(this,arguments)}function m(t){switch(o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Received action: ",""])),t),t.type){case"chat_archive":return p(t);case"chat_delete":return g(t).then(function(e){var t=e.deletedMessages;return o("WADeleteReceiptsApi").deleteReceipts(t)});default:return t.type,_(t)}}function p(e){return(u||(u=n("Promise"))).resolve()}function _(e){return(u||(u=n("Promise"))).resolve()}function f(e){switch(e.type){case"delete_for_me":return h(e).then(r("emptyFunction"));default:return r("WAAssertUnreachable")(e.type)}}var g=o("MAWIndexedDb").makeMsgrTransactor({chunk:(s=o("MAWTransactionMode")).READWRITE,deletedMessages:s.READWRITE,editMsgHistory:s.READWRITE,ftsPurgeThreadBacklog:s.READWRITE,groupInfo:s.READWRITE,groupInvites:s.READWRITE,media:s.READWRITE,messages:s.READWRITE,participants:s.READWRITE,pendingStanzas:s.READWRITE,reactions:s.READWRITE,threads:s.READWRITE,unrenderedMessages:s.READWRITE,xma:s.READWRITE},"handleChatDeleteTxn",function(e){return function(t){return o("MAWWriteMetaSyncsTxns").handleChatDelete(e,t)}}),h=o("MAWIndexedDb").makeMsgrTransactor({chunk:s.READWRITE,editMsgHistory:s.READWRITE,ftsPurgeBacklog:s.READWRITE,groupInfo:s.READWRITE,groupInvites:s.READWRITE,media:s.READWRITE,messages:s.READWRITE,pendingStanzas:s.READWRITE,reactions:s.READWRITE,threads:s.READWRITE,unrenderedMessages:s.READWRITE,xma:s.READWRITE},"handleDeleteForMeTxn",function(e){return function(t){return o("MAWWriteDeleteMessageTxns").handleDeleteForMe(e,t)}});l.handleMetaSyncActions=c}),98);
__d("MAWProtocolQueueAppdata",["MAWHandleEncryptedBackupsSecretsApi","MAWHandleMetaSyncAction","MAWSharedCOPLogger","Promise","WAConvertAppData","WAMsgApplication.pb","WAParseMessageApplication","WAProtocolQueue","WAResultOrError","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p;function _(e){var t=e.map(function(e){return f(e.appdata)});return(p||(p=n("Promise"))).all(t.map(function(e){var t=g(e);return t})).then(function(t){var n=[];return t.map(function(t,r){t.success===!0&&n.push(e[r].stanzaQueueId)}),{followUpParams:void 0,toAck:n}})}function f(t){r("MAWSharedCOPLogger").DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Parse Appdata application protocol"])));var n=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMsgApplication.pb").MessageApplicationSpec,o("WAProtocolQueue").extractSubProtocolFromAppdataProtocol(t).payload),a=o("WAParseMessageApplication").parseMessageApplication(n);if(a.type==="error"){r("MAWSharedCOPLogger").MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Appdata contains unparseable message application."])));return}return o("WAConvertAppData").parseAppData(a)}function g(e){if(r("MAWSharedCOPLogger").DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Handle appdata"]))),e==null)return(p||(p=n("Promise"))).resolve(o("WAResultOrError").makeResult());switch(e.type){case"meta_sync":return r("MAWSharedCOPLogger").DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Handle appdata: meta sync"]))),o("MAWHandleMetaSyncAction").handleMetaSyncActions(e).then(function(){return o("WAResultOrError").makeResult()});case"backups_secrets":return r("MAWSharedCOPLogger").DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Handle appdata: backup secret"]))),o("MAWHandleEncryptedBackupsSecretsApi").handleEncryptedBackupsSecret(e.encryptedBackupsSecrets).then(function(){return o("WAResultOrError").makeResult()});case"sync_key_share":return(p||(p=n("Promise"))).resolve(o("WAResultOrError").makeResult());case"sync_key_request":return(p||(p=n("Promise"))).resolve(o("WAResultOrError").makeResult());default:return e.type,r("MAWSharedCOPLogger").WARN(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Unknown appdata type: ",""])),e.type),(p||(p=n("Promise"))).resolve(o("WAResultOrError").makeResult())}}l.handleAppdataStanzas=_}),98);
__d("MAWCOPAppdataHandler",["MAWIsQuotaExceededError","MAWProtocolQueueAppdata","MAWSharedCOPLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){return c(t).catch(function(t){if(o("MAWIsQuotaExceededError").isQuotaExceededError(t))throw t;return r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Appdata consumer error"]))),[]})}function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return[];var t=yield o("MAWProtocolQueueAppdata").handleAppdataStanzas(e);return t.toAck.length!==e.length&&r("MAWSharedCOPLogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing appdata batch, see transactor error reports."]))),t.toAck}),d.apply(this,arguments)}l.copIncomingAppdataHandler=u}),98);
__d("MAWDbGetAlertsWithDeviceJidTxn",["err"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return e.deviceChangeAlerts.filter(function(e){return e.deviceJid===t&&!e.loggedOut}).toArray().then(function(e){return e.length>1&&r("err")("Invalid result, more than one active devices with the same deviceJid: "+t),e[0]})}l.getAlertsWithDeviceJidTxn=e}),98);
__d("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn",["MAWIndexedDb"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e.deviceChangeAlerts.filter(function(e){return e.isArchived===!1}).toArray().then(function(e){return o("MAWIndexedDb").afterTransaction({tag:"UnArchivedSelfDeviceChangeAlerts",value:e.length})})}l.getUnArchivedDeviceChangeAlertsCountTxn=e}),98);
__d("MAWDbUpdateDeviceChangeAlertsTxn",[],(function(t,n,r,o,a,i){"use strict";function e(e,t){return e.deviceChangeAlerts.put(t)}i.updateDeviceChangeAlertsTxn=e}),66);
__d("MAWDbUpdateDeviceChangeAlertsLogInStatusTxn",["MAWDbGetAlertsWithDeviceJidTxn","MAWDbUpdateDeviceChangeAlertsTxn"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return o("MAWDbGetAlertsWithDeviceJidTxn").getAlertsWithDeviceJidTxn(e,t).then(function(t){return o("MAWDbUpdateDeviceChangeAlertsTxn").updateDeviceChangeAlertsTxn(e,babelHelpers.extends({},t,{loggedOut:!0}))})}l.updateDeviceChangeAlertsLogInStatusTxn=e}),98);
__d("WAUpdateDevicesForUserApi",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=e.allowSecurityAlertForContact,n=e.isMe;return!n&&t}i.getShouldShowAdminMessages=e}),66);
__d("WAUpdateRotateSenderKeyToTrue",["WASignalDB","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){return o("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=yield e.stores.personalSenderKeyStatuses.bulkGet(t),r=n.filter(function(e){return e!=null}).map(function(e){return babelHelpers.extends({},e,{rotateSenderKey:!0})});return yield e.stores.personalSenderKeyStatuses.bulkPut(r),r});return function(t){return e.apply(this,arguments)}})(),o("WASignalDB").signalOp("updateRotateSenderKeyToTrue"))};l.updateRotateSenderKeyToTrue=e}),98);
__d("MAWProtocolQueueInstructions",["FBLogger","MAWAdminWriteUserDeviceMsgTxn","MAWBridge","MAWDbAddDeviceChangeAlertsTxn","MAWDbDeviceChangeAlerts","MAWDbGetAlertsWithDeviceJidTxn","MAWDbGetUnArchivedDeviceChangeAlertsCountTxn","MAWDbMsgTypeVersionTxns","MAWDbThreadTxns","MAWDbUpdateDeviceChangeAlertsLogInStatusTxn","MAWDexieTable","MAWIndexedDb","MAWODSProxy","MAWTransactionMode","Promise","WAArmadilloTransportEvent.pb","WAAssertUnreachable","WADbContact","WAGlobals","WAJids","WALogger","WAOdsEnums","WAUpdateDevicesForUserApi","WAUpdateRotateSenderKeyToTrue","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){var n=new Set(t.map(function(e){return e.jid}));return o("MAWDexieTable").dexieAll([o("MAWDbMsgTypeVersionTxns").maybeBulkGetSecuritySetting(e),o("MAWDbThreadTxns").getAllThreadsForUsers(e,Array.from(n))])}function d(e){var t=o("WAGlobals").getMyUserJid(),a=e.filter(function(e){return e.jid===t&&e.deviceChangeType!==o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.NONE});return a.length===0?(u||(u=n("Promise"))).resolve():o("MAWIndexedDb").makeMsgrTransactor({appMeta:o("MAWTransactionMode").READONLY,deviceChangeAlerts:o("MAWTransactionMode").READWRITE},"recordDeviceChangeHistory",function(e){return function(){return o("MAWDbMsgTypeVersionTxns").getSecuritySettingForSelf(e).then(function(t){if(t)return o("MAWDexieTable").dexieAll(a.map(function(n){switch(n.deviceChangeType){case o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.ADDED:return n.identity!=null&&n.model!=null&&n.platform!=null?o("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(e,{action:o("MAWDbDeviceChangeAlerts").KEY_CHANGE,deviceJid:n.device,identity:n.identity,isArchived:!t,model:n.model,platform:n.platform,ts:n.ts}):o("MAWDexieTable").dexieResolve();case o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REMOVED:return o("MAWDbUpdateDeviceChangeAlertsLogInStatusTxn").updateDeviceChangeAlertsLogInStatusTxn(e,n.device);case o("WAArmadilloTransportEvent.pb").TransportEvent$Event$DeviceChange$Type.REPLACED:return n.identity!=null&&n.model!=null&&n.platform!=null?o("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(e,{action:o("MAWDbDeviceChangeAlerts").KEY_CHANGE,deviceJid:n.device,identity:n.identity,isArchived:!1,model:n.model,platform:n.platform,ts:n.ts}):o("MAWDexieTable").dexieResolve();default:return r("FBLogger")("wmi").mustfix("Unknown device change type"),o("MAWDexieTable").dexieResolve()}})).then(function(){return o("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(e)})})}})()}function m(e){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("MAWBridge").getBridge().sendAndReceive("event","getLSDBUsersRelationships",{users:Array.from(new Set(e.map(function(e){return e.jid})))}),n=yield _(e,t),r=n.followUpParams,a=n.toAck,i=r.groupsToUpdateForIdentityRemoved.flat();return yield o("WAUpdateRotateSenderKeyToTrue").updateRotateSenderKeyToTrue(i),{followUpParams:void 0,toAck:a}}),p.apply(this,arguments)}var _=o("MAWIndexedDb").makeMsgrTransactor({appMeta:(s=o("MAWTransactionMode")).READONLY,deviceChangeAlerts:s.READWRITE,ftsBackloggedMessages:s.READWRITE,groupInfo:s.READONLY,messages:s.READWRITE,participants:s.READONLY,threads:s.READWRITE},"handleInstructions",function(e){return(function(t,n){return c(e,t).then(function(r){var a=r[0],i=a.allowSecurityAlertForContact,l=a.allowSecurityAlertForSelf,s=r[1];return o("MAWDexieTable").dexieSequentialAll(t.map(function(t){var r,a=t.jid,u=a===o("WAGlobals").getMyUserJid(),c=o("WAUpdateDevicesForUserApi").getShouldShowAdminMessages({allowSecurityAlertForContact:i,isMe:u})&&n.get(a)===o("WADbContact").TWO_WAY_CONTACT,d={allowSecurityAlertForSelf:l,isMe:u,shouldShowAdminMessages:c,threads:(r=s.get(a))!=null?r:[],user:a};return function(){return f(e,t,d)}})).then(function(){var e=t.filter(function(e){return e.instruction==="identityRemoved"}).map(function(e){var t,n=(t=s.get(e.jid))!=null?t:[],r=n.map(function(e){return o("WAJids").interpretAsGroupJid(e.jid)}).filter(Boolean);return r});return{followUpParams:{groupsToUpdateForIdentityRemoved:e},toAck:t.map(function(e){return e.stanzaQueueId})}})})})});function f(e,t,n){switch(t.instruction){case"identityChanged":return g(e,t,n);case"identityAdded":return h(e,t,n);case"identityRemoved":return y(e,t,n);case"icdcError":return C(e,t,n);default:throw r("WAAssertUnreachable")(t)}}function g(e,t,n){var r=n.allowSecurityAlertForSelf,a=n.isMe,i=n.shouldShowAdminMessages,l=n.threads,s=a&&t.model!=null&&t.platform!=null&&t.notificationTs!=null;return o("MAWDexieTable").dexieAll([s&&t.model!=null&&t.platform!=null&&t.notificationTs!=null&&t.identity!=null&&t.device!=null?o("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(e,{action:o("MAWDbDeviceChangeAlerts").KEY_CHANGE,deviceJid:t.device,identity:t.identity,isArchived:!r,model:t.model,platform:t.platform,ts:t.notificationTs}).then(function(){return o("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(e)}):o("MAWDexieTable").dexieResolve()].concat(i?l.map(function(n){return o("WAJids").interpretAsGroupJid(n.jid)==null&&o("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(e,t.jid,n,o("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.update,t.notificationTs)}):[])).then(function(){(s||i)&&o("MAWODSProxy").odsBumpEntityKey({entity:a?o("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:o("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:o("MAWDbDeviceChangeAlerts").KEY_CHANGE})})}function h(e,t,n){var r=n.allowSecurityAlertForSelf,a=n.isMe,i=n.shouldShowAdminMessages,l=n.threads,s=n.user,u=a&&t.model!=null&&t.platform!=null&&t.notificationTs!=null;return o("MAWDexieTable").dexieAll([u&&t.model!=null&&t.platform!=null&&t.notificationTs!=null&&t.identity!=null&&t.device!=null?o("MAWDbAddDeviceChangeAlertsTxn").addDeviceChangeAlertsTxn(e,{action:o("MAWDbDeviceChangeAlerts").ADD,deviceJid:t.device,identity:t.identity,isArchived:!r,model:t.model,platform:t.platform,ts:t.notificationTs}).then(function(){return o("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(e)}):o("MAWDexieTable").dexieResolve()].concat(i?l.map(function(n){return o("WAJids").interpretAsGroupJid(n.jid)==null&&o("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(e,s,n,o("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.add,t.notificationTs)}):[])).then(function(){(u||i)&&o("MAWODSProxy").odsBumpEntityKey({entity:a?o("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:o("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:o("MAWDbDeviceChangeAlerts").ADD})})}function y(e,t,n){var r=n.isMe,a=n.shouldShowAdminMessages,i=n.threads,l=n.user;return o("MAWDexieTable").dexieAll([r&&t.device!=null?o("MAWDbGetAlertsWithDeviceJidTxn").getAlertsWithDeviceJidTxn(e,t.device).then(function(){return o("MAWDbUpdateDeviceChangeAlertsLogInStatusTxn").updateDeviceChangeAlertsLogInStatusTxn(e,t.device)}).then(function(){return o("MAWDbGetUnArchivedDeviceChangeAlertsCountTxn").getUnArchivedDeviceChangeAlertsCountTxn(e)}):o("MAWDexieTable").dexieResolve()].concat(a?i.map(function(n){return o("WAJids").interpretAsGroupJid(n.jid)==null&&o("MAWAdminWriteUserDeviceMsgTxn").writeUserDeviceAdminMsg(e,l,n,o("MAWAdminWriteUserDeviceMsgTxn").DeviceChange.remove,t.notificationTs)}):[])).then(function(){(r||a)&&o("MAWODSProxy").odsBumpEntityKey({entity:r?o("WAOdsEnums").Entity.SECURITY_ALERT_FOR_SELF:o("WAOdsEnums").Entity.SECURITY_ALERT_FOR_CONTACT,key:o("MAWDbDeviceChangeAlerts").REMOVE})})}function C(t,n,r){var a=r.threads;if(!o("WAGlobals").getConfig().isICDCErrorEnabled())return o("MAWDexieTable").dexieResolve();var i=a.find(function(e){return e.jid===n.jid});return i==null?(o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["ICDC error instruction for thread "," not found"])),n.jid),o("MAWDexieTable").dexieResolve()):o("MAWAdminWriteUserDeviceMsgTxn").writeICDCAlert(t,n.jid,i,n.notificationTs)}l.recordDeviceChangeHistory=d,l.handleInstructions=m}),98);
__d("MAWCOPInstructionsHandler",["MAWIsQuotaExceededError","MAWProtocolQueueInstructions","MAWSharedCOPLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){return c(t).catch(function(t){if(o("MAWIsQuotaExceededError").isQuotaExceededError(t))throw t;return r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Instruction consumer error"]))),[]})}function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return[];var t=yield o("MAWProtocolQueueInstructions").handleInstructions(e);return t.toAck.length!==e.length&&r("MAWSharedCOPLogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing instructions batch, see transactor error reports."]))),t.toAck}),d.apply(this,arguments)}l.copIncomingInstructionsHandler=u}),98);
__d("MAWGroupInfoStore",["MAWBridgeTypesCreators","MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieCastToPromise","MAWDexieTable","MAWFolderTypes","MAWGetOrCreateThreadTxns","MAWIndexedDb","MAWLoadThreadsTxns","MAWThreadManagementTxns","MAWTransactionMode","WAResultOrError","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){if(e!=null&&typeof e=="object"&&e.groupStatus!=null&&typeof e.groupStatus=="string")return e.groupStatus}function u(e){if(e!=null&&typeof e=="object"&&e.clientThreadKey!=null&&typeof e.clientThreadKey=="string")return e.clientThreadKey}function c(e){if(e!=null&&typeof e=="object"&&e.folder!=null&&typeof e.folder=="number")return e.folder}function d(e){if(e!=null&&typeof e=="object"&&e.updateParticipantMedatadata!=null&&typeof e.updateParticipantMedatadata=="boolean")return e.updateParticipantMedatadata}function m(e){return e===null?{}:e}var p=(function(){function e(e){var t=this;this.get=function(e,n){var r=c(n);return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWThreadManagementTxns").getGroupThread(t.db,e,r).then(function(e){return e!=null?e:null}).then(function(e){return e==null?o("WAResultOrError").makeError("missing_group"):o("MAWLoadThreadsTxns").loadContentsForThreads(t.db,[e.thread],1,null,"getGroupInfoStore").then(function(){return e.groupInfo}).then(function(e){return o("WAResultOrError").makeResult(_(e))})}))},this.create=function(e,n){var r=s(n)==="added"?o("WATimeUtils").millisTime():o("WATimeUtils").castUnixTimeToMillisTime(e.creationTs);return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWGetOrCreateThreadTxns").getOrCreateThread(t.db,{clientThreadKey:u(n),createTs:r,description:"MAWGroupInfoStore-create",folder:o("MAWFolderTypes").FOLDER_ID.INBOX,jid:e.jid}).then(function(n){var r=n.created,a=n.thread,i=f(e);return o("MAWDexieTable").dexieAll([t.db.groupInfo.put(i),o("MAWDbMsgTxns").getThreadNewestMessageId(t.db,a.jid)]).then(function(e){var t=e[0],n=e[1];o("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(i)})}).then(function(){return a.archived===!0?o("MAWDbThreadTxns").unarchiveThreads(t.db,[a.jid]):o("MAWDexieTable").dexieResolve()}).then(function(){return r?o("WAResultOrError").makeResult(i.groupJid):o("WAResultOrError").makeError("existing")})}))},this.delete=function(e){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWDexieTable").dexieAll([t.db.threads.get({jid:e}),t.db.groupInfo.delete(e)]).then(function(e){var n=e[0];return n==null?o("WAResultOrError").makeError("missing_group"):o("MAWDexieTable").dexieAll([o("MAWDbThreadTxns").deleteThread(t.db,n.jid),t.db.participants.where("threadJid").equals(n.jid).delete()]).then(function(){return o("WAResultOrError").makeResult()})}))},this.update=function(e,n,r){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(t.db.threads.get({jid:e}).then(function(a){return a==null?o("WAResultOrError").makeError("missing_group"):t.db.groupInfo.get(e).then(function(e){if(e==null)return o("WAResultOrError").makeError("missing_group");var i=_(e),l=n(i),s=f(l);return t.db.groupInfo.put(s).then(function(){return o("MAWIndexedDb").afterTransaction({tag:"GroupInfoUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedGroupInfo(s)}),d(r)===!0&&o("MAWIndexedDb").afterTransaction({tag:"UpdateE2EEMetadataParticipants",value:o("MAWBridgeTypesCreators").createBridgeUpdateE2EEMetadataParticipants(a.jid)}),o("WAResultOrError").makeResult()})})}))},this.clear=function(){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(t.db.groupInfo.clear())},this.db=e}var t=e.prototype;return t.has=function(t){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(this.db.groupInfo.get(t).then(function(e){return e!=null}))},e})();p.tableLocks={chunk:(e=o("MAWTransactionMode")).READONLY,editMsgHistory:e.READONLY,groupInfo:e.READWRITE,groupInvites:e.READONLY,media:e.READONLY,messages:e.READWRITE,participants:e.READWRITE,poll:e.READONLY,reactions:e.READONLY,receiverFetchInfo:e.READONLY,threads:e.READWRITE,xma:e.READONLY};function _(e){return babelHelpers.extends({jid:e.groupJid},m(e.creator!=null?{creator:e.creator}:null),{creationTs:e.creationTs},m(e.participantVersion!=null?{participantVersion:e.participantVersion}:null),{inviter:e.inviter,memberAddMode:e.memberAddMode,subject:babelHelpers.extends({content:e.name},m(e.nameOwner!=null?{user:e.nameOwner}:null),m(e.nameTs!=null?{ts:e.nameTs}:null))})}function f(e){var t=e.subject.content;return t!=null&&t.length===0&&(t=void 0),{creationTs:e.creationTs,creator:e.creator,groupJid:e.jid,inviter:e.inviter,memberAddMode:e.memberAddMode,name:t,nameOwner:e.subject.user,nameTs:e.subject.ts,participantVersion:e.participantVersion}}l.MAWGroupInfoStore=p}),98);
__d("MAWMessageStore",["MAWAckLevel","MAWAuthor","MAWBridgeMsg","MAWDbMsgTxns","MAWDbThread","MAWDexieCastToPromise","MAWDexieTable","MAWFolderTypes","MAWIndexedDb","MAWLocalizationUtils","MAWMsgType","MAWThreadFetchAndEmitTxns","MAWTransactionMode","MAWWriteMsgTxns","WAJids","WALogger","WAResultOrError","WATimeUtils","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){if(e!=null&&typeof e=="object"&&e.optimisticMsg!=null){var t=e.optimisticMsg;if(typeof t.msgId=="string"&&typeof t.ts=="number")return{msgId:t.msgId,ts:t.ts}}}function c(e){if(e!=null&&typeof e=="object"&&e.openMessageOtid!=null&&typeof e.openMessageOtid=="string")return e.openMessageOtid}function d(e){if(e!=null&&typeof e=="object"&&e.folder!=null&&typeof e.folder=="number"){if(e.folder===o("MAWFolderTypes").FOLDER_ID.INBOX)return o("MAWFolderTypes").FOLDER_ID.INBOX;if(e.folder===o("MAWFolderTypes").FOLDER_ID.PENDING)return o("MAWFolderTypes").FOLDER_ID.PENDING;if(e.folder===o("MAWFolderTypes").FOLDER_ID.OTHER)return o("MAWFolderTypes").FOLDER_ID.OTHER;if(e.folder===o("MAWFolderTypes").FOLDER_ID.ARCHIVED)return o("MAWFolderTypes").FOLDER_ID.ARCHIVED}return null}var m=(function(){function t(e){this.db=e}var n=t.prototype;return n.create=function(t,n){var e=this,a=u(n),i=c(n),l=d(n);return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWThreadFetchAndEmitTxns").fetchAndEmitThread(this.db,t.id.chat,l,void 0,"MAWMessageStore_DEPRECATED-create").then(function(n){if(n==null)return o("WAResultOrError").makeError({type:"missing_thread"});var l=n.thread;if(t.type===o("MAWMsgType").MSG_TYPE.TEXT){var s,u=void 0;t.ephemeralSetting!=null&&(u={ephemeralExpirationInSec:t.ephemeralSetting.expirationTs,ephemeralLastUpdatedOrSetTimestamp:t.ephemeralSetting.updatedTs});var c={ack:t.ack,altIndex:void 0,author:t.id.author,ephemeralSetting:u,externalId:t.id.externalId,forwardingScore:t.forwardingScore,isForwarded:t.forwardingScore>0,msgContent:{content:((s=t.msgContent)==null?void 0:s.content)||""},serverTs:t.serverTs,threadJid:l.jid,ts:t.ts,type:o("MAWMsgType").MSG_TYPE.TEXT};return o("MAWWriteMsgTxns").writeMsg(e.db,c,l,{openMessageOtid:i,optimisticMsg:a}).then(function(){return o("WAResultOrError").makeResult()})}else if(t.type===o("MAWMsgType").MSG_TYPE.ICDC_ALERT){var d={ack:t.ack,altIndex:void 0,author:t.id.author,externalId:t.id.externalId,msgContent:{adminType:t.msgContent.adminType,authorName:t.msgContent.authorName},serverTs:t.serverTs,threadJid:l.jid,ts:t.ts,type:o("MAWMsgType").MSG_TYPE.ICDC_ALERT};return o("MAWWriteMsgTxns").writeMsg(e.db,d,l,{openMessageOtid:i,optimisticMsg:a}).then(function(){return t.hasUnknownName&&!o("WAJids").isAuthorMe(t.id.author)&&!o("WAJids").isAuthorSystem(t.id.author)&&o("MAWIndexedDb").afterTransaction({tag:"SyncContacts",value:[o("WAJids").userIdFromJid(t.id.author)]}),o("WAResultOrError").makeResult()})}else if(t.type===o("MAWMsgType").MSG_TYPE.ADMIN){var m={ack:t.ack,altIndex:void 0,author:o("WAJids").AUTHOR_SYSTEM,externalId:t.id.externalId,msgContent:babelHelpers.extends({},t.msgContent,{version:o("MAWLocalizationUtils").isAdminMsgNormalized(t.msgContent.adminType)?1:0}),serverTs:t.serverTs,threadJid:l.jid,ts:t.ts,type:t.type};return o("MAWWriteMsgTxns").writeMsg(e.db,m,l).then(function(){return o("WAResultOrError").makeResult()})}throw r("err")("non renderable store not implemented yet")}))},n.get=function(t){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWDexieTable").dexieAll([this.db.threads.get({jid:t.chat}),this.db.messages.where("externalId").equals(t.externalId).toArray()]).then(function(e){var n,r=e[0],a=e[1];if(r==null)return o("MAWDexieTable").dexieResolve(null);var i=a.find(function(e){return e.threadJid===r.jid&&e.author===t.author});return i==null||i.type!=="Text"?o("MAWDexieTable").dexieResolve(null):o("MAWDexieTable").dexieResolve({ack:i.ack,forwardingScore:(n=i.forwardingScore)!=null?n:0,id:t,msgContent:{content:i.msgContent.content},ts:i.ts,type:i.type})}))},n.update=function(t){var e=this;return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWDexieTable").dexieAll([this.db.threads.get({jid:t.id.chat}),this.db.messages.where("externalId").equals(t.id.externalId).toArray()]).then(function(n){var r=n[0],a=n[1];if(r==null)return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("missing"));var i=a.find(function(e){return e.threadJid===r.jid&&e.author===t.id.author});if(i==null||i.type!=="Text")return o("MAWDexieTable").dexieResolve(o("WAResultOrError").makeError("missing"));var l=i.ack<o("MAWAckLevel").ACK.sent;i.ack=t.ack,i.ts=t.ts,i.serverTs=t.sentTs;var s=void 0;t.ephemeralSetting!=null&&(s={ephemeralExpirationInSec:t.ephemeralSetting.expirationTs,ephemeralLastUpdatedOrSetTimestamp:t.ephemeralSetting.updatedTs}),i.ephemeralSetting=s;var u=t.sentTs,c=u==null?u:o("WATimeUtils").castUnixTimeToMillisTime(u),d=c!=null&&l?e.db.threads.put(babelHelpers.extends({},r,{newestMsgTs:c,threadOrder:o("MAWDbThread").craftThreadOrder(c,r.jid)})):o("MAWDexieTable").dexieResolve();return o("MAWDexieTable").dexieAll([e.db.messages.put(i),d]).then(function(){var e=null;return o("MAWIndexedDb").afterTransaction({tag:"MsgUpdated",value:o("MAWBridgeMsg").createBridgeMsg(i,e)}),o("WAResultOrError").makeResult()})}))},n.deleteReactionsForMsg=function(t){var e=this;return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(this.db.reactions.where("reactToExternalId").equals(t.externalId).filter(function(e){return o("MAWAuthor").getAuthorUserJid(e.reactToAuthor)===o("MAWAuthor").getAuthorUserJid(t.author)&&e.threadJid===t.chat}).toArray().then(function(t){return e.db.reactions.bulkDelete(t.map(function(e){return e.rowId}))}))},n.bulkDelete=function(n){var t=this,r=o("MAWDexieTable").dexieAll(n.map(function(e){var n=e.author,r=e.chat,a=e.externalId,i=o("MAWAuthor").getAuthorUserJid(n);return t.db.reactions.where("reactToExternalId").equals(a).filter(function(e){return o("MAWAuthor").getAuthorUserJid(e.reactToAuthor)===i&&e.threadJid===r}).toArray()})).then(function(e){return e.flat()}).then(function(n){return o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Successfully deleted: "," reactions rows."])),n.length),t.db.reactions.bulkDelete(n.map(function(e){return e.rowId}))});return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(o("MAWDbMsgTxns").getMsgsByProtocolMsgId(this.db,n).then(function(e){var n=e.map(function(e){return e.rowId});return o("MAWDexieTable").dexieAll([t.db.messages.bulkDelete(n),r]).then(function(){return n.length})}))},n.bulkGetInGroup=function(t){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(this.db.messages.where("threadJid").equals(t).toArray()).then(function(e){return e==null||e.length===0?[]:e.map(function(e){return{author:e.author,chat:t,externalId:e.externalId}})})},t})();m.tableLocks={chunk:(s=o("MAWTransactionMode")).READONLY,ftsBackloggedMessages:s.READWRITE,groupInfo:s.READWRITE,groupInvites:s.READONLY,media:s.READONLY,messages:s.READWRITE,participants:s.READWRITE,poll:s.READONLY,reactions:s.READWRITE,receiverFetchInfo:s.READONLY,threads:s.READWRITE,xma:s.READONLY},l.MAWMessageStore_DEPRECATED_DO_NOT_USE=m}),98);
__d("WAResultOrErrorUtils",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=[];return e.forEach(function(e){e.success&&t.push(e.value)}),t}function l(e){var t=[];return e.forEach(function(e){e.success||t.push(e.error)}),t}i.unpackValues=e,i.unpackErrors=l}),66);
__d("MAWParticipantsStore",["MAWBridgeParticipants","MAWBridgeTypesCreators","MAWDbParticipant","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieCastToPromise","MAWDexieTable","MAWIndexedDb","MAWTransactionMode","WAArrayGroupBy","WAArrayZip","WAGlobals","WAResultOrError","WAResultOrErrorUtils","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t){var e=this;this.bulkGetInGroup=function(t){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(e.db.threads.get({jid:t}).then(function(t){return t!=null?o("MAWDbParticipantTxns").getParticipantsInThread(e.db,t.jid).then(function(e){return o("WAResultOrError").makeResult(e.map(function(e){return s(e,t.jid)}))}):o("WAResultOrError").makeError("missing_group")}))},this.bulkPut=function(t){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(d(e.db,t.map(function(e){var t=e.chatJid;return t})).then(function(e){return o("WAResultOrErrorUtils").unpackValues(t.map(function(t){return e.has(t.chatJid)?o("WAResultOrError").makeResult({participantId:o("MAWDbParticipant").craftParticipantId(t.chatJid,t.user),waParticipant:t}):o("WAResultOrError").makeError()}))}).then(function(t){return e.db.participants.bulkGet(t.map(function(e){var t=e.participantId;return t})).then(function(e){return o("WAArrayZip").zip(t,e).map(function(e){var t=e[0].waParticipant,n=e[1];return{chatJid:t.chatJid,dbParticipantToPut:babelHelpers.extends({deliveredWatermarkTs:o("WATimeUtils").castToUnixTime(0),lastReadWatermarkTs:o("WATimeUtils").castToUnixTime(0)},n,u(t)),existed:n!=null,participant:t}})})}).then(function(t){var n=t.map(function(e){var t=e.dbParticipantToPut;return babelHelpers.extends({},t)});return n.forEach(function(e){return o("MAWDbParticipantTxns").logIfIllegalParticipant(e,"MAWParticipantsStore::bulkPut")}),e.db.participants.bulkPut(n).then(function(){return m(e.db,t)})}))},this.bulkDelete=function(t,n){var r=n||{},a=r.remover,i=o("WAArrayGroupBy").groupBy(t.map(function(e,t){return{index:t,key:e}}),function(e){var t=e.key;return t.groupJid}),l=i.map(function(e){var t=e[0];return t});return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(d(e.db,l).then(function(e){return i.flatMap(function(t){var n=t[0],r=t[1];return r.map(function(t){var r=t.index,a=t.key;return e.has(n)?o("WAResultOrError").makeResult({groupJid:n,index:r,participantId:o("MAWDbParticipant").craftParticipantId(n,a.userJid),participantKey:[n,a.userJid],userJid:a.userJid}):o("WAResultOrError").makeError({index:r,message:"missing_group"})})})}).then(function(t){var n=o("WAResultOrErrorUtils").unpackValues(t),r=o("WAResultOrErrorUtils").unpackErrors(t).map(function(e){return o("WAResultOrError").makeError(e)}),a=n.map(function(e){var t=e.participantId;return t});return e.db.participants.bulkGet(a).then(function(e){return o("WAArrayZip").zip(n,e).map(function(e){var t=e[0],n=e[1];return n==null?o("WAResultOrError").makeError({index:t.index,message:"missing_participant"}):o("WAResultOrError").makeResult(t)}).concat(r)})}).then(function(t){var n=o("WAResultOrErrorUtils").unpackValues(t),r=n.map(function(e){var t=e.participantKey;return t}),i=n.map(function(e){var t=e.groupJid,n=e.userJid;return{groupJid:t,userJid:n}});return o("MAWDbParticipantTxns").bulkDeleteParticipants(e.db,r).then(function(){return p(e.db,i,a)}).then(function(){return t})}).then(function(e){return e.map(function(e){return e.success?{index:e.value.index,result:o("WAResultOrError").makeResult()}:{index:e.error.index,result:o("WAResultOrError").makeError(e.error.message)}}).sort(function(e,t){var n=e.index,r=t.index;return n-r}).map(function(e){var t=e.result;return t})}))},this.clear=function(){return o("MAWDexieCastToPromise").dexieCastToPromise_I_KNOW_WHAT_I_AM_DOING(e.db.participants.clear())},this.db=t};e.tableLocks={participants:o("MAWTransactionMode").READWRITE,threads:o("MAWTransactionMode").READWRITE};function s(e,t){var n=e.addressable!=null?{addressable:e.addressable}:null;return babelHelpers.extends({chatJid:t,type:e.type,user:e.userJid},n)}function u(e){return{addressable:e.addressable,id:o("MAWDbParticipant").craftParticipantId(e.chatJid,e.user),threadJid:e.chatJid,type:e.type,userJid:e.user}}function c(e){return e.map(function(e){return e.user}).filter(function(e){return e===o("WAGlobals").getMyUserJid()||e==="@me"}).length>0}function d(e,t){var n=e.threads;return n.where("jid").anyOf(t).toArray().then(function(e){return new Set(e.map(function(e){var t=e.jid;return t}))})}function m(e,t){var n=t.filter(function(e){var t=e.existed;return!t}).map(function(e){var t=e.chatJid,n=e.participant;return{chatJid:t,participant:n}}),r=o("WAArrayGroupBy").groupBy(n,function(e){var t=e.chatJid;return t}).map(function(e){var t=e[0],n=e[1];return[t,n.map(function(e){var t=e.participant;return t})]});t.forEach(function(e){var t=e.dbParticipantToPut;o("MAWIndexedDb").afterTransaction({tag:"ParticipantsUpdated",value:{participants:[o("MAWBridgeParticipants").createBridgeParticipant(t)]}})});var a=r.filter(function(e){var t=e[0],n=e[1];return c(n)}).map(function(e){var t=e[0];return t});return o("MAWDbThreadTxns").subscribeToThreads(e,a)}function p(e,t,n){var r=Array.from(t);r.forEach(function(e){var t=e.groupJid;return o("MAWIndexedDb").afterTransaction({tag:"UpdateE2EEMetadataParticipants",value:o("MAWBridgeTypesCreators").createBridgeUpdateE2EEMetadataParticipants(t)})});var a=new Set(r.filter(function(e){return e.userJid===o("WAGlobals").getMyUserJid()&&(n===o("WAGlobals").getMyUserJid()||n==="@me")}).map(function(e){return e.groupJid})),i=new Set(r.filter(function(e){var t=e.userJid;return t!==n&&(t===o("WAGlobals").getMyUserJid()||t==="@me")}).filter(function(e){var t=e.groupJid;return!a.has(t)}).map(function(e){var t=e.groupJid;return t}));return o("MAWDexieTable").dexieAll([o("MAWDbThreadTxns").archiveThreads(e,Array.from(a),!0),o("MAWDbThreadTxns").unsubscribeFromThreads(e,Array.from(i))])}l.MAWParticipantsStore=e}),98);
__d("MAWRunInTransaction",["MAWDexie","MAWGroupInfoStore","MAWIndexedDb","MAWMessageStore","MAWParticipantsStore","MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";var e={GroupInfoStore:o("MAWGroupInfoStore").MAWGroupInfoStore.tableLocks,MessagesStore:o("MAWMessageStore").MAWMessageStore_DEPRECATED_DO_NOT_USE.tableLocks,ParticipantsStore:o("MAWParticipantsStore").MAWParticipantsStore.tableLocks},s=function(n,a,i){var t=[];for(var l in n)n[l]===!0&&t.push(l);var s=t.flatMap(function(t){return Object.entries(e[t])}).reduce(function(e,t){var n,r=t[0],a=t[1];if(e[r]===o("MAWTransactionMode").READWRITE)return e;var i=r;return babelHelpers.extends({},e,(n={},n[""+i]=a,n))},{}),u=o("MAWIndexedDb").makeMsgrTransactor(s,i!=null?i:"runInTransaction",function(e){return function(){var t={CollectionVersionStore:null,GroupInfoStore:n.GroupInfoStore===!0?new(o("MAWGroupInfoStore")).MAWGroupInfoStore(e):null,MessagesStore:n.MessagesStore===!0?new(o("MAWMessageStore")).MAWMessageStore_DEPRECATED_DO_NOT_USE(e):null,MissingKeyStore:null,ParticipantsStore:n.ParticipantsStore===!0?new(o("MAWParticipantsStore")).MAWParticipantsStore(e):null,PendingMutationStore:null,SyncActionStore:null,SyncKeyStore:null};return new(r("MAWDexie")).Promise(function(e){e(a(t))})}});return u()};l.runInTransaction=s}),98);
__d("MAWAddGroupParticipantsApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(e){return s.apply(void 0,[e].concat(t))},"addGroupParticipants")},s=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a,i,l,s){var u=e.GroupInfoStore,c=e.MessagesStore,d=e.ParticipantsStore,m=yield u.get(n);if(!m.success)return o("WAResultOrError").makeError("missing_group");var p=a.map(function(e){return{addressable:e.addressable,chatJid:n,type:e.type,user:e.user}});if(yield d.bulkPut(p),t!=null){var _=o("MAWAdminMsgHelpers").createParticipantAddAdminMessage(n,p.map(function(e){return e.user}),r,s);yield c.create(_),yield u.update(n,function(e){return babelHelpers.extends({},e,{participantVersion:t.current})},{updateParticipantMedatadata:i})}return o("WAResultOrError").makeResult()});return function(n,r,o,a,i,l,s,u){return e.apply(this,arguments)}})();l.addGroupParticipants=e,l.addGroupParticipantsTransactor=s}),98);
__d("MAWChangeGroupMemberAddModeApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0},function(e){return s.apply(void 0,[e].concat(t))},"changeGroupMemberAddMode")},s=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a,i){var l=e.GroupInfoStore,s=e.MessagesStore,u=yield l.get(t);if(!u.success)return o("WAResultOrError").makeError("missing_group");if(yield l.update(t,function(e){return babelHelpers.extends({},e,{memberAddMode:r})}),i==="create_admin_message"){var c=o("MAWAdminMsgHelpers").createMemberAddModeChangeAdminMsg(t,r,n,a);c!=null&&(yield s.create(c))}return o("WAResultOrError").makeResult()});return function(n,r,o,a,i,l){return e.apply(this,arguments)}})();l.changeGroupMemberAddMode=e,l.changeGroupMemberAddModeTransactor=s}),98);
__d("MAWChangeGroupParticipantAdminStatusApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(e){return s.apply(void 0,[e].concat(t))},"changeGroupParticipantAdminStatus")},s=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a,i,l){var s=e.GroupInfoStore,u=e.MessagesStore,c=e.ParticipantsStore,d=yield s.get(n);if(!d.success)return o("WAResultOrError").makeError("missing_group");var m=a.map(function(e){return{addressable:e.addressable,chatJid:n,type:i,user:e.user}});if(yield c.bulkPut(m),t!=null){yield s.update(n,function(e){return babelHelpers.extends({},e,{participantVersion:t.current})});for(var p,_=0;_<m.length;_++)i==="admin"?p=o("MAWAdminMsgHelpers").createParticipantPromoteAdminMsg(n,m[_].user,r,l):p=o("MAWAdminMsgHelpers").createParticipantDemoteAdminMsg(n,m[_].user,r,l),yield u.create(p)}return o("WAResultOrError").makeResult()});return function(n,r,o,a,i,l,s){return e.apply(this,arguments)}})();l.changeGroupParticipantAdminStatus=e,l.changeGroupParticipantAdminStatusTransactor=s}),98);
__d("MAWAdminWriteChangeParticipantsAdminMsgTxn",["FBLogger","MAWAdminAddParticipantMsg","MAWAdminRemoveParticipantMsg","MAWDbThreadTxns","MAWLocalizationUtils","MAWUserJidWrapper","MAWWriteMsgTxns","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return u(e,t,o("MAWAdminAddParticipantMsg").createAddParticipantsAdminMessage)}function s(e,t){return u(e,t,o("MAWAdminRemoveParticipantMsg").createRemoveParticipantsAdminMessage)}function u(e,t,n){var a=t.admin,i=t.chatJid,l=t.participants,s=t.serverTs;if(l.length===0)throw r("FBLogger")("messenger_web").mustfixThrow("invalid number of participants when writing participants change admin msg");return o("MAWDbThreadTxns").getThread(e,i).then(function(i){if(!i.success)throw r("FBLogger")("messenger_web").mustfixThrow("no thread when writing participants change admin msg");var u=i.value,c=o("MAWUserJidWrapper").getMyUserJid(),d=a==="@me"?c:a;if(d!=null){var m=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg(n(d,l),u.jid,t.externalId,s);return o("MAWWriteMsgTxns").writeMsg(e,m,u).then(r("emptyFunction"))}})}l.writeAddParticipantAdminMsg=e,l.writeRemoveParticipantAdminMsg=s}),98);
__d("MAWAdminWriteGroupNameChangeTxn",["MAWAdminWriteGroupNameChangeAdminMsgContent","MAWDexieTable","MAWExternalId","MAWLocalizationUtils","MAWWriteMsgTxns","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){var a=t.name;if(a==null)return o("MAWDexieTable").dexieResolve();var i=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg(o("MAWAdminWriteGroupNameChangeAdminMsgContent").getAdminMsgContent(t.nameOwner,a),n.jid,o("MAWExternalId").generateExternalId(),o("WATimeUtils").castMillisTimeToUnixTime(o("WATimeUtils").millisTime()));return o("MAWWriteMsgTxns").writeMsg(e,i,n).then(r("emptyFunction"))}l.writeGroupNameChangeInfo=e}),98);
__d("MAWParticipantManagementTxns",["MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWUserJidWrapper"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t,n){return o("MAWDbParticipantTxns").getParticipantsInThread(e,t).then(function(r){if(n.length===0&&r.length===0)return{addedJids:[],participants:r,removedJids:[],typeUpdateJids:[]};var a=new Map;r.forEach(function(e){a.set(e.userJid,e)});var i=new Set(n.map(function(e){return e.userJid})),l=[],s=[],u=[],c=[];a.forEach(function(e,t){i.has(t)||(e.type!=="invitedParticipant"?l.push(t):(c.push({type:e.type,userJid:e.userJid}),u.push(babelHelpers.extends({},e))))}),n.forEach(function(e){var t=a.get(e.userJid);t==null?(s.push(e),e.type==="admin"&&c.push({type:e.type,userJid:e.userJid})):(t.type!==e.type&&c.push({type:e.type,userJid:e.userJid}),u.push(babelHelpers.extends({},t,e)))});var d=l.indexOf(o("MAWUserJidWrapper").getMyUserJid())>=0,m=function(){return[o("MAWDbParticipantTxns").bulkAddParticipants(e,t,s),o("MAWDbParticipantTxns").bulkUpdateParticipants(e,u),o("MAWDbParticipantTxns").bulkDeleteParticipantsInThread(e,t,l),d?o("MAWDbThreadTxns").archiveThreads(e,[t],!0):o("MAWDexieTable").dexieResolve()]};return o("MAWDexieTable").dexieAll(m()).then(function(e){var t=e[0],n=e[1];return{addedJids:s.map(function(e){return e.userJid}),participants:[].concat(t,n),removedJids:l,typeUpdateJids:c}})})}l.syncParticipantList=e}),98);
__d("MAWGroupManagementTxns",["MAWAdminWriteChangeParticipantsAdminMsgTxn","MAWAdminWriteGroupNameChangeTxn","MAWDbGroupInfoTxns","MAWDbParticipantTxns","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWFolderTypes","MAWGetOrCreateThreadTxns","MAWParticipantManagementTxns","MAWThreadManagementTxns","MAWUserJidWrapper","WATimeUtils","isGroupInvitesEnabled"],(function(t,n,r,o,a,i,l){"use strict";var e=["description","participants"];function s(e,t,n){return o("MAWDexieTable").dexieAll([o("MAWThreadManagementTxns").deleteAllThreadData(e,n),o("MAWDbGroupInfoTxns").deleteGroupInfo(e,t)]).then(function(e){var t=e[0];return t}).then(function(e){return e})}var u=function(n,a){var t=a.authoritativeThreadKey,i=a.deduplicationKey,l=a.extras,s=a.folder,u=a.groupStatus,c=a.groupToCreate,d=a.serverTs,m=u==="added"?o("WATimeUtils").unixTime():c.creationTs;return o("MAWGetOrCreateThreadTxns").getOrCreateThread(n,{authoritativeThreadKey:t,clientThreadKey:l==null?void 0:l.clientThreadKey,createTs:o("WATimeUtils").castUnixTimeToMillisTime(m),deduplicationKey:i,description:"createGroup",folder:s==null?o("MAWFolderTypes").FOLDER_ID.INBOX:s,jid:c.jid}).then(function(t){var a=t.created,i=t.thread,l=c.participants.map(function(e){return e.error?r("isGroupInvitesEnabled")()&&e.error.errorCode===403?{addressable:!0,type:"invitedParticipant",userJid:e.error.user}:null:{addressable:e.value.addressable,type:e.value.type,userJid:e.value.user}}).filter(Boolean),s=a?o("MAWDbParticipantTxns").bulkAddParticipants:o("MAWParticipantManagementTxns").syncParticipantList,m=s(n,i.jid,l),p=o("MAWUserJidWrapper").getMyUserJid(),_=u==="added"&&!a&&c.creator!==p?o("MAWAdminWriteChangeParticipantsAdminMsgTxn").writeAddParticipantAdminMsg(n,{admin:c.inviter,chatJid:i.jid,externalId:o("MAWExternalId").generateExternalId(),participants:[p],serverTs:d}):o("MAWDexieTable").dexieResolve(),f=c.description,g=c.participants,h=babelHelpers.objectWithoutPropertiesLoose(c,e);return o("MAWDexieTable").dexieAll([m,o("MAWDbGroupInfoTxns").putGroupInfo(n,h),_]).then(function(e){var t=e[0],r=e[1];return a&&u==="added"?o("MAWAdminWriteGroupNameChangeTxn").writeGroupNameChangeInfo(n,r,i):o("MAWDexieTable").dexieResolve()}).then(function(){return i.archived===!0?o("MAWDbThreadTxns").unarchiveThreads(n,[i.jid]):o("MAWDbThreadTxns").subscribeToThreads(n,[i.jid])}).then(function(e){return i.jid})})};l.deleteGroup=s,l.createGroupInternal=u}),98);
__d("MAWThreadTypes",["MAWTransactionMode"],(function(t,n,r,o,a,i,l){"use strict";var e,s={chunk:(e=o("MAWTransactionMode")).READWRITE,deletedMessages:e.READWRITE,editMsgHistory:e.READWRITE,groupInfo:e.READWRITE,groupInvites:e.READWRITE,media:e.READWRITE,messages:e.READWRITE,participants:e.READWRITE,pendingStanzas:e.READWRITE,reactions:e.READWRITE,threads:e.READWRITE,unrenderedMessages:e.READWRITE,xma:e.READWRITE};l.ThreadRelatedTablesPermissions=s}),98);
__d("MAWDeleteGroupsApi",["MAWDbThreadTxns","MAWDexieTable","MAWGroupManagementTxns","MAWIndexedDb","MAWThreadTypes","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor(o("MAWThreadTypes").ThreadRelatedTablesPermissions,"deleteGroups",function(e){return(function(t){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=t.group;return o("MAWDbThreadTxns").getThread(e,n).then(function(t){return t.success?o("MAWGroupManagementTxns").deleteGroup(e,n,t.value).then(function(e){return o("WAResultOrError").makeResult({deletedGroupId:n,deletedMsgIds:e.deletedMessages})}):o("WAResultOrError").makeError("missing_thread")})})).then(function(e){return e})})});l.deleteGroupsFromMAW=e}),98);
__d("WADeleteGroupFollowUpLowLevelApi",["Promise","WASignalDB","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(r){return o("WASignalDB").getDb().runInTransaction(["senderKeySessions","personalSenderKeyStatuses"],"readwrite",(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){yield(e||(e=n("Promise"))).all([t.stores.senderKeySessions.readIndex("groupJid",[r]).then(function(e){return t.stores.senderKeySessions.bulkDelete(e.map(function(e){return e.id}))}),t.stores.personalSenderKeyStatuses.delete(r)])});return function(e){return t.apply(this,arguments)}})(),o("WASignalDB").signalOp("deleteGroupFollowUpLowLevel"))};l.deleteGroupFollowUpLowLevel=s}),98);
__d("MAWDeleteGroup",["MAWDeleteGroupsApi","Promise","WADeleteGroupFollowUpLowLevelApi","WALogger","asyncToGeneratorRuntime","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,a){var i=yield o("MAWDeleteGroupsApi").deleteGroupsFromMAW(a.map(function(e){return{deleter:t,group:e}}));return(s||(s=n("Promise"))).all(i.map((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){if(!t.success)o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["deleteGroups failed to delete group to a non-existent thread"])));else{var n=t.value,r=n.deletedGroupId,a=n.deletedMsgIds;yield o("WADeleteGroupFollowUpLowLevelApi").deleteGroupFollowUpLowLevel(r,a)}});return function(e){return t.apply(this,arguments)}})())).then(r("emptyFunction"))}),c.apply(this,arguments)}l.default=u}),98);
__d("MAWRemoveGroupInvitesApi",["MAWDbGroupInviteTxns","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MAWIndexedDb").makeMsgrTransactor({groupInvites:o("MAWTransactionMode").READWRITE},"removeGroupInvites",function(t){return(function(n,r){return o("MAWDbGroupInviteTxns").deleteGroupInvitesByThreadAndInvitedParticipant(t,n,r).then(function(t){o("WALogger").DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["removeGroupInvites deleted "," record(s) from "," for ",""])),t,n,r),o("MAWIndexedDb").afterTransaction({tag:"DeleteGroupInvite",value:{threadJid:n}})}).then(function(){o("MAWIndexedDb").afterTransaction({tag:"GroupInviteLoaded",value:{actorId:r,threadJid:n}})})})});l.removeGroupInvites=s}),98);
__d("MAWRemoveGroupParticipantsApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAAPI","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];return o("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(e){return s.apply(void 0,[e].concat(t))},"removeGroupParticipants").then((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){return e.success&&(yield r("WAAPI").setRotateSenderKeyToTrue([t[1]])),e});return function(t){return e.apply(this,arguments)}})())},s=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a,i,l){var s=e.GroupInfoStore,u=e.MessagesStore,c=e.ParticipantsStore,d=yield s.get(n);if(!d.success)return o("WAResultOrError").makeError("missing_group");var m=a.map(function(e){return e.user}),p=m.map(function(e){return{groupJid:n,userJid:e}});if(yield c.bulkDelete(p,{remover:r}),t!=null){var _=o("MAWAdminMsgHelpers").createParticipantRemoveAdminMsg(n,m,r,l);yield u.create(_),yield s.update(n,function(e){return babelHelpers.extends({},e,{participantVersion:t.current})},{updateParticipantMedatadata:i})}return o("WAResultOrError").makeResult()});return function(n,r,o,a,i,l,s){return e.apply(this,arguments)}})();l.removeGroupParticipants=e,l.removeGroupParticipantsTransactor=s}),98);
__d("MAWUpdateGroupSubjectApi",["MAWAdminMsgHelpers","MAWRunInTransaction","WAJids","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return o("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(e){return s.apply(void 0,[e].concat(t))},"updateGroupSubject")},s=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r,a=e.GroupInfoStore,i=e.MessagesStore,l=yield a.get(t);if(!l.success)return o("WAResultOrError").makeError("missing_group");var s=l.value;if(s.subject.ts!=null&&(n.ts==null||s.subject.ts>n.ts))return o("WAResultOrError").makeResult();yield a.update(t,function(e){return babelHelpers.extends({},e,{subject:n})});var u=yield a.get(s.jid);if(!u.success)return o("WAResultOrError").makeError("missing_group");var c=u.value,d=c.subject.user,m=o("MAWAdminMsgHelpers").createGroupNameChangeAdminMsg(t,c,d!=null?o("WAJids").userIdFromJid(d):void 0,(r=n.ts)!=null?r:o("WATimeUtils").unixTime());return m!=null&&(yield i.create(m)),o("WAResultOrError").makeResult()});return function(n,r,o){return e.apply(this,arguments)}})();l.updateGroupSubject=e,l.updateGroupSubjectTransactor=s}),98);
__d("MAWHandleGroupNotifications",["FBLogger","MAWAddGroupParticipantsApi","MAWChangeGroupMemberAddModeApi","MAWChangeGroupParticipantAdminStatusApi","MAWDeleteGroup","MAWRemoveGroupInvitesApi","MAWRemoveGroupParticipantsApi","MAWUpdateGroupSubjectApi","Promise","WAAPI","WACreateGroup","WAGlobals","WAResultOrError","asyncToGeneratorRuntime","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var a=t.notification;switch(a.type){case"join":return u(a).then(function(){return o("WAResultOrError").makeResult()});case"add":return d(a);case"remove":return m(a);case"promote":return _(a);case"demote":return p(a);case"delete":{var i=a.groupJid,l=a.participant;if(l==null)throw r("FBLogger")("messenger_web").mustfixThrow("Group delete notification without deleter JID: "+i);return r("MAWDeleteGroup")(l,[i]).then(function(){return o("WAResultOrError").makeResult()})}case"subject":return f(a).then(function(){return o("WAResultOrError").makeResult()});case"memberAddMode":return g(a);default:return a.type,(e||(e=n("Promise"))).resolve(o("WAResultOrError").makeResult())}}function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(!e.isE2EEMigration){var t=e.group,n=e.isNew,a=e.key,i=e.serverTs;yield o("WACreateGroup").createGroups([{extras:a!=null?{deduplicationKey:a,platform:"msgr"}:null,folder:null,groupStatus:n?"new":"added",groupToCreate:t,key:a,serverTs:i}]);var l=e.group.participants.map(function(e){return e.success?e.value.user:e.error.user}),s=o("WAGlobals").getMyUserJid();l.find(function(e){return e===s})&&(yield o("MAWRemoveGroupInvitesApi").removeGroupInvites(t.jid,s)),yield r("WAAPI").getDevices({ignoreDhash:!1,reason:"added-to-group",users:new Set(l)})}}),c.apply(this,arguments)}function d(e){var t=e.groupJid,n=e.participant,a=e.participants,i=e.previousVersionId,l=e.reason,s=e.serverTs,u=e.versionId;if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("Group add participant notification without adder JID: "+t);return o("MAWAddGroupParticipantsApi").addGroupParticipants({current:u,previous:i},t,n,a,!1,l,s)}function m(e){var t=e.groupJid,n=e.participant,a=e.participants,i=e.previousVersionId,l=e.serverTs,s=e.versionId;if(n==null)throw r("FBLogger")("messenger_web").mustfixThrow("Group remove participant notification without remover JID: "+t);var u=null;return s!=null&&(u={current:s,previous:i}),o("MAWRemoveGroupParticipantsApi").removeGroupParticipants(u,t,n,a,!1,l)}function p(e){var t=e.groupJid,n=e.participant,r=e.participants,a=e.previousVersionId,i=e.serverTs,l=e.versionId;return o("MAWChangeGroupParticipantAdminStatusApi").changeGroupParticipantAdminStatus({current:l,previous:a},t,n,r,"participant",i)}function _(e){var t=e.groupJid,n=e.participant,r=e.participants,a=e.previousVersionId,i=e.serverTs,l=e.versionId;return o("MAWChangeGroupParticipantAdminStatusApi").changeGroupParticipantAdminStatus({current:l,previous:a},t,n,r,"admin",i)}function f(e){var t=e.groupJid,n=e.participant,a=e.subject,i=e.ts;return o("MAWUpdateGroupSubjectApi").updateGroupSubject(t,{content:a,ts:i,user:n}).then(r("emptyFunction"))}function g(e){var t=e.groupJid,n=e.memberAddMode,r=e.participant,a=e.serverTs;return o("MAWChangeGroupMemberAddModeApi").changeGroupMemberAddMode(t,r,n,a,"create_admin_message")}l.persistGroupNotification=s}),98);
__d("MAWQueryGroupOverGraphQL",["E2EEMetadataMailboxFetchGroupInfoMutation","FBLogger","MAWODSProxy","WAJids","WAOdsEnums","WAResultOrError","WATimeUtils","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){try{var t,n,a,i,l,s,u,c=yield o("E2EEMetadataMailboxFetchGroupInfoMutation").fetchGroupInfoFromMIOverGraphQL({request_type:0,transport_thread_fbid:o("WAJids").groupIdFromJid(e)}),d=c==null?void 0:c.xfb_fetch_group_info_from_mi;if(d==null||d.success!==!0)return o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.WA_QUERY_GROUP,key:"fail"}),o("WAResultOrError").makeError("QueryGroupInfoResponseServerError");var m=((t=d.participants)!=null?t:[]).map(function(e){var t,n;return{addressable:(t=e.is_addressable)!=null?t:!0,type:e.type==="E2EE_GROUP_PARTICIPANT_TYPE_ADMIN"?"admin":e.type==="E2EE_GROUP_PARTICIPANT_TYPE_SUPER_ADMIN"?"superadmin":"participant",user:o("WAJids").toMsgrUserJid((n=e.contact_id)!=null?n:"")}}),p={creationTs:o("WATimeUtils").castMilliSecondsToUnixTime((n=d.creation_ts_ms)!=null?n:0),creator:d.creator_id!=null?o("WAJids").toMsgrUserJid(d.creator_id):void 0,jid:d.transport_thread_fbid!=null?o("WAJids").toGroupJid(d.transport_thread_fbid):e,memberAddMode:d.participant_update_mode==="OPEN"?"all_member_add":"admin_add",participants:m.map(function(e){return o("WAResultOrError").makeResult(e)}),participantVersion:d.participant_version_id!=null?String(d.participant_version_id):void 0,subject:{content:(a=(i=d.subject_change)==null?void 0:i.subject)!=null?a:"",ts:o("WATimeUtils").castMilliSecondsToUnixTime((l=(s=d.subject_change)==null?void 0:s.subject_change_ts_ms)!=null?l:0),user:((u=d.subject_change)==null?void 0:u.subject_changer_id)!=null?o("WAJids").toMsgrUserJid(d.subject_change.subject_changer_id):void 0}};return o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.WA_QUERY_GROUP,key:"success"}),o("WAResultOrError").makeResult(p)}catch(e){return o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.WA_QUERY_GROUP,key:"fail"}),r("FBLogger")("wmi").tags(["MiSOTGroupMetadataUpdate"]).catching(r("getErrorSafe")(e)).mustfix("Failed to query group info from MI"),o("WAResultOrError").makeError("QueryGroupInfoResponseServerError")}}),s.apply(this,arguments)}l.queryGroupOverGraphQL=e}),98);
__d("MAWQueryGroup",["MAWODSProxy","MAWQueryGroupOverGraphQL","WAOdsEnums","WAQueryGroupOverChatD","WAResultOrError","asyncToGeneratorRuntime","gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=e.groupJid;return r("gkx")("7445")?o("MAWQueryGroupOverGraphQL").queryGroupOverGraphQL(t):s(t)}function s(e){return u.apply(this,arguments)}function u(){return u=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("WAQueryGroupOverChatD").queryGroupOverChatD({groupJid:e});return t.success===!1?(o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.WA_QUERY_GROUP,key:"fail"}),o("WAResultOrError").makeError("QueryGroupInfoResponseServerError")):(o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.WA_QUERY_GROUP,key:"success"}),o("WAResultOrError").makeResult(t.value))}),u.apply(this,arguments)}l.queryGroup=e}),98);
__d("WAParticipant",[],(function(t,n,r,o,a,i){"use strict";function e(e){switch(e){case"admin":case"superadmin":return!0;default:return!1}}i.isGroupAdminParticipantType=e}),66);
__d("WASyncParticipantsApi",["WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var r=e.ParticipantsStore,a=yield r.bulkGetInGroup(t);if(a.success!==!0)return o("WAResultOrError").makeError("missing_participants");if(n.length===0&&a.value.length===0)return o("WAResultOrError").makeResult({removedJids:[],addedJids:[],typeUpdateJids:[]});var i=new Map;a.value.forEach(function(e){i.set(e.user,e)});var l=new Set(n.map(function(e){return e.user})),s=[],u=[],c=[],d=[];return i.forEach(function(e,n){l.has(n)||(e.type!=="invitedParticipant"?s.push({userJid:n,groupJid:t}):(d.push({previousType:e.type,newType:e.type,userJid:e.user}),c.push(babelHelpers.extends({},e))))}),n.forEach(function(e){var t=i.get(e.user);t==null?(u.push(e),e.type==="admin"&&d.push({previousType:"nonparticipant",newType:e.type,userJid:e.user})):(t.type!==e.type&&d.push({previousType:t.type,newType:e.type,userJid:e.user}),c.push(babelHelpers.extends({},t,e)))}),yield r.bulkPut(u),yield r.bulkPut(c),yield r.bulkDelete(s),o("WAResultOrError").makeResult({removedJids:s.map(function(e){var t=e.userJid;return t}),addedJids:u.map(function(e){return e.user}),typeUpdateJids:d})});return function(n,r,o){return e.apply(this,arguments)}})();l.syncParticipantsTransactor=e}),98);
__d("MAWResetGroupParticipantInfoApi",["MAWAdminMsgHelpers","MAWRunInTransaction","Promise","WAAPI","WALogger","WAParticipant","WAResultOrError","WASyncParticipantsApi","WATimeUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=function(){for(var e=arguments.length,t=new Array(e),a=0;a<e;a++)t[a]=arguments[a];return o("MAWRunInTransaction").runInTransaction({GroupInfoStore:!0,MessagesStore:!0,ParticipantsStore:!0},function(e){return c.apply(void 0,[e].concat(t))},"resetGroupParticipantInfo").then((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){return e.success&&(yield r("WAAPI").setRotateSenderKeyToTrue([t[0]])),e});return function(t){return e.apply(this,arguments)}})())},c=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,r,a,i){var l=t.GroupInfoStore,u=t.MessagesStore,c=t.ParticipantsStore,d=a.map(function(e){return{addressable:e.addressable,chatJid:r,type:e.type,user:e.user}}),m=yield o("WASyncParticipantsApi").syncParticipantsTransactor({ParticipantsStore:c},r,d);if(i!=null){var p=yield l.update(r,function(e){return babelHelpers.extends({},e,{participantVersion:i})});if(!p.success)return p}if(m.success!==!0)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly received an error when sync-ing participants"]))),m;var _=m.value,f=[];if(_.removedJids.length>0){var g=o("MAWAdminMsgHelpers").createParticipantRemoveAdminMsg(r,_.removedJids,null,o("WATimeUtils").unixTime());f.push(u.create(g))}if(_.addedJids.length>0){var h=o("MAWAdminMsgHelpers").createParticipantAddAdminMessage(r,_.addedJids,null,o("WATimeUtils").unixTime());f.push(u.create(h))}if(_.typeUpdateJids.length>0)for(var y=0;y<_.typeUpdateJids.length;y++){var C=_.typeUpdateJids[y].previousType,b=_.typeUpdateJids[y].newType,v=o("WAParticipant").isGroupAdminParticipantType(C),S=o("WAParticipant").isGroupAdminParticipantType(b),R=!v&&S,L=v&&!S;if(R){var E=o("MAWAdminMsgHelpers").createParticipantPromoteAdminMsg(r,_.typeUpdateJids[y].userJid,null,o("WATimeUtils").unixTime());f.push(u.create(E))}else if(L){var k=o("MAWAdminMsgHelpers").createParticipantDemoteAdminMsg(r,_.typeUpdateJids[y].userJid,null,o("WATimeUtils").unixTime());f.push(u.create(k))}}return(s||(s=n("Promise"))).all(f).then(function(){return o("WAResultOrError").makeResult()})});return function(n,r,o,a){return t.apply(this,arguments)}})();l.resetGroupParticipantInfo=u,l.resetGroupParticipantInfoTransactor=c}),98);
__d("MAWProtocolQueueGroupNotification",["FBLogger","MAWHandleGroupNotifications","MAWQueryGroup","MAWResetGroupParticipantInfoApi","Promise","WALogger","WAQueryGroupsAndSync","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m;function p(e){var t=e.notification;return o("MAWHandleGroupNotifications").persistGroupNotification(e).then(function(e){return e.success?e:o("WAResultOrError").makeResult({errorResult:e,groupNotification:t})})}function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=[];if(yield(m||(m=n("Promise"))).all(t.map((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){try{var n=yield o("MAWQueryGroup").queryGroup({groupJid:t});if(n.success===!1){var i;o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[ParticipantRecovery] Cannot get a group, as per ",""])),n.error),r("FBLogger")("messenger_web").mustfix("[ParticipantRecovery] Cannot get a group, as per %s",(i=n.error)!=null?i:"unknown");return}var l=n.value,c=l.participants.map(function(e){return e.error?(o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Unexpectedly received a participant with an error"]))),null):e.value}).filter(Boolean),d=yield o("MAWResetGroupParticipantInfoApi").resetGroupParticipantInfo(t,c,l.participantVersion),m=d.error;!d.success&&m==="missing_group"&&a.push(t)}catch(e){o("WALogger").DEV(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Failed to get group info"]))).devConsole(e)}});return function(e){return t.apply(this,arguments)}})())),a.length>0)try{yield o("WAQueryGroupsAndSync").queryGroupsAndSync({groupJids:a})}catch(e){o("WALogger").DEV(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed to query groups"]))).devConsole(e)}}),f.apply(this,arguments)}function g(e){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){try{yield o("WAQueryGroupsAndSync").queryGroupsAndSync({groupJids:e})}catch(e){o("WALogger").DEV(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to recover missing group info"]))).devConsole(e)}}),h.apply(this,arguments)}l.handleProtocolQueueGroupNotification=p,l.doParticipantRecovery=_,l.doGroupRecovery=g}),98);
__d("MAWAdminWriteUsersConnectedMsgTxn",["MAWDbMsgTxns","MAWDbThreadTxns","MAWDexieTable","MAWExternalId","MAWIndexedDb","MAWLocalizationType","MAWLocalizationUtils","MAWMsgType","MAWUserJidWrapper","MAWWriteMsgTxns","MessengerMSplitFlag","WAJids","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t,n,a,i){var l=o("MAWUserJidWrapper").getMyUserJid();return n===l?(o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["writeUsersConnectedAdminMsg is called for self thread"]))),o("MAWDexieTable").dexieResolve()):o("MAWDbThreadTxns").getThread(t,n).then(function(e){if(!e.success){o("WALogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["writeUsersConnectedAdminMsg failed to create or get 1:1 thread"])));return}var n=e.value,c=o("MAWDbMsgTxns").doesThreadHaveMsgsMatchCriteria(t,n.jid,function(e){return e.type===o("MAWMsgType").MSG_TYPE.ADMIN?!1:e.author===l||e.author===o("WAJids").AUTHOR_ME}),d=o("MAWDbMsgTxns").doesThreadHaveMsgsMatchCriteria(t,n.jid,function(e){return e.type===o("MAWMsgType").MSG_TYPE.ADMIN?!1:e.author!==l&&e.author!==o("WAJids").AUTHOR_ME});return o("MAWDexieTable").dexieAll([c,d]).then(function(e){var l=e[0],s=e[1];if(!l||!s){o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["writeUsersConnectedAdminMsg found a thread without messages from both users, which we'll not append to."])));return}var c=o("MAWLocalizationUtils").buildUnstoredDbAdminMsg({adminMsgContent:[],adminType:r("MessengerMSplitFlag").is_msplit_account||a?o("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED_ONE_MSPLIT:o("MAWLocalizationType").LOCALIZATION_TYPE.TWO_USERS_CONNECTED,version:1},n.jid,o("MAWExternalId").generateExternalId(),i);return o("MAWWriteMsgTxns").writeDedupedUsersConnectedAdminMessage(t,c,n).then(function(){var e=o("WAJids").interpretAsUserJid(n.jid);e!=null&&o("MAWIndexedDb").afterTransaction({tag:"UpdateContactAsConnected",value:{contactUserId:o("WAJids").extractUserId(e),threadJid:n.jid}})})})})}l.writeUsersConnectedAdminMsg=c}),98);
__d("MAWHandleConnectedAdminMsgApi",["MAWAdminWriteUsersConnectedMsgTxn","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("MAWIndexedDb").makeMsgrTransactor({ftsBackloggedMessages:(s=o("MAWTransactionMode")).READWRITE,groupInfo:s.READONLY,messages:s.READWRITE,threads:s.READWRITE},"handleConnectedAdminMsg",function(t){return(function(n){var r=n.chatJid,a=n.isOtherContactMsplit,i=n.notificationTs;return o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["handleConnectedAdminMsg: chat ",""])),r),o("MAWAdminWriteUsersConnectedMsgTxn").writeUsersConnectedAdminMsg(t,r,a,i)})});l.handleConnectedAdminMsg=u}),98);
__d("MAWUpdateThreadFolderApi",["MAWBridgeTypesCreators","MAWDbThreadTxns","MAWIndexedDb","MAWTransactionMode","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("MAWIndexedDb").makeMsgrTransactor({threads:o("MAWTransactionMode").READWRITE},"updateThreadFolder",function(t){return(function(n,r){return o("WALogger").LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Update thread ",""])),n),o("MAWDbThreadTxns").getThread(t,n).then(function(e){if(e.success)return o("MAWDbThreadTxns").updateThread(t,babelHelpers.extends({},e.value,{folder:r})).then(function(t){o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Update thread "," folder with folder id ",""])),e.value.jid,r),o("MAWIndexedDb").afterTransaction({tag:"ThreadUpdated",value:o("MAWBridgeTypesCreators").createBridgeUpdatedThread({folder:r,threadJid:e.value.jid})})})})})});l.updateThreadFolder=u}),98);
__d("MAWProtocolQueueNotification",["MAWBridge","MAWFolderTypes","MAWHandleConnectedAdminMsgApi","MAWODSProxy","MAWProtocolQueueGroupNotification","MAWUpdateThreadFolderApi","MWFBLogger","Promise","WAJids","WAOdsEnums","WAResultOrError","asyncToGeneratorRuntime","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m=o("MWFBLogger").MWLogger().tags(["ProtocolQueue"]);function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.stanzaId,a=e.notification,i=a.actions,l=a.chatJid,p=a.ts,_=o("WAJids").interpretAsUserJid(l),f=yield o("MAWBridge").getBridge().sendAndReceive("event","getLSDBUsersIsMsplit",{users:[_].filter(Boolean)});return(d||(d=n("Promise"))).all(i.map(function(e){switch(e.type){case"folder":{var r,a=(r=e.folderId)!=null?r:o("MAWFolderTypes").FOLDER_ID.INBOX;return m.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") with folder id ",", jid: ",""])),t,a,l),o("MAWUpdateThreadFolderApi").updateThreadFolder(l,a)}case"connected":{m.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") connected, jid: ",""])),t,l);var i=_!=null&&f.get(_)===!0;return o("MAWHandleConnectedAdminMsgApi").handleConnectedAdminMsg({chatJid:l,isOtherContactMsplit:i,notificationTs:p})}default:return e.type,m.MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["handleThreadNotification (",") unknown thread action, jid: ",""])),t,l),(d||(d=n("Promise"))).reject("Handle thread notification: unknown thread action")}})).then(r("emptyFunction"))}),_.apply(this,arguments)}function f(e){return(d||(d=n("Promise"))).all(e.map(function(e){var t=e.notification,n=g(t);return n})).then(function(t){var n={groupRecoveries:[],participantRecoveries:[]},r=[];return t.map(function(t,o){if(t.success===!0&&(r.push(e[o].stanzaQueueId),t.value!=null)){var a=t.value;a.type==="group"&&n.groupRecoveries.push(a.data.groupNotification.groupJid)}}),{followUpParams:n,toAck:r}})}function g(t){switch(t.type){case"group":return o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.WA_PROTOCOL_QUEUE_NOTIFICATION,key:t.type+"."+t.notification.type}),o("MAWProtocolQueueGroupNotification").handleProtocolQueueGroupNotification(t).then(function(e){return e.value?o("WAResultOrError").makeResult({data:e.value,type:"group"}):o("WAResultOrError").makeResult()});case"thread":return t.notification.actions.forEach(function(e){o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.WA_PROTOCOL_QUEUE_NOTIFICATION,key:t.type+"."+e.type})}),p(t).then(function(){return o("WAResultOrError").makeResult()});default:return m.MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Received unsupported notification type: ",""])),t.type),(d||(d=n("Promise"))).resolve(o("WAResultOrError").makeResult())}}l.handleIncomingNotificationStanzas=f}),98);
__d("MAWCOPNotificationsHandler",["MAWCommonScheduler","MAWIsQuotaExceededError","MAWProtocolQueueGroupNotification","MAWProtocolQueueNotification","MAWSharedCOPLogger","WorkerScheduler","asyncToGeneratorRuntime","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){return c(t).catch(function(t){if(o("MAWIsQuotaExceededError").isQuotaExceededError(t))throw t;return r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Notification consumer error"]))),[]})}function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return[];var t=yield o("MAWProtocolQueueNotification").handleIncomingNotificationStanzas(e);t.toAck.length!==e.length&&r("MAWSharedCOPLogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing notifications batch, see transactor error reports."])));var a=t.followUpParams,i=a.groupRecoveries,l=a.participantRecoveries;return l.length>0&&r("promiseDone")(o("MAWCommonScheduler").mawCommonScheduler().runTask({fn:function(){return o("MAWProtocolQueueGroupNotification").doParticipantRecovery(l)},name:"ParticipantsRecovery",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})),i.length>0&&r("promiseDone")(o("MAWCommonScheduler").mawCommonScheduler().runTask({fn:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield o("MAWProtocolQueueGroupNotification").doGroupRecovery(i)});function t(){return e.apply(this,arguments)}return t})(),name:"GroupsRecovery",priority:o("WorkerScheduler").BACKGROUND_PRIORITY})),t.toAck}),d.apply(this,arguments)}l.copIncomingNotificationHandler=u}),98);
__d("MAWIncomingReceiptDataFormatTxns",["MAWDbMsgTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWMsgType","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e=["protocolMsgId"],s;function u(e){var t=e.author,n=e.chat,r=e.externalId;return n+"_"+r+"_"+t}function c(t,n){if(n.length===0)return o("MAWDexieTable").dexieResolve();var r=new Map,a=new Set;n.forEach(function(e){var t=e.msgs;t.forEach(function(e){return a.add(babelHelpers.extends({},e))})});var i=o("MAWDexieTable").dexieAll([o("MAWDbMsgTxns").getMsgsByProtocolMsgId(t,Array.from(a)),o("MAWDbUnrenderedMsgTxns").getUnrenderedMsgsByProtocolMsgId(t,Array.from(a))]).then(function(e){var t=e[0],n=e[1],r=[];return t.forEach(function(e){return r.push({msg:e,renderType:"regular"})}),n.forEach(function(e){return r.push({msg:e,renderType:"unrendered"})}),{msgs:r}});return i.then(function(t){var a=t.msgs;n.forEach(function(e){var t=e.msgs,n=e.receivers,o=e.type;t.forEach(function(e){var t=u(e),a=r.get(t)||{deliveryReceipts:[],protocolMsgId:e,readReceipts:[],senderReceipts:[]};n.forEach(function(e){if(o==="read"||o==="read-self"){a.readReceipts.push(e);return}else if(o==="delivered"){a.deliveryReceipts.push(e);return}else if(o==="sender"){a.senderReceipts.push(e);return}else if(o==="inactive"){a.deliveryReceipts.push(e);return}}),r.set(t,a)})});var i=new Map,l=new Map,c=[];return a.forEach(function(t){var n=t.msg,a=n.author,c=n.externalId,d=n.msgId,m=n.threadJid,p=n.type;if(m==null){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to map the threadId of a message to its threadJid during receipt-writing"])));return}if(p!==o("MAWMsgType").MSG_TYPE.CIPHERTEXT){var _=u({author:a,chat:m,externalId:c}),f=r.get(_);if(f!=null){var g=f.protocolMsgId,h=babelHelpers.objectWithoutPropertiesLoose(f,e),y=babelHelpers.extends({msgId:d},h);l.set(d,y),r.delete(_)}}i.set(d,t)}),r.forEach(function(e){var t=e.deliveryReceipts,n=e.protocolMsgId,r=e.readReceipts;if(!(t.length===0&&r.length===0)){var o=n.author,a=n.chat,i=n.externalId;c.push({author:o,deliveryReceipts:t,externalId:i,readReceipts:r,thread:a})}}),{msgIdToDbMsgMap:i,pendingReceiptsToWrite:c,receiptsToWriteMap:l}})}l.prepareDataForReceiptsToWrite=c}),98);
__d("MAWIncomingReceiptUtils",["WALogger","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){var n=new Map;return t.forEach(function(t){t.msgRenderType!=="unrendered"&&t.affectedUserJids.forEach(function(r){var a,i=t.receipt.statusTsPerUser.get(r);if(i==null){o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["User "," is in affectedUserJids in receipt-writing results, but they have no corresponding read/delivery receipt entry in the DB"])),r);return}var l=[t.threadJid,r],s=n.get(JSON.stringify(l)),u=i.deliveredTs!=null,c=i.readTs!=null,d=u?t.msgTs:0,m=c?t.msgTs:0,p=(a=i.readTs)!=null?a:0;if(s!=null){var _=s.lastDeliveredMsgTs,f=s.lastReadMsgTs,g=s.lastReadActionTs;d=Math.max(d,_),m=Math.max(m,f),p=Math.max(p,g)}n.set(JSON.stringify(l),{lastDeliveredMsgTs:o("WATimeUtils").castToUnixTime(d),lastReadActionTs:o("WATimeUtils").castToUnixTime(p),lastReadMsgTs:o("WATimeUtils").castToUnixTime(m)})})}),new Map(Array.from(n).map(function(e){var t=e[0],n=e[1];return[JSON.parse(t),n]}))}l.getMaxTimestampsPerParticipant=s}),98);
__d("MAWAckAndTimestampUpdatesForReceiptsTxns",["MAWDbMsgTxns","MAWDbParticipantTxns","MAWDbUnrenderedMsgTxns","MAWDexieTable","MAWIncomingReceiptUtils","MAWLoggerUtils","MWFBLogger","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e,s=o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.Countdown,o("MAWLoggerUtils").Tag.Incoming]);function u(t,n,a){var i=o("MAWIncomingReceiptUtils").getMaxTimestampsPerParticipant(n);s.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Updating timestamps for "," participants"])),i.size);var l=[];i.forEach(function(e,t){l.push({deliveredWatermarkTs:e.lastDeliveredMsgTs,lastReadActionTs:e.lastReadActionTs,lastReadWatermarkTs:e.lastReadMsgTs,participantKey:t})});var u=a.regular.length>0?o("MAWDbMsgTxns").bulkUpdateSystemAck(t,a.regular):o("MAWDexieTable").dexieResolve(),c=a.unrendered.length>0?o("MAWDbUnrenderedMsgTxns").bulkUpdateSystemAckForUnrenderedMsgs(t,a.unrendered):o("MAWDexieTable").dexieResolve(),d=o("MAWDexieTable").dexieAll([u,c]);return o("MAWDexieTable").dexieAll([d,l.length>0?o("MAWDbParticipantTxns").bulkUpdateParticipantTimestamps(t,l,s):o("MAWDexieTable").dexieResolve()]).then(r("emptyFunction"))}l.handleAckAndTimestampUpdatesForReceipts=u}),98);
__d("MAWDbPendingReceiptTxns",["WAJids","WAMsg"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=t.map(function(e){var t=e.author,n=e.externalId,r=e.thread;return o("WAMsg").craftWAMsgIdString({author:t,chat:r,externalId:n})});return e.pendingReceipts.where("id").anyOf(n).toArray().then(function(n){var r=new Map;n.forEach(function(e){r.set(e.id,e)});var a=t.map(function(e){var t=e.author,n=e.externalId,a=e.thread,i=o("WAMsg").craftWAMsgIdString({author:t,chat:a,externalId:n}),l=r.get(i),s=l!=null?l:{author:t,deliveryReceipts:[],externalId:n,id:i,readReceipts:[],thread:a};return t===o("WAJids").AUTHOR_ME?(e.deliveryReceipts.forEach(function(e){s.deliveryReceipts.push(e)}),e.readReceipts.forEach(function(e){s.readReceipts.push(e)})):(s.deliveryReceipts=[],e.readReceipts.forEach(function(e){s.readReceipts.push(e)})),s});return e.pendingReceipts.bulkPut(a).then(function(){return a})})}function s(e,t){return e.pendingReceipts.bulkGet(t)}l.bulkAddPendingReceipts=e,l.getPendingReceipts=s}),98);
__d("MAWIncomingReceiptDataFormatUtils",["MAWAckLevel","MAWDbMsg"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){var n=[],r=[];return e.forEach(function(e){var a=null,i=e.receipt.msgId,l=e.receipt.statusTsPerUser,s=t.get(i);if(s!=null){var u=s.msg,c=s.renderType;e.affectedUserJids.forEach(function(e){var t,n,r=null;((t=l.get(e))==null?void 0:t.readTs)!=null?r=o("MAWAckLevel").ACK.read:((n=l.get(e))==null?void 0:n.deliveredTs)!=null&&(r=o("MAWAckLevel").ACK.received),a=a==null||r!=null&&r>a?r:a}),a!=null&&a>u.ack&&(c==="regular"?n.push({ack:a,msgId:i,reportingMeta:null}):r.push({ack:a,msgId:i}))}}),{regular:n,unrendered:r}}function s(e,t,n){return e.map(function(e){var r=t.get(e.receipt.msgId);if(r==null)return null;var a=r.msg,i=n.get(a.msgId);return i==null||i.deliveryReceipts.length===0&&i.readReceipts.length===0?null:babelHelpers.extends({},e,{externalId:a.externalId,msgRenderType:r.renderType,msgTs:o("MAWDbMsg").getCanonicalTsFromMsg(a),threadJid:a.threadJid})}).filter(Boolean)}l.createUpdateSystemAckParams=e,l.formatWriteReceiptResultsWithExtras=s}),98);
__d("MAWReceiptTrace",["ArmadilloDataTraceType","MAWBridgeTrace","MAWBridgeTraceEvent","MAWIndexedDb"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){if(e==="delivered"){var n=t.reduce(function(e,t){return t.externalId!=null?[].concat(e,[t.externalId]):e},[]);n.length>0&&o("MAWIndexedDb").afterTransaction({tag:"UpdateTrace",value:o("MAWBridgeTrace").createBridgeUpdateTraceData(n,r("MAWBridgeTraceEvent").ReceivedReceipt,o("ArmadilloDataTraceType").armadilloMessageSend)})}}l.flushTrace=e}),98);
__d("MAWIncomingReceiptTxns",["MAWAckAndTimestampUpdatesForReceiptsTxns","MAWDbPendingReceiptTxns","MAWDbReceiptTxns","MAWDexieTable","MAWIncomingReceiptDataFormatUtils","MAWReceiptTrace"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){if(t==null)return o("MAWDexieTable").dexieResolve();var n=t.msgIdToDbMsgMap,r=t.pendingReceiptsToWrite,a=t.receiptsToWriteMap,i=Array.from(a.values());return o("MAWDexieTable").dexieAll([o("MAWDbReceiptTxns").bulkWriteReceiptsForDevices(i),o("MAWDbPendingReceiptTxns").bulkAddPendingReceipts(e,r)]).then(function(t){var r=t[0],i=o("MAWIncomingReceiptDataFormatUtils").createUpdateSystemAckParams(r,n),l=o("MAWIncomingReceiptDataFormatUtils").formatWriteReceiptResultsWithExtras(r,n,a),s=l.filter(function(e){var t,n=((t=a.get(e.receipt.msgId))==null?void 0:t.deliveryReceipts)||[];return n.length>0});return s.length>0&&o("MAWReceiptTrace").flushTrace("delivered",s),o("MAWAckAndTimestampUpdatesForReceiptsTxns").handleAckAndTimestampUpdatesForReceipts(e,l,i)})}l.bulkHandleIncomingReceipts=e}),98);
__d("MAWWriteAppDataReceiptsApi",["MAWDexieTable","MAWIndexedDb","MAWTransactionMode","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({appData:o("MAWTransactionMode").READWRITE},"writeAppDataReceipts",function(e){return(function(t){return s(e,t).then(function(t){return u(e,t)})})});function s(e,t){if(t.length===0)return o("MAWDexieTable").dexieResolve();var n=t.reduce(function(e,t){var n=e.appDataExternalIdSet,r=e.appDataReceiversSet,o=t.externalIds,a=t.receivers;return o.forEach(function(e){n.add(e)}),a.forEach(function(e){r.add(e)}),{appDataExternalIdSet:n,appDataReceiversSet:r}},{appDataExternalIdSet:new Set,appDataReceiversSet:new Set}),r=n.appDataExternalIdSet,a=n.appDataReceiversSet,i=Array.from(r),l=Array.from(a);return e.appData.where("externalId").anyOf(i).toArray().then(function(e){if(e.length!==0)return c(e,l)})}function u(e,t){if(t==null)return o("MAWDexieTable").dexieResolve();var n=t.toDelete,a=t.toUpdate;return o("MAWDexieTable").dexieAll([n.length>0?e.appData.bulkDelete(n):o("MAWDexieTable").dexieResolve(),a.length>0?e.appData.bulkPut(a):o("MAWDexieTable").dexieResolve()]).then(r("emptyFunction"))}function c(e,t){return e.reduce(function(e,n){if(n==null)return e;for(var r of t)n.permittedIdentitiesPerDevice.delete(r);return n.permittedIdentitiesPerDevice.size===0?(e.toDelete.push(n.appDataId),e):(e.toUpdate.push(n),e)},{toDelete:[],toUpdate:[]})}l.writeAppDataReceipts=e,l.prepareBulkAppDataReceipts=s,l.writeBulkAppDataReceipts=u}),98);
__d("MAWWritePeerMsgReceiptsApi",["MAWDbMsg","MAWDbMsgTxns","MAWDbPendingReceiptTxns","MAWDexieTable","MAWLoggerUtils","MAWMarkThreadAsReadTxns","MAWMsgType","MWFBLogger","WAGlobals","WAJids","WATimeUtils","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){return o("MAWDbMsgTxns").maybeGetMsgByProtocolMsgId(e,t).then(function(e){return e==null||e.type===o("MAWMsgType").MSG_TYPE.CIPHERTEXT?{msg:t,readReceipt:n,type:"missing"}:{dbMsg:e,msg:t,readReceipt:n,type:"found"}})}function u(e){var t=e.map(function(e){return e.type==="missing"?null:e.dbMsg}).filter(Boolean);return t.reduce(function(e,t){var n=t.threadJid,r=o("WATimeUtils").castToMillisTime(o("MAWDbMsg").getSortOrderWithFallback(t)),a=e.get(n);return(a==null||r>a.msgSortOrderMs)&&e.set(n,{msgId:t.msgId,msgSortOrderMs:r}),e},new Map)}function c(t,n){if(n.length===0)return o("MAWDexieTable").dexieResolve([]);var r=n.map(function(t){if(o("MWFBLogger").MWLogger().tags([o("MAWLoggerUtils").Tag.Ephemeral,o("MAWLoggerUtils").Tag.PeerReceipt]).DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Processing "," receipt for messages not from me"])),t.type),t.type!=="delivered"){var n={device:void 0,ts:void 0};if(t.receivers.forEach(function(e){var t=e.device,r=e.ts,a=o("WAJids").extractUserJid(t);a===o("WAGlobals").getMyUserJid()&&(n.ts==null||r<n.ts)&&(n.device=t,n.ts=r)}),n.device!=null&&n.ts!=null)return babelHelpers.extends({},t,{receivers:{device:n.device,ts:n.ts}})}}).filter(Boolean),a=[];return r.forEach(function(e){e.msgs.forEach(function(t){a.push([t,e.receivers])})}),o("MAWDexieTable").dexieAll(a.map(function(e){var n=e[0],r=e[1];return s(t,n,r)}))}function d(e,t){if(t.length===0)return o("MAWDexieTable").dexieResolve();var n=[],a=[];t.map(function(e){e.type==="missing"?n.push({author:e.msg.author,deliveryReceipts:[],externalId:e.msg.externalId,readReceipts:[e.readReceipt],thread:e.msg.chat}):a.push({msgId:e.msg,ts:e.readReceipt.ts})});var i=u(t),l=t.reduce(function(e,t){var n=t.msg.chat,r=i.get(n);return r!=null&&e.set(n,{msgId:r.msgId,sortOrderMs:r.msgSortOrderMs}),e},new Map);return o("MAWDexieTable").dexieAll([o("MAWDbPendingReceiptTxns").bulkAddPendingReceipts(e,n),o("MAWMarkThreadAsReadTxns").bulkMarkThreadAsReadUpToMsgSortOrderMs(e,l)]).then(r("emptyFunction"))}l.getResultByProtocolMsgId=s,l.prepareReceiptsForMeToWrite=c,l.bulkWritePeerReceiptsForMsgsNotFromMeInternal=d}),98);
__d("MAWBulkWriteReceiptsApi",["MAWDexieTable","MAWIncomingReceiptDataFormatTxns","MAWIncomingReceiptTxns","MAWIndexedDb","MAWTransactionMode","MAWWriteAppDataReceiptsApi","MAWWritePeerMsgReceiptsApi","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t){var n=[],r=[],a=[];return t.forEach(function(e){switch(e.type){case"msg-receipt":n.push(e.params);break;case"not-from-me":r.push(e.params);break;default:a.push(e.params);break}}),o("MAWDexieTable").dexieAll([a.length>0?o("MAWWriteAppDataReceiptsApi").prepareBulkAppDataReceipts(e,a):o("MAWDexieTable").dexieResolve(),n.length>0?o("MAWIncomingReceiptDataFormatTxns").prepareDataForReceiptsToWrite(e,n):o("MAWDexieTable").dexieResolve(),r.length>0?o("MAWWritePeerMsgReceiptsApi").prepareReceiptsForMeToWrite(e,r):o("MAWDexieTable").dexieResolve([])]).then(function(e){var t=e[0],n=e[1],r=e[2];if(t==null)return{incomingReceiptData:n,processedPeerReceiptsNotForMeResults:r};var o=t.toDelete,a=t.toUpdate;return{appDataReceipts:{toDelete:o,toUpdate:a},incomingReceiptData:n,processedPeerReceiptsNotForMeResults:r}})}var u=o("MAWIndexedDb").makeMsgrTransactor({appData:(e=o("MAWTransactionMode")).READWRITE,chunk:e.READONLY,media:e.READONLY,messages:e.READWRITE,participants:e.READWRITE,pendingReceipts:e.READWRITE,receiverFetchInfo:e.READONLY,threads:e.READWRITE,unrenderedMessages:e.READWRITE,xma:e.READONLY},"bulkWriteReceipts",function(e){return(function(t){return t.length===0?o("MAWDexieTable").dexieResolve():s(e,t).then(function(t){var n=t.appDataReceipts,a=t.incomingReceiptData,i=t.processedPeerReceiptsNotForMeResults;return o("MAWDexieTable").dexieAll([n!=null&&(n==null?void 0:n.toDelete.length)>0&&(n==null?void 0:n.toUpdate.length)>0?o("MAWWriteAppDataReceiptsApi").writeBulkAppDataReceipts(e,n):o("MAWDexieTable").dexieResolve(),a!=null?o("MAWIncomingReceiptTxns").bulkHandleIncomingReceipts(e,a):o("MAWDexieTable").dexieResolve(),i.length>0?o("MAWWritePeerMsgReceiptsApi").bulkWritePeerReceiptsForMsgsNotFromMeInternal(e,i):o("MAWDexieTable").dexieResolve()]).then(r("emptyFunction"))})})});l.bulkWriteReceipts=u}),98);
__d("MAWSharedProtocolQueueReceipt",["asyncToGeneratorRuntime"],(function(t,n,r,o,a,i){"use strict";function e(e){if(e.receiptType==="appdata")return{params:{externalIds:e.externalIds,receivers:[e.from]},type:"appdata"};var t,n,r=e.chat;switch(e.receiptType){case"user":n=e.externalIds,t=[{device:e.from.author,ts:e.ts}];break;case"group":n=e.externalIds,t=[{device:e.from.author,ts:e.ts}];break;default:e.receiptType,n=[e.externalId],t=e.receivers;break}var o=e.messageAuthor,a=e.type;return o==="@me"||a==="sender"?{params:{msgs:n.map(function(e){return{author:"@me",chat:r,externalId:e}}),receivers:t,type:a},type:"msg-receipt"}:{params:{msgs:n.map(function(e){return{author:o,chat:r,externalId:e}}),receivers:t,type:a},type:"not-from-me"}}function l(e,t){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var r=t.map(function(t){var n=e(t.receipt);return n});return yield n(r),{followUpParams:void 0,toAck:t.map(function(e){return e.stanzaQueueId})}}),s.apply(this,arguments)}i.sharedHandleIncomingReceiptStanza=l}),66);
__d("WADbHandlePermitedIdentitiesApi",["MAWTransactionMode","WADbTransactor"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WADbTransactor").makeSignalTransactor({receipts:o("MAWTransactionMode").READWRITE},"handlePermitedIdentitiesPerDevice",function(e){return(function(t){var n=Array.from(t.keys());return e.receipts.where("waMsgId").anyOf(n).toArray().then(function(e){return e.map(function(e){var n,r=(n=t.get(e.waMsgId))!=null?n:new Set;for(var o of r){var a;(a=e.permittedIdentitiesPerDevice)==null||a.delete(o)}return e})}).then(function(t){return e.receipts.bulkPut(t).then(function(){})})})});l.handlePermitedIdentitiesPerDevice=e}),98);
__d("WAPreKeysStanzaUtils",["WAWap"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t;return(t=o("WAWap")).wap("key",null,t.wap("id",null,t.BIG_ENDIAN_CONTENT(e.id,3)),t.wap("value",null,e.keyPair.publicKey))}function s(e){var t;return(t=o("WAWap")).wap("skey",null,t.wap("id",null,t.BIG_ENDIAN_CONTENT(e.id,3)),t.wap("value",null,e.keyPair.publicKey),t.wap("signature",null,e.signature))}function u(e){var t=e.child("skey"),n=null;if(e.hasChild("key")){var r=e.child("key");n={id:r.child("id").contentUint(3),publicKey:r.child("value").contentSerializedPubKey()}}return{identity:e.child("identity").contentSerializedPubKey(),signedKey:{id:t.child("id").contentUint(3),publicKey:t.child("value").contentSerializedPubKey(),signature:t.child("signature").contentBytes(64)},oneTimeKey:n}}l.xmppPreKey=e,l.xmppSignedPreKey=s,l.readSessionInfo=u}),98);
__d("WASmaxInPreKeysIQErrorItemNotFoundMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"error");if(!t.success)return t;var n=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrString,e,"text","item-not-found");if(!n.success)return n;var r=o("WASmaxParseUtils").literal(o("WASmaxParseUtils").attrInt,e,"code",404);return r.success?o("WAResultOrError").makeResult({text:n.value,code:r.value}):r}l.parseIQErrorItemNotFoundMixin=e}),98);
__d("WASmaxInPreKeysRequestErrorsFetchDigest",["WAResultOrError","WASmaxInPreKeysIQErrorFallbackClientMixin","WASmaxInPreKeysIQErrorItemNotFoundMixin","WASmaxInPreKeysIQErrorNotAcceptableMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInPreKeysIQErrorNotAcceptableMixin").parseIQErrorNotAcceptableMixin(e);if(t.success)return o("WAResultOrError").makeResult({name:"IQErrorNotAcceptable",value:t.value});var n=o("WASmaxInPreKeysIQErrorItemNotFoundMixin").parseIQErrorItemNotFoundMixin(e);if(n.success)return o("WAResultOrError").makeResult({name:"IQErrorItemNotFound",value:n.value});var r=o("WASmaxInPreKeysIQErrorFallbackClientMixin").parseIQErrorFallbackClientMixin(e);return r.success?o("WAResultOrError").makeResult({name:"IQErrorFallbackClient",value:r.value}):o("WASmaxParseUtils").errorMixinDisjunction(e,["IQErrorNotAcceptable","IQErrorItemNotFound","IQErrorFallbackClient"],[t,n,r])}l.parseRequestErrorsFetchDigest=e}),98);
__d("WASmaxInPreKeysFetchDigestResponseRequestError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysRequestErrorsFetchDigest","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysRequestErrorsFetchDigest").parseRequestErrorsFetchDigest(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRequestErrorsFetchDigest:i.value})):i}l.parseFetchDigestResponseRequestError=e}),98);
__d("WASmaxInPreKeysFetchDigestResponseServerError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysServerErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysServerErrors").parseServerErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorServerErrors:i.value})):i}l.parseFetchDigestResponseServerError=e}),98);
__d("WASmaxInPreKeysKeysHashMixin",["WAResultOrError","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").flattenedChildWithTag(e,"hash");if(!t.success)return t;var n=o("WASmaxParseUtils").contentBytesRange(t.value,20,20);return n.success?o("WAResultOrError").makeResult({hashElementValue:n.value}):n}l.parseKeysHashMixin=e}),98);
__d("WASmaxInPreKeysPreKeyIDListMixin",["WAResultOrError","WASmaxInPreKeysKeyIDMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxParseUtils").assertTag(e,"id");if(!t.success)return t;var n=o("WASmaxInPreKeysKeyIDMixin").parseKeyIDMixin(e);return n.success,n}function s(t){var n=o("WASmaxParseUtils").flattenedChildWithTag(t,"list");if(!n.success)return n;var r=o("WASmaxParseUtils").mapChildrenWithTag(n.value,"id",0,2e4,e);return r.success?o("WAResultOrError").makeResult({listId:r.value}):r}l.parsePreKeyIDListListId=e,l.parsePreKeyIDListMixin=s}),98);
__d("WASmaxInPreKeysIdentityDigestBundleMixin",["WAResultOrError","WASmaxInPreKeysIdentityKeyMixin","WASmaxInPreKeysKeyTypeMixin","WASmaxInPreKeysKeysHashMixin","WASmaxInPreKeysPreKeyIDListMixin","WASmaxInPreKeysRegistrationIDMixin","WASmaxInPreKeysSignedPreKeyMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=o("WASmaxInPreKeysRegistrationIDMixin").parseRegistrationIDMixin(e);if(!t.success)return t;var n=o("WASmaxInPreKeysIdentityKeyMixin").parseIdentityKeyMixin(e);if(!n.success)return n;var r=o("WASmaxInPreKeysPreKeyIDListMixin").parsePreKeyIDListMixin(e);if(!r.success)return r;var a=o("WASmaxInPreKeysSignedPreKeyMixin").parseSignedPreKeyMixin(e);if(!a.success)return a;var i=o("WASmaxInPreKeysKeyTypeMixin").parseKeyTypeMixin(e),l=o("WASmaxInPreKeysKeysHashMixin").parseKeysHashMixin(e);return l.success?o("WAResultOrError").makeResult(babelHelpers.extends({},t.value,n.value,r.value,a.value,{keyTypeMixin:i.success?i.value:null},l.value)):l}l.parseIdentityDigestBundleMixin=e}),98);
__d("WASmaxInPreKeysFetchDigestResponseSuccess",["WAResultOrError","WASmaxInPreKeysIQResultResponseMixin","WASmaxInPreKeysIdentityDigestBundleMixin","WASmaxParseReference","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"digest");if(!r.success)return r;var a=o("WASmaxParseReference").optionalAttrStringFromReference(t,["digest","identity_type"]);if(!a.success)return a;var i=o("WASmaxParseUtils").optionalLiteral(o("WASmaxParseUtils").attrString,r.value,"identity_type",a.value);if(!i.success)return i;var l=o("WASmaxInPreKeysIdentityDigestBundleMixin").parseIdentityDigestBundleMixin(r.value);if(!l.success)return l;var s=o("WASmaxInPreKeysIQResultResponseMixin").parseIQResultResponseMixin(e,t);return s.success?o("WAResultOrError").makeResult(babelHelpers.extends({hasDigestIdentityType:i.value!=null,digestIdentityDigestBundleMixin:l.value},s.value)):s}l.parseFetchDigestResponseSuccess=e}),98);
__d("WASmaxOutPreKeysFetchDigestRequest",["WASmaxJsx","WASmaxOutPreKeysClientRequestMixin"],(function(t,n,r,o,a,i,l){function e(){var e=o("WASmaxOutPreKeysClientRequestMixin").mergeClientRequestMixin(o("WASmaxJsx").smax("iq",{type:"get"},o("WASmaxJsx").smax("digest",null)));return e}l.makeFetchDigestRequest=e}),98);
__d("WASmaxPreKeysFetchDigestRPC",["WAComms","WASmaxInPreKeysFetchDigestResponseRequestError","WASmaxInPreKeysFetchDigestResponseServerError","WASmaxInPreKeysFetchDigestResponseSuccess","WASmaxOutPreKeysFetchDigestRequest","WASmaxParsingFailure","WASmaxRpcUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){function e(e){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=o("WASmaxOutPreKeysFetchDigestRequest").makeFetchDigestRequest(),n=yield o("WAComms").sendSmaxStanza(t,e),r=o("WASmaxInPreKeysFetchDigestResponseSuccess").parseFetchDigestResponseSuccess(n,t);if(r.success)return{name:"FetchDigestResponseSuccess",value:r.value};var a=o("WASmaxInPreKeysFetchDigestResponseRequestError").parseFetchDigestResponseRequestError(n,t);if(a.success)return{name:"FetchDigestResponseRequestError",value:a.value};var i=o("WASmaxInPreKeysFetchDigestResponseServerError").parseFetchDigestResponseServerError(n,t);if(i.success)return{name:"FetchDigestResponseServerError",value:i.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("FetchDigest",{Success:r,RequestError:a,ServerError:i}))}),s.apply(this,arguments)}l.sendFetchDigestRPC=e}),98);
__d("WARequestPreKeyDigestProtocol",["WABinary","WAConvertRegistrationIdMixin","WAConvertSignedPreKeyMixin","WACryptoDependencies","WACryptoUtils","WAParsableXmlNode","WAResultOrError","WASignalKeys","WASmaxPreKeysFetchDigestRPC","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=o("WATagsLogger").TAGS(["requestPreKeyDigestProtocol"]);function c(t){return o("WASmaxPreKeysFetchDigestRPC").sendFetchDigestRPC({withoutRetry:!1}).then(function(n){switch(n.name){case"FetchDigestResponseServerError":{var r=n.value.errorServerErrors.name;return u.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["",": ",""])),n.name,r),o("WAResultOrError").makeError({type:"server-error",payload:r})}case"FetchDigestResponseRequestError":{var a=n.value.errorRequestErrorsFetchDigest.name;return u.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",": ",""])),n.name,a),o("WAResultOrError").makeError({type:"request-error",payload:a})}default:{n.name;var i=d(n.value.digestIdentityDigestBundleMixin);return m(i,t).then(function(e){return e==="ok"?o("WAResultOrError").makeResult():o("WAResultOrError").makeError({type:"compare-error",payload:e})})}}})}function d(e){var t=o("WAConvertRegistrationIdMixin").registrationIdMixin(e),n=o("WAConvertSignedPreKeyMixin").convertSignedPreKeyMixin(e),r=e.listId.map(function(e){return o("WASignalKeys").castToPreKeyId(o("WAParsableXmlNode").convertBytesToUint(e.elementValue,3))}),a=e.hashElementValue;return{regId:t,skeyId:n.id,preKeyIds:r,hash:a}}function m(e,t){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){if(e.regId!==t.regInfo.regId)return"RegIdMismatch";if(e.skeyId!==t.signedPreKey.id)return"SignedPreKeyIdMismatch";var n=new Map;t.preKeys.forEach(function(e){return n.set(e.id,e)});var r=e.preKeyIds.some(function(e){return!n.has(e)});if(r)return"UnknownPreKey";var a=e.preKeyIds.map(function(e){return n.get(e)}).filter(Boolean),i=yield _(t,a);return o("WACryptoUtils").uint8ArraysEqual(i,e.hash)?"ok":"HashMismatch"}),p.apply(this,arguments)}function _(e,t){var n=new(o("WABinary")).Binary;return n.writeByteArray(e.regInfo.staticKeyPair.publicKey),n.writeByteArray(e.signedPreKey.keyPair.publicKey),n.writeByteArray(e.signedPreKey.signature),t.forEach(function(e){n.writeByteArray(e.keyPair.publicKey)}),o("WACryptoDependencies").getCrypto().subtle.digest("SHA-1",n.readByteArrayView()).then(function(e){return new Uint8Array(e)})}l.requestPreKeyDigestProtocol=c}),98);
__d("WARequestPreKeyDigest",["WABridge","WAGenerateAndUploadPreKeys","WAGetKeysForUpload","WAGlobals","WALogger","WAOdsEnums","WARequestPreKeyDigestProtocol","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=yield t(function(e){var t=e.cryptoManager;return o("WAGetKeysForUpload").getKeysForUpload(t)}),a=yield o("WARequestPreKeyDigestProtocol").requestPreKeyDigestProtocol(n.value);if(a.success===!1){if(o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.PREKEY_DIGEST,key:"fail"}),a.error.type==="compare-error"){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["PreKey digest comparison failed: ",""])),a.error.payload),o("WAGenerateAndUploadPreKeys").generateAndUploadPreKeys(null,{reason:"prekey digest comparison failed"}).catch(function(e){o("WALogger").ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error while generating and uploading prekeys: ",""])),e)});return}throw r("err")("Error while requesting key digest: "+a.error.type+" "+a.error.payload)}a.success,o("WABridge").getBridge().fireAndForget("event","odsBumpEntityKey",{entity:o("WAOdsEnums").Entity.PREKEY_DIGEST,key:"success"})}),c.apply(this,arguments)}function d(e){return u(function(e){return o("WAGlobals").getWaOneQueue().enqueue(e,{operationType:"request_prekey_digest",flush:!1})})}l.requestPreKeyDigestFn=u,l.requestPreKeyDigest=d}),98);
__d("WAReceiptUtils",["WACryptoManagerUtils","WADeprecatedSendIq","WAMapWithDefault","WAMsg","WAPreKeysStanzaUtils","WARequestPreKeyDigest","WAWap","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(e,t){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=e.retryCount,r=n+1;r>=3&&(yield o("WARequestPreKeyDigest").requestPreKeyDigestFn(function(e){return e(t)}));var a=null;r>=2&&(a=yield o("WACryptoManagerUtils").getSignalInfoForRetry(t.cryptoManager));var i=t.cryptoManager.regInfo.regId;return d(e,r,i,a)}),s.apply(this,arguments)}function u(e,t){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var r=t.externalId,a=t.from,i=t.participant,l;a.type==="group"?l=a.groupJid:(a.type,l=a.deviceJid),yield o("WADeprecatedSendIq").deprecatedSendStanzaAndWaitForAck(yield e(t,n),{id:r,class:"receipt",from:l,participant:i})}),c.apply(this,arguments)}function d(e,t,n,r){var a=null;if(r!=null){var i=r.keyType,l=r.signedPreKey,s=r.preKey,u=r.publicKey,c=e.deviceIdentity!=null?o("WAWap").wap("device-identity",null,e.deviceIdentity):null;a=o("WAWap").wap("keys",null,o("WAWap").wap("type",null,o("WAWap").BIG_ENDIAN_CONTENT(i,1)),o("WAWap").wap("identity",null,u),o("WAPreKeysStanzaUtils").xmppPreKey(s),o("WAPreKeysStanzaUtils").xmppSignedPreKey(l),c)}var d;return e.from.type==="group"?d=e.from.groupJid:(e.from.type,d=e.from.deviceJid),o("WAWap").wap("receipt",{category:e.category!=null?o("WAWap").CUSTOM_STRING(e.category):o("WAWap").DROP_ATTR,id:o("WAWap").CUSTOM_STRING(e.externalId),participant:e.participant?o("WAWap").DEVICE_JID(e.participant):o("WAWap").DROP_ATTR,recipient:e.recipient?o("WAWap").USER_JID(e.recipient):o("WAWap").DROP_ATTR,to:o("WAWap").JID(d),type:"retry"},o("WAWap").wap("retry",{count:o("WAWap").INT(t),id:o("WAWap").CUSTOM_STRING(e.externalId),t:o("WAWap").INT(e.ts),v:"1"}),o("WAWap").wap("registration",null,o("WAWap").BIG_ENDIAN_CONTENT(n)),a)}function m(e){var t=new(o("WAMapWithDefault")).MapWithDefault(function(e){return new Set});for(var n of e){var r=n.receipt;if(r.receiptType==="group"||r.receiptType==="user")for(var a of r.externalIds)t.get(o("WAMsg").craftWAMsgIdString({author:r.messageAuthor,chat:r.chat,externalId:a})).add(r.from.author);else if(r.receiptType==="group-server-agg")for(var i of r.receivers)t.get(o("WAMsg").craftWAMsgIdString({author:r.messageAuthor,chat:r.chat,externalId:r.externalId})).add(i.device)}return t.toMap()}l.makeRetryReceipt=e,l.sendRetryReceipt=u,l.calculateIdentitiesToDelete=m}),98);
__d("MAWProtocolQueueReceipt",["MAWBulkWriteReceiptsApi","MAWSharedProtocolQueueReceipt","WADbHandlePermitedIdentitiesApi","WAReceiptUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return o("WADbHandlePermitedIdentitiesApi").handlePermitedIdentitiesPerDevice(o("WAReceiptUtils").calculateIdentitiesToDelete(e)).then(function(){return o("MAWSharedProtocolQueueReceipt").sharedHandleIncomingReceiptStanza(e,o("MAWBulkWriteReceiptsApi").bulkWriteReceipts)})}l.handleIncomingReceiptStanza=e}),98);
__d("MAWCOPReceiptsHandler",["MAWIsQuotaExceededError","MAWProtocolQueueReceipt","MAWSharedCOPLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(t){return c(t).catch(function(t){if(o("MAWIsQuotaExceededError").isQuotaExceededError(t))throw t;return r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Receipt consumer error"]))),[]})}function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return[];var t=yield o("MAWProtocolQueueReceipt").handleIncomingReceiptStanza(e);return t.toAck.length!==e.length&&r("MAWSharedCOPLogger").WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Errors occurred while processing receipts batch, see transactor error reports."]))),t.toAck}),d.apply(this,arguments)}l.copIncomingReceiptsHandler=u}),98);
__d("MAWBulkGetAppDataForRetryApi",["MAWIndexedDb","MAWTransactionMode","WATimeUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=30*o("WATimeUtils").DAY_SECONDS,s=o("MAWIndexedDb").makeMsgrTransactor({appData:o("MAWTransactionMode").READONLY},"bulkGetAppDataForRetry",function(t){return(function(n){var r=n.map(function(e){var t=e.externalId;return t});return t.appData.where("externalId").anyOf(r).toArray().then(function(t){var r=new Map(t.map(function(e){return[e.externalId,e]}));return n.map(function(t){var n=t.deviceJid,a=t.externalId,i=r.get(a);if(i==null)return{type:"missing"};var l=i.permittedIdentitiesPerDevice.get(n);return l==null||!o("WATimeUtils").happenedWithin(i.ts,e)?{type:"unauthorized"}:{appData:i.contents,deviceIdentity:l,permittedIdentitiesPerDevice:i.permittedIdentitiesPerDevice,type:"unacked"}})})})});l.bulkGetAppDataForRetry=s}),98);
__d("MAWConstants",[],(function(t,n,r,o,a,i){"use strict";var e=5,l="Facebook user",s="Instagram user",u=3;i.MESSAGE_RETRY_COUNT_LIMIT=e,i.FB_UNKNOWN_USER=l,i.INS_UNKNOWN_USER=s,i.CURRENT_REGISTRATION_VERSION=u}),66);
__d("MAWWriteAppDataRetryApi",["MAWIndexedDb","MAWTransactionMode","emptyFunction"],(function(t,n,r,o,a,i,l){"use strict";var e=o("MAWIndexedDb").makeMsgrTransactor({appData:o("MAWTransactionMode").READWRITE},"writeAppDataRetry",function(e){return(function(t,n,o){return e.appData.get({externalId:t}).then(function(t){if(t!=null){var a=t.permittedIdentitiesPerDevice,i=a.get(n);if(i!=null)return i.baseKey=o,a.set(n,i),e.appData.update(t.appDataId,{permittedIdentitiesPerDevice:a}).then(r("emptyFunction"))}})})});l.writeAppDataRetry=e}),98);
__d("WAMarkParticipantNeedsKeyApi",["WASignalDB","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e=function(t,r){return o("WASignalDB").getDb().runInTransaction(["personalSenderKeyStatuses"],"readwrite",(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=yield e.stores.personalSenderKeyStatuses.get(t);n==null||n.rotateSenderKey||(n.hasSenderKey.delete(r),yield e.stores.personalSenderKeyStatuses.bulkPut([n]))});return function(t){return e.apply(this,arguments)}})(),o("WASignalDB").signalOp("markParticipantNeedsKey"))};l.markParticipantNeedsKey=e}),98);
__d("WASendAppDataIndividualProtocol",["WAAsMessageApplication","WAConvertAppData","WAEncUserMsg","WAErrorMessage","WAGetCurrentUserDeviceInfoApi","WAGlobals","WAMsgApplication.pb","WAResultOrError","WASmaxAppdataPublishPeerRPC","WATagsLogger","WATimeUtils","asyncToGeneratorRuntime","encodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p=o("WATagsLogger").TAGS(["sendAppDataIndividual"]);function _(t,n,r,a,i){return g(t,n,r,void 0,a,i).catch(function(t){var n=o("WAErrorMessage").maybeGetMessageFromError(t);return p.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata to device with error: ",""])),n),o("WAResultOrError").makeError("runtime-error")})}function f(e,t,n,r,a,i){return g(e,t,n,r,a,i).catch(function(e){var t=o("WAErrorMessage").maybeGetMessageFromError(e);return p.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata retry to device with error: ",""])),t),o("WAResultOrError").makeError("runtime-error")})}function g(e,t,n,r,o,a){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a,i){p.LOG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Sending appdata, externalId: ",""])),t);var l=o("WAConvertAppData").convertAppData(e),s={bytes:o("WAAsMessageApplication").castToMessageApplicationBytes(o("encodeProtobuf").encodeProtobuf(o("WAMsgApplication.pb").MessageApplicationSpec,l).readByteArrayView()),version:"v3"},_=yield o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return o("WAEncUserMsg").encryptDeviceJidMessage(n,{messageBytes:s,type:"appdata"},{cryptoManager:t},void 0,i,a)},{operationType:"encrypt",flush:!0});if(_==null)return p.LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["MAWSendAppData Failed to encrypt appdata"]))),o("WAResultOrError").makeError("encrypt-failure");var f;r!=null&&(f={appdataT:o("WATimeUtils").unixTime(),encRetryMixinArgs:{encCount:r}});var g={appdataTo:n,encVersionFutureproofMixinArgs:{encV:parseInt(_.v,10)},encTypeIndividualMixinArgs:{encType:_.type,encElementValue:_.ciphertext},retryMixinArgs:f},h={peerPeerSingle:g},y=void 0;if(_.type==="pkmsg"){var C=yield o("WAGetCurrentUserDeviceInfoApi").getCurrentUserDeviceInfo(),b=C==null?void 0:C.identityKey;if(b==null)return p.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Failed to fetch current device public identity key"]))),o("WAResultOrError").makeError("no-public-identity");y={deviceIdentityElementValue:b}}var v={appdataId:t,peerMsgTypesArgs:h,deviceIdentityMixinArgs:y},S=yield o("WASmaxAppdataPublishPeerRPC").sendPeerRPC(v);switch(S.name){case"PeerResponseSuccess":return o("WAResultOrError").makeResult({baseKey:_.baseKey});default:return S.name,p.ERROR(m||(m=babelHelpers.taggedTemplateLiteralLoose(["Failed to send appdata. Error: ",""])),S.value.error),o("WAResultOrError").makeError("ack-failure")}}),h.apply(this,arguments)}l.sendAppDataToIndividualDeviceProtocol=_,l.sendAppDataRetryToIndividualDeviceProtocol=f}),98);
__d("WAWriteMsgRetryApi",["MAWTransactionMode","WADbTransactor","WAMsg"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WADbTransactor").makeSignalTransactor({receipts:o("MAWTransactionMode").READWRITE},"writeMsgRetry",function(e){return(function(t,n,r){return s(e,o("WAMsg").craftWAMsgIdString({author:t.author,chat:t.chat,externalId:t.externalId}),n,r)})});function s(e,t,n,r){return e.receipts.get({waMsgId:t}).then(function(t){if(!(t==null||t.permittedIdentitiesPerDevice==null)){var o=t.permittedIdentitiesPerDevice,a=o.get(n);if(a!=null)return a.baseKey=r,o.set(n,a),e.receipts.put(babelHelpers.extends({},t,{permittedIdentitiesPerDevice:o})).then(function(){})}})}l.writeMsgRetry=e}),98);
__d("WAWriteMsgRetryCountApi",["MAWTransactionMode","WADbTransactor","WAMsg"],(function(t,n,r,o,a,i,l){"use strict";var e=o("WADbTransactor").makeSignalTransactor({receipts:o("MAWTransactionMode").READWRITE},"writeMsgRetryCount",function(e){return(function(t,n,r){return s(e,o("WAMsg").craftWAMsgIdString({author:t.author,chat:t.chat,externalId:t.externalId}),n,r)})});function s(e,t,n,r){return e.receipts.get({waMsgId:t}).then(function(t){var o;if(!(t==null||r==null)){var a=(o=t.retryCountsPerDevice)!=null?o:new Map;return a.set(n,r),e.receipts.put(babelHelpers.extends({},t,{retryCountsPerDevice:a})).then(function(){})}})}l.writeMsgRetryCount=e}),98);
__d("MAWSharedHandleRetryRequest",["MAWBulkGetAppDataForRetryApi","MAWConstants","MAWDebugMsg","MAWWriteAppDataRetryApi","Promise","WACryptoManagerUtils","WACryptoUtils","WAGenReportingMeta","WAGlobals","WAJids","WALoadReceiptApi","WALogger","WAMarkParticipantNeedsKeyApi","WAQPLProxy","WASendAppDataIndividualProtocol","WASendMsgInternal","WASentBytesCache","WAWap","WAWriteMsgRetryApi","WAWriteMsgRetryCountApi","asyncToGeneratorRuntime","gkx","qpl"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g;function h(){var e=0,t=0,n=new Map;return{getMetrics:function(){var r,o,a,i,l,s;return{appDataMissing:(r=n.get("appDatamissing"))!=null?r:0,appDataUnauthorized:(o=n.get("appDataunauthorized"))!=null?o:0,appDataUnsupported:(a=n.get("appDataunsupported"))!=null?a:0,msgMissing:(i=n.get("msgmissing"))!=null?i:0,msgUnauthorized:(l=n.get("msgunauthorized"))!=null?l:0,msgUnsupported:(s=n.get("msgunsupported"))!=null?s:0,receiptFailures:t,receiptSuccesses:e}},markError:function(){return t++},markSuccess:function(){return e++},setError:function(t){var e=n.get(t);e!=null?n.set(t,e+1):n.set(t,1)}}}function y(e,t){return t+"_"+e}function C(e){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return[];o("WALogger").LOG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["bulkHandleRetryRequest called for ",""])),e.map(function(e){var t=e.externalId;return t}).join(","));var t=o("WAQPLProxy").waQPLProxyStart(r("qpl")._(25308942,"164"),{bool:{bulk:!0},int:{receipts:e.length},string:{origin:self.location.origin}}),a=new Set(e.filter(function(e){return e.category!=null&&!D(e)||x(e)}).map(function(e){return e.externalId})),i=e.filter(function(e){return!a.has(e.externalId)&&!D(e)}),l=e.filter(D),s=yield(g||(g=n("Promise"))).all([v(l),L(i)]),u=s[0],m=s[1];t.addPoint("get_msg_for_retry_complete");var p=[],_=h();for(var f of e){var C=u.get(f.externalId),b=m.get(y(f.from.author,f.externalId));a.has(f.externalId)?(t.addPoint("just_ack"),_.markError(),_.setError("just_ack"),$(f)):C!=null?(t.addPoint("app_data_for_retry"),yield P(f,C,t,!1,_),t.addPoint("app_data_for_retry_complete")):b!=null?(t.addPoint("msg_for_retry"),yield M(f,b,t,!1,_),t.addPoint("msg_for_retry_complete")):(o("WALogger").ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["bulkHandleRetryRequest unexpected receipt"]))),_.markError(),_.setError("unexpected_receipt")),p.push(T(f))}return t.endSuccess({int:babelHelpers.extends({},_.getMetrics())}),p}),b.apply(this,arguments)}function v(e){return S.apply(this,arguments)}function S(){return S=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return new Map;var t=e.map(function(e){var t=e.externalId,n=e.from;return{deviceJid:n.author,externalId:t}}),n=yield o("MAWBulkGetAppDataForRetryApi").bulkGetAppDataForRetry(t);return new Map(n.map(function(t,n){var r=e[n];return[r.externalId,t]}))}),S.apply(this,arguments)}function R(t){return t.map(function(t){var n=t.externalId,r=t.from,a=t.recipient,i=r.chat;if(r.type==="device"&&o("WAJids").extractUserJid(r.author)===o("WAJids").extractUserJid(o("WAGlobals").getMyDeviceJid())){if(a==null){o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Received retry request from peer without recipient set"])));return}i=a}var l={author:"@me",chat:i,externalId:n};return{deviceJid:r.author,protocolMsgId:l,retryCount:t.retryCount}})}function L(e){return E.apply(this,arguments)}function E(){return E=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return new Map;var t=R(e),n=e.filter(function(e,n){return t[n]!=null}),r=t.filter(Boolean),a=yield o("WASentBytesCache").sentBytesCache().getMsgsForRetry(r),i=new Map(a.map(function(e,t){return[y(r[t].deviceJid,n[t].externalId),{msgForRetry:e,retryRequest:r[t]}]}));return i}),E.apply(this,arguments)}function k(e,t){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=void 0,r=yield o("WAGlobals").getWaOneQueue().enqueue(function(t){var n=t.cryptoManager;return o("WACryptoManagerUtils").getParticipantInfo(e.from.author,n)},{flush:!1,operationType:"get_participant_info"});if(e.keys!=null){var a=e.keys,i=e.timestamp,l={baseKey:t.baseKey,keys:a,timestamp:i},s=A(e,r);s?n={session:l,type:"compareTSAndUseSession"}:n={session:l,type:"useSession"}}else{var u=r==null||e.regId!==r.regId;u&&(n={type:"requestNewSession"})}return n}),I.apply(this,arguments)}function T(e){var t,n=e.externalId,r=e.from;return(t=o("WAWap")).wap("ack",{class:"receipt",id:t.CUSTOM_STRING(n),participant:t.PARTICIPANT_JID(r),to:t.TO_JID(r),type:"retry"})}function D(e){var t=e.category;return t==="peer_appdata"||t==="peer"}function x(e){var t=e.retryCount;return t>=o("MAWConstants").MESSAGE_RETRY_COUNT_LIMIT}function $(e){if(x(e)){o("WALogger").LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied due to retry count"])));return}if(e.category!=null){o("WALogger").WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Unknown receipt categories: ",""])),e.category);return}}function P(e,t,n,r,o){return N.apply(this,arguments)}function N(){return N=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r,a){r===void 0&&(r=!0);var i=e.externalId,l=e.from,s=e.retryCount;if(n.addPoint("get_app_data_for_retry"),t.type!=="unacked"){o("WALogger").LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied with type "," id: ",""])),t.type,i),r?n.endFail(t.type):n.addPoint(t.type),a==null||a.markError(),a==null||a.setError("appData"+t.type);return}var u=t.appData,c=t.deviceIdentity,d=yield k(e,c);n.addPoint("get_session_info");var p=yield o("WASendAppDataIndividualProtocol").sendAppDataRetryToIndividualDeviceProtocol(u,i,l.author,s,c.pubKey,d);if(n.addPoint("send_app_data"),s>=2&&p.success===!0&&p.value.baseKey!=null){var _=p.value.baseKey;yield o("MAWWriteAppDataRetryApi").writeAppDataRetry(i,l.author,_)}return a==null||a.markSuccess(),p}),N.apply(this,arguments)}function M(e,t,n,r,o){return w.apply(this,arguments)}function w(){return w=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,a,i){var l;a===void 0&&(a=!0);var s=t.msgForRetry,u=t.retryRequest,c=e.externalId,d=e.from,m=e.retryCount,g=u.protocolMsgId.chat;if(s.type!=="unacked"){a&&n.endFail(s.type),o("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied with type ",""])),s.type),i==null||i.markError(),i==null||i.setError("msg"+s.type);return}if(s.retryCount!=null&&s.retryCount>0&&s.retryCount===m){a&&n.endFail("unauthorized"),o("WALogger").LOG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied because (messageId, deviceJID, retryCount) is already executed for retryCount ",""])),m),i==null||i.markError(),i==null||i.setError("msgunauthorized");return}d.type==="group"&&(yield o("WAMarkParticipantNeedsKeyApi").markParticipantNeedsKey(d.chat,d.author),n.addPoint("mark_participant_needs_key_complete"));var h=s.backupDirective,y=s.frankingKey,C=s.frankingVersion,b=s.isInstamadillo,v=s.messageBytes,S=s.messageType,R=s.protocolMsgId,L=yield o("WALoadReceiptApi").loadReceipt({author:R.author,chat:R.chat,externalId:R.externalId}).then(function(e){return e.success?e.value:null}),E=L==null||(l=L.permittedIdentitiesPerDevice)==null?void 0:l.get(u.deviceJid);if(L==null||E==null){a&&n.endFail("unauthorized"),o("WALogger").LOG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["handleRetryRequest denied because receipt is null"]))),i==null||i.markError(),i==null||i.setError("msgunauthorized");return}var I=yield k(e,E);n.addPoint("get_session_info_complete"),r("gkx")("24021")&&o("MAWDebugMsg").writeDebugMsg(g,"Handling retry request for message: "+s.protocolMsgId.externalId.toString()+" to user "+d.author);var T=yield o("WAGenReportingMeta").genReportingMeta(v.bytes,y,C),D=yield o("WASendMsgInternal").sendMessage({backupDirective:h,chat:g,count:m,deviceIdentity:null,externalId:c,identityKey:E.pubKey,messageBytes:v,messageType:S,protocolMsgId:R,reportingMeta:T,sessionInfo:I,to:d.author,type:"direct"},n,b);if(n.addPoint("send_message_complete"),m>=2&&D.success&&D.value.baseKey!=null){var x=D.value.baseKey;yield o("WAWriteMsgRetryApi").writeMsgRetry(u.protocolMsgId,d.author,x)}m>=1&&D.success&&(yield o("WAWriteMsgRetryCountApi").writeMsgRetryCount(u.protocolMsgId,d.author,m)),i==null||i.markSuccess()}),w.apply(this,arguments)}function A(e,t){if(e.offline==null)return!1;var n=t==null||e.regId!==t.regId,r=t!=null&&e.keys!=null&&!o("WACryptoUtils").uint8ArraysEqual(t.pubKey,e.keys.identity);return n||r}l.bulkHandleRetryRequest=C}),98);
__d("MAWCOPRetryHandler",["MAWIsQuotaExceededError","MAWSharedCOPLogger","MAWSharedHandleRetryRequest","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){return u(t).catch(function(t){if(o("MAWIsQuotaExceededError").isQuotaExceededError(t))throw t;return r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Receipt consumer error"]))),[]})}function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){return e.length===0?[]:(yield o("MAWSharedHandleRetryRequest").bulkHandleRetryRequest(e.map(function(e){return e.retry})),e.map(function(e){return e.stanzaQueueId}))}),c.apply(this,arguments)}l.copIncomingRetryHandler=s}),98);
__d("MAWSplitProtocolEntityByType",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t={appdatas:[],instructions:[],messages:[],notifications:[],receipts:[],retries:[]};return e.forEach(function(e){switch(e.type){case"message":{t.messages.push(e);return}case"retryReceipt":{t.retries.push(e);return}case"appdata":{t.appdatas.push(e);return}case"notification":{t.notifications.push(e);return}case"receipt":{t.receipts.push(e);return}default:{t.instructions.push(e);return}}}),t}i.default=e}),66);
__d("WAParseMessageTransport",["WALogger","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e){return{version:"v3",type:"error",error:e}}function u(e,t){return e!=null&&(t.dsm==null||t.dsm.destinationJid==null||t.dsm.destinationJid!==e)}function c(t,n){var r=t.payload,a=t.protocol;if(r==null&&a==null)return s("There is no payload and protocol in the message transport");if(a==null)return s("There is no protocol part in the message transport");var i=a.integral;if(i==null)return s("There is no integral part in the message transport");if(i.padding==null)return s("There is no padding in the message transport");if(u(n,i))return s("The recipient does not match the device sent message recipient");if(o("decodeProtobuf").getUnknownFields(i)!=null)return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["There are unknown fields in the integral"]))),babelHelpers.extends({},s("There are unknown fields in the integral"),{futureProof:r==null?void 0:r.futureProof});if(r!=null){var l=r.applicationPayload;return l==null?s("There is no applicationPayload payload in the message transport"):{type:"applicationPayload",applicationPayload:l,skdm:m(a.ancillary),icdc:p(a.ancillary)}}var c=m(a.ancillary);return c!=null?{type:"skdm",skdm:c,icdc:p(a.ancillary)}:d(t)===!0?{type:"empty",version:"v3"}:{type:"unknown"}}function d(e){var t,n;if(e.payload!=null)return!1;if(e.protocol==null)return!0;var r=e.protocol,o=new Set(["$$unknownFieldCount","padding","backupDirective"]),a=Object.keys((t=r.integral)!=null?t:{}).filter(function(e){return!o.has(e)}),i=Object.keys((n=r.ancillary)!=null?n:{}).filter(function(e){return!o.has(e)});return i.length===0&&a.length===0}function m(e){return e==null?null:e.skdm}function p(e){return e==null?null:e.icdc}l.parseMessageTransport=c}),98);
__d("WADecodeIncomingMsg",["WALogger","WALongInt","WAMsgApplication.pb","WAMsgTransport.pb","WAParseMessageApplication","WAParseMessageTransport","WAStanzaUtils","WATimeUtils","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e,t,n){return e.futureProof&&n!=null?{version:"v3",type:"futureProof",futureProof:e.futureProof,protobuf:t,applicationPayload:n,subtype:null}:{version:"v3",type:"error",error:e.error}}function c(t,n,r,a){if(n==="v2")return{version:"v2",encoded:t};if(n==="v3"){var i=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMsgTransport.pb").MessageTransportSpec,t),l=o("WAParseMessageTransport").parseMessageTransport(i,r),c=_(i);if(l.type==="error")return u(l,t);if(l.type==="skdm")return d(l.skdm,l.icdc);if(l.type==="applicationPayload"){if(a===!0)return l.applicationPayload.payload==null?(o("WALogger").DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["instamadillo decodeIncomingMsg called with null applicationPayload"]))),{version:"v3",type:"error",error:"instamadillo unhandled proto"}):{version:"v3",type:"instamadillo",applicationPayload:new Uint8Array(l.applicationPayload.payload),backupDirective:c};var p=m(l.applicationPayload,t,l.icdc,c);if(l.skdm!=null){var f=d(l.skdm,l.icdc);return{version:"v3",type:"msgWithSKDM",msg:p,skdm:f}}return p}else return l.type==="empty"?{version:"v3",type:"empty"}:(l.type,{version:"v3",type:"error",error:"unhandled proto with type "+l.type})}else return o("WALogger").DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["decodeIncomingMsg called with unexpected encoding version: ",""])),n),{type:"error",version:"v3",error:"decodeIncomingMsg called with unexpected encoding version: "+n}}function d(e,t){var n=e.axolotlSenderKeyDistributionMessage,r=e.groupId;return n==null?{type:"error",version:"v3",error:"parseSKDM called with null axolotlSenderKeyDistributionMessage"}:r==null?{type:"error",version:"v3",error:"parseSKDM called with null groupId"}:{version:"v3",type:"skdm",msg:{senderKey:n,groupId:r},icdc:t}}function m(e,t,n,r){var a,i=o("decodeProtobuf").decodeProtobufWithUnknowns(o("WAMsgApplication.pb").MessageApplicationSpec,e.payload);if(i.payload==null)return p(i.metadata,e.payload);var l=o("WAParseMessageApplication").parseMessageApplication(i);return l.type==="error"?u(l,t):e.payload==null?u({error:"Empty application payload",type:"error",version:"v3"},t):{version:"v3",type:"subprotocol",metadata:(a=i.metadata)!=null?a:null,subprotocolType:l.subprotocolType,subprotocol:l.payload,applicationPayload:e.payload,protobuf:t,frankingContent:e.payload,backupDirective:r,icdc:n}}function p(e,t){var n=e==null?void 0:e.chatEphemeralSetting;if(n!=null){var r=n.ephemeralExpiration,a=n.ephemeralSettingTimestamp;if(r==null)return{version:"v3",type:"error",error:"Ephemeral setting without expiration"};if(t==null)return{error:"Empty application payload",type:"error",version:"v3"};try{var i,l=a!=null?o("WATimeUtils").castToUnixTime(o("WALongInt").numberOrThrowIfTooLarge(a)/1e3):o("WATimeUtils").DEFAULT_UNIXTIME;return{version:"v3",type:"ephemeral",ephemeralExpirationInSec:r,ephemeralLastUpdatedOrSetTimestamp:l,isEphemeralSettingReset:(i=n.isEphemeralSettingReset)!=null?i:!1,applicationPayload:t}}catch(e){var s;return{version:"v3",type:"ephemeral",ephemeralExpirationInSec:r,ephemeralLastUpdatedOrSetTimestamp:o("WATimeUtils").DEFAULT_UNIXTIME,isEphemeralSettingReset:(s=n.isEphemeralSettingReset)!=null?s:!1,applicationPayload:t}}}else return{version:"v3",type:"error",error:"MessageApplication has no payload and is not ephemeral"}}function _(e){var t,n=(t=e.protocol)==null||(t=t.ancillary)==null?void 0:t.backupDirective;if(n==null)return null;var r=n.messageId,a=n.actionType,i=n.supplementalKey;return r==null||a==null?null:{messageId:o("WAStanzaUtils").toStanzaId(r),actionType:a,supplementalKey:i}}l.decodeIncomingMsg=c,l.parseEphemeralSetting=p}),98);
__d("MawMpsPayloadToWaProtocolEntry",["FBLogger","MAWJids","MAWProtobufDeserializers","MAWUnsafeCoerce","MpsFutureProofKey","MpsTypes","WAArmadilloTransportEvent.pb","WADecodeIncomingMsg","WAFranking","WAFrankingTypes","WAJids","WAProtocolQueue","WAStanzaUtils","WATimeUtils","err"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return null}function s(e){return c(e.message.payload,e.message.messageId,e.message.threadId,e.message.senderId,e.message.timestampMs,e.insertionSource===o("MpsTypes").InsertionSource.Send?"wa-outgoing":"wa-incoming")}function u(e){var t=e.toplevelProtobuf,n=t.messageId,a=t.payload,i=t.senderId,l=t.threadId,s=t.timestampMs,u=c(a,n,l,i,s,"ebrestore"),d=e.supplementalProtobufs,m=Array.from(d.values()).map(function(e){var t,n=(t=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(e.payload).proto.metadata)==null?void 0:t.senderId;if(n==null)return r("FBLogger")("mps").mustfix("Supplemental message has no senderId"),null;var a=c(e.payload,e.messageId,l,n,e.timestampMs,"ebrestore");return a});return[u].concat(m).filter(Boolean)}function c(t,n,r,a,i,l){var s=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t),u=s.payload();switch(u.kind){case"messageApplication":{var c,d,m=u,p=m.subProtocol(),_;if(p==null){if(_=o("WADecodeIncomingMsg").parseEphemeralSetting(m.proto.metadata,u.bytes),_.type==="error")return null}else{var f,g;if(p.kind==="armadillo"&&((f=p.payload)==null?void 0:f.applicationData)!=null){var h=o("MAWUnsafeCoerce").unsafeCoerce(n);return{appdata:o("WAProtocolQueue").appdataApplicationProtocol({payload:m.bytes,version:3}),deviceJid:o("WAJids").toDeviceJid(o("MAWJids").toUserJid(a),o("WAJids").DEFAULT_DEVICE_ID),jid:o("MAWJids").threadIdToChatJid(r),priority:o("WAProtocolQueue").WAProtocolQueuePriorityHigh,stanzaId:o("MpsTypes").messageIdToStanzaId(n),stanzaQueueId:h,type:"appdata"}}_={applicationPayload:m.bytes,backupDirective:null,frankingContent:m.bytes,icdc:null,metadata:(g=u.proto.metadata)!=null?g:null,protobuf:new Uint8Array(m.bytes),subprotocol:new Uint8Array(p.bytes),subprotocolType:p.kind==="armadillo"?"armadillo":"consumerMessage",type:"subprotocol",version:"v3"}}var y={contentType:e(m),fbFolderId:null,from:o("WAJids").toDeviceJid(o("MAWJids").toUserJid(a),o("WAJids").DEFAULT_DEVICE_ID),incomingType:l,jid:o("MAWJids").threadIdToChatJid(r),message:_,offline:null,priority:o("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,remoteIdentity:null,reportingMeta:{frankingKey:null,frankingTag:((c=s.proto.metadata)==null||(c=c.frankingMetadata)==null?void 0:c.frankingTag)!=null?o("WAFrankingTypes").castToFrankingTag(new Uint8Array(s.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:o("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((d=s.proto.metadata)==null||(d=d.frankingMetadata)==null?void 0:d.reportingTag)!=null?o("WAFrankingTypes").castToReportingTag(new Uint8Array(s.proto.metadata.frankingMetadata.reportingTag)):null},retryCount:0,serverTs:o("WATimeUtils").castMilliSecondsToUnixTime(i),stanzaId:o("MpsTypes").messageIdToStanzaId(n),subtype:"armadillo",type:"message"},C=o("MAWUnsafeCoerce").unsafeCoerce(n);return babelHelpers.extends({},y,{stanzaQueueId:C})}case"transportEvent":{var b=u;if(b.proto.event!=null){var v=b.proto.event;if(v.icdcAlert!=null){var S={instruction:"icdcError",jid:o("MAWJids").toUserJid(a),notificationTs:o("WATimeUtils").castMilliSecondsToUnixTime(i),priority:o("WAProtocolQueue").WAProtocolQueuePriorityHigh,type:"instruction"},R=o("MAWUnsafeCoerce").unsafeCoerce(n);return babelHelpers.extends({},S,{stanzaQueueId:R})}if(v.deviceChange!=null)return}if(b.proto.placeholder!=null&&b.proto.placeholder.type!=null)switch(b.proto.placeholder.type){case o("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.DECRYPTION_FAILURE:{var L,E,k,I={contentType:null,decryptionError:"",fbFolderId:null,from:o("WAJids").toDeviceJid(o("MAWJids").toUserJid(a),o("WAJids").DEFAULT_DEVICE_ID),hideDecryptionFailure:((L=s.proto.metadata)==null?void 0:L.futureProofBehavior)===o("MpsFutureProofKey").WCEPlaintextPayloadFutureProof.WCEPlaintextPayloadFutureProofNoPlaceholder,jid:o("MAWJids").threadIdToChatJid(r),offline:null,priority:o("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,reportingMeta:{frankingKey:null,frankingTag:((E=s.proto.metadata)==null||(E=E.frankingMetadata)==null?void 0:E.frankingTag)!=null?o("WAFrankingTypes").castToFrankingTag(new Uint8Array(s.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:o("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((k=s.proto.metadata)==null||(k=k.frankingMetadata)==null?void 0:k.reportingTag)!=null?o("WAFrankingTypes").castToReportingTag(new Uint8Array(s.proto.metadata.frankingMetadata.reportingTag)):null},retryCount:0,serverTs:o("WATimeUtils").castMilliSecondsToUnixTime(i),stanzaId:o("WAStanzaUtils").toStanzaId(n),subtype:"ciphertext",type:"message"},T=o("MAWUnsafeCoerce").unsafeCoerce(n);return babelHelpers.extends({},I,{stanzaQueueId:T})}case o("WAArmadilloTransportEvent.pb").TransportEvent$Placeholder$Type.UNAVAILABLE_MESSAGE:{var D,x,$={contentType:null,fbFolderId:null,from:o("WAJids").toDeviceJid(o("MAWJids").toUserJid(a),o("WAJids").DEFAULT_DEVICE_ID),jid:o("MAWJids").threadIdToChatJid(r),offline:null,priority:o("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,reportingMeta:{frankingKey:null,frankingTag:((D=s.proto.metadata)==null||(D=D.frankingMetadata)==null?void 0:D.frankingTag)!=null?o("WAFrankingTypes").castToFrankingTag(new Uint8Array(s.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:o("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((x=s.proto.metadata)==null||(x=x.frankingMetadata)==null?void 0:x.reportingTag)!=null?o("WAFrankingTypes").castToReportingTag(new Uint8Array(s.proto.metadata.frankingMetadata.reportingTag)):null},retryCount:0,serverTs:o("WATimeUtils").castMilliSecondsToUnixTime(i),stanzaId:o("WAStanzaUtils").toStanzaId(n),subtype:"unavailable",type:"message"},P=o("MAWUnsafeCoerce").unsafeCoerce(n);return babelHelpers.extends({},$,{stanzaQueueId:P})}}break}case"locallyTransformedMessage":break;case"adminMessage":{var N,M,w=u;if(w.proto.groupAdminChanged!=null||w.proto.groupMembershipAddModeChanged!=null||w.proto.groupParticipantChanged!=null)break;var A={content:w.proto,type:"admin"},F={contentType:null,fbFolderId:null,from:o("WAJids").toDeviceJid(o("MAWJids").toUserJid(a),o("WAJids").DEFAULT_DEVICE_ID),incomingType:l,jid:o("MAWJids").threadIdToChatJid(r),message:A,offline:null,priority:o("WAProtocolQueue").WAProtocolQueuePriorityHigh,recipient:void 0,remoteIdentity:null,reportingMeta:{frankingKey:null,frankingTag:((N=s.proto.metadata)==null||(N=N.frankingMetadata)==null?void 0:N.frankingTag)!=null?o("WAFrankingTypes").castToFrankingTag(new Uint8Array(s.proto.metadata.frankingMetadata.frankingTag)):null,frankingVersion:o("WAFranking").getFrankingVersion(),reportingContent:null,reportingTag:((M=s.proto.metadata)==null||(M=M.frankingMetadata)==null?void 0:M.reportingTag)!=null?o("WAFrankingTypes").castToReportingTag(new Uint8Array(s.proto.metadata.frankingMetadata.reportingTag)):null},retryCount:0,serverTs:o("WATimeUtils").castMilliSecondsToUnixTime(i),stanzaId:o("MpsTypes").messageIdToStanzaId(n),subtype:"armadillo",type:"message"},O=o("MAWUnsafeCoerce").unsafeCoerce(n);return babelHelpers.extends({},F,{stanzaQueueId:O})}default:}}function d(e,t,n){var a=new Set(t);for(var i of e)!a.has(o("MAWUnsafeCoerce").unsafeCoerce(i.message.messageId))&&!n.has(i.message.messageId)&&n.set(i.message.messageId,r("err")("Ack not received"));return n}l.mpsIncomingPayloadToWAProtocolEntry=s,l.mpsFullMessageToMawPayload=u,l.mawAcksToMpsIncomingPayloadErrorMap=d}),98);
__d("MAWProtocolQueueProcess",["FBLogger","MAWCOPAppdataHandler","MAWCOPInstructionsHandler","MAWCOPMessagesHandler","MAWCOPNotificationsHandler","MAWCOPReceiptsHandler","MAWCOPRetryHandler","MAWDbMsgTxns","MAWSharedCOPLogger","MAWSplitProtocolEntityByType","MawMpsPayloadToWaProtocolEntry","MpsTypes","Promise","WAJids","WebMps","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m;function p(e){return _.apply(this,arguments)}function _(){return _=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=r("MAWSplitProtocolEntityByType")(t);r("MAWSharedCOPLogger").DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["COP handler for "," msgs, "," appdatas, "," notifications, "," receipts, "," retries, "," instructions"])),a.messages.length,a.appdatas.length,a.notifications.length,a.receipts.length,a.retries.length,a.instructions.length);var i=(yield(m||(m=n("Promise"))).all([o("MAWCOPInstructionsHandler").copIncomingInstructionsHandler(a.instructions),o("MAWCOPReceiptsHandler").copIncomingReceiptsHandler(a.receipts),o("MAWCOPAppdataHandler").copIncomingAppdataHandler(a.appdatas),o("MAWCOPNotificationsHandler").copIncomingNotificationHandler(a.notifications),o("MAWCOPRetryHandler").copIncomingRetryHandler(a.retries)])).flat();return i}),_.apply(this,arguments)}function f(e){return g.apply(this,arguments)}function g(){return g=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e,a=t.map(function(e){return{chat:o("WAJids").unsafeCoerceToChatJid(e.toplevelProtobuf.threadId),externalId:o("MpsTypes").messageIdToStanzaId(e.toplevelProtobuf.messageId)}}),i=yield o("MAWDbMsgTxns").checkMessagesExistenceByProtocolMsgIds(a);if(t=t.filter(function(e,t){return i[t]==null}),t.length===0){r("MAWSharedCOPLogger").DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["MPS COP: All messages already exist in MAW DB, skipping"])));return}var l=t.map(function(e){try{return o("MawMpsPayloadToWaProtocolEntry").mpsFullMessageToMawPayload(e)}catch(n){var t=r("getErrorSafe")(n);return r("FBLogger")("COP").catching(t).mustfix("Failed to convert FullMessage %s to MAW payload",e.toplevelProtobuf.messageId),null}}).flat().filter(Boolean);r("MAWSharedCOPLogger").DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["MPS COP handler for "," msgs"])),l.map(function(e){return e.stanzaId}).join(", "));var d=r("MAWSplitProtocolEntityByType")(l);r("MAWSharedCOPLogger").DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["MPS COP handler for "," msgs, "," appdatas, "," notifications, "," receipts, "," retries, "," instructions"])),d.messages.length,d.appdatas.length,d.notifications.length,d.receipts.length,d.retries.length,d.instructions.length),yield(m||(m=n("Promise"))).all([o("MAWCOPMessagesHandler").copIncomingMsgsHandler(d.messages),o("MAWCOPInstructionsHandler").copIncomingInstructionsHandler(d.instructions),o("MAWCOPAppdataHandler").copIncomingAppdataHandler(d.appdatas),o("MAWCOPNotificationsHandler").copIncomingNotificationHandler(d.notifications)])}),g.apply(this,arguments)}function h(e){return y.apply(this,arguments)}function y(){return y=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.filter(function(e){return e.directive!=null&&e.directive.isTransportErrorPlaceholder&&e.directive.actionType===o("MpsTypes").ActionType.UpsertTopLevel});if(t.length===0)return e;var a=(yield(m||(m=n("Promise"))).all(t.map(function(e){return o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-only"},debug:{purpose:"decryption-error-recovery-m3"},messageId:e.message.messageId,threadId:e.message.threadId}).then(function(e){return e.success===!0&&e.value!=null?e.value.toplevelProtobuf:null}).catch(function(e){return r("FBLogger")("mps").catching(e).mustfix("Failed to load message to recover decryption error"),null})}))).filter(Boolean);if(a.length===0)return e;var i=new Map;return a.forEach(function(e){var t=e.threadId,n=i.get(t);n==null&&(n=new Map,i.set(t,n)),n.set(e.messageId,e)}),e.map(function(e){var t,n=(t=i.get(e.message.threadId))==null?void 0:t.get(e.message.messageId);return n!=null?babelHelpers.extends({},e,{message:n}):e})}),y.apply(this,arguments)}function C(e){return b.apply(this,arguments)}function b(){return b=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=new Map,a=yield h(e),i=a.map(function(e){try{return o("MawMpsPayloadToWaProtocolEntry").mpsIncomingPayloadToWAProtocolEntry(e)}catch(o){var n=r("getErrorSafe")(o);return r("FBLogger")("COP").catching(n).mustfix("Failed to convert incoming payload to MAW payload"),t.set(e.message.messageId,n),null}}).flat().filter(Boolean),l=r("MAWSplitProtocolEntityByType")(i);r("MAWSharedCOPLogger").DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["MPS COP handler for "," msgs, "," appdatas, "," notifications, "," receipts, "," retries, "," instructions"])),l.messages.length,l.appdatas.length,l.notifications.length,l.receipts.length,l.retries.length,l.instructions.length);var s=(yield(m||(m=n("Promise"))).all([o("MAWCOPMessagesHandler").copIncomingMsgsHandler(l.messages),o("MAWCOPInstructionsHandler").copIncomingInstructionsHandler(l.instructions),o("MAWCOPAppdataHandler").copIncomingAppdataHandler(l.appdatas),o("MAWCOPNotificationsHandler").copIncomingNotificationHandler(l.notifications)])).flat();return o("MawMpsPayloadToWaProtocolEntry").mawAcksToMpsIncomingPayloadErrorMap(a,s,t)}),b.apply(this,arguments)}l.processProtocolQueueEntries=p,l.processMPSFullMessageEntries=f,l.processMPSIncomingPayloadEntries=C}),98);
__d("MAWIsRTCCallXmaEnabled",["gkx"],(function(t,n,r,o,a,i,l){"use strict";function e(){return r("gkx")("16666")}l.isRTCCallXmaEnabled=e}),98);
__d("MAWProtocolQueueMsg",["MAWBulkHandleIncomingMsgApi","MAWHIMLogger","MAWIsRTCCallXmaEnabled","MAWMsgType","MAWParseXMAUnsupportedMessageType","MAWXMALoggingUtils","MAWXMAUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(e,t){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n){var a=new Set,i=t.map(function(e){var t,n,r,i,l,s,u,c,d=e.decodedMsg,m=e.receiveFlow,p=e.stanza,_=p.message.decrypted,f=o("MAWXMALoggingUtils").getXmaTargetTypeStringFromEnum(d==null?void 0:d.xmaTargetTypeForLogging),g=d==null||(t=d.unstoredXMA)==null?void 0:t.unstoredDbXMA.xmaDataclass,h=d==null||(n=d.unstoredXMA)==null?void 0:n.unstoredDbXMA.targetType,y=o("MAWParseXMAUnsupportedMessageType").getXMAUnsupportedMessageType(h,g);return m.addAnnotations({bool:{furuteproof:(d==null||(r=d.unstoredDbMsg)==null?void 0:r.type)===o("MAWMsgType").MSG_TYPE.FUTUREPROOF},int:{xmaTargetType:(i=d==null?void 0:d.xmaTargetTypeForLogging)!=null?i:-1},string:{contentType:(l=d==null?void 0:d.contentTypeForLogging)!=null?l:"",subtype:(s=d==null||(u=d.unstoredDbMsg)==null||(u=u.msgContent)==null?void 0:u.subtype)!=null?s:y,xmaTargetTypeString:f}}),o("MAWXMAUtils").isRtcXMA(d==null||(c=d.unstoredXMA)==null||(c=c.unstoredDbXMA)==null?void 0:c.targetType)&&!o("MAWIsRTCCallXmaEnabled").isRTCCallXmaEnabled()?(m.endFail("rtc_xma_not_supported"),a.add(p.stanzaQueueId),null):_.type==="InstamadilloMsg"?(m.endFail("instamadillo_not_supported"),a.add(p.stanzaQueueId),null):_.type==="InvisibleMsg"?(a.add(p.stanzaQueueId),null):{msgData:_,receiveFlow:m,stanzaSource:p.incomingType,unstoredContent:d}}).filter(Boolean);return r("MAWHIMLogger").DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs"])),i.length),o("MAWBulkHandleIncomingMsgApi").bulkHandleIncomingMsgs(i,n).then(function(e){var n=e.msgResults;return r("MAWHIMLogger").DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Handle: "," msgs: done"])),i.length),t.map(function(e){var t=e.stanza,o=n.get(t.message.decrypted.id);if(o==null){a.has(t.stanzaQueueId)||r("MAWHIMLogger").MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Cannot have null result for non-invisible msgs"])));return}o.success===!0&&a.add(t.stanzaQueueId)}),{followUpParams:{incomingMsgResults:n,incomingMsgs:t},toAck:Array.from(a)}}).catch(function(e){var n="Not an Error instance",r="N/A";throw typeof e.message=="string"&&(n=e.message),typeof e.stack=="string"&&(r=e.stack),t.forEach(function(e){e.receiveFlow.endFail("consumer_handle_message_transaction_error",{string:{errorDescription:n,errorStack:r}})}),e})}),d.apply(this,arguments)}l.handleIncomingMessagesStanzas=c}),98);
__d("MawCopScheduler",["WorkerScheduler"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return e==null&&(e=o("WorkerScheduler").makeScheduler("cop",{concurrency:1,maxTaskLimit:1,maxThrottleMs:1e5,timeoutMs:1e5})),e}l.copScheduler=s}),98);
__d("MessageChunksFromMediaEntry",[],(function(t,n,r,o,a,i){"use strict";function e(e){var t=[{messageId:e.message.messageId,plaintextHash:e.plaintextHash,threadId:e.message.threadId}];return e.thumbnailHash!=null&&e.thumbnailHash!==e.plaintextHash&&t.push({messageId:e.message.messageId,plaintextHash:e.thumbnailHash,threadId:e.message.threadId}),t}function l(t){return t.flatMap(e)}i.getMessageChunksFromMediaEntry=e,i.getMessageChunksFromMediaEntries=l}),66);
__d("MpsMediaPostProcessor",["MAWMediaManager","MessageChunksFromMediaEntry","MpsMediaEntryCache","MpsTypes","Promise","WAMediaManager","WAStartMediaDownloadQplFlow","WmiMediaService","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){try{var a=o("MpsMediaEntryCache").hydrateCache(t.message),i=o("MessageChunksFromMediaEntry").getMessageChunksFromMediaEntries(a);o("WmiMediaService").mediaService().storeMessageChunks(i),t.insertionSource===o("MpsTypes").InsertionSource.Receive&&(e||(e=n("Promise"))).all(a.map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("WAStartMediaDownloadQplFlow").startMediaDownloadQplFlow({downloadEntry:"MpsSyncMedia",msgType:null,protocolMsgId:null,triggerUIView:null}),n=yield o("MAWMediaManager").getMawMediaManager().enqueueDownloadFullSizeAndPreview({fullSizePlaintextHash:e.plaintextHash,mediaDownloadFlow:t,priority:o("WAMediaManager").MediaTaskPriority.MEDIUM}).fullsizePromise;n.success===!1?t.endFail(n.error):t.endSuccess()});return function(t){return e.apply(this,arguments)}})()))}catch(e){return r("getErrorSafe")(e)}}function u(e){var t=new Map;return e.forEach(function(e){var n=s(e);n!=null&&t.set(e.message.messageId,n)}),t}l.postProcessPayloads=u}),98);
__d("MpsToUIPostProcessor",["FBLogger","MpsMessageToBridge","MpsMessageToBridgeWrapper","MpsToBridgeMessageId","MpsTypes","WAJids","WATimeUtils","WebMps","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return[{tag:"NewMsg",value:e}]}function s(e){return[{tag:"EditMsgHistoryAdded",value:[e]}]}function u(e){if(e.type==="upsert")return[{tag:"UpsertReaction",value:e.reaction}];if(e.type==="delete")return[{tag:"DeleteReaction",value:e.reaction}];throw e.type,r("FBLogger")("messenger_web").mustfixThrow("unreachable")}function c(e){return[{tag:"NewMedia",value:e}]}function d(e){return[{tag:"MsgsStartCountdown",value:e}]}function m(e){return[{tag:"StoryReplyStartCountdown",value:e}]}function p(e){return[{tag:"NoteReplyStartCountdown",value:e}]}function _(e){return[{tag:"NewReceiverFetchInfo",value:e}]}function f(e){return[{tag:"NewXMA",value:e}]}function g(e){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){if(t.directive.actionType===o("MpsTypes").ActionType.DeleteTopLevel){var n=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(t.message),r=o("MpsToBridgeMessageId").mpsToBridgeMsgId(n.message.threadId,t.directive.targetMessageId);return[{tag:"DeleteMessages",value:{messages:[{msgId:r,ts:n.getUnixTs()}],threadJid:n.getChatJid()}}]}if(!(t.directive.actionType===o("MpsTypes").ActionType.UpsertTopLevel||t.directive.actionType===o("MpsTypes").ActionType.UpsertSupplemental||t.directive.actionType===o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder))return[];var a=t.directive.actionType===o("MpsTypes").ActionType.UpsertSupplemental?t.directive.targetMessageId:t.message.messageId,i=yield o("WebMps").mps().loadMessage({config:{shouldFetchSupplementals:!0,strategy:"local-only"},debug:{purpose:"UI-fetch"},messageId:a,threadId:t.message.threadId}),l=i.value;if(!l)return[];var g=o("MpsMessageToBridge").mpsFullMessagetoBridge(l);if(g==null)return[];var h=[g.topLevel].concat(g.supplementals).map(function(t){return(function(t){if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeMsg"&&"value"in t){var n=t.value;return e(n)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeEditHistoryMsg"&&"value"in t){var r=t.value;return s(r)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeReactionAction"&&"value"in t){var o=t.value;return u(o)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeMedia"&&"value"in t){var a=t.value;return c(a)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeXMAStartCountdown"&&"value"in t){var i=t.value;return m(i)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeNoteReplyStartCountdown"&&"value"in t){var l=t.value;return p(l)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeMsgsStartCountdown"&&"value"in t){var g=t.value;return d(g)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeReceiverFetchInfo"&&"value"in t){var h=t.value;return _(h)}if((typeof t=="object"&&t!==null||typeof t=="function")&&t.kind==="bridgeXMA"&&"value"in t){var y=t.value;return f(y)}throw Error("Match: No case succesfully matched. Make exhaustive or add a wildcard case using '_'. Argument: "+t)})(t)}),y=h.flat(),C=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(l.toplevelProtobuf),b=[{tag:"VerifyThreadExists",value:{authoritativeThreadKey:null,cannotReplyReason:null,clientThreadKey:null,description:"mpsToUIPostProcessor",folder:null,instanceKey:null,isGroup:o("WAJids").switchOnMsgrChatJidType(C.getChatJid(),{group:function(){return!0},user:function(){return!1}}),jid:C.getChatJid(),lastReadTs:o("WATimeUtils").castToMillisTime(0)}}];return b.concat(y)}),h.apply(this,arguments)}l.mpsToUIEventPostProcessPayload=g}),98);
__d("WAPriorityQueue",[],(function(t,n,r,o,a,i){"use strict";var e=(function(){function e(e,t){this.$2=e,this.$1=[],this.$3(t)}var t=e.prototype;return t.size=function(){return this.$1.length},t.$3=function(t){var e=this;t!=null&&t.length&&t.forEach(function(t){e.push(t)})},t.$4=function(t,n){var e=this.$1[n];this.$1[n]=this.$1[t],this.$1[t]=e},t.$5=function(t){if(t===void 0&&(t=0),t!==0){var e=this.$6(t),n=e*2+1,r=e*2+2,o=this.$1.length;if(!(t>=o)){var a=this.$7(e),i=e;if(n<o){var l=this.$7(n);a>l&&(i=n,a=l)}if(r<o){var s=this.$7(r);a>s&&(i=r)}i!==e&&(this.$4(i,e),this.$5(e))}}},t.$8=function(t){t===void 0&&(t=0);var e=t*2+1,n=t*2+2,r=this.$1.length;if(!(t>=r)){var o=this.$7(t),a=t;if(e<r){var i=this.$7(e);o>i&&(a=e,o=i)}if(n<r){var l=this.$7(n);o>l&&(a=n)}a!==t&&this.$4(a,t),e<r&&this.$8(e),n<r&&this.$8(n)}},t.$7=function(t){return this.$2(this.$1[t])},t.$6=function(t){return t%2===0?(t-2)/2:(t-1)/2},t.push=function(t){this.$1.push(t);var e=this.$1.length-1;this.$5(e)},t.pull=function(){var e=this.$1.shift();return this.heapify(),e},t.heapify=function(){this.$8(0)},t.peek=function(){return this.$1[0]},e})();i.default=e}),66);
__d("MawMpsCop",["FBLogger","MAWBridge","MAWMpsGating","MAWProtocolQueueProcess","MawCopScheduler","MawMpsCopProtocolQueueProcessor","MpsMediaEntryCache","MpsMediaPostProcessor","MpsToUIPostProcessor","Promise","WAPriorityQueue","WAPubSub","WAWaitForUserUnblocked","WebMps","WorkerScheduler","asyncToGeneratorRuntime","getErrorSafe","getSafeQplErrorMessage","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s=1,u=10,c=r("justknobx")._("4688");function d(){return o("MAWMpsGating").isFullMpsEnabled()?r("justknobx")._("4841"):s}var m=(function(){function t(){this.$1=o("WAPubSub").simplePubSub(),this.$3=new Map,this.$4=new Map,this.$2=new(o("MawMpsCopProtocolQueueProcessor")).ProtocolQueueProcessor}var a=t.prototype;return a.$5=function(t){return o("MAWMpsGating").isMpsMessageRendering()&&t.forEach(function(e){return o("MpsMediaEntryCache").hydrateCache(e.toplevelProtobuf)}),o("MAWProtocolQueueProcess").processMPSFullMessageEntries(t)},a.loadMsgIntoMaw=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("WebMps").mps().loadMessage(e);if(t.success===!1)throw t.error;t.value!=null&&(yield this.$5([t.value]))});function t(t){return e.apply(this,arguments)}return t})(),a.loadBatchMsgsIntoMaw=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("WebMps").mps().batchLoadMessages(babelHelpers.extends({},e,{config:babelHelpers.extends({shouldFetchSupplementals:!0,shouldFetchTags:!0,strategy:"full-fetch"},e.config)}));if(t.success===!1)return t;var n=t.value.map(function(e){return e.messages}).flat();return n.length===0?t:this.$6(n).then(function(){return t})});function t(t){return e.apply(this,arguments)}return t})(),a.loadMoreMsgsIntoMaw=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("WebMps").mps().loadMessages(babelHelpers.extends({},e,{config:{shouldFetchSupplementals:!0,shouldFetchTags:!0,strategy:"full-fetch"}}));return t.success===!1?t:this.$5(t.value.messages).then(function(){return t})});function t(t){return e.apply(this,arguments)}return t})(),a.subscribe=function(t){return this.$1.subscribe(t)},a.$7=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=this;if(this.$3.size===0)return{exhausted:!0};var r=[];return this.$3.forEach(function(o,a){t!=null&&r.length>=t||(r.push.apply(r,o.splice(-e)),o.length===0&&n.$3.delete(a))}),o("MAWMpsGating").isFullMpsEnabled()?{exhausted:this.$3.size===0}:(yield this.$8(r),{exhausted:this.$3.size===0})});function t(t,n){return e.apply(this,arguments)}return t})(),a.$9=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=this;if(this.$4.size===0)return{exhausted:!0};var r=[];return this.$4.forEach(function(o,a){if(!(t!=null&&r.length>=t)){for(var i=1;i<=e;i++){var l=o.pull();l!=null&&r.push(l)}o.size()===0&&n.$4.delete(a)}}),yield this.$10({payloadList:r}),{exhausted:this.$4.size===0}});function t(t,n){return e.apply(this,arguments)}return t})(),a.$11=function(t){var e=this;t.forEach(function(t){var n,r=t.message.threadId,o=(n=e.$3.get(r))!=null?n:[];o.push(t),e.$3.set(r,o)})},a.$12=function(t){var e=this;t.payloadList.forEach(function(t){var n,o=t.message.threadId,a=(n=e.$4.get(o))!=null?n:new(r("WAPriorityQueue"))(function(e){return-e.message.timestampMs});a.push(t),e.$4.set(o,a)})},a.$10=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.ctx,i=t.payloadList;o("MpsMediaPostProcessor").postProcessPayloads(i);var l=new Map,s=[];yield(e||(e=n("Promise"))).all(i.map((function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){try{var t=yield o("MpsToUIPostProcessor").mpsToUIEventPostProcessPayload(e);t.forEach(function(t){t.tag==="NewMsg"&&t.value.unsupportedType!=null&&(a==null||a.messageToQpl.addPoint(e.message.messageId,"unsupported_type",{string:{unsupported:t.value.unsupportedType}}))}),s.push.apply(s,t)}catch(t){l.set(e.message.messageId,r("getErrorSafe")(t))}});return function(t){return e.apply(this,arguments)}})())),o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:s}),i.forEach(function(e){var t=l.get(e.message.messageId);if(t){var n=t;a==null||a.messageToQpl.addPoint(e.message.messageId,"ui-fail",{string:{errorDescription:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(n)}}),r("FBLogger")("mps").catching(n).mustfix("Failed to process payload for UI for thread id = %s , message Id = %s",e.message.threadId,e.message.messageId)}})});function a(e){return t.apply(this,arguments)}return a})(),a.$8=function(t){return o("MAWProtocolQueueProcess").processMPSIncomingPayloadEntries(t).then(function(e){e.forEach(function(e,t){r("FBLogger")("mps").catching(e).mustfix("Failed to process payload for MAW for message Id = %s",t)})}).catch(function(e){r("FBLogger")("mps").catching(r("getErrorSafe")(e)).mustfix("Failed to process payload for MAW")})},a.postProcessMessages=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=this;if(t.payloadList.length===0)return(e||(e=n("Promise"))).resolve();if(!(o("MAWMpsGating").isMpsMessageRendering()&&(o("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked()?this.$12({ctx:t.ctx,payloadList:t.payloadList}):yield this.$10({ctx:t.ctx,payloadList:t.payloadList}),o("MAWMpsGating").isFullMpsEnabled())))return o("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked()?(this.$11(t.payloadList),(e||(e=n("Promise"))).resolve()):(o("MawCopScheduler").copScheduler().runTask({fn:function(){return a.$8(t.payloadList)},name:"online-message",priority:o("MAWMpsGating").isMpsMessageRendering()?r("justknobx")._("960")?o("WorkerScheduler").BACKGROUND_PRIORITY:o("WorkerScheduler").REGULAR_PRIORITY:o("WorkerScheduler").BLOCKING_PRIORITY}).catch(function(e){r("FBLogger")("cop").catching(r("getErrorSafe")(e)).mustfix("online message processing fails")}),(e||(e=n("Promise"))).resolve())});function a(e){return t.apply(this,arguments)}return a})(),a.subscribeToOfflineQueue=function(t){var e=this;t.subscribe(function(t){switch(t.type){case"offline-start":{o("WAWaitForUserUnblocked").maybeResetWaitForUserUnblocked();break}case"offline-end":{e.$1.publish({type:"maw-infra-start"}),o("MAWMpsGating").isMpsMessageRendering()?o("MawCopScheduler").copScheduler().runTask({fn:function(){return e.$7(d())},name:"offline-queue",priority:r("justknobx")._("960")?o("WorkerScheduler").BACKGROUND_PRIORITY:o("WorkerScheduler").REGULAR_PRIORITY}).catch(function(e){r("FBLogger")("cop").catching(r("getErrorSafe")(e)).mustfix("offline-end cop fails")}).finally(function(){e.$13(function(){return e.$7(u,c)},r("justknobx")._("960")?o("WorkerScheduler").BACKGROUND_PRIORITY:o("WorkerScheduler").REGULAR_PRIORITY),e.$2.startProcessing()}):e.$7(d()).catch(function(e){r("FBLogger")("cop").catching(r("getErrorSafe")(e)).mustfix("offline-end cop fails")}).finally(function(){e.$13(function(){return e.$7(u,c)},o("WorkerScheduler").REGULAR_PRIORITY),e.$2.startProcessing()}),o("MAWMpsGating").isMpsMessageRendering()&&e.$9(d()).catch(function(e){r("FBLogger")("wmi").catching(r("getErrorSafe")(e)).mustfix("MPS offline-end cop fails")}).finally(function(){e.$13(function(){return e.$9(u,c)},o("WorkerScheduler").REGULAR_PRIORITY)}),e.$1.publish({success:!0,type:"maw-infra-end"}),o("WAWaitForUserUnblocked").unblockUser();break}default:{t.type;break}}})},a.$6=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){for(var t=c,n=0;n<e.length;n+=t){var o=e.slice(n,n+t);yield this.$5(o).catch(function(e){return r("FBLogger")("mps").catching(r("getErrorSafe")(e)).mustfix("Failed to process batch")})}});function t(t){return e.apply(this,arguments)}return t})(),a.$13=function(t,n){var e=this;this.$14==null&&(this.$14=o("MawCopScheduler").copScheduler().task({fn:t,name:"background-iterator",priority:n}),this.$14.run().then(function(r){e.$14=null,r.exhausted===!1&&e.$13(t,n)}).catch(function(o){r("FBLogger")("cop").catching(r("getErrorSafe")(o)).mustfix("Cop fails"),e.$14=null,e.$13(t,n)}))},t})(),p;function _(){return p||(p=new m,p)}l.MpsCop=m,l.mpsCop=_}),98);
__d("MAWSharedRestoreUnavailableMessages",["LSMEBTaskCreationSource","MAWBridgeEventTransmitter","WAGlobals","WAJids","setTimeout"],(function(t,n,r,o,a,i,l){"use strict";var e=1e4,s=new Map;function u(t){s.has(t.externalId)||(s.set(t.externalId,!0),r("setTimeout")(function(){var e=t.chat;o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(t.externalId,r("LSMEBTaskCreationSource").EB_POINT_QUERY_RETRY_DECRYPTION_FAILURES,e)},e))}function c(e){e.forEach(function(e){if(e.type==="message")if(e.subtype!=null){if(e.subtype==="unavailable"||e.subtype==="ciphertext"){var t=o("WAJids").extractUserJid(e.from);u({author:o("WAGlobals").getMyUserJid()===t?"@me":t,chat:e.jid,externalId:e.stanzaId})}}else(e.message.decrypted.type==="IncomingCiphertextMsg"||e.message.decrypted.type==="UnavailableMsg")&&u(e.message.decrypted.id)})}l.restoreUnavailableMessages=c}),98);
__d("MAWSharedCOPHandleBatch",["MAWIsQuotaExceededError","MAWSharedCOPLogger","MAWSharedRestoreUnavailableMessages","WALogger","WAProtocolQueue","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p;function _(e,t,n){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a){var i=yield a(t).then(function(e){return[e,null,!1]}).catch(function(t){return o("MAWIsQuotaExceededError").isQuotaExceededError(t)?(r("MAWSharedCOPLogger").catching(t).MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Quota exceeded while processing stanzas batch."]))),[[],null,!0]):(r("MAWSharedCOPLogger").catching(t).MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Runtime error while processing stanzas batch"]))),[[],t instanceof Error?t:r("err")(""+t),!1])}),l=i[0],m=i[1],p=i[2];if(p)return{entriesLeft:[],exhausted:!0,handled:0};if(yield o("WAProtocolQueue").protocolQueue().ack(l).catch(function(e){return r("MAWSharedCOPLogger").catching(e).MUSTFIX(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[ackProtocols] Cannot ack from MAWConsumer"])))}),l.length>=t.length)return{entriesLeft:[],exhausted:!1,handled:l.length};if(r("MAWSharedCOPLogger").WARN(c||(c=babelHelpers.taggedTemplateLiteralLoose(["Failed processing "," items"])),t.length-l.length),n===1){if(t.length>1&&r("MAWSharedCOPLogger").MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Received more than 1 entry, despite having limit === 1"]))),t.length===0)return{entriesLeft:[],exhausted:!1,handled:0};var _=t[0];return yield o("WAProtocolQueue").protocolQueue().delete([_.stanzaQueueId]),{entriesLeft:[],exhausted:!1,handled:1}}var f=new Map(t.map(function(e){return[e.stanzaQueueId,e]}));return l.forEach(function(e){return f.delete(e)}),{entriesLeft:Array.from(f.values()),error:!0,exhausted:!1,handled:l.length}}),f.apply(this,arguments)}function g(e,t,n){return h.apply(this,arguments)}function h(){return h=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n){var a=yield e(t);if(t.order==="desc"&&(a=a.toReversed()),a.length===0)return{exhausted:!0,handled:0};r("MAWSharedCOPLogger").DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose([""," stanzas. Config:",""])),a.length,String(t)),o("MAWSharedRestoreUnavailableMessages").restoreUnavailableMessages(a);var i=yield _(a,t.limit,n);if(i.error==null)return{exhausted:i.exhausted,handled:i.handled};o("WALogger").LOG(p||(p=babelHelpers.taggedTemplateLiteralLoose(["Linear COP v2"])));var l=0;for(var s of i.entriesLeft){var u=yield _([s],1,n);if(l+=u.handled,u.exhausted)return{exhausted:!0,handled:l+i.handled}}return{exhausted:!1,handled:l+i.handled}}),h.apply(this,arguments)}l.copHandleBatch=g}),98);
__d("MawMpsCopProtocolQueueProcessor",["FBLogger","MAWProtocolQueueProcess","MAWSharedCOPHandleBatch","MawCopScheduler","Promise","WAProtocolQueue","WAWaitForUserUnblocked","WorkerScheduler","justknobx"],(function(t,n,r,o,a,i,l){"use strict";var e,s=(function(){function t(){this.$2=r("justknobx")._("2539"),this.$3=null,this.$1()}var a=t.prototype;return a.$4=function(){var t=this;this.$3==null&&(this.$3=o("MawCopScheduler").copScheduler().task({fn:function(){return o("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked()?(e||(e=n("Promise"))).resolve({exhausted:!0,handled:0}):o("MAWSharedCOPHandleBatch").copHandleBatch(o("WAProtocolQueue").protocolQueue().index("priority").read,{limit:t.$2,order:"desc"},o("MAWProtocolQueueProcess").processProtocolQueueEntries)},name:"protocol-queue",priority:o("WorkerScheduler").BACKGROUND_PRIORITY}),this.$3.run().then(function(e){t.$3=null,e.exhausted===!1&&t.$4()}).catch(function(e){r("FBLogger")("cop").catching(e).mustfix("ProtocolQueueProcessor fails"),t.$3=null,t.$4()}))},a.startProcessing=function(){this.$4()},a.$1=function(){var e=this;o("WAProtocolQueue").protocolQueue().subscribe(function(t){switch(t.type){case"flush":{if(o("WAWaitForUserUnblocked").isStillWaitingForUserUnblocked())return;e.startProcessing();return}}})},t})();l.ProtocolQueueProcessor=s}),98);
__d("MAWSharedOfflineQueueMetric",["$InternalEnum","MAWMpsGating","MWFBLogger","MawMpsCop","WAGlobals","WAPREList","WATimeUtils","WAWaterFlow"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("MWFBLogger").MWLogger().tags(["offline-resume"]),m=n("$InternalEnum").Mirrored(["OFFLINE","ONLINE"]),p=n("$InternalEnum").Mirrored(["WA_CLIENT_INFRA","WA_CLIENT_INFRA_DUPLICATED_START","WA_PASSIVE_MODE","WA_PASSIVE_MODE_FAIL","MAW_INFRA","MAW_STUCK","WA_STUCK","MAW_NOT_IDLE_OQ"]),_=(function(){function t(e,t,n,r){this.$1=0,this.$3=r,this.$2=o("WAWaterFlow").makeWaterflow("offline-resume",o("WAPREList").PRE_METRIC.OFFLINE_QUEUE),this.$6(e),this.$7(),this.$8(t),this.$9(n),this.$4=Math.round(o("WATimeUtils").performanceAbsoluteNow()/1e3)}var n=t.prototype;return n.$8=function(t){var e=this;t.subscribe(function(t){switch(t.type){case"passive-mode-start":{e.$2.isOnGoing()||e.$2.startMetric(),e.$2.startPoint(p.WA_PASSIVE_MODE,{passiveModeAcks:t.count}),e.$10("wa");break}case"passive-mode-end":{e.$2.endPoint(p.WA_PASSIVE_MODE),e.$10("wa");break}default:t.type,e.$2.addPoint(p.WA_PASSIVE_MODE_FAIL),e.$10("wa")}})},n.$9=function(t){var e=this;t.subscribe(function(t){switch(t.type){case"new-message":{if(t.commonMessageBase.offline==null)return;e.addWAMessage(),e.$10("wa");break}}})},n.$6=function(t){var e=this;t.subscribe(function(t){switch(t.type){case"offline-start":{e.$11(t.offlineStats),e.$10("wa");break}case"offline-end":{e.$2.isOnGoing()&&(e.$2.endPoint(p.WA_CLIENT_INFRA),e.$10("maw"));break}case"offline-entity":{e.$12(t.serverTs,t.offline),e.$10("wa");break}case"offline-processed":{e.$13(t.count),e.$10("wa");break}case"connection-lost":{e.$2.isOnGoing()&&e.$2.endFail("connection-lost",{isConnectionLost:!0}),e.$14();break}default:}})},n.$10=function(n){var t=this;clearTimeout(this.$5),this.$2.isOnGoing()&&(this.$5=setTimeout(function(){t.$2.isOnGoing()&&(n==="wa"?t.$2.addPoint(p.WA_STUCK,{waStuck:!0}):t.$2.addPoint(p.MAW_STUCK,{mawStuck:!0}),d.WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Possible stuck reason: ",""])),n))},o("WAGlobals").getConfig().offlineQueueStuckTimeoutMs()))},n.$14=function(){clearTimeout(this.$5)},n.$7=function(){var e=this;o("MawMpsCop").mpsCop().subscribe(function(t){e.$15(t)}),this.$3&&this.$3.subscribe(function(t){e.$15(t)})},n.$15=function(t){switch(t.type){case"maw-infra-start":{if(!this.$2.isOnGoing())break;this.$10("maw"),this.$2.startPoint(p.MAW_INFRA);break}case"maw-infra-end":{if(!this.$2.isOnGoing())break;this.$2.endPoint(p.MAW_INFRA),this.$14(),t.success?this.$2.endSuccess():this.$2.endFail("fail");break}default:}},n.addWAMessage=function(){this.$2.isOnGoing()&&(this.$2.reAnnotate(function(e){var t=e.waMessage;return{waMessage:(t!=null?t:0)+1}}),this.$10("wa"))},n.addMAWEntity=function(t){this.$2.isOnGoing()&&(this.$2.reAnnotate(function(e){var n=e.mawProcessedCount;return{mawProcessedCount:(n!=null?n:0)+t}}),this.$10("maw"))},n.$11=function(t){this.$2.isOnGoing()?this.$2.addPoint(p.WA_CLIENT_INFRA_DUPLICATED_START):(this.$1++,this.$2.startMetric(),this.$4=Math.round(o("WATimeUtils").performanceAbsoluteNow()/1e3)),this.$2.startPoint(p.WA_CLIENT_INFRA,{expectedAppdata:t.appdata,expectedCount:t.count,expectedMessage:t.message,expectedNotification:t.notification,expectedReceipt:t.receipt,mpsStatus:this.$16(),offlineResumeCount:this.$1,waDanglingQueue:o("WAGlobals").getConfig().waDanglingQueue()})},n.$16=function(){return o("MAWMpsGating").isFullMpsEnabled()?"full":"mps"},n.getDetails=function(){var e;return((e=this.$2)==null?void 0:e.getAnnotations())||{}},n.$13=function(t){var e;(e=this.$2)==null||e.reAnnotate(function(e){var n;return{waProcessed:((n=e.waProcessed)!=null?n:0)+t}})},n.addRuntimeErrorDuringOffflineQueue=function(){if(this.$2.isOnGoing()){var e;(e=this.$2)==null||e.reAnnotate(function(e){var t;return{runtimeErrors:((t=e.runtimeErrors)!=null?t:0)+1}})}},n.addDecryptionError=function(){if(this.$2.isOnGoing()){var e;(e=this.$2)==null||e.reAnnotate(function(e){var t;return{decryptErrors:((t=e.decryptErrors)!=null?t:0)+1}})}},n.addRetriesTrack=function(t){if(this.$2.isOnGoing()){var e;(e=this.$2)==null||e.reAnnotate(function(e){var n;return{retries:((n=e.retries)!=null?n:0)+t}})}},n.$12=function(t,n){var e=this;if(!this.$2.isOnGoing()){d.WARN(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Waterflow should start before the start of the processing"])));return}this.$2.reAnnotate(function(r){var o=r.mailboxAgeSec,a=r.maxOffline,i=r.waDownloaded,l=o;return l==null&&t!=null&&(l=e.$4-t,d.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["New mailbox age is ",""])),l)),l!=null&&t!=null&&e.$4-t>l&&(l=e.$4-t,d.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["New mailbox age is ",""])),l)),{mailboxAgeSec:l,maxOffline:Math.max(a!=null?a:0,n),waDownloaded:(i!=null?i:0)+1}})},t})(),f;function g(e,t,n,r){if(f!=null){var o=f;return d.mustfix("Offline sync reported is inited twice"),o}return f=new _(e,t,n,r),f}function h(){return f==null?(d.mustfix("Offline sync reported is not inited"),null):f}l.OfflineMode=m,l.OfflineStages=p,l.makeOfflineQueueMetric=g,l.getOfflineQueueMetric=h}),98);
__d("EncryptedBackupsUploadQueueProcessor",["EBDBMetricsConsistencyOperationEnum","EBEnableUnifiedAttachment","EBLogger","EBMessageProbe","EBUnifyLegacyMediaUpload","EBUploadMessagesFromWorkerMutationDeferred","EBWorkerEBDBApiDeferred","EncryptedBackupsConstructEchoMessages","EncryptedBackupsMediaRestoreProbe","EncryptedBackupsMediaRestoreProbeV2","EncryptedBackupsUploadQueue","EncryptedBackupsUtils","EncryptedBackupsWorkerScheduler","FBLogger","MAWBridge","MAWBridgeUpload","MAWEBLSInWorkerSwitch","MAWEBUploadTrackingUtils","MAWGetMsgByProtocolIdApi","MAWMpsGating","MAWODSProxy","MAWProtobufDeserializers","MAWTraceUtils","MawMpsCop","MpsTypes","Promise","WACommsConnectionState","WAGlobals","WAJids","WAOdsEnums","WAStanzaUtils","WAWaitForUserUnblocked","WorkerScheduler","asyncToGeneratorRuntime","err","getSafeQplErrorMessage","gkx","justknobx","performanceAbsoluteNow","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L,E,k,I,T,D,x,$,P,N,M,w,A,F,O,B=o("EBLogger").EBLogger().tags(["EbUploadQueue"]);function W(){return r("gkx")("1842")}function q(){return r("gkx")("13409")}function U(){return q()?r("justknobx")._("5177"):r("justknobx")._("2368")}var V=new Map;function H(){var e=(O||(O=r("performanceAbsoluteNow")))(),t=!1;for(var n of V.entries()){var a=n[0],i=n[1].addedAtMs;e-i>r("justknobx")._("3472")&&(t=!0,o("MAWEBUploadTrackingUtils").endFailWorkerOnly(a,"message_upload_timeout",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.MESSAGE_UPLOAD_TIMEOUT}}),V.delete(a))}return t}var G=null,z=null,j=null,K=null,Q=null,X=null;function Y(){return Q!=null}function J(){return X}function Z(){return ee.apply(this,arguments)}function ee(){return ee=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){yield o("WAWaitForUserUnblocked").waitForUserUnblocked(),Q==null&&(B.DEBUG(C||(C=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Running..."]))),K!=null&&(B.DEBUG(b||(b=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Cancelling scheduled retry as another process has triggered a run"]))),window.clearTimeout(K),K=null),Q=o("EncryptedBackupsWorkerScheduler").ebScheduler().task({fn:(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(W()&&o("WACommsConnectionState").WACommsConnectionState.isConnected()===!1&&(B.DEBUG(v||(v=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Connection lost during scheduling, waiting for reconnection"]))),yield o("WACommsConnectionState").WACommsConnectionState.waitForConnection(),B.DEBUG(S||(S=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Connection restored, proceeding with upload"])))),o("EBWorkerEBDBApiDeferred").trackConsistency(o("EBDBMetricsConsistencyOperationEnum").EBConsistencyOperation.Upload).then(function(e){return o("MAWBridge").getBridge().fireAndForget("event","trackEbConsistency",{workerDeviceId:e})}),!r("MAWEBLSInWorkerSwitch").isEnabled())return!1;var e=yield de(),t=e.isEmpty;return!t});function t(){return e.apply(this,arguments)}return t})(),name:"eb_upload",priority:o("WorkerScheduler").BACKGROUND_PRIORITY}),Q.run().then(function(e){Q=null,e&&Z()}).catch(function(e){Q=null,B.MUSTFIX(R||(R=babelHelpers.taggedTemplateLiteralLoose([""," cannot process EB upload"])),e),V.forEach(function(t,n,r){o("MAWEBUploadTrackingUtils").endFailWorkerOnly(n,"upload_eb_msgs_error",{string:{comms_status_on_failure:o("WACommsConnectionState").WACommsConnectionState.isConnected()===!0?"connected":"disconnected",error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e),error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.RUNTIME_ERROR,reason:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}),V.clear(),B.DEBUG(L||(L=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Waiting ","ms before scheduling next run due to an error"])),r("justknobx")._("2366")),K=globalThis.setTimeout(n("asyncToGeneratorRuntime").asyncToGenerator(function*(){K=null,W()||o("WACommsConnectionState").WACommsConnectionState.isConnected()===!1&&(B.DEBUG(E||(E=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Network is currently disconneted. Waiting for the network to reconnect before continuing eb upload."]))),yield o("WACommsConnectionState").WACommsConnectionState.waitForConnection(),B.DEBUG(k||(k=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Network has been re-established."])))),B.DEBUG(I||(I=babelHelpers.taggedTemplateLiteralLoose(["[scheduleEB] Finished waiting, scheduling next run"]))),Z()}),r("justknobx")._("2366"))}))}),ee.apply(this,arguments)}function te(){return ne.apply(this,arguments)}function ne(){return ne=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(Q==null)try{var e=o("EncryptedBackupsUploadQueue").ebUploadQueue(),t=yield e.read({limit:1,order:"desc"});t.length>0&&(B.DEBUG(T||(T=babelHelpers.taggedTemplateLiteralLoose(["[checkAndKickstartScheduler] Found "," items in queue, scheduler not running - kickstarting"])),t.length),o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"restart_upload_scheduler"}),Z())}catch(e){var n=o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e);B.WARN(D||(D=babelHelpers.taggedTemplateLiteralLoose(["[checkAndKickstartScheduler] Error checking queue: ",""])),n)}}),ne.apply(this,arguments)}function re(){if(G==null&&(G=globalThis.setInterval(H,5e3)),z==null&&r("gkx")("18463")&&(B.DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] Setting up recurring upload trigger interval"]))),z=globalThis.setInterval(te,r("justknobx")._("4405")||3e4)),W()){j==null&&(B.DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] Setting up WAComms connection subscription"]))),j=o("WACommsConnectionState").WACommsConnectionState.onSet(function(e){e?(B.DEBUG(u||(u=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] WAComms connected, scheduling upload"]))),Z()):B.DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] WAComms disconnected, upload scheduling paused"])))}));var t=o("WACommsConnectionState").WACommsConnectionState.isConnected();if(t)B.DEBUG(_||(_=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] WAComms is connected, scheduling upload"]))),Z();else{B.DEBUG(d||(d=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] WAComms is disconnected, waiting for connection"]))),o("WACommsConnectionState").WACommsConnectionState.waitForConnection().then(function(){B.DEBUG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] WAComms connection restored, scheduling upload"]))),Z()}).catch(function(e){B.WARN(p||(p=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] Error waiting for WAComms connection: ",""])),e)});return}}else B.DEBUG(f||(f=babelHelpers.taggedTemplateLiteralLoose(["[scheduleNextRun] Feature gate disabled, proceeding without network checks"]))),Z()}function oe(){r("MAWEBLSInWorkerSwitch").onSet(function(e){e===!0&&re()}),re();var e=o("EncryptedBackupsUploadQueue").ebUploadQueue();e.subscribe(function(e){e.type==="flush"&&re()})}function ae(e){return ie.apply(this,arguments)}function ie(){return ie=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=yield o("EBUploadMessagesFromWorkerMutationDeferred").uploadMessagesFromWorker(e,"EncryptedBackupsUploadQueueProcessor:fireUploadEvent").then(function(t){return t.success||(B.MUSTFIX(x||(x=babelHelpers.taggedTemplateLiteralLoose(["uploadMessagesFromWorker failed with error: ",""])),t.error),e.forEach(function(e){var n=e.uploadTrackingInstanceKey;if(n!=null){var r;o("MAWEBUploadTrackingUtils").endFailWorkerOnly(n,"gql_upload_runtime_error",{string:{error_description:(r=t.error)!=null?r:"unknown gql upload error"}})}})),t});t.success&&(yield(F||(F=n("Promise"))).all(e.map(function(e){var r=e.uploadTrackingInstanceKey;return r==null?(F||(F=n("Promise"))).resolve():pe(r,t.success)})),X=Date.now())}),ie.apply(this,arguments)}function le(e){return se.apply(this,arguments)}function se(){return se=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=o("EncryptedBackupsUploadQueue").ebUploadQueue(),n=[],r=yield t.read({filter:function(t){return t.sortOrderMs==null||o("EncryptedBackupsUtils").entryOlderThan30Days(t.sortOrderMs)?(n.push(t.queueId),!1):!V.has(o("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(t.msgId))},limit:e,order:"desc"});return yield t.delete(n),r}),se.apply(this,arguments)}function ue(){return ce.apply(this,arguments)}function ce(){return ce=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){for(var e=U();e>0;)try{return yield le(e)}catch(t){if(e===1)throw o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"queue_batch_throw"}),t;o("MAWODSProxy").odsBumpEntityKey({entity:o("WAOdsEnums").Entity.EB_UPLOAD,key:"queue_batch_halved."+e}),e=Math.floor(e/2)}throw r("err")("getNextBatchFromEBUploadQueueWithRetry: Code should not be reachable unless batch size is 0. Starting batch size was "+U())}),ce.apply(this,arguments)}function de(){return me.apply(this,arguments)}function me(){return me=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){var e=yield ue().catch(function(e){throw B.catching(e).MUSTFIX($||($=babelHelpers.taggedTemplateLiteralLoose(["getNextBatchFromEBUploadQueue failed with error"]))),e});if(e.length===0)return{isEmpty:!0};B.DEBUG(P||(P=babelHelpers.taggedTemplateLiteralLoose(["upload queue uploading "," messages"])),e.length);var t=e.map(function(e){var t,n,r,a,i,l,s,u=o("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(e.msgId),c=e.isRetroactiveUpload==null?!1:e.isRetroactiveUpload;return o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(o("MpsTypes").toMessageId(e.msgId.externalId),"message_picked_from_queue",{is_retroactive:c,trigger_source:(t=e.triggerSource)!=null?t:"unknown"}),{bridgeUploadMessage:o("MAWBridgeUpload").createBridgeUploadMessage({actionType:e.backupActionType===3?2:1,attachmentContextArray:e.attachmentContext,echoDocument:void 0,echoEncodingLatencyNs:void 0,errorCode:void 0,errorMessage:void 0,messageId:((n=e.backupDirective)==null?void 0:n.supplementalKey)!=null?(r=e.backupDirective)==null?void 0:r.originalMsgProtocolId.externalId:e.msgId.externalId,protoMsg:{backupActionType:e.backupActionType,msgId:e.msgId,originalMsgProtocolId:(a=e.backupDirective)==null?void 0:a.originalMsgProtocolId,protobuf:e.protobuf,senderId:e.senderId,serverTs:e.serverTs,sortOrderMs:e.sortOrderMs,supplementalKey:(i=e.supplementalKey)!=null?i:(l=e.backupDirective)==null?void 0:l.supplementalKey,tags:e.tags},sortOrderMs:e.sortOrderMs||0,threadId:o("WAJids").threadIdForChatJid(e.msgId.chat),traceId:u.toString(),uploadTrackingInstanceKey:u}),isRetroactiveUpload:c,legacyAttachmentContext:e.legacyAttachmentContext,messageType:e.dbMsgType,queueId:e.queueId,triggerSource:(s=e.triggerSource)!=null?s:"unknown"}}),a=t.filter(function(e){return e.bridgeUploadMessage.actionType===2}),i=t.filter(function(e){return e.bridgeUploadMessage.actionType!==2}),l=r("gkx")("8488");if(l||a.length>0){var s=l?t:a,u=s.length===t.length,c=(O||(O=r("performanceAbsoluteNow")))();for(var d of s){var m,p=d.bridgeUploadMessage,_=d.isRetroactiveUpload,f=d.messageType,g=d.queueId,h=d.triggerSource;p.uploadTrackingInstanceKey!=null&&V.set(p.uploadTrackingInstanceKey,{addedAtMs:c,queueId:g});var y=(m=p.protoMsg)==null?void 0:m.msgId;if(y!=null&&p.uploadTrackingInstanceKey!=null){var C=p.uploadTrackingInstanceKey;o("MAWEBUploadTrackingUtils").startUploadTracking(o("WAStanzaUtils").toStanzaId(p.messageId),o("WAJids").threadIdForChatJid(y.chat),f,h,C,!0,_,p.attachmentBackupContext,"protobuf_only")}}Ce(s.map(function(e){return e.legacyAttachmentContext}).filter(Boolean));var b=s.map(function(e){var t=e.bridgeUploadMessage;return t.uploadTrackingInstanceKey!=null&&o("MAWEBUploadTrackingUtils").addPointWorkerOnly(t.uploadTrackingInstanceKey,"fire_protobuf_only_upload_bridge_event"),t});yield ae(b);for(var v of s){var S=v.bridgeUploadMessage;{var R,L=(R=S.protoMsg)==null?void 0:R.msgId;(L==null?void 0:L.externalId)!=null&&o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(o("MpsTypes").toMessageId(L.externalId),"message_uploaded_via_graphql",{action_type:S.actionType===2?"delete":"upsert",upload_type:"protobuf_only"})}}if(l||u)return{isEmpty:!1}}var E=new Map,k=[],I=[],T=[],D=new Map,x=new Map,M=(O||(O=r("performanceAbsoluteNow")))();for(var w of e){var A;if(w.backupActionType!==3){var W=he(w);if(W==null){r("promiseDone")(o("EncryptedBackupsUploadQueue").ebUploadQueue().ack([w.queueId]));continue}var q=o("MAWEBUploadTrackingUtils").genInstanceKeyForUploadQueue(w.msgId);V.set(q,{addedAtMs:M,queueId:w.queueId}),D.set(W.externalId,(A=w.attachmentContext)!=null?A:T);var U=w.msgId.externalId,H=w.originalMsgProtocolId.externalId;if(U!==H&&x.set(U,{currentExternalId:U,originalMsgExternalId:H}),!E.has(W.externalId)){var G;E.set(W.externalId,q);var z=o("MAWBridgeUpload").createBridgeUploadAttachmentBackupContext(null,"msgr",w.attachmentContext);o("MAWEBUploadTrackingUtils").startUploadTracking(W.externalId,o("WAJids").threadIdForChatJid(W.chat),w.dbMsgType,(G=w.triggerSource)!=null?G:"unknown",q,!0,w.isRetroactiveUpload,z,"dual_upload"),k.push(W),I.push({originalMsgId:W,uploadEntity:w})}}}if(!o("MAWMpsGating").isFullMpsEnabled()){var j=I.map(function(e){if(e.uploadEntity.sortOrderMs==null)return B.warn("Cannot fetch message from MPS, timestampMs field is missing"),null;var t=e.uploadEntity.sortOrderMs;return{direction:"desc",from:[o("MpsTypes").toTimestamp(t),o("MpsTypes").toMessageId(e.uploadEntity.msgId.externalId)],numMessages:1,threadId:o("MpsTypes").toThreadId(e.uploadEntity.msgId.chat)}}),K=yield o("MawMpsCop").mpsCop().loadBatchMsgsIntoMaw({config:{shouldFetchSupplementals:!1,shouldFetchTags:!1,strategy:"local-only"},debug:{purpose:"eb_echo_upload"},ranges:j.filter(Boolean)});K.success||B.warn("Failed to fetch messages from MPS",K.error)}E.forEach(function(e,t){o("MAWEBUploadTrackingUtils").addPointWorkerOnly(e,"queue_get_original_msg_ids_done")});var Q=yield o("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn(k).catch(function(e){var t=k.map(function(t){var a=r("justknobx")._("4483"),i=(F||(F=n("Promise"))).reject(e);return a&&(i=o("MAWGetMsgByProtocolIdApi").getMsgsByProtocolMsgIdsTxn([t]).then(function(e){return e[0]})),i.catch(function(r){var i=E.get(t.externalId);if(i!=null?o("MAWEBUploadTrackingUtils").endFailWorkerOnly(i,"get_db_msgs_error",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.ERROR_FETCHING_DB_MESSAGE,reason:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(r)}}):B.WARN(N||(N=babelHelpers.taggedTemplateLiteralLoose(["Cannot get message from db: ",""])),e),a&&r.name==="EARError"){var l=(F||(F=n("Promise"))).resolve();if(i!=null){var s,u=(s=V.get(i))!=null?s:{queueId:null},c=u.queueId;c!=null&&(l=o("EncryptedBackupsUploadQueue").ebUploadQueue().delete([c]))}return l}return(F||(F=n("Promise"))).reject(r)})});return(F||(F=n("Promise"))).all(t).then(function(e){return e.filter(Boolean)})}),X=Q.map(function(e){return e.externalId}),Y=I.filter(function(e){return!X.includes(e.originalMsgId.externalId)});Y.forEach(function(e){var t=E.get(e.originalMsgId.externalId);if(t!=null){var n;o("MAWEBUploadTrackingUtils").addPointWorkerOnly(t,"missing_entity_in_maw_db",{string:{missing_msg_id:e.originalMsgId.externalId,msg_type:e.uploadEntity.dbMsgType,trigger_source:(n=e.uploadEntity.triggerSource)!=null?n:"unknown"}})}});var J=new Map;Q.forEach(function(e){var t,n=E.get(e.externalId);if(n!=null){o("MAWEBUploadTrackingUtils").addPointWorkerOnly(n,"queue_get_msgs_done");var r=x.get(e.externalId);r!=null&&o("MAWEBUploadTrackingUtils").addPointWorkerOnly(n,"external_id_mismatch",{string:{currentExternalId:r.currentExternalId,differing_ids_type:e.type,originalMsgExternalId:r.originalMsgExternalId}}),J.set(e.externalId,(t=D.get(e.externalId))!=null?t:T)}}),ye(E,k,Q),Ce(i.map(function(e){return e.legacyAttachmentContext}).filter(Boolean));var Z=Q.map(function(e){var t,n=((t=o("MAWEBUploadTrackingUtils").getUploadTrackingInstanceKey(E,e.externalId))!=null?t:o("MAWTraceUtils").createTraceId()).toString();return o("MAWEBUploadTrackingUtils").addUploadTrackingByType("point",E,e.externalId,"construct_echo_start"),o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(o("MpsTypes").toMessageId(e.externalId),"message_dual_upload_started",{msg_type:e.type,upload_type:"dual_upload"}),{dbMsg:e,traceId:n}});return yield o("EncryptedBackupsConstructEchoMessages").uploadMessageFromUploadQueue(Z,E,i.map(function(e){return e.bridgeUploadMessage.protoMsg}).filter(Boolean),J),{isEmpty:!1}}),me.apply(this,arguments)}function pe(e,t){return _e.apply(this,arguments)}function _e(){return _e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n,a=o("EncryptedBackupsUploadQueue").ebUploadQueue();if(t)o("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(e,"upload_queue_ack_worker_success");else{o("MAWEBUploadTrackingUtils").endFailWorkerOnly(e,"upload_queue_ack_worker_fail",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.FAILED_TO_ACK_MESSAGE,reason:"failure to ack upload queue"}}),re();return}var i=(n=V.get(e))!=null?n:{queueId:null},l=i.queueId;l!=null&&(fe(a,l).catch(function(e){r("FBLogger")("wmi").catching(e).mustfix("Failed to probe media restore")}),yield a.ack([l]),V.delete(e),re())}),_e.apply(this,arguments)}function fe(e,t){return ge.apply(this,arguments)}function ge(){return ge=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=yield e.get(t);if(n==null){B.MUSTFIX(M||(M=babelHelpers.taggedTemplateLiteralLoose(["upload queue - uploadEntity was null when attepmting to ack"])));return}var a=n;if(r("gkx")("5680")){if(a.msgType==="media"){var i,l,s=babelHelpers.extends({},a.msgId,{author:o("WAGlobals").getMyUserJid()===a.msgId.author?o("WAJids").AUTHOR_ME:a.msgId.author}),u=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(a.protobuf);o("EncryptedBackupsMediaRestoreProbeV2").sampleProbeMediaRestoreV2({backupMessage:u,chatJid:s.chat,protocolMsgId:s,sortOrderMs:(i=a==null?void 0:a.sortOrderMs)!=null?i:0,stanzaId:s.externalId,triggerSource:(l=a.triggerSource)!=null?l:"unknown"}).catch(function(e){B.MUSTFIX(w||(w=babelHelpers.taggedTemplateLiteralLoose(["Unexpected runtime error in probeMediaRestoreV2: ",""])),e)})}}else{var c,d;o("EncryptedBackupsMediaRestoreProbe").sampleProbeMediaRestore({isRetroactiveUpload:(c=a.isRetroactiveUpload)!=null?c:!1,triggerSource:(d=a.triggerSource)!=null?d:"unknown",uploadEntity:a}).catch(function(e){B.MUSTFIX(A||(A=babelHelpers.taggedTemplateLiteralLoose(["Unexpected runtime error in probeMediaRestore: ",""])),e)})}}),ge.apply(this,arguments)}function he(e){var t=e.originalMsgProtocolId;return t.author==null||t.chat==null?null:{author:o("WAGlobals").getMyUserJid()===t.author?o("WAJids").AUTHOR_ME:t.author,chat:t.chat,externalId:e.backupActionType===4?e.msgId.externalId:e.originalMsgProtocolId.externalId}}function ye(e,t,r){if(t.length>r.length){var a=new Set(t.map(function(e){return e.externalId}));r.forEach(function(t){if(a.has(t.externalId)){a.delete(t.externalId);var n=e.get(t.externalId);n!=null?o("MAWEBUploadTrackingUtils").addPointWorkerOnly(n,"msg_found",{string:{originalMsgType:t.type}}):B.WARN(g||(g=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg found"])))}}),a.forEach((function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=e.get(t);if(n!=null){var r;o("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(n,"upload_queue_msg_not_found");var a=(r=V.get(n))!=null?r:{queueId:null},i=a.queueId;if(V.delete(n),i==null)return;yield o("EncryptedBackupsUploadQueue").ebUploadQueue().delete([i])}else B.WARN(h||(h=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg not found 1"])))});return function(e){return t.apply(this,arguments)}})())}else r.forEach(function(t){var n=e.get(t.externalId);n!=null?o("MAWEBUploadTrackingUtils").addPointWorkerOnly(n,"msg_found",{string:{originalMsgType:t.type}}):B.WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["upload queue - instanceKey not found from uploadTrackingInstanceKeyMap, in checkMsgExist msg found 2"])))})}function Ce(e){if(e.length!==0){var t=[];e.forEach(function(e){e!=null&&e.forEach(function(e){t.push({tag:"UploadAttachment",value:e})})}),t.length>0&&o("EBUnifyLegacyMediaUpload").getEnableUnifyLegacyMediaUpload()&&!o("EBEnableUnifiedAttachment").getEbEnableUnifiedAttachment()&&o("MAWBridge").getBridge().fireAndForget("event","uiUpdate",{events:t})}}l.isEbUploadTaskScheduled=Y,l.getLastSuccessfulAckTimestampMs=J,l.scheduleNextRun=re,l.listenForEbUploadQueueFlush=oe,l.uploadEBMsgs=de,l.ackWithInstanceKeyWorkerOnly=pe,l.buildProtocolMsgIdFromEntity=he}),98);
__d("EncryptedBackupsCreateAttachmentContext",["EBLogger","EncryptedBackupsUploadEntity","MAWProtobufDeserializers","WAMediaTransport.pb","WAMediaUtils","decodeProtobuf"],(function(t,n,r,o,a,i,l){"use strict";var e=o("EBLogger").EBLogger().tags(["labyrinth_web","CreateAttachmentContext"]);function s(t){var n=new Map;try{var r=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t),a=r.encryptedTransportMessage();if(a==null)return e.warn("transport message subprotocol is undefined"),[];var i=d(a);if(i!=null)if(i.type!==o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)c(i,n);else{var l=i.payload;u(l.favicon,n),u(l.headerImage,n),l.previews!=null&&l.previews.forEach(function(e){u(e,n)});var s=l.associatedMessage;if(s!=null&&s.payload!=null){var m=new(o("MAWProtobufDeserializers")).DeserializedMessageApplication(s.payload),p=d(m);p!=null&&c(p,n)}}}catch(t){e.warn("Unable to create attachment context for message")}return Array.from(n.entries()).map(function(e){var t=e[0],n=e[1];return{mediaObjectId:t,mediaType:n}})}function u(e,t){var n;if(e!=null){var r=o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").ImageTransportSpec,e.payload),a=(n=r.integral)==null||(n=n.transport)==null||(n=n.ancillary)==null?void 0:n.objectId;a!=null&&t.set(o("WAMediaUtils").stringToDeliveryObjectId(a),o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA)}}function c(t,n){var r,a,i,l=t.type,s=t.payload,u=s.integral;if((u==null||(r=u.transport)==null||(r=r.ancillary)==null?void 0:r.objectId)==null){e.warn("object id for attachment is null");return}var c=o("WAMediaUtils").stringToDeliveryObjectId(u==null||(a=u.transport)==null||(a=a.ancillary)==null?void 0:a.objectId);n.set(c,l);var d=u==null||(i=u.transport)==null||(i=i.ancillary)==null||(i=i.thumbnail)==null||(i=i.downloadableThumbnail)==null?void 0:i.objectId;if(d!=null&&d!==c){var m=o("WAMediaUtils").stringToDeliveryObjectId(d);n.set(m,o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.MESSENGER_PREVIEW)}}function d(e){var t=e.consumerMessage(),n=e.armadillo();if(t!=null){var r,a,i,l,s,u=t.payload;if((u==null||(r=u.content)==null?void 0:r.imageMessage)!=null){var c;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").ImageTransportSpec,u==null||(c=u.content)==null||(c=c.imageMessage.image)==null?void 0:c.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.IMAGE}}if((u==null||(a=u.content)==null?void 0:a.videoMessage)!=null){var d,m,p,_=o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").VideoTransportSpec,u==null||(d=u.content)==null||(d=d.videoMessage.video)==null?void 0:d.payload);return{payload:_,type:(_==null||(m=_.ancillary)==null?void 0:m.gifPlayback)!==!0||(_==null||(p=_.ancillary)==null?void 0:p.gifAttribution)!=null?o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.GIF:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.VIDEO}}if((u==null||(i=u.content)==null?void 0:i.stickerMessage)!=null){var f;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").StickerTransportSpec,u==null||(f=u.content)==null||(f=f.stickerMessage.sticker)==null?void 0:f.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.STICKER}}if((u==null||(l=u.content)==null?void 0:l.audioMessage)!=null){var g;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").AudioTransportSpec,u==null||(g=u.content)==null||(g=g.audioMessage.audio)==null?void 0:g.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.PTT}}if((u==null||(s=u.content)==null?void 0:s.documentMessage)!=null){var h;return{payload:o("decodeProtobuf").decodeProtobuf(o("WAMediaTransport.pb").DocumentTransportSpec,u==null||(h=u.content)==null||(h=h.documentMessage.document)==null?void 0:h.payload),type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.DOCUMENT}}}if(n!=null){var y,C=n.payload;if((C==null||(y=C.content)==null?void 0:y.extendedContentMessage)!=null){var b;return{payload:C==null||(b=C.content)==null?void 0:b.extendedContentMessage,type:o("EncryptedBackupsUploadEntity").AttachmentContextMediaType.XMA}}}}l.createAttachmentContext=s}),98);
__d("MAWMPSCreateBackupDirective",["EBLogger","MpsMessageToBridgeWrapper","MpsTypes","WAStanzaUtils"],(function(t,n,r,o,a,i,l){"use strict";var e=o("EBLogger").EBLogger().tags(["mps"]);function s(t){switch(t){case o("MpsTypes").ActionType.UpsertTopLevel:return 1;case o("MpsTypes").ActionType.UpsertSupplemental:return 2;case o("MpsTypes").ActionType.DeleteTopLevel:return 3;case o("MpsTypes").ActionType.DeleteTopLevelWithPlaceholder:return 4;case o("MpsTypes").ActionType.DeleteSupplemental:case o("MpsTypes").ActionType.Preprocess:case o("MpsTypes").ActionType.Noop:case o("MpsTypes").ActionType.DeleteThread:case o("MpsTypes").ActionType.Unknown:return e.warn("Action type %d not supported on EB upload",t),0}}function u(t,n){var r=s(t.actionType);if(r===0){e.warn("Unknown EB upload action type - cannot upload message");return}var o={actionType:r,originalMsgProtocolId:n};return t.supplementalKey!=null&&(o=babelHelpers.extends({},o,{supplementalKey:t.supplementalKey})),o}function c(e,t){var n=o("MpsMessageToBridgeWrapper").MpsMessageToBridgeWrapper.fromTopLevel(t);return{author:n.getAuthor(),chat:n.getChatJid(),externalId:o("WAStanzaUtils").toStanzaId(e.targetMessageId)}}l.createBackupDirectiveFromMPSMessage=u,l.getTargetProtocolMsgIdForMessage=c}),98);
__d("WormPersistedQueueSchema",["MAWWormOdsLogger","WAHex","Worm","WormEAR","WormIDbDriver"],(function(t,n,r,o,a,i,l){"use strict";function e(e){return e}var s={autoIncrement:!1,primaryKey:"queueId",secure:!0},u={ebUploadQueueV3:babelHelpers.extends({},s,{indexes:{"[attemptCount+addedAtMs]":{fields:["attemptCount","addedAtMs"],unique:!1}},nonEncryptedFields:["attemptCount","addedAtMs"]})};function c(e,t,n,r,a,i){var l=o("WAHex").parseHex(t),s="worm_pqdb",c=new(o("WormEAR")).WormEAR(u,s,l);return new(o("Worm")).WormDatabase(new(o("WormIDbDriver")).WormIDbDriver(e,s,u,c,o("MAWWormOdsLogger").wormOdsWorkerLogger,{blockingErrorThreshold:n,onBlockingError:r,onTransactionError:a}),i)}l.toWormPersistedQueueId=e,l.makePersistedQueueSchema=c}),98);
__d("WormPersistedQueueDb",["FBLogger","Promise","WAResolvable","WormEAR","WormPersistedQueueSchema","asyncToGeneratorRuntime","err","getErrorSafe","promiseDone"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u=new(o("WAResolvable")).Resolvable;function c(e){return d.apply(this,arguments)}function d(){return d=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=t.blockingErrorThreshold,i=t.dbName,l=t.onBlockingError,c=t.qplEvent,d=t.strEncKey;try{var m=o("WormPersistedQueueSchema").makePersistedQueueSchema(i,d,a,l,function(t){if(t instanceof o("WormEAR").DecryptionError){var a,i,l=t;r("FBLogger")("messenger_web").mustfix("EAR decryption error in store: %s. Dropping corrupted entity",l.store),r("promiseDone")((a=(i=s)==null?void 0:i.runInTransaction([l.store],"readwrite",function(e){var t=e.stores[l.store];return l.maybeHashedPk!=null?t.delete(l.maybeHashedPk):t.clear()},"delete-corrupted-entity"))!=null?a:(e||(e=n("Promise"))).resolve())}},c);return s=m,yield m.init(),u.resolve(m),m}catch(e){throw r("FBLogger")("messenger_web").catching(r("getErrorSafe")(e)).mustfix("Error performing WORM PersistedQueue init"),e}}),d.apply(this,arguments)}function m(){if(s==null)throw r("err")("PersistedQueue is not initialized");return s}function p(){return u.promise}l.makePersistedQueueDb=c,l.getPersistedQueues=m,l.getDbPromise=p}),98);
__d("WormPersistedQueue",["FBLogger","WAPubSub","WormPersistedQueueDb","asyncToGeneratorRuntime","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s=function(){return r("FBLogger")("wmi").tags(["worm-persisted-queue"])},u=36e5,c=(function(){function t(e){this.$1=o("WAPubSub").simplePubSub(),this.$4=0,this.$2=o("WormPersistedQueueDb").getPersistedQueues(),this.$3=e}var a=t.prototype;return a.$5=function(t){return"WormPersistedQueue:"+this.$3+":"+t},a.$6=function(){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.stores[e.$3],r=yield n.readAll({limit:1});r.length===0&&(yield n.clear())});return function(e){return t.apply(this,arguments)}})(),this.$5("clearIfEmpty"))},a.$7=(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(Date.now()-this.$4>u)try{yield this.$6(),this.$4=Date.now()}catch(n){var t=r("getErrorSafe")(n);s().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Error during PersistedQueue cleanup: ",""])),t.message)}});function o(){return t.apply(this,arguments)}return o})(),a.subscribe=function(t){return this.$1.subscribe(t)},a.ack=function(t){return this.delete(t)},a.delete=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=n.stores[e.$3];yield r.bulkDelete(t),e.$7()});return function(e){return r.apply(this,arguments)}})(),this.$5("delete"))},a.read=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readonly",(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=n.stores[e.$3];return yield r.readAll(t)});return function(e){return r.apply(this,arguments)}})(),this.$5("read"))},a.readFromIndex=function(t,r){var e=this;return this.$2.runInTransaction([this.$3],"readonly",(function(){var o=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var o=n.stores[e.$3];return yield o.readIndex(t,void 0,r)});return function(e){return o.apply(this,arguments)}})(),this.$5("readIndex"))},a.add=function(t){return this.put(t)},a.put=function(t){var e=this;return this.$2.runInTransaction([this.$3],"readwrite",(function(){var r=n("asyncToGeneratorRuntime").asyncToGenerator(function*(n){var r=n.stores[e.$3];yield r.bulkPut(t),e.$1.publish({type:"new_entities"})});return function(e){return r.apply(this,arguments)}})(),this.$5("put"))},t})();l.WormPersistedQueue=c}),98);
__d("EncryptedBackupsUploadQueueV3",["EncryptedBackupsMediaRestoreProbeV2","FBLogger","MAWEBSwitch","MAWMPSCreateBackupDirective","MAWProtobufDeserializers","WAGlobals","WAJids","WAStanzaUtils","WATimeUtils","WormPersistedQueue","WormPersistedQueueSchema"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(e,t,n){return o("WormPersistedQueueSchema").toWormPersistedQueueId(e+"."+t+"."+n.toString())}function u(e){var t=e.directive,n=e.message,a=o("WATimeUtils").millisTime(),i=o("MAWMPSCreateBackupDirective").getTargetProtocolMsgIdForMessage(t,n),l=o("MAWMPSCreateBackupDirective").createBackupDirectiveFromMPSMessage(t,i);if(l==null)throw r("FBLogger")("wmi").mustfixThrow("invalid-protobuf-no-backup-directive");return babelHelpers.extends({},n,{addedAtMs:a,attemptCount:0,backupDirective:l,debugInfo:{isRetroactive:!r("MAWEBSwitch").isEnabled()},queueId:s(n.messageId,n.threadId,a)})}var c=function(){return r("FBLogger")("wmi").tags(["eb_upload","upload_queue_v3"])},d=null;function m(){return d==null&&(d=new(o("WormPersistedQueue")).WormPersistedQueue("ebUploadQueueV3")),d}var p=o("WAJids").createJidUtils({platform:"msgr"});function _(t){var n=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t.payload),r=p.toUserJid(t.senderId),a={author:r===o("WAGlobals").getMyUserJid()?o("WAJids").AUTHOR_ME:r,chat:o("WAJids").unsafeCoerceToChatJid(t.threadId),externalId:o("WAStanzaUtils").toStanzaId(t.messageId)};o("EncryptedBackupsMediaRestoreProbeV2").sampleProbeMediaRestoreV2({backupMessage:n,chatJid:a.chat,protocolMsgId:a,sortOrderMs:t.timestampMs,stanzaId:a.externalId,triggerSource:"upload-message-from-mps"}).catch(function(t){c().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Unexpected runtime error in probeMediaRestoreV2: ",""])),t)})}l.uploadEntityFromIncomingPayload=u,l.getUploadQueue=m,l.queryMediaRestoreProbe=_}),98);
__d("EncryptedBackupsUploadQueueV3Scheduler",["EBGenerateMessageTags","EBMessageProbe","EBUploadMessagesFromWorkerMutationDeferred","EncryptedBackupsCreateAttachmentContext","EncryptedBackupsUploadEntity","EncryptedBackupsUploadQueueV3","FBLogger","I64","MAWBridgeUpload","MAWEBLSInWorkerSwitch","MAWEBUploadTrackingUtils","QPLFlow","WAGlobals","WAHashStringToNumber","WAJids","WAStanzaUtils","WATimeUtils","WAWaitForUserUnblocked","WorkerScheduler","asyncToGeneratorRuntime","getErrorSafe","justknobx","performanceAbsoluteNow","qpl","uuidv4"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_=function(){return r("FBLogger")("wmi").tags(["eb_upload","upload_queue_v3_scheduler"])},f=null;function g(){return f!==null}var h;function y(){return h}var C={concurrency:1,maxTaskLimit:1,maxThrottleMs:r("justknobx")._("1453"),timeoutMs:r("justknobx")._("1460")};function b(){r("MAWEBLSInWorkerSwitch").onSet(function(e){e===!0&&v()}),o("EncryptedBackupsUploadQueueV3").getUploadQueue().subscribe(function(e){e.type==="new_entities"&&v()}),v()}function v(){return S.apply(this,arguments)}function S(){return S=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){if(f!=null){_().DEBUG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EB Upload is already running"])));return}if(!r("MAWEBLSInWorkerSwitch").isEnabled()){_().DEBUG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["EB is not enabled"])));return}yield o("WAWaitForUserUnblocked").waitForUserUnblocked();var t=o("QPLFlow").startQPLFlow(r("qpl")._(521475028,"909"));f=o("WorkerScheduler").makeScheduler("EncryptedBackupsUploadQueueV3",C).task({fn:function(){return R(t)},name:"eb_upload_queue_v3",priority:o("WorkerScheduler").BACKGROUND_PRIORITY});try{var n=yield f.run();f=null,n&&v()}catch(e){f=null;var a=r("getErrorSafe")(e);_().FATAL(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Runtime error during EB upload run: ",""])),a.message),t.endFail("runtime_error"),v()}}),S.apply(this,arguments)}function R(e){return L.apply(this,arguments)}function L(){return L=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=[],n=yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().readFromIndex("[attemptCount+addedAtMs]",{filter:function(n){return Date.now()-n.timestampMs>o("WATimeUtils").DAY_MILLISECONDS*30?(t.push(n.queueId),!1):n.attemptCount<r("justknobx")._("1596")},limit:r("justknobx")._("1676"),order:"asc"});if(e.addPoint("retrieved_entries",{int:{entriesCount:n.length}}),t.length>0&&(yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().delete(t),e.addPoint("deleted_expired_entries",{int:{expiredEntriesCount:t.length}})),n.length===0)return e.endSuccess(),!1;_().DEBUG(c||(c=babelHelpers.taggedTemplateLiteralLoose(["upload queue uploading "," messages"])),n.length);var a=[],i=[];for(var l of n){o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(l.messageId,"message_picked_from_queue",{is_retroactive:l.debugInfo.isRetroactive||!1,trigger_source:"upload-message-from-mps"});var s=o("WAHashStringToNumber").hashStringToNumber(r("uuidv4")()),u=D(l,s);a.push(u),i.push(s),o("MAWEBUploadTrackingUtils").startUploadTracking(o("WAStanzaUtils").toStanzaId(l.messageId),o("WAJids").threadIdForChatJid(o("WAJids").unsafeCoerceToChatJid(l.threadId)),void 0,"upload-message-from-mps",s,!0,l.debugInfo.isRetroactive||!1,u.attachmentBackupContext,"protobuf_only",l.attemptCount)}e.addPoint("generated_bridge_upload_messages"),i.forEach(function(e){return o("MAWEBUploadTrackingUtils").addPointWorkerOnly(e,"fire_protobuf_only_upload_bridge_event")});try{var m=yield o("EBUploadMessagesFromWorkerMutationDeferred").uploadMessagesFromWorker(a,"EncryptedBackupsUploadQueueV3");if(e.addPoint("received_upload_response"),m.success){for(var f of n)o("EBMessageProbe").EBMessageProbe.getInstance().addMarkerToItem(f.messageId,"message_uploaded_via_graphql",{action_type:f.backupDirective.actionType,upload_type:"protobuf_only"}),o("EncryptedBackupsUploadQueueV3").queryMediaRestoreProbe(f);yield E(n,i),h=(p||(p=r("performanceAbsoluteNow")))(),e.endSuccess()}else if(yield k(n,i,m.error,!0),e.endFail(m.error),m.error==="user_device_not_enrolled")return!1}catch(t){var g=r("getErrorSafe")(t);_().MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["Runtime error when doing GraphQL upload, ",""])),g.message),yield k(n,i,g.message,!0),e.endFail("graphql_runtime_error")}return!0}),L.apply(this,arguments)}function E(e,t){return t.forEach(function(e){return o("MAWEBUploadTrackingUtils").endSuccessWorkerOnly(e,"upload_queue_ack_worker_success")}),o("EncryptedBackupsUploadQueueV3").getUploadQueue().ack(e.map(function(e){return e.queueId}))}function k(e,t,n,r){return I.apply(this,arguments)}function I(){return I=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t,n,r){if(t.forEach(function(e){return o("MAWEBUploadTrackingUtils").endFailWorkerOnly(e,"upload_queue_ack_worker_"+(r?"retriable":"non_retriable")+"_error",{string:{error_description:o("MAWEBUploadTrackingUtils").EBUploadTrackingWorkerFailurePoints.FAILED_TO_ACK_MESSAGE,reason:n}})}),r){yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().put(e.map(function(e){return babelHelpers.extends({},e,{attemptCount:e.attemptCount+1})}));return}yield o("EncryptedBackupsUploadQueueV3").getUploadQueue().ack(e.map(function(e){return e.queueId}))}),I.apply(this,arguments)}var T=o("WAJids").createJidUtils({platform:"msgr"});function D(e,t){var n=e.backupDirective.actionType===3?e.backupDirective.originalMsgProtocolId.externalId:o("WAStanzaUtils").toStanzaId(e.messageId),r=T.toUserJid(e.senderId),a=o("WAJids").unsafeCoerceToChatJid(e.threadId),i=r===o("WAGlobals").getMyUserJid()?o("WAJids").AUTHOR_ME:r,l={author:i,chat:a,externalId:n},s=o("EncryptedBackupsCreateAttachmentContext").createAttachmentContext(o("EncryptedBackupsUploadEntity").toEbBackupMessageBytes(e.payload)),u=o("MAWBridgeUpload").createBridgeUploadAttachmentBackupContext(void 0,"msgr",s),c=s.map(function(e){return o("EBGenerateMessageTags").generateEBMessageTags(e.mediaType)}).filter(Boolean);return{actionType:e.backupDirective.actionType===3?2:1,attachmentBackupContext:u,authTs:void 0,echoDocument:void 0,echoEncodingLatencyNs:void 0,errorCode:void 0,errorMessage:void 0,messageId:e.backupDirective.originalMsgProtocolId.externalId,messageType:void 0,protoMsg:{backupActionType:e.backupDirective.actionType,msgId:l,originalMsgProtocolId:e.backupDirective.originalMsgProtocolId,protobuf:o("EncryptedBackupsUploadEntity").toEbBackupMessageBytes(e.payload),senderId:(m||(m=o("I64"))).of_string(o("WAJids").userIdFromJid(r)),serverTs:o("WATimeUtils").castMilliSecondsToUnixTime(e.timestampMs),sortOrderMs:o("WATimeUtils").castToMillisTime(e.timestampMs),supplementalKey:e.backupDirective.supplementalKey,tags:c},sortOrderMs:e.timestampMs,threadId:o("WAJids").threadIdForChatJid(a),traceId:t.toString(),uploadTrackingInstanceKey:t}}l.isUploadTaskScheduled=g,l.getLastSuccessfulAckTimestampMs=y,l.subscribeToUploadQueueUpdates=b}),98);
__d("MAWConvertExtendedContentOverlayIconGlyphToXMAGatingType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.INFO:return o("EchoMessageXMAFieldUtils").XMAGatingType.INFO;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.EYE_OFF:return o("EchoMessageXMAFieldUtils").XMAGatingType.EYE_OFF;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NEWS_OFF:return o("EchoMessageXMAFieldUtils").XMAGatingType.NEWS_OFF;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.WARNING:return o("EchoMessageXMAFieldUtils").XMAGatingType.WARNING;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.PRIVATE:return o("EchoMessageXMAFieldUtils").XMAGatingType.PRIVATE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_OVERLAY_ICON_GLYPH.NONE:return o("EchoMessageXMAFieldUtils").XMAGatingType.NONE;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid ExtendedContentOverlayIconGlyph: ",""])),t),o("EchoMessageXMAFieldUtils").XMAGatingType.NONE}}l.convertExtendedContentOverlayIconGlyphToXMAGatingType=s}),98);
__d("MAWConvertExtendedContentTargetTypeToXMATargetType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_MENTION:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_MENTION;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_IMAGE_POST_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_IMAGE_POST_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_MULTIPOST_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_MULTIPOST_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SINGLE_VIDEO_POST_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_SINGLE_VIDEO_POST_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_CLIPS_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_CLIPS_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_IGTV_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_IGTV_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_SHOP_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_SHOP_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_PROFILE_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_PROFILE_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_PHOTO_HIGHLIGHT_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_PHOTO_HIGHLIGHT_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_VIDEO_HIGHLIGHT_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_VIDEO_HIGHLIGHT_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REPLY:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REPLY;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.IG_STORY_REACTION:return o("EchoMessageXMAFieldUtils").XMAContentType.IG_STORY_REACTION;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_REPLY:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_REPLY;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_STORY_MENTION:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_STORY_MENTION;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_VIDEO_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_VIDEO_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_GAMING_CUSTOM_UPDATE:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_GAMING_CUSTOM_UPDATE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PRODUCER_STORY_REPLY:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_PRODUCER_STORY_REPLY;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_EXTERNAL_LINK_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.MSG_EXTERNAL_LINK_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_AUDIO_CALL:return o("EchoMessageXMAFieldUtils").XMAContentType.RTC_AUDIO_CALL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_VIDEO_CALL:return o("EchoMessageXMAFieldUtils").XMAContentType.RTC_VIDEO_CALL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_AUDIO_CALL:return o("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_AUDIO_CALL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_MISSED_VIDEO_CALL:return o("EchoMessageXMAFieldUtils").XMAContentType.RTC_MISSED_VIDEO_CALL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_AUDIO_CALL:return o("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_AUDIO_CALL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.RTC_GROUP_VIDEO_CALL:return o("EchoMessageXMAFieldUtils").XMAContentType.RTC_GROUP_VIDEO_CALL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_EVENT:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_EVENT;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_RECEIVER_FETCH:return o("EchoMessageXMAFieldUtils").XMAContentType.MSG_RECEIVER_FETCH;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_SHORT:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_SHORT;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING:return o("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_LOCATION_SHARING_V2:return o("EchoMessageXMAFieldUtils").XMAContentType.MSG_LOCATION_SHARING_V2;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.MSG_MEMORIES_SHARE:return o("EchoMessageXMAFieldUtils").XMAContentType.MSG_MEMORIES_SHARE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_PROFILE_DIRECTORY_ITEM:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_PROFILE_DIRECTORY_ITEM;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_EXTENDED_CONTENT_TYPE.FB_FEED_POST_REACTION_REPLY:return o("EchoMessageXMAFieldUtils").XMAContentType.FB_FEED_POST_REACTION_REPLY;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid ExtendedContentTargetType: ",""])),t),o("EchoMessageXMAFieldUtils").XMAContentType.NONE}}l.convertExtendedContentTargetTypeToXMATargetType=s}),98);
__d("MAWConvertExtendedContentXMLLayoutTypeToXMALayoutType",["EchoMessageXMAFieldUtils","WAArmadilloXMA.pb","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE:return o("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.PORTRAIT:return o("EchoMessageXMAFieldUtils").XMALayoutType.PORTRAIT;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.HSCROLL:return o("EchoMessageXMAFieldUtils").XMALayoutType.HSCROLL;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.STANDARD_DXMA:return o("EchoMessageXMAFieldUtils").XMALayoutType.STANDARD_DXMA;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.LIST_DXMA:return o("EchoMessageXMAFieldUtils").XMALayoutType.LIST_DXMA;case o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.GRID:return o("EchoMessageXMAFieldUtils").XMALayoutType.GRID;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid ExtendedContentXMLLayoutType: ",""])),t),o("EchoMessageXMAFieldUtils").XMALayoutType.SINGLE}}l.convertExtendedContentXMLLayoutTypeToXMALayoutType=s}),98);
__d("MAWGetAttachmentTypeForServerMediaType",["EchoMessageMediaFieldUtils","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case"image":return o("EchoMessageMediaFieldUtils").AttachmentType.IMAGE;case"video":return o("EchoMessageMediaFieldUtils").AttachmentType.VIDEO;case"ptt":return o("EchoMessageMediaFieldUtils").AttachmentType.PTT;case"gif":return o("EchoMessageMediaFieldUtils").AttachmentType.GIF;case"sticker":return o("EchoMessageMediaFieldUtils").AttachmentType.STICKER;case"xma-image":return o("EchoMessageMediaFieldUtils").AttachmentType.XMA;case"document":return o("EchoMessageMediaFieldUtils").AttachmentType.DOCUMENT;default:return o("WALogger").WARN(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid AttachmentType: ",""])),t),null}}l.getAttachmentTypeForServerMediaType=s}),98);
__d("MAWGetMediaAttachmentTypeForServerMediaType",["EchoMessageMediaFieldUtils","WALogger"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(t){switch(t){case"image":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.IMAGE;case"video":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.VIDEO;case"ptt":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.PTT;case"gif":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.GIF;case"sticker":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER;case"audio":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.AUDIO;case"document":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.DOCUMENT;case"ppic":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.PROFILE_PICTURE;case"md-app-state":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.APP_STATE;case"md-msg-hist":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.HISTORY_SYNC;case"thumbnail-image":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_IMAGE;case"thumbnail-video":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_VIDEO;case"thumbnail-gif":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_GIF;case"thumbnail-document":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_DOCUMENT;case"thumbnail-link":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.THUMBNAIL_LINK;case"novi-video":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.NOVI_VIDEO;case"novi-image":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.NOVI_IMAGE;case"xma-image":return o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.XMA_IMAGE;default:return o("WALogger").ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["[labyrinth_web] Not a valid EchoMessageActMediaAttachmentType: ",""])),t),null}}l.getMediaAttachmentTypeForServerMediaType=s}),98);
__d("MAWGetPreviewContentTypeForMediaType",["EchoMessageMediaFieldUtils"],(function(t,n,r,o,a,i,l){"use strict";function e(e){switch(e){case"image":return o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG;case"gif":return o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.GIF;case"sticker":return o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER;case"video":return o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_MP4;case"ptt":return o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.AUDIO_WAV;case"xma-image":return o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.IMAGE_JPEG;default:return null}}l.getPreviewContentTypeForMediaType=e}),98);
__d("MAWUploadMessageTxns",["EBLogger","EchoCommonUtils","EchoEncodingUtils","EchoMessage","EchoMessageMediaFieldUtils","EchoMessageQuoteFieldUtils","EncryptedBackupsConstructEchoMessages","LSEBPayloadSerializerError","LSMEBTaskCreationSource","MAWBridgeEventTransmitter","MAWConvertExtendedContentOverlayIconGlyphToXMAGatingType","MAWConvertExtendedContentTargetTypeToXMATargetType","MAWConvertExtendedContentXMLLayoutTypeToXMALayoutType","MAWDbEditMsgHistoryTxns","MAWDbMediaTxns","MAWDbMsg","MAWDbMsgTxns","MAWDbMsgUtil","MAWDbReactionsTxns","MAWDbReceiverFetchTxns","MAWDbXMATxns","MAWDexieTable","MAWGetAttachmentTypeForServerMediaType","MAWGetMediaAttachmentTypeForServerMediaType","MAWGetPreviewContentTypeForMediaType","MAWJidUtils","MAWJids","MAWMessageSortOrderUtils","MAWMsgType","MAWUserJidWrapper","MAWVault","MAWXMAUtils","WAArmadilloXMA.pb","WABase64","WAJids","WAMediaUtils","WATimeUtils","getErrorSafe"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m="You unsent a message";function p(e){switch(e.specialTextSize){case 1:return o("EchoMessage").MessageTextSize.SMALL;case 2:return o("EchoMessage").MessageTextSize.MEDIUM;case 3:return o("EchoMessage").MessageTextSize.LARGE;default:return o("EchoMessage").MessageTextSize.NONE}}function _(t,n){return o("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(t,o("MAWJidUtils").maybeToProtocolMsgId(n.author,n.threadJid,n.externalId)).then(function(a){return a!=null?a.previewMediaIds!=null?o("MAWDexieTable").dexieAll(a.previewMediaIds.map(function(e){return o("MAWDbMediaTxns").maybeGetMediaFromMediaId(t,e)})).then(function(e){for(var t of e)if(t==null)return o("MAWDexieTable").dexieResolve({maybeErrorDetail:{errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"constructEchoMessage: DbMedia is null for the XMA message",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.WARN},xmaData:void 0});return S(a)}):S(a):(o("EBLogger").EBLogger().MUSTFIX(e||(e=babelHelpers.taggedTemplateLiteralLoose(["No XMA object found for msg with external id ",". Cannot upload XMA"])),n.externalId),o("MAWDexieTable").dexieResolve({maybeErrorDetail:{errorCode:r("LSEBPayloadSerializerError").UNKNOWN_ERROR,errorMsg:"constructEchoMessage: no xma object found for msg with external id "+n.externalId,uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.WARN},xmaData:void 0}))})}function f(e,t){try{return o("MAWDbMsg").isMediaMsg(e)||e.type===o("MAWMsgType").MSG_TYPE.XMA||e.type===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH}catch(e){var n=r("getErrorSafe")(e),a="[labyrinth_web] Invalid msg type for isMediaMsg check: "+String(e);return o("EBLogger").EBLogger().catching(n).MUSTFIX(s||(s=babelHelpers.taggedTemplateLiteralLoose(["",""])),a),t.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:a,uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},!1}}function g(e,t){return{echoMessage:null,externalId:e,maybeErrorDetail:{errorCode:r("LSEBPayloadSerializerError").NOT_IMPLEMENTED,errorMsg:t,uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.WARN}}}function h(e,t,n){var r=o("MAWDexieTable").dexieResolve(n.threadJid),a={mediaMetadata:null,previewMetadata:null},i=f(n,a),l=i?b(e,n):o("MAWDexieTable").dexieResolve(a),s=v(e,n),u=n.quote!=null?T(e,n.quote,r,t):o("MAWDexieTable").dexieResolve(),c=o("MAWDbMsg").isXMAMsg(n)?_(e,n):o("MAWDexieTable").dexieResolve(null),d=o("MAWDbEditMsgHistoryTxns").getEditHistoryAsEchoWithJidPromise(e,n.externalId,n.author,r);return{editHistoryPromise:d,mediaMetadataUploadPromise:l,quotedMsgPromise:u,reactionsPromise:s,threadJidPromise:r,xmaDataUploadRequestPromise:c}}function y(e,t,n,r,a,i,l,s){var c,d,_=o("WAJids").threadIdForChatJid(e),f=l.serverTs,g=(c=l.editCount)!=null?c:0;i.length>0&&i.length-1!==l.editCount&&(o("EBLogger").EBLogger().WARN(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Edit history has length ",", but edit count on message is ",""])),i.length,l.editCount),g=i.length-1);var h={authoritativeTimestampMs:f!=null?f*1e3:void 0,contentSubtype:o("EchoMessage").EchoMessageContentSubtype.NONE,contentType:o("EchoMessage").EchoMessageContentType.TEXT,displayTimestampMs:l.ts*1e3,editCount:g,editHistory:i,from:o("EchoCommonUtils").craftEchoAddress(null,s,"AdvancedCrypto"),groupId:l.groupId,groupIndex:l.groupIndex,groupSize:l.groupSize,isForwarded:l.isForwarded,messageId:l.externalId,serializationOrigin:o("EchoMessage").EchoSerializationOriginType.WEB,sortOrderMs:o("MAWMessageSortOrderUtils").generateAuthoritativeMessageSortOrder(l),textSize:p(l),threadId:_,version:o("EchoMessage").ECHO_MESSAGE_MIGRATION_DOCUMENT_VERSION,xContentType:o("EchoEncodingUtils").convertDbMsgTypeToXMessageContentType(l.type),xMessagePlaceholderType:o("EchoMessage").EchoMessagePlaceholderType.NO_PLACEHOLDER,xOfflineThreadingId:l.externalId,xThreadId:_};if(((d=l.msgContent)==null?void 0:d.content)!=null&&(h=babelHelpers.extends({},h,{text:o("MAWVault").unvault(l.msgContent.content)})),l.type===o("MAWMsgType").MSG_TYPE.REVOKED&&(h.contentType=o("EchoMessage").EchoMessageContentType.PLACEHOLDER,h.contentSubtype=o("EchoMessage").EchoMessageContentSubtype.UNSEND,h.revokeSentTimestampMs=l.originalTs,h.revokeUnsentTimestampMS=l.unsendMsgContentDeleteTs,h.text=m),r!=null){var y=I(r),C=o("MAWXMAUtils").isXMAStoryReply(r.xmaMessageType)?D(y.senderId,e):y.senderId,b=o("EchoCommonUtils").craftEchoAddress(null,C,"AdvancedCrypto");r.sortOrderMs!=null&&(h.quoteData={quoteMessageId:r.externalId,quoteMessageSender:b,quoteSortOrderInMs:r.sortOrderMs,replyType:l.type===o("MAWMsgType").MSG_TYPE.BUMP_EXISTING_MESSAGE?o("EchoMessageQuoteFieldUtils").EchoMessageQuoteReplyType.BUMP:void 0,status:o("EchoMessageQuoteFieldUtils").EchoMessageQuoteStatus.VALID})}if(o("MAWMsgType").isMAWSupportedMediaType(l.type)){var v=t.mediaMetadata;if(v!=null){h=babelHelpers.extends({},h,{contentType:o("EchoMessage").EchoMessageContentType.MEDIA,mediaData:v});var S=t.previewMetadata;S!=null&&(h=babelHelpers.extends({},h,{previewMediaData:S}))}else if(l.type!==o("MAWMsgType").MSG_TYPE.XMA)return{echoMessage:h,externalId:l.externalId,maybeErrorDetail:t.maybeErrorDetail}}if(a!=null&&a.xmaData!=null&&l.type===o("MAWMsgType").MSG_TYPE.XMA){var R;if(h.xmaData=a.xmaData,h.contentType=o("EchoMessage").EchoMessageContentType.XMA,h.mediaData==null&&((R=a.xmaData)==null?void 0:R.xmaDefaultCTA)!=null&&h.text==null){var L;h.text=(L=a.xmaData)==null?void 0:L.xmaDefaultCTA}}else if(a!=null&&a.xmaData==null&&l.type===o("MAWMsgType").MSG_TYPE.XMA)return{echoMessage:h,externalId:l.externalId,maybeErrorDetail:a.maybeErrorDetail};return l.type===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH&&(h.receiverFetchId=l.receiverFetchId),{echoMessage:babelHelpers.extends({},h,n),externalId:l.externalId}}function C(e,t){return o("MAWDexieTable").dexieAll(t.map(function(t){var n=t.dbMsg,r=t.quotedMsg;if(!o("MAWMsgType").isEBSupportedMsgType(n.type))return o("MAWDexieTable").dexieResolve(g(n.externalId,'constructEchoMessage: "'+String(n.type)+'" NYI'));if(n.serverTs==null)return o("MAWDexieTable").dexieResolve(g(n.externalId,'constructEchoMessage: "'+String(n.type)+'" Not authoritative msg. '));var a=o("WATimeUtils").castToUnixTime(0);if(n.serverTs===a||n.serverTs==null&&n.ts===a){var i="constructEchoMessage: Invalid timestamp - timestamp for message corresponds to 1/1/1970";return o("EBLogger").EBLogger().MUSTFIX(c||(c=babelHelpers.taggedTemplateLiteralLoose(["",""])),i),o("MAWDexieTable").dexieResolve(g(n.externalId,i))}var l=I(n),s=l.senderId,u=h(e,r,n),d=u.editHistoryPromise,m=u.mediaMetadataUploadPromise,p=u.quotedMsgPromise,_=u.reactionsPromise,f=u.threadJidPromise,C=u.xmaDataUploadRequestPromise;return o("MAWDexieTable").dexieAll([f,m,_,p,C,d]).then(function(e){var t=e[0],r=e[1],o=e[2],a=e[3],i=e[4],l=e[5];return y(t,r,o,a,i,l,n,s)})}))}function b(e,t){var n={mediaMetadata:null,previewMetadata:null};if(t.type===o("MAWMsgType").MSG_TYPE.XMA)return o("MAWDbXMATxns").maybeGetXMAFromProtocolMsgId(e,o("MAWJidUtils").maybeToProtocolMsgId(t.author,t.threadJid,t.externalId)).then(function(t){return t!=null?R(e,t):(n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] Media meta data couldn't be created for XMA because DbXMA is not in IndexedDB. This probably means the XMA message was not sent properly by ChatX.",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},o("MAWDexieTable").dexieResolve(n))});if(t.type===o("MAWMsgType").MSG_TYPE.RECEIVER_FETCH)return t.receiverFetchId==null?(n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No receiver fetch id found in a receiver fetch msg",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},o("MAWDexieTable").dexieResolve(n)):o("MAWDbReceiverFetchTxns").maybeGetReceiverFetchInfoFromReceiverFetchId(e,t.receiverFetchId).then(function(e){return e==null?(n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No corresponding receiver fetch info found for receiver fetch msg",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},o("MAWDexieTable").dexieResolve(n)):o("MAWDexieTable").dexieResolve(x(e))});if(!o("MAWMsgType").isMAWSupportedMediaType(t.type))return n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").NOT_SUPPORTED_ON_WEB,errorMsg:"[labyrinth_web] Media type is not supported for msg, type: "+t.type,uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.WARN},o("MAWDexieTable").dexieResolve(n);if(t.mediaId==null)return n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No media id found in a media msg",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},o("MAWDexieTable").dexieResolve(n);var a=o("WATimeUtils").DAY_SECONDS*28,i=t.serverTs;return i!=null&&o("WATimeUtils").unixTime()-i>a?(n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] Media is older than 28 days and is not being uploaded.",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.WARN},o("MAWDexieTable").dexieResolve(n)):o("MAWDbMediaTxns").maybeGetMediaFromMediaId(e,t.mediaId).then(function(e){return e?o("MAWDexieTable").dexieResolve(L(t.msgId,e,!1)):(n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No media db entry for media id",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},o("MAWDexieTable").dexieResolve(n))})}function v(e,t){var n=o("MAWDbMsgUtil").getProtocolMsgIdFromDbMsg(t);return n==null?o("MAWDexieTable").dexieResolve():o("MAWDbReactionsTxns").getReactionForEcho(e,n).then(function(e){if(e!=null&&e.length>0){var t=o("WAJids").extractUserId(o("MAWUserJidWrapper").getMyUserJid()),n=e.map(function(e){var n=o("WAJids").authorToUserId(e.author,t);return o("EchoCommonUtils").craftEchoAddress(e.reaction,n,"AdvancedCrypto")}),r=e.map(function(e){var n=o("WAJids").authorToUserId(e.author,t);return o("EchoCommonUtils").craftEchoAddress((e.ts*1e3).toString(),n,"AdvancedCrypto")}),a=e.map(function(e){var n=o("WAJids").authorToUserId(e.author,t);return o("EchoCommonUtils").craftEchoAddress(e.externalId.toString(),n,"AdvancedCrypto")});return{reactionAuthoritativeTimestampMs:r,reactions:n,reactionXOfflineThreadingIds:a}}})}function S(e){var t={xmaData:null};if(e.isTombstoned==null)return t.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no isTombstoned to construct XMAData",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},t;var n={xmaContentRef:e.contentRef,xmaDataclass:e.xmaDataclass,xmaHeaderSubtitle:e.overlayTitle,xmaHeaderTitle:e.headerTitle,xmaIsTombstoned:e.isTombstoned,xmaMaxSubtitleNumLines:e.maxSubtitleNumOfLines,xmaMaxTitleNumLines:e.maxTitleNumOfLines,xmaSubtitleText:e.subtitleText,xmaTargetExpiry:e.targetExpiringAtSec,xmaTargetId:e.targetId,xmaTargetUsername:e.targetUsername,xmaTitleText:e.titleText},a=e.xmaLayoutType||o("WAArmadilloXMA.pb").EXTENDED_CONTENT_MESSAGE_XMA_LAYOUT_TYPE.SINGLE;return n=babelHelpers.extends({},n,{xmaLayoutType:o("MAWConvertExtendedContentXMLLayoutTypeToXMALayoutType").convertExtendedContentXMLLayoutTypeToXMALayoutType(a)}),e.targetType!=null&&(n=babelHelpers.extends({},n,{xmaTargetType:o("MAWConvertExtendedContentTargetTypeToXMATargetType").convertExtendedContentTargetTypeToXMATargetType(e.targetType)})),e.overlayIconGlyph!=null&&(n=babelHelpers.extends({},n,{xmaGatingType:o("MAWConvertExtendedContentOverlayIconGlyphToXMAGatingType").convertExtendedContentOverlayIconGlyphToXMAGatingType(e.overlayIconGlyph)})),e.defaultCTA!=null&&e.defaultCTA.nativeUrl!=null&&(n=babelHelpers.extends({},n,{xmaDefaultCTA:e.defaultCTA.nativeUrl})),t.xmaData=n,t}function R(e,t){var n={mediaMetadata:null,previewMetadata:null};if(t.previewMediaIds!=null){var a=t.previewMediaIds[0];return o("MAWDbMediaTxns").maybeGetMediaFromMediaId(e,a).then(function(e){if(!e)return n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No media db entry for media id to be used for xma",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.WARN},o("MAWDexieTable").dexieResolve(n);var a=t.msgId;return a==null?(n.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] No message id found in a xma msg",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},o("MAWDexieTable").dexieResolve(n)):o("MAWDexieTable").dexieResolve(L(a,e,!0))})}else return o("MAWDexieTable").dexieResolve(n)}function L(e,t,n,a){var i,l={mediaMetadata:null,previewMetadata:null},s=(i=t.mediaEntries)==null?void 0:i.get(e);if(s==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no media entry to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var u=o("WAMediaUtils").decodeMediaEntryData(s),c=(u==null?void 0:u.objectId)!=null?o("WAMediaUtils").stringToDeliveryObjectId(u.objectId):null;if(c==null)return o("EBLogger").EBLogger().MUSTFIX(d||(d=babelHelpers.taggedTemplateLiteralLoose(["no objectId to construct mediaMetadata isXMA: ",""])),n),l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no objectId to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var m=o("MAWGetAttachmentTypeForServerMediaType").getAttachmentTypeForServerMediaType(u.serverMediaType);if(m==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no attachment type to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var p=u.mediaKey;if(p==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no mediaKey to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var _=u.mediaKeyTimestamp;if(_==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no mediaKeyTimestamp to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var f=u.directPath;if(f==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no directPath to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;if(u.serverMediaType==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no mediaContentType to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var g=n?"image/jpeg":o("WAMediaUtils").getMimeTypeFromServerMediaType(u.serverMediaType),h=o("MAWGetMediaAttachmentTypeForServerMediaType").getMediaAttachmentTypeForServerMediaType(u.serverMediaType);if(h==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no xAttachmentType to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;if(u.serverMediaType!=null&&u.serverMediaType in{gif:1,image:1,sticker:1}&&t.validatedImageInfo==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no imageinfo to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;if(u.serverMediaType==="video"&&t.validatedVideoInfo==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no videoinfo to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;if(u.serverMediaType==="ptt"&&t.validatedAudioInfo==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no audioinfo to construct mediaMetadata",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;if(u.fileSha256==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no WA fileSha256 found",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var y=o("WABase64").encodeB64UrlSafe(u.fileSha256);if(u.fileEncSha256==null)return l.maybeErrorDetail={errorCode:r("LSEBPayloadSerializerError").MEDIA_INFO_INVALID,errorMsg:"[labyrinth_web] no WA fileEncSha256 found",uploadErrorType:o("EncryptedBackupsConstructEchoMessages").UploadErrorType.FATAL},l;var C=o("WABase64").encodeB64UrlSafe(u.fileEncSha256),b=null,v=null,S=null,R=null,L=null,I=void 0,T=o("MAWGetPreviewContentTypeForMediaType").getPreviewContentTypeForMediaType(u.serverMediaType);if(t.validatedImageInfo!=null){var D,x,$,P;b=(D=t.validatedImageInfo.width)!=null?D:0,v=(x=t.validatedImageInfo.height)!=null?x:0,R=($=t.validatedImageInfo.jpegThumbnailWidth)!=null?$:0,L=(P=t.validatedImageInfo.jpegThumbnailHeight)!=null?P:0}if(t.validatedVideoInfo!=null){var N,M,w,A,F;b=(N=t.validatedVideoInfo.width)!=null?N:0,v=(M=t.validatedVideoInfo.height)!=null?M:0,R=(w=t.validatedVideoInfo.jpegThumbnailWidth)!=null?w:0,L=(A=t.validatedVideoInfo.jpegThumbnailHeight)!=null?A:0,S=(F=t.validatedVideoInfo.duration)!=null?F:0}if(t.validatedAudioInfo!=null){var O;S=(O=t.validatedAudioInfo.duration)!=null?O:0}t.validatedDocumentFileInfo!=null&&(I=t.validatedDocumentFileInfo.filename);var B={attachmentObjectId:c,attachmentType:m,directPath:f,encryptedHash:C,mediaBackupStatus:"success",mediaContentType:g,mediaKey:o("EchoEncodingUtils").convertMediaKeyToString(p),mediaKeyTimestamp:_,plaintextHash:y,size:t.size,xAttachmentType:h,xContentType:"full"},W=null,q=u.downloadableThumbnail;if((q==null?void 0:q.objectId)!=null){W={attachmentObjectId:q.objectId,attachmentType:o("EchoMessageMediaFieldUtils").AttachmentType.IMAGE,directPath:f,encryptedHash:C,mediaBackupStatus:"success",mediaContentType:"image/jpeg",mediaKey:o("EchoEncodingUtils").convertMediaKeyToString(p),mediaKeyTimestamp:_,plaintextHash:y,size:t.size,xAttachmentType:o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.MESSENGER_PREVIEW,xContentType:"preview"};var U=q.fileSha256!=null?o("WABase64").encodeB64UrlSafe(q.fileSha256):null,V=q.fileEncSha256!=null?o("WABase64").encodeB64UrlSafe(q.fileEncSha256):null,H=q.mediaKey!=null?o("EchoEncodingUtils").convertMediaKeyToString(p):null;W=k(W,q.directPath,V,U,H,q.mediaKeyTimestamp)}return B=E(B,null,T,b,v,S,R,L,I),{mediaMetadata:B,previewMetadata:W}}function E(e,t,n,r,o,a,i,l,s){var u=e;return t!=null&&(u=babelHelpers.extends({},u,{backupEntFbid:t})),n!=null&&(u=babelHelpers.extends({},u,{previewContentType:n})),r!=null&&(u=babelHelpers.extends({},u,{width:r})),o!=null&&(u=babelHelpers.extends({},u,{height:o})),a!=null&&(u=babelHelpers.extends({},u,{mediaPlayableDuration:a*1e3})),i!=null&&(u=babelHelpers.extends({},u,{previewContentWidth:i})),l!=null&&(u=babelHelpers.extends({},u,{previewContentHeight:l})),s!=null&&(u=babelHelpers.extends({},u,{filename:s})),u}function k(e,t,n,r,o,a){var i=e;return t!=null&&(i=babelHelpers.extends({},i,{directPath:t})),n!=null&&(i=babelHelpers.extends({},i,{encryptedHash:n})),r!=null&&(i=babelHelpers.extends({},i,{plaintextHash:r})),o!=null&&(i=babelHelpers.extends({},i,{mediaKey:o})),a!=null&&(i=babelHelpers.extends({},i,{mediaKeyTimestamp:a})),i}function I(e){var t=o("WAJids").authorToUserId(e.author,o("WAJids").userIdFromJid(o("MAWUserJidWrapper").getMyUserJid())),n=o("MAWJids").toUserJid(t);return{senderId:t,senderJid:n}}function T(e,t,n,a){var i=t.content.msgId,l=t.content.externalId;return a!=null?o("MAWDexieTable").dexieResolve(a):o("MAWDbMsgTxns").maybeGetMsg(e,i).then(function(e){return e==null?n.then(function(e){return o("MAWBridgeEventTransmitter").issuePointQueryOutsideTxn(l,r("LSMEBTaskCreationSource").POINT_QUERY_FROM_EB,e),null}):o("MAWDexieTable").dexieResolve(e)})}function D(e,t){var n=o("WAJids").extractUserId(o("MAWUserJidWrapper").getMyUserJid()),r=o("WAJids").interpretAsUserJid(t);if(r==null)throw o("EBLogger").EBLogger().mustfixThrow("this is a flow check, participant jid can not be null");return e===n?o("WAJids").extractUserId(r):n}function x(e){return{mediaMetadata:{attachmentObjectId:e.receiverFetchId,attachmentType:o("EchoMessageMediaFieldUtils").AttachmentType.STICKER,directPath:"",encryptedHash:null,height:e.previewHeight,mediaContentType:"image/webp",plaintextHash:e.receiverFetchId,previewContentHeight:e.previewHeight,previewContentType:o("EchoMessageMediaFieldUtils").EchoMessageMediaPreviewType.STICKER,previewContentWidth:e.previewWidth,width:e.previewWidth,xAttachmentType:o("EchoMessageMediaFieldUtils").EchoMessageActMediaAttachmentType.STICKER,xContentType:o("EchoMessage").EchoXMessageContentType.STICKER},previewMetadata:null}}l.constructEchoMessage=C,l.constructXMAData=S,l.constructMediaMetadata=L,l.setConditionalFields=E}),98);
__d("EBMinosWasmDecryptAndVerifyMessage",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.plaintext;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToDecryptedMessage(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.cipherText,r=t.mekKey,a=t.messageEncryptionVersion,i=t.metadata,l=t.signature,s=t.transportSigningPK;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosDecryptAndVerifyMessageResultSpec,validateResult:e},{decryptAndVerifyMessage:{encryptedMessageCiphertext:n,encryptedMessageSignature:l,mek:r,messageEncryptionVersion:a,metadata:i,transportSigningPk:s}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.decryptAndVerifyMessage=s}),98);
__d("EBMinosWasmDecryptMekForDistribution",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){return e.success!=null?o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastMekKey(e.success.mek)):o("WAResultOrError").makeError({errorName:"wasm-internal-invalid-result-type",failReason:e.errorMessage})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.encryptedMek,r=t.mailboxAuthPk,a=t.mailboxEncSk,i=t.mekEncryptionVersion,l=t.mekId,s=t.recipientEpochHead,u=t.rosterHash,c=t.senderEpochHead;return yield o("EBMinosWasmReactorSingleton").minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DecryptMekForDistributionResultSpec,validateResult:e},{decryptMekForDistribution:{ciphertext:n,fromPk:r,mekEncryptionVersion:i,mekId:l,rosterHash:u,senderEpochHead:c,toEpochHead:s,toMailboxSk:a}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.decryptMekForDistribution=s}),98);
__d("EBMinosWasmDecryptMekForDistributionFromTransportSender",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){return e.success!=null?o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastMekKey(e.success.mek)):o("WAResultOrError").makeError({errorName:"wasm-internal-invalid-result-type",failReason:e.errorMessage})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.mekDistribution,r=t.mekEncryptionVersion,a=t.mekId,i=t.recipientEncSk,l=t.rosterHash;return yield o("EBMinosWasmReactorSingleton").minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DecryptMekForDistributionFromTransportSenderResultSpec,validateResult:e},{decryptMekForDistributionFromTransportSender:{mekDistribution:n,mekId:a,recipientEncSk:i,rosterHash:l,version:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.createMinosWasmDecryptMekForDistributionFromTransportSender=e,l.decryptMekForDistributionFromTransportSender=s}),98);
__d("EBMinosWasmDeriveMailboxEncryptionKeypair",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.mailboxEncryptionPrivateKey,n=e.mailboxEncryptionPublicKey;return o("WAResultOrError").makeResult({pk:o("EBMinosTypes").unsafeCastToMailboxEncryptionPK(n),sk:o("EBMinosTypes").unsafeCastToMailboxEncryptionSK(t)})}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochNumber,r=t.exportRootKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").DeriveMailboxEncryptionKeypairResultSpec,validateResult:e},{deriveMailboxEncryptionKeypair:{epochNumber:n,exportRootKey:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.deriveMailboxEncryptionKeypair=s}),98);
__d("EBMinosWasmEncryptAndSignMessage",["EBMinosClientConfig","EBMinosLogger","EBMinosMessageEncryptionVersion","EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){function t(t){var n=t.ciphertext,r=t.signature,a=t.version,i=o("EBMinosMessageEncryptionVersion").MinosMessageEncryptionVersion.cast(a);return i==null?(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to cast message encryption version: ",""])),a),o("WAResultOrError").makeError("invalid-message-encryption-version")):o("WAResultOrError").makeResult({encryptedMsg:o("EBMinosTypes").unsafeCastToEncryptedMessage(n),signature:o("EBMinosTypes").unsafeCastToEncryptedMessageSignature(r),version:i})}return(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var n=e.mekKey,r=e.metadata,a=e.plaintext,i=e.transportSigningPK,l=e.transportSigningSK;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosEncryptAndSignMessageResultSpec,validateResult:t},{encryptAndSignMessage:{conf:o("EBMinosClientConfig").MINOS_CLIENT_CONFIG,mek:n,metadata:r,plaintext:a,transportSigningPk:i,transportSigningSk:l}})});function r(t){return e.apply(this,arguments)}return r})()}var u=s();l.encryptAndSignMessage=u}),98);
__d("EBMinosWasmGenerateMekRosterHash",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.rosterHash;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastMekRosterHash(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.epochHeads;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").GenerateMekRosterHashResultSpec,validateResult:e},{generateMekRosterHash:{epochHeads:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.generateMekRosterHash=s}),98);
__d("EBMinosWasmWrapTransportSigningPublicKey",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.prefixedKey;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToTransportSigningPK(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.signalIdentityPublicKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").WrapTransportSigningPublicKeyResultSpec,validateResult:e},{wrapTransportSigningPublicKey:{keyBytes:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.wrapTransportSigningPublicKey=s}),98);
__d("EBMinosWasmWrapTransportSigningSecretKey",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.prefixedKey;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToTransportSigningSK(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.signalIdentityPrivateKey;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").WrapTransportSigningSecretKeyResultSpec,validateResult:e},{wrapTransportSigningSecretKey:{keyBytes:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.wrapTransportSigningSecretKey=s}),98);
__d("EBMinosWrapTransportSigningKeypair",["EBMinosLogger","EBMinosWasmWrapTransportSigningPublicKey","EBMinosWasmWrapTransportSigningSecretKey","WAByteArray","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s;function u(e){return c.apply(this,arguments)}function c(){return c=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.privateKey,r=t.publicKey,a=o("EBMinosWasmWrapTransportSigningPublicKey").wrapTransportSigningPublicKey({signalIdentityPublicKey:o("WAByteArray").uint8ArrayToBuffer(r)}),i=yield a,l=o("EBMinosWasmWrapTransportSigningSecretKey").wrapTransportSigningSecretKey({signalIdentityPrivateKey:o("WAByteArray").uint8ArrayToBuffer(n)}),u=yield l;if(!i.success)return o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Failed to wrap transport signing public key"]))),o("WAResultOrError").makeError("minos-wrap-transport-signing-keypair-error");if(!u.success)return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to wrap transport signing secret key"]))),o("WAResultOrError").makeError("minos-wrap-transport-signing-keypair-error");var c={pk:i.value,sk:u.value};return o("WAResultOrError").makeResult(c)}),c.apply(this,arguments)}l.wrapTransportSigningKeypair=u}),98);
__d("EBMinosWasmMinosThreadIdFromActThreadId",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.threadId;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToMinosThreadId(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.actThreadId;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosThreadIdFromActThreadIdResultSpec,validateResult:e},{minosThreadIdFromActThreadId:{actThreadId:n}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.minosThreadIdFromActThreadId=s}),98);
__d("EBMinosWasmMinosThreadIdFromOneToOneThread",["EBMinosTypes","EBMinosWasm.pb","EBMinosWasmReactorSingleton","WAResultOrError","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";function e(){function e(e){var t=e.threadId;return o("WAResultOrError").makeResult(o("EBMinosTypes").unsafeCastToMinosThreadId(t))}return(function(){var t=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var n=t.actThreadId,r=t.selfFbid;return yield o("EBMinosWasmReactorSingleton").DEPRECATED_minosCommand({InputSpec:o("EBMinosWasm.pb").MinosCommandSpec,ResultSpec:o("EBMinosWasm.pb").MinosThreadIdFromOneToOneThreadResultSpec,validateResult:e},{minosThreadIdFromOneToOneThread:{actThreadId:n,selfFbid:r}})});function r(e){return t.apply(this,arguments)}return r})()}var s=e();l.minosThreadIdFromOneToOneThread=s}),98);
__d("MpsThreadIdToMinosThreadId",["EBMinosLogger","EBMinosWasmMinosThreadIdFromActThreadId","EBMinosWasmMinosThreadIdFromOneToOneThread","Promise","WAJids","WAResultOrError"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u;function c(t,r){var a=o("WAJids").validateUserJid(t);if(a!=null){var i=o("WAJids").userIdFromJid(a);return o("EBMinosWasmMinosThreadIdFromOneToOneThread").minosThreadIdFromOneToOneThread({actThreadId:i,selfFbid:r}).then(function(t){return t.success?o("WAResultOrError").makeResult(t.value):(o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["mpsThreadIdToMinosThreadId UserJid error: ",""])),t.error),o("WAResultOrError").makeError("create-minos-thread-id-error"))})}var l=o("WAJids").validateGroupJid(t);if(l!=null){var c=o("WAJids").groupIdFromJid(l);return o("EBMinosWasmMinosThreadIdFromActThreadId").minosThreadIdFromActThreadId({actThreadId:c}).then(function(e){return e.success?o("WAResultOrError").makeResult(e.value):(o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["mpsThreadIdToMinosThreadId GroupJid error: ",""])),e.error),o("WAResultOrError").makeError("create-minos-thread-id-error"))})}return(u||(u=n("Promise"))).resolve(o("WAResultOrError").makeError("invalid-mps-thread-id"))}l.mpsThreadIdToMinosThreadId=c}),98);
__d("MpsThreadIdToWaThreadId",["WAJids"],(function(t,n,r,o,a,i,l){"use strict";function e(e){var t=o("WAJids").validateUserJid(e);if(t!=null)return o("WAJids").userIdFromJid(t);var n=o("WAJids").validateGroupJid(e);return n!=null?o("WAJids").groupIdFromJid(n):null}l.mpsThreadIdToWaThreadId=e}),98);
__d("EBMinosCryptoLibrary",["EBDecryptQplFlow","EBDeps","EBGenerateAndUploadMek","EBGetMinosAttachmentPayloadFromMpsMessage","EBMessageEncryptionKeyStorage","EBMessageEncryptionKeyStorageDecrypt","EBMinosCheckWasmFeatureSupport","EBMinosLogger","EBMinosMessageMetadataVersion","EBMinosProcessMessages","EBMinosTypes","EBMinosWasmDecryptAndVerifyMessage","EBMinosWasmDecryptMekForDistribution","EBMinosWasmDecryptMekForDistributionFromTransportSender","EBMinosWasmDeriveMailboxEncryptionKeypair","EBMinosWasmEncryptAndSignMessage","EBMinosWasmGenerateMekRosterHash","EBMinosWrapTransportSigningKeypair","MAWProtobufDeserializers","MpsThreadIdToMinosThreadId","MpsThreadIdToWaThreadId","MpsTypes","WAFrankingTypes","WAGetPlatformFromStanzaId","WAGlobals","WAResultOrError","WAStanzaUtils","asyncToGeneratorRuntime","err","gkx","nullthrows"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p,_,f,g,h,y,C,b,v,S,R,L;function E(e){return k.apply(this,arguments)}function k(){return k=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.io,a=t.loadMessageEncryptionKey,i=t.loadMessageEncryptionKeyForDecryption,l=t.loadMostRecentSelfMinosEpoch,s=t.loadSelfMinosEpochForDecryption,u=t.registerMinosMessageEncryptionKey,c=t.saveNewMessageEncryptionKey,d=e.logger,R=e.transportSigningKeypair,L=yield o("EBMinosCheckWasmFeatureSupport").checkWasFeatureSupportAndQE();d.DEV(m||(m=babelHelpers.taggedTemplateLiteralLoose(["gk minos_mvp_enabled: ",""])),L);var E=o("EBMessageEncryptionKeyStorage").createMessageEncryptionKeyStorage({io:{loadMessageEncryptionKey:a,saveNewMessageEncryptionKey:c},logger:d}),k=o("EBMessageEncryptionKeyStorageDecrypt").createMessageEncryptionKeyStorageDecrypt({io:{loadMessageEncryptionKeyForDecryption:i,saveNewMessageEncryptionKey:c},logger:d}),I=yield o("EBMinosWrapTransportSigningKeypair").wrapTransportSigningKeypair(R);if(I.success===!1)return o("WAResultOrError").makeError("transport-signing-keypair-error");var T=I.value,D=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.qplFlow,n=e.uploadEntity,a=n.deletionOfflineThreadingId,i=n.directive,s=n.isEphemeral,c=n.mailboxKeys,m=n.messageId,y=n.payload,C=n.senderId,b=n.supplementalOpToken,v=n.tags,S=n.threadId,R=n.timestampMs;t.addPoint("generate_mek_roster_hash_start");var L=c.map(function(e){var t=e.epochHead;return t}),k=yield o("EBMinosWasmGenerateMekRosterHash").generateMekRosterHash({epochHeads:L});if(!k.success)return t.addPoint("generate_mek_roster_hash_fail"),o("WAResultOrError").makeError("generate-mek-roster-hash-error");var I=k.value;t.addPoint("generate_mek_roster_hash_end"),t.addPoint("get_or_generate_mek_start");var D=o("EBMinosTypes").userJidToUserFbId(o("WAGlobals").getMyUserJid());if(D==null)return d.ERROR(p||(p=babelHelpers.taggedTemplateLiteralLoose(["selfFbid is invalid"]))),o("WAResultOrError").makeError("invalid-self-fbid");var $=yield o("MpsThreadIdToMinosThreadId").mpsThreadIdToMinosThreadId(S,D);if(!$.success)return d.ERROR(_||(_=babelHelpers.taggedTemplateLiteralLoose(["mpsThreadIdToMinosThreadId error: ",""])),$.error),o("WAResultOrError").makeError("create-minos-thread-id-error");var P=$.value,M=yield N({actThreadId:r("nullthrows")(o("MpsThreadIdToWaThreadId").mpsThreadIdToWaThreadId(S),"invalid MPS threadId"),io:{loadMostRecentSelfMinosEpoch:l,registerMinosMessageEncryptionKey:u},logger:d,mailboxKeys:c,mekStorage:E,minosThreadId:P,msgUploadQpl:t,rosterHash:I,transportSigningKeypair:T});if(!M.success)return d.ERROR(f||(f=babelHelpers.taggedTemplateLiteralLoose(["get or generate mek error: ",""])),M.error),t.addPoint("get_or_generate_mek_fail"),o("WAResultOrError").makeError("get-mek-error");t.addPoint("get_or_generate_mek_end",{string:{mekCacheStatus:M.value.cacheStatus}});var w=M.value.registeredMek,A=w.mek,F=w.mekFbid,O=o("EBMinosProcessMessages").createMessageTimestamp(R,o("EBMinosMessageMetadataVersion").MESSAGE_METADATA_CURRENT_VERSION,m);t.addPoint("encrypt_message_start");var B=yield o("EBMinosWasmEncryptAndSignMessage").encryptAndSignMessage({mekKey:A.key,metadata:{mekId:A.mekId,messageId:m,threadId:P,timestamp:O},plaintext:new Uint8Array(y),transportSigningPK:T.pk,transportSigningSK:T.sk});if(!B.success)return d.ERROR(g||(g=babelHelpers.taggedTemplateLiteralLoose(["message encryption error: ",""])),B.error),t.addPoint("encrypt_message_fail"),o("WAResultOrError").makeError("encrypt-message-error");t.addAnnotations({int:{message_encryption_version:B.value.version}}),t.addPoint("encrypt_message_end");var W=yield o("EBGetMinosAttachmentPayloadFromMpsMessage").getMinosAttachmentPayloadFromMpsMessage({logger:d,message:{messageId:m,payload:y,senderId:C,threadId:S,timestampMs:R},qplFlow:t});d.DEV(h||(h=babelHelpers.taggedTemplateLiteralLoose([""," attchmentSecrets generated"])),W.length);var q=x(a,y),U=q.frankingTag,V=q.reportingTag;return o("WAResultOrError").makeResult({attachmentPayload:W,backupActionType:i.actionType,deletionOfflineThreadingId:a,encryptedMsg:B.value.encryptedMsg,encryptedMsgSignature:B.value.signature,frankingTag:U,isEphemeral:s,mekFbid:F,mekId:A.mekId,messageEncryptionVersion:B.value.version,messageTimestampMs:R,otid:m,reportingTag:V,supplementalOpToken:b,tags:v,toplevelOfflineThreadingId:o("MpsTypes").toMessageId(i.originalMsgProtocolId.externalId),transportSigningPK:T.pk,waThreadId:S})});return function(n){return e.apply(this,arguments)}})(),P=(function(){var e=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t,n=e.encryptedMessage,a=e.encryptedMsgSignature,i=e.entryPoint,l=e.mekCreatorInfo,u=e.mekFbid,c=e.mekInfo,m=e.messageEncryptionVersion,p=e.messageInfo,_=e.recipientInfo,f=e.source,g=e.threadId,h=e.transportSigningPK,R=o("EBDecryptQplFlow").startDecryptQplFlow({decryptionType:"protobuf_message_decryptor",entryPoint:i,isMinos:!0,source:f,threadId:g});R.addAnnotations({bool:{mek_reuse_enabled:r("gkx")("7918")},int:{mek_creation_time_sec:c.mekCreationTimestamp,mek_encryption_version:c.mekEncryptionVersion,message_encryption_version:m,metadata_version:o("EBMinosMessageMetadataVersion").MESSAGE_METADATA_CURRENT_VERSION},string:{mek_fbid:u,message_id:p.messageId,platform_type:o("WAGetPlatformFromStanzaId").getPlatformFromStanzaId(o("WAStanzaUtils").toStanzaId(p.messageId)),sender_type:l.senderType}}),R.addPoint("load_self_minos_epoch_for_decryption_start");var L=yield s(_.epochFbId,c.mekEncryptionVersion);if(!L.success&&r("gkx")("20623")&&L.error==="no-self-epoch-found"){d.WARN(y||(y=babelHelpers.taggedTemplateLiteralLoose(["no self epoch found - will try to sync epochs"]))),R.addPoint("sync_epochs_start");var E=yield o("EBDeps").getDeps().getEBSMAPI(),I=yield E.repairEpochs();I.success?(R.addPoint("sync_epochs_end"),L=yield s(_.epochFbId,c.mekEncryptionVersion)):(d.ERROR(C||(C=babelHelpers.taggedTemplateLiteralLoose(["sync epochs error: ",""])),I.error),R.addAnnotations({string:{sync_epochs_error:I.error.message,sync_epochs_error_code:I.error.errorCode}}),R.addPoint("sync_epochs_fail"))}if(!L.success)return d.ERROR(b||(b=babelHelpers.taggedTemplateLiteralLoose(["epoch decryption error for message ID ",": ",""])),p.messageId,L.error),R.endFailWithError("load_self_minos_epoch_for_decryption_fail",L.error),o("WAResultOrError").makeError(L.error);R.addPoint("load_self_minos_epoch_for_decryption_end"),R.addPoint("derive_mailbox_encryption_key_pair_start");var T=yield o("EBMinosWasmDeriveMailboxEncryptionKeypair").deriveMailboxEncryptionKeypair({epochNumber:_.epochAnonId,exportRootKey:L.value.exportRootKey});if(!T.success)return d.ERROR(v||(v=babelHelpers.taggedTemplateLiteralLoose(["mailbox encryption key pair derivation error for message ID ",": ",""])),p.messageId,T.error),R.endFailWithError("derive_mailbox_encryption_key_pair_fail",T.error),o("WAResultOrError").makeError("derive-mailbox-keys-error");var D=T.value.sk;R.addPoint("derive_mailbox_encryption_key_pair_end"),R.addPoint("get_or_decrypt_message_encryption_key_start");var x=yield $({logger:d,mailboxEncryptionSK:D,mekCreatorInfo:l,mekFbid:u,mekInfo:c,mekStorageDecrypt:k,minosThreadId:p.threadId,qplFlow:R,recipientEpochHead:(t=_.epochHead)!=null?t:L.value.exportEpochHead,transportSigningPK:h});if(!x.success){var P;return R.endFailWithError(x.error.errorName,(P=x.error.failReason)!=null?P:"decrypt-mek-error"),o("WAResultOrError").makeError("decrypt-mek-error")}R.addPoint("get_or_decrypt_mailbox_encryption_key_end",{string:{mekCacheStatus:x.value.cacheStatus}}),R.addPoint("decrypt_and_verify_message_start");var N=yield o("EBMinosWasmDecryptAndVerifyMessage").decryptAndVerifyMessage({cipherText:n,mekKey:x.value.mekKey,messageEncryptionVersion:m,metadata:{mekId:c.mekId,messageId:p.messageId,threadId:p.threadId,timestamp:p.timestamp},signature:a,transportSigningPK:h});return N.success?(R.addPoint("decrypt_and_verify_message_end"),R.endSuccess(),o("WAResultOrError").makeResult(N.value)):(d.ERROR(S||(S=babelHelpers.taggedTemplateLiteralLoose(["message decryption error for message ID ",": ",""])),p.messageId,N.error),R.endFailWithError("decrypt_and_verify_message_fail",N.error),o("WAResultOrError").makeError("decrypt-message-error"))});return function(n){return e.apply(this,arguments)}})();return o("WAResultOrError").makeResult({decryptMessage:P,encryptMessage:D})}),k.apply(this,arguments)}var I=null;function T(t){if(I!=null){o("EBMinosLogger").minosLogger.DEV(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Minos crypto library is already set"])));return}o("EBMinosLogger").minosLogger.DEV(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Minos crypto library is initialized"]))),I=t}function D(){if(I==null)throw o("EBMinosLogger").minosLogger.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["Minos crypto library is not set"]))),r("err")("Minos crypto library is not set");return I}function x(e,t){var n=null,r=null;if(e==null){var a,i,l=o("MAWProtobufDeserializers").DeserializedBackupMessage.create(t),s=(a=l.proto.metadata)==null||(a=a.frankingMetadata)==null?void 0:a.frankingTag;s==null?o("EBMinosLogger").minosLogger.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["missing frankingTag in upload"]))):n=o("WAFrankingTypes").castToFrankingTag(new Uint8Array(s));var u=(i=l.proto.metadata)==null||(i=i.frankingMetadata)==null?void 0:i.reportingTag;u==null?o("EBMinosLogger").minosLogger.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["missing reportingTag in upload"]))):r=o("WAFrankingTypes").castToReportingTag(new Uint8Array(u))}return{frankingTag:n,reportingTag:r}}function $(e){return P.apply(this,arguments)}function P(){return P=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.logger,n=e.mailboxEncryptionSK,a=e.mekCreatorInfo,i=e.mekFbid,l=e.mekInfo,s=e.mekStorageDecrypt,u=e.minosThreadId,c=e.qplFlow,d=e.recipientEpochHead,m=e.transportSigningPK;if(r("gkx")("7918")){var p=yield s.getMessageEncryptionKeyDecrypt({mekId:l.mekId});if(c.addAnnotations({bool:{mek_reuse:p!=null}}),p!=null)return o("WAResultOrError").makeResult({cacheStatus:p.cacheStatus,mekKey:p.registeredMek.mek.key})}var _=a.senderType==="Transport"?yield o("EBMinosWasmDecryptMekForDistributionFromTransportSender").decryptMekForDistributionFromTransportSender({mekDistribution:{encryptedMek:l.encryptedMek,ephemeralEncryptionPk:a.transportSenderEphemeralPK,recipientEpochHead:d,signature:a.transportSenderEphemeralKeySig,signingPk:m},mekEncryptionVersion:l.mekEncryptionVersion,mekId:l.mekId,recipientEncSk:n,rosterHash:l.mekRosterHash}):yield o("EBMinosWasmDecryptMekForDistribution").decryptMekForDistribution({encryptedMek:l.encryptedMek,mailboxAuthPk:a.senderMailboxAuthPK,mailboxEncSk:n,mekEncryptionVersion:l.mekEncryptionVersion,mekId:l.mekId,recipientEpochHead:d,rosterHash:l.mekRosterHash,senderEpochHead:a.senderEpochHead});if(!_.success)return t.ERROR(R||(R=babelHelpers.taggedTemplateLiteralLoose(["mek decryption error: ",""])),_.error),_;if(r("gkx")("7918")){var f={key:_.value,mekId:l.mekId,rosterHash:l.mekRosterHash},g={mek:f,mekFbid:i};yield s.setNewMessageEncryptionKeyDecrypt({minosThreadId:u,registeredMek:g})}return o("WAResultOrError").makeResult({cacheStatus:"new",mekKey:_.value})}),P.apply(this,arguments)}function N(e){return M.apply(this,arguments)}function M(){return M=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){var t=e.actThreadId,n=e.io,r=e.logger,a=e.mailboxKeys,i=e.mekStorage,l=e.minosThreadId,s=e.msgUploadQpl,u=e.rosterHash,c=e.transportSigningKeypair,d=yield i.getMessageEncryptionKey({minosThreadId:l,rosterHash:u});if(d!=null)return o("WAResultOrError").makeResult(d);var m=yield o("EBGenerateAndUploadMek").generateAndUploadMek({actThreadId:t,io:{loadMostRecentSelfMinosEpoch:n.loadMostRecentSelfMinosEpoch,registerMinosMessageEncryptionKey:n.registerMinosMessageEncryptionKey},logger:r,msgUploadQpl:s,participantMailboxes:a,transportSigningKeypair:c});if(!m.success)return r.ERROR(L||(L=babelHelpers.taggedTemplateLiteralLoose(["mek register error: ",""])),m.error),o("WAResultOrError").makeError("register-mek-error");var p={mek:m.value.mek,mekFbid:m.value.mekFbid};return yield i.setNewMessageEncryptionKey({minosThreadId:l,registeredMek:p,rosterHash:u}),o("WAResultOrError").makeResult({cacheStatus:"new",registeredMek:p})}),M.apply(this,arguments)}l.createMinosCryptoLibrary=E,l.setMinosCryptoLibrary=T,l.getMinosCryptoLibrary=D}),98);
__d("EBSenderUploadQueue",["EBMinosLogger","PersistedQueueApi","Promise","WAPersistedQueue","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c=function(t){return t},d=null;function m(){return d==null?p():d}function p(){d!=null&&o("EBMinosLogger").minosLogger.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["EB Upload Queue is already initialized"])));var t=o("WAPersistedQueue").initPersistedQueue("ebSenderUploadQueueV3",o("PersistedQueueApi").persistedQueueApi());return d=t,t}function _(e){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e){if(e.length===0)return(u||(u=n("Promise"))).resolve();try{var t=m();yield t.addAndCommit(e)}catch(e){return o("EBMinosLogger").minosLogger.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Failed to write to ebSenderUploadQueue ",""])),e),(u||(u=n("Promise"))).reject(e)}}),f.apply(this,arguments)}l.toSendersQueueId=c,l.ebSenderUploadQueue=m,l.enqueueMessages=_}),98);
__d("EncryptedBackupTaskFailureFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5725"),s=o("FalcoLoggerInternal").create("encrypted_backup_task_failure",e),u=s;l.default=u}),98);
__d("EncryptedBackupTaskIssuedFalcoEvent",["FalcoLoggerInternal","getFalcoLogPolicy_DO_NOT_USE"],(function(t,n,r,o,a,i,l){"use strict";var e=r("getFalcoLogPolicy_DO_NOT_USE")("5726"),s=o("FalcoLoggerInternal").create("encrypted_backup_task_issued",e),u=s;l.default=u}),98);
__d("LSWriteSupplementalMessage",["LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][writeSupplementalMessage] Beginning execution."),r[1]=t.i64.of_float(Date.now()),t.filter(t.db.table(302).fetch(),function(t){return t.threadId===e[1]&&t.toplevelOfflineThreadingId===e[2]&&t.supplementalKey===e[3]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[2]=void 0:(t=o.item,r[2]=t.messageTimestampMs)})},function(n){return t.i64.neq(r[2],void 0)?t.sequence([function(n){var o;return t.i64.gt(r[2],e[5])?t.resolve((o=[!1,t.i64.cast([0,851])],r[12]=o[0],r[13]=o[1],o)):t.sequence([function(n){return t.forEach(t.filter(t.db.table(302).fetch(),function(t){return t.threadId===e[1]&&t.toplevelOfflineThreadingId===e[2]&&t.supplementalKey===e[3]}),function(e){return e.delete()})},function(n){return t.db.table(302).add({pk:void 0,messagePayload:e[0],threadId:e[1],toplevelOfflineThreadingId:e[2],supplementalKey:e[3],offlineThreadingId:e[4],messageTimestampMs:e[5]})},function(e){var t;return t=[!0,void 0],r[12]=t[0],r[13]=t[1],t}])},function(e){var t;return t=[r[12],r[13]],r[4]=t[0],r[5]=t[1],t}]):t.sequence([function(n){return t.forEach(t.filter(t.db.table(302).fetch(),function(t){return t.threadId===e[1]&&t.toplevelOfflineThreadingId===e[2]&&t.supplementalKey===e[3]}),function(e){return e.delete()})},function(n){return t.db.table(302).add({pk:void 0,messagePayload:e[0],threadId:e[1],toplevelOfflineThreadingId:e[2],supplementalKey:e[3],offlineThreadingId:e[4],messageTimestampMs:e[5]})},function(e){var t;return t=[!0,void 0],r[4]=t[0],r[5]=t[1],t}])},function(e){return r[6]=t.i64.of_float(Date.now()),r[7]=t.i64.random(),r[9]="Finishing execution. Execution time: ",r[10]=t.i64.to_string(t.i64.sub(r[6],r[0])),r[11]=" ms",r[8]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][writeSupplementalMessage] ",r[8],r[9],r[8],r[10],r[8],r[11]].join("")),t.i64.eq(t.i64.mod_(r[7],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[12]=",",r[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"writeSupplementalMessage",[r[9],r[12],r[10],r[12],r[11]].join(""),r[13],t.i64.cast([0,4]))):t.resolve()},function(e){var t;return t=[r[4],r[5]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMPSWriteSupplementalMessageStoredProcedure",e.__tables__=["local_message_persistence_store_supplemental"],a.exports=e}),null);
__d("LSWriteSupplementalMessageStoredProcedure",["LSSynchronousPromise","LSWriteSupplementalMessage","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSWriteSupplementalMessage"),a.messagePayload,a.threadId,a.toplevelOfflineThreadingId,a.supplementalKey,a.offlineThreadingId,a.messageTimestampMs);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("LSWriteTopLevelMessage",["LSLogMebClientEvent.nop"],(function(t,n,r,o,a,i){function e(){var e=arguments,t=e[e.length-1],r=[],o=[];return t.sequence([function(a){return t.sequence([function(n){return r[0]=t.i64.of_float(Date.now()),(function(e){t.logger(e).info(e)})("[EncryptedBackups][writeTopLevelMessage] Beginning execution."),r[1]=t.i64.of_float(Date.now()),t.filter(t.db.table(301).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[2]=void 0:(t=o.item,r[2]=t.messageTimestampMs)})},function(n){return t.i64.neq(r[2],void 0)?t.sequence([function(n){var o;return t.i64.gt(r[2],e[3])?t.resolve((o=[!1,t.i64.cast([0,851])],r[12]=o[0],r[13]=o[1],o)):t.sequence([function(n){return t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[14]=!1:(t=o.item,r[14]=!0)})},function(n){return r[14]?t.sequence([function(n){return t.forEach(t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(t){var n=t.update,r=t.item;return n({deletedMessagePayload:e[0],isLocalOnlyMessage:e[4],messageTimestampMs:e[3]})})},function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(n){return n.threadId===e[1]&&n.offlineThreadingId===e[2]&&t.i64.eq(n.messageTimestampMs,t.i64.cast([-1,4294967295]))}),function(t){var n=t.update,r=t.item;return n({messageTimestampMs:e[3]})})},function(e){var n;return n=[!1,t.i64.cast([0,852])],r[16]=n[0],r[17]=n[1],n}]):t.sequence([function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(e){return e.delete()})},function(n){return t.db.table(301).add({pk:void 0,messagePayload:e[0],threadId:e[1],offlineThreadingId:e[2],messageTimestampMs:e[3],isLocalOnlyMessage:e[4],extraData:e[5]})},function(e){var t;return t=[!0,void 0],r[16]=t[0],r[17]=t[1],t}])},function(e){var t;return t=[r[16],r[17]],r[12]=t[0],r[13]=t[1],t}])},function(e){var t;return t=[r[12],r[13]],r[4]=t[0],r[5]=t[1],t}]):t.sequence([function(n){return t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}).next().then(function(e,t){var n=e.done,o=e.value;return n?r[12]=!1:(t=o.item,r[12]=!0)})},function(n){return r[12]?t.sequence([function(n){return t.forEach(t.filter(t.db.table(303).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(t){var n=t.update,r=t.item;return n({deletedMessagePayload:e[0],isLocalOnlyMessage:e[4],messageTimestampMs:e[3]})})},function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(n){return n.threadId===e[1]&&n.offlineThreadingId===e[2]&&t.i64.eq(n.messageTimestampMs,t.i64.cast([-1,4294967295]))}),function(t){var n=t.update,r=t.item;return n({messageTimestampMs:e[3]})})},function(e){var n;return n=[!1,t.i64.cast([0,852])],r[14]=n[0],r[15]=n[1],n}]):t.sequence([function(n){return t.forEach(t.filter(t.db.table(301).fetch(),function(t){return t.threadId===e[1]&&t.offlineThreadingId===e[2]}),function(e){return e.delete()})},function(n){return t.db.table(301).add({pk:void 0,messagePayload:e[0],threadId:e[1],offlineThreadingId:e[2],messageTimestampMs:e[3],isLocalOnlyMessage:e[4],extraData:e[5]})},function(e){var t;return t=[!0,void 0],r[14]=t[0],r[15]=t[1],t}])},function(e){var t;return t=[r[14],r[15]],r[4]=t[0],r[5]=t[1],t}])},function(e){return r[6]=t.i64.of_float(Date.now()),r[7]=t.i64.random(),r[9]="Finishing execution. Execution time: ",r[10]=t.i64.to_string(t.i64.sub(r[6],r[0])),r[11]=" ms",r[8]="",(function(e){t.logger(e).info(e)})(["[EncryptedBackups][writeTopLevelMessage] ",r[8],r[9],r[8],r[10],r[8],r[11]].join("")),t.i64.eq(t.i64.mod_(r[7],t.i64.cast([0,1e3])),t.i64.cast([0,0]))?(r[12]=",",r[13]=t.createArray(),t.nativeOperation(n("LSLogMebClientEvent.nop"),"writeTopLevelMessage",[r[9],r[12],r[10],r[12],r[11]].join(""),r[13],t.i64.cast([0,4]))):t.resolve()},function(e){var t;return t=[r[4],r[5]],o[0]=t[0],o[1]=t[1],t}])},function(e){return t.resolve(o)}])}e.__sproc_name__="LSMPSWriteTopLevelMessageStoredProcedure",e.__tables__=["local_message_persistence_store","local_message_persistence_store_deleted_messages"],a.exports=e}),null);
__d("LSWriteTopLevelMessageStoredProcedure",["LSSynchronousPromise","LSWriteTopLevelMessage","Promise","cr:8709"],(function(t,n,r,o,a,i,l){var e;function s(t,a){var i=t.storedProcedure(r("LSWriteTopLevelMessage"),a.messagePayload,a.threadId,a.offlineThreadingId,a.messageTimestampMs,a.isLocalOnlyMessage,a.extraData);return(e||(e=n("Promise"))).resolve(o("LSSynchronousPromise").maybeExtractValueIfSynchronousPromise(i))}l.default=s}),98);
__d("MessageBackupTagsDelimiter",[],(function(t,n,r,o,a,i){"use strict";var e=":";i.INSTAMADILLO_TAG_DELIMITER=e}),66);
__d("EncryptedBackupsWriteToMPSTables",["EncryptedBackupsUploadEntity","FBLogger","I64","IGDWEBUploadMessageUtils","LSFactory","LSWriteSupplementalMessageStoredProcedure","LSWriteTopLevelMessageStoredProcedure","MessageBackupTagsDelimiter","WAErrorMessage","WAResultOrError","asyncToGeneratorRuntime","getSafeQplErrorMessage","gkx","promiseDone","requireDeferred"],(function(t,n,r,o,a,i,l){"use strict";var e,s=r("requireDeferred")("ReverbWriteFailureFalcoEvent").__setRef("EncryptedBackupsWriteToMPSTables"),u=r("requireDeferred")("ReverbWriteSuccessFalcoEvent").__setRef("EncryptedBackupsWriteToMPSTables"),c=r("gkx")("8488")||r("gkx")("10326");function d(e,t,n,o,a,i){o?r("promiseDone")(u.load(),function(r){return r.log(function(){return{backup_action:n,backup_protocol:a,labyrinth_version:0,message_id:e,thread_id:t}})}):r("promiseDone")(s.load(),function(r){return r.log(function(){return{backup_action:n,backup_protocol:a,failure_reason:i,labyrinth_version:0,message_id:e,thread_id:t}})})}function m(e,t,n,r,o){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,a,i,l){var s=n.backupActionType,u=n.instamadilloItemId,m=n.msgId,p=n.originalMsgProtocolId,_=n.protobuf,f=n.serverTs,g=n.sortOrderMs,h=n.supplementalKey;l==null||l.addPoint("mps_tables_write_start");var y=m.externalId,C=p==null?void 0:p.externalId,b=u!=null?u:g;if(b==null)return l==null||l.addPoint("mps_tables_write_missing_protobuf_ts"),o("WAResultOrError").makeError({errorCode:null,errorMsg:"protobufTimestampMs is null when writing to MPS tables"});var v=(e||(e=o("I64"))).of_float(b),S=!1,R=c?"protobuf_only":"dual_upload";i&&(R="open_eb_ttlc");var L=null;switch(s){case 1:{l==null||l.addPoint("mps_top_level_write_start");try{var E=yield r("LSWriteTopLevelMessageStoredProcedure")(r("LSFactory")(t),{isLocalOnlyMessage:!1,messagePayload:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(_),messageTimestampMs:v,offlineThreadingId:y,threadId:a}),k=E[0],I=E[1];L=I,k&&(S=!0),d(y,a,"upsert_top_level",k,R),l==null||l.addPoint("mps_top_level_write",{bool:{mps_top_level_write_succesful:k}})}catch(e){d(y,a,"upsert_top_level",!1,R,o("WAErrorMessage").maybeGetMessageFromError(e)),l==null||l.addPoint("mps_top_level_write_error",{string:{mps_top_level_write_error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}break}case 2:{if(l==null||l.addPoint("mps_supplemental_write_start"),C==null||h==null)d(y,a,"upsert_supplemental",!1,R),r("FBLogger")("wmi_eb").warn("Missing toplevelOfflineThreadingId or supplementalKey when writing to MPS tables");else try{var T=yield r("LSWriteSupplementalMessageStoredProcedure")(r("LSFactory")(t),{messagePayload:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(_),messageTimestampMs:v,offlineThreadingId:y,supplementalKey:h,threadId:a,toplevelOfflineThreadingId:C}),D=T[0],x=T[1];L=x,D&&(S=!0),d(y,a,"upsert_supplemental",D,R),l==null||l.addPoint("mps_supplemental_write",{bool:{mps_supplemental_write_successful:D}})}catch(e){d(y,a,"upsert_supplemental",!1,R,o("WAErrorMessage").maybeGetMessageFromError(e)),l==null||l.addPoint("mps_supplemental_write_error",{string:{mps_supplemental_write_error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}break}case 4:{if(l==null||l.addPoint("mps_delete_top_level_with_placeholder_write_start"),C==null)break;try{var $=yield r("LSWriteTopLevelMessageStoredProcedure")(r("LSFactory")(t),{isLocalOnlyMessage:!1,messagePayload:o("EncryptedBackupsUploadEntity").getEbBackupMessageBytesBuffer(_),messageTimestampMs:(e||(e=o("I64"))).of_float(o("IGDWEBUploadMessageUtils").generateProtobufServerTs(C,f)),offlineThreadingId:y,threadId:a}),P=$[0],N=$[1];L=N,P&&(S=!0),d(C,a,"delete_top_level",P,R),l==null||l.addPoint("mps_delete_top_level_with_placeholder_write",{bool:{mps_delete_top_level_with_placeholder_write_successful:P}})}catch(e){d(C,a,"delete_top_level_with_placeholder",!1,R,o("WAErrorMessage").maybeGetMessageFromError(e)),l==null||l.addPoint("mps_delete_top_level_with_placeholder_write_error",{string:{mps_delete_top_level_with_placeholder_write_error:o("getSafeQplErrorMessage").getSafeQPLErrorMessage(e)}})}break}case 3:S=!0,C!=null&&d(C,a,"delete_top_level",!1,R);break;default:l==null||l.addPoint("mps_write_unsupported_backup_action_type"),r("FBLogger")("wmi_eb").warn("Unsupported backupActionType when writing to MPS tables")}return S?(l==null||l.addPoint("mps_write_successful"),o("WAResultOrError").makeResult(S)):(l==null||l.addPoint("mps_write_unsuccessful"),o("WAResultOrError").makeError({errorCode:L,errorMsg:"Unsuccessful writing to MPS tables"}))}),p.apply(this,arguments)}function _(e,t,n){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t,n,r){var a=n.msgId,i=n.sortOrderMs,l=n.tags;l!=null&&l.length!==0&&i!=null&&(yield t.local_message_persistence_store_tag_index.put({localMessagePersistenceStoreKey:(e||(e=o("I64"))).of_string(a.externalId),messageTimestampMs:e.of_float(i),offlineThreadingId:a.externalId,tag:l.join(o("MessageBackupTagsDelimiter").INSTAMADILLO_TAG_DELIMITER),threadId:r}))}),f.apply(this,arguments)}l.writeToMPSTables=m,l.writeTagsToMPSTables=_}),98);
__d("WACryptoCurve25519Dependencies",["Promise","WACryptoPrimitives","WASignalKeys","WASignalOther"],(function(t,n,r,o,a,i,l){"use strict";var e;function s(){return(e||(e=n("Promise"))).resolve().then(function(){return o("WASignalKeys").makeKeyPair()})}function u(t,r){return(e||(e=n("Promise"))).resolve().then(function(){return o("WACryptoPrimitives").scalarMult(o("WASignalOther").ensureSize(r,32),o("WASignalOther").ensureSize(t,32)).buffer})}var c={generateIdentityKeyPair:s,calculateAgreement:u};l.calculateAgreement=u,l.CURVE25519_SIGNAL_DEPENDENCIES=c}),98);
__d("WASmaxInPreKeysRotateSignedResponseRequestError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysRequestErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysRequestErrors").parseRequestErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorRequestErrors:i.value})):i}l.parseRotateSignedResponseRequestError=e}),98);
__d("WASmaxInPreKeysRotateSignedResponseServerError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysServerErrors","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);if(!a.success)return a;var i=o("WASmaxInPreKeysServerErrors").parseServerErrors(r.value);return i.success?o("WAResultOrError").makeResult(babelHelpers.extends({},a.value,{errorServerErrors:i.value})):i}l.parseRotateSignedResponseServerError=e}),98);
__d("WASmaxInPreKeysRotateSignedResponseSuccess",["WASmaxInPreKeysIQResultResponseMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxInPreKeysIQResultResponseMixin").parseIQResultResponseMixin(e,t);return r.success,r}l.parseRotateSignedResponseSuccess=e}),98);
__d("WASmaxInPreKeysRotateSignedResponseValidationError",["WAResultOrError","WASmaxInPreKeysIQErrorResponseMixin","WASmaxInPreKeysIdentityKeyMixin","WASmaxParseUtils"],(function(t,n,r,o,a,i,l){function e(e,t){var n=o("WASmaxParseUtils").assertTag(e,"iq");if(!n.success)return n;var r=o("WASmaxParseUtils").flattenedChildWithTag(e,"error");if(!r.success)return r;var a=o("WASmaxParseUtils").attrString(r.value,"text");if(!a.success)return a;var i=o("WASmaxParseUtils").attrIntRange(r.value,"code",400,499);if(!i.success)return i;var l=o("WASmaxInPreKeysIdentityKeyMixin").parseIdentityKeyMixin(r.value);if(!l.success)return l;var s=o("WASmaxInPreKeysIQErrorResponseMixin").parseIQErrorResponseMixin(e,t);return s.success?o("WAResultOrError").makeResult(babelHelpers.extends({errorText:a.value,errorCode:i.value,errorIdentityKeyMixin:l.value},s.value)):s}l.parseRotateSignedResponseValidationError=e}),98);
__d("WASmaxOutPreKeysRotateSignedRequest",["WASmaxJsx","WASmaxOutPreKeysClientRequestMixin","WASmaxOutPreKeysSignedPreKeyMixin"],(function(t,n,r,o,a,i,l){function e(e){var t=e.signedPreKeyMixinArgs,n=o("WASmaxOutPreKeysClientRequestMixin").mergeClientRequestMixin(o("WASmaxJsx").smax("iq",{type:"set"},o("WASmaxOutPreKeysSignedPreKeyMixin").mergeSignedPreKeyMixin(o("WASmaxJsx").smax("rotate",null),t)));return n}l.makeRotateSignedRequest=e}),98);
__d("WASmaxPreKeysRotateSignedRPC",["WAComms","WASmaxInPreKeysRotateSignedResponseRequestError","WASmaxInPreKeysRotateSignedResponseServerError","WASmaxInPreKeysRotateSignedResponseSuccess","WASmaxInPreKeysRotateSignedResponseValidationError","WASmaxOutPreKeysRotateSignedRequest","WASmaxParsingFailure","WASmaxRpcUtils","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){function e(e,t){return s.apply(this,arguments)}function s(){return s=n("asyncToGeneratorRuntime").asyncToGenerator(function*(e,t){var n=o("WASmaxOutPreKeysRotateSignedRequest").makeRotateSignedRequest(e),r=yield o("WAComms").sendSmaxStanza(n,t),a=o("WASmaxInPreKeysRotateSignedResponseSuccess").parseRotateSignedResponseSuccess(r,n);if(a.success)return{name:"RotateSignedResponseSuccess",value:a.value};var i=o("WASmaxInPreKeysRotateSignedResponseValidationError").parseRotateSignedResponseValidationError(r,n);if(i.success)return{name:"RotateSignedResponseValidationError",value:i.value};var l=o("WASmaxInPreKeysRotateSignedResponseRequestError").parseRotateSignedResponseRequestError(r,n);if(l.success)return{name:"RotateSignedResponseRequestError",value:l.value};var s=o("WASmaxInPreKeysRotateSignedResponseServerError").parseRotateSignedResponseServerError(r,n);if(s.success)return{name:"RotateSignedResponseServerError",value:s.value};throw new(o("WASmaxParsingFailure")).SmaxParsingFailure(o("WASmaxRpcUtils").errorMessageRpcParsing("RotateSigned",{Success:a,ValidationError:i,RequestError:l,ServerError:s}))}),s.apply(this,arguments)}l.sendRotateSignedRPC=e}),98);
__d("WARotateSignedPreKeyProtocol",["WACryptoManager","WAErrorMessage","WAGlobals","WAHandleFailureUtils","WAMakeSignedPreKeyMixin","WAResultOrError","WASmaxPreKeysRotateSignedRPC","WATagsLogger","asyncToGeneratorRuntime"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d,m,p=o("WATagsLogger").TAGS(["rotateSignedPreKeyProtocol"]);function _(){return f.apply(this,arguments)}function f(){return f=n("asyncToGeneratorRuntime").asyncToGenerator(function*(){p.LOG(e||(e=babelHelpers.taggedTemplateLiteralLoose(["start generating skey..."])));try{var t=yield o("WAGlobals").getWaOneQueue().enqueue(function(e){var t=e.cryptoManager;return o("WACryptoManager").generateSignedPreKey(t)},{operationType:"generate_signed_prekey",flush:!0,afterInit:!0});p.LOG(s||(s=babelHelpers.taggedTemplateLiteralLoose(["generated skey. Start rotating skey..."])));var n=yield o("WASmaxPreKeysRotateSignedRPC").sendRotateSignedRPC({signedPreKeyMixinArgs:o("WAMakeSignedPreKeyMixin").makeSignedPreKeyMixin(t)});switch(n.name){case"RotateSignedResponseValidationError":{var r=n.value,a=r.errorCode,i=r.errorText,l=r.errorIdentityKeyMixin;return p.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["ValidationError: "," ",""])),a,i),o("WAResultOrError").makeError({type:"validation-error",identity:l.elementValue})}case"RotateSignedResponseRequestError":{var _=n.value.errorRequestErrors.value.code,f=n.value.errorRequestErrors.name;return p.ERROR(c||(c=babelHelpers.taggedTemplateLiteralLoose(["RequestError: "," ",""])),_,f),o("WAResultOrError").makeError({type:"request-error"})}case"RotateSignedResponseServerError":{var g=n.value.errorServerErrors.value.code,h=n.value.errorServerErrors.name;return p.ERROR(d||(d=babelHelpers.taggedTemplateLiteralLoose(["ServerError: "," ",""])),g,h),o("WAResultOrError").makeError({type:"server-error"})}default:return n.name,p.LOG(m||(m=babelHelpers.taggedTemplateLiteralLoose(["successfully rotated new skey"]))),o("WAResultOrError").makeResult()}}catch(e){var y=o("WAErrorMessage").maybeGetMessageFromError(e);if(y.includes("No lastSignedPrekeyId and registration"))return yield o("WAHandleFailureUtils").reregisterPhone(),o("WAResultOrError").makeError({type:"no-prekey-reregistered"});throw e}}),f.apply(this,arguments)}l.rotateSignedPreKeyProtocol=_}),98);
__d("WARotateSignedPreKey",["Promise","WAGenerateAndUploadPreKeys","WALoggerTag","WARotateSignedPreKeyProtocol","WATagsLogger","asyncToGeneratorRuntime","err"],(function(t,n,r,o,a,i,l){"use strict";var e,s,u,c,d=o("WATagsLogger").TAGS([r("WALoggerTag").SignedPrekeyRotation,r("WALoggerTag").SignedPrekey]);function m(e){return p.apply(this,arguments)}function p(){return p=n("asyncToGeneratorRuntime").asyncToGenerator(function*(t){var a=yield o("WARotateSignedPreKeyProtocol").rotateSignedPreKeyProtocol();if(!(a.success||a.error.type==="no-prekey-reregistered")){if(a.error.type==="validation-error")return d.ERROR(e||(e=babelHelpers.taggedTemplateLiteralLoose(["Signed prekey failed server validation. need to upload all keys."]))),o("WAGenerateAndUploadPreKeys").generateAndUploadPreKeys(null,{reason:"signed prekey failed server validation"}).catch(function(e){d.ERROR(s||(s=babelHelpers.taggedTemplateLiteralLoose(["Error while generating and uploading prekeys: ",""])),e)}),(c||(c=n("Promise"))).resolve();throw d.ERROR(u||(u=babelHelpers.taggedTemplateLiteralLoose(["rotateSignedPreKey failed."]))),r("err")("rotateSignedPreKey RPC failed: "+a.error.type)}}),p.apply(this,arguments)}l.rotateSignedPreKey=m}),98);